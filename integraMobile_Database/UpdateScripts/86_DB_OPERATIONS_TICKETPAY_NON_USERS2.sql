ALTER PROCEDURE [dbo].[Update_DB_OPERATIONS_HOUR]
	@FromHour AS Datetime
AS	
BEGIN

	IF (@FromHour IS NULL)
	BEGIN
		SET @FromHour = (SELECT MAX([HOUR_UTC])
		FROM DB_OPERATIONS_HOUR
		WHERE [HOUR_UTC] < GETUTCDATE())

		IF (@FromHour IS NOT NULL)
		BEGIN
			SET @FromHour = DATEADD(HOUR, -1, @FromHour)
		END		
	END
	
	IF (@FromHour IS NULL)
	BEGIN
		SET @FromHour = (SELECT MIN(OPE_UTC_DATE)
		FROM ALL_OPERATIONS_EXT
		WHERE OPE_TYPE IN (1,2,3,4, 5))
	END	

	DELETE FROM DB_OPERATIONS_HOUR_DIST
	WHERE OHD_DBOH_ID IN (SELECT DBOH_ID
						  FROM DB_OPERATIONS_HOUR
						  WHERE CASE WHEN [HOUR_UTC] IS NULL THEN [HOUR] ELSE [HOUR_UTC] END >= @FromHour)
						  
	DELETE FROM DB_OPERATIONS_HOUR
	WHERE CASE WHEN [HOUR_UTC] IS NULL THEN [HOUR] ELSE [HOUR_UTC] END >= @FromHour
	

	INSERT INTO DB_OPERATIONS_HOUR([HOUR], HOUR_UTC, OPE_INS_ID, GRP_ID, OPE_AMOUNT_CUR_ISO_CODE, PARKINGS_COUNT, EXTENSIONS_COUNT, REFUNDS_COUNT, TICKETPAYMENTS_COUNT, RECHARGES_COUNT, PAGATELIA_COUNT, RECHARGEREFUNDS_COUNT, COUPONS_COUNT, COUPONREFUNDS_COUNT, SERVICES_COUNT, RECHARGES_REGULAR_COUNT, RECHARGES_AUTOMATIC_COUNT, RECHARGES_USERCREATION_COUNT, RECHARGES_CHANGEPM_COUNT, TICKETPAYMENTS_NON_USERS_COUNT,
								   PARKINGS_AMOUNT, PARKINGS_VAT, PARKINGS_PERC_FEE, PARKINGS_PERC_FEE_VAT, PARKINGS_FIXED_FEE, PARKINGS_FIXED_FEE_VAT, PARKINGS_TOTAL_AMOUNT, 
								   EXTENSIONS_AMOUNT, EXTENSIONS_VAT, EXTENSIONS_PERC_FEE, EXTENSIONS_PERC_FEE_VAT, EXTENSIONS_FIXED_FEE, EXTENSIONS_FIXED_FEE_VAT, EXTENSIONS_TOTAL_AMOUNT, 
								   REFUNDS_AMOUNT, REFUNDS_VAT, REFUNDS_PERC_FEE, REFUNDS_PERC_FEE_VAT, REFUNDS_FIXED_FEE, REFUNDS_FIXED_FEE_VAT, REFUNDS_TOTAL_AMOUNT, 
								   TICKETPAYMENTS_AMOUNT, TICKETPAYMENTS_VAT, TICKETPAYMENTS_PERC_FEE, TICKETPAYMENTS_PERC_FEE_VAT, TICKETPAYMENTS_FIXED_FEE, TICKETPAYMENTS_FIXED_FEE_VAT, TICKETPAYMENTS_TOTAL_AMOUNT, 
								   TICKETPAYMENTS_NON_USERS_AMOUNT, TICKETPAYMENTS_NON_USERS_VAT, TICKETPAYMENTS_NON_USERS_PERC_FEE, TICKETPAYMENTS_NON_USERS_PERC_FEE_VAT, TICKETPAYMENTS_NON_USERS_FIXED_FEE, TICKETPAYMENTS_NON_USERS_FIXED_FEE_VAT, TICKETPAYMENTS_NON_USERS_TOTAL_AMOUNT, 
								   RECHARGES_AMOUNT, RECHARGES_VAT, RECHARGES_PERC_FEE, RECHARGES_PERC_FEE_VAT, RECHARGES_FIXED_FEE, RECHARGES_FIXED_FEE_VAT, RECHARGES_TOTAL_AMOUNT, RECHARGEREFUNDS_TOTAL_AMOUNT,
								   PAGATELIA_AMOUNT, PAGATELIA_VAT, PAGATELIA_PERC_FEE, PAGATELIA_PERC_FEE_VAT, PAGATELIA_FIXED_FEE, PAGATELIA_FIXED_FEE_VAT, PAGATELIA_TOTAL_AMOUNT,
								   COUPONS_AMOUNT, COUPONS_VAT, COUPONS_PERC_FEE, COUPONS_PERC_FEE_VAT, COUPONS_FIXED_FEE, COUPONS_FIXED_FEE_VAT, COUPONS_TOTAL_AMOUNT, COUPONREFUNDS_TOTAL_AMOUNT, 
								   SERVICES_AMOUNT, SERVICES_VAT, SERVICES_PERC_FEE, SERVICES_PERC_FEE_VAT, SERVICES_FIXED_FEE, SERVICES_FIXED_FEE_VAT, SERVICES_TOTAL_AMOUNT, 
								   RECHARGES_REGULAR_AMOUNT, RECHARGES_REGULAR_VAT, RECHARGES_REGULAR_PERC_FEE, RECHARGES_REGULAR_PERC_FEE_VAT, RECHARGES_REGULAR_FIXED_FEE, RECHARGES_REGULAR_FIXED_FEE_VAT, RECHARGES_REGULAR_TOTAL_AMOUNT, 
								   RECHARGES_AUTOMATIC_AMOUNT, RECHARGES_AUTOMATIC_VAT, RECHARGES_AUTOMATIC_PERC_FEE, RECHARGES_AUTOMATIC_PERC_FEE_VAT, RECHARGES_AUTOMATIC_FIXED_FEE, RECHARGES_AUTOMATIC_FIXED_FEE_VAT, RECHARGES_AUTOMATIC_TOTAL_AMOUNT, 
								   RECHARGES_USERCREATION_AMOUNT, RECHARGES_USERCREATION_VAT, RECHARGES_USERCREATION_PERC_FEE, RECHARGES_USERCREATION_PERC_FEE_VAT, RECHARGES_USERCREATION_FIXED_FEE, RECHARGES_USERCREATION_FIXED_FEE_VAT, RECHARGES_USERCREATION_TOTAL_AMOUNT, 
								   RECHARGES_CHANGEPM_AMOUNT, RECHARGES_CHANGEPM_VAT, RECHARGES_CHANGEPM_PERC_FEE, RECHARGES_CHANGEPM_PERC_FEE_VAT, RECHARGES_CHANGEPM_FIXED_FEE, RECHARGES_CHANGEPM_FIXED_FEE_VAT, RECHARGES_CHANGEPM_TOTAL_AMOUNT,
								   PARKINGS_TIME, EXTENSIONS_TIME, REFUNDS_TIME)
	SELECT dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN DATEADD(hour, -DATEDIFF(hour, OPE_DATE, OPE_UTC_DATE), STATUS_DATE) 
												  ELSE OPE_DATE END), 0) AS HOUR, 
		   dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_UTC_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN STATUS_DATE
												  ELSE OPE_UTC_DATE END), 0) AS HOUR_UTC,
		   ISNULL(OPE_INS_ID,0), ISNULL(GRP_ID,0), OPE_AMOUNT_CUR_ISO_CODE,
		   count(distinct(CASE OPE_TYPE WHEN 1 THEN ope_id ELSE NULL END)) PARKINGS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 2 THEN ope_id ELSE NULL END)) EXTENSIONS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 3 THEN ope_id ELSE NULL END)) REFUNDS_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN ope_id ELSE NULL END)) TICKETPAYMENTS_COUNT,		   
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE != 2 THEN ope_id ELSE NULL END)) RECHARGES_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN ope_id ELSE NULL END)) PAGATELIA_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS = 7 THEN ope_id ELSE NULL END)) RECHARGEREFUNDS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 12 THEN ope_id ELSE NULL END)) COUPONS_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS = 7 THEN ope_id ELSE NULL END)) COUPONREFUNDS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 6 THEN ope_id ELSE NULL END)) SERVICES_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN ope_id ELSE NULL END)) RECHARGES_REGULAR_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN ope_id ELSE NULL END)) RECHARGES_AUTOMATIC_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN ope_id ELSE NULL END)) RECHARGES_USERCREATION_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN ope_id ELSE NULL END)) RECHARGES_CHANGEPM_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN ope_id ELSE NULL END)) TICKETPAYMENTS_NON_USERS_COUNT,

		   sum(CASE OPE_TYPE WHEN 1 THEN -OPE_AMOUNT ELSE 0 END) PARKINGS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 1 THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) PARKINGS_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PARKINGS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PARKINGS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PARKINGS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PARKINGS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) PARKINGS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 2 THEN -OPE_AMOUNT ELSE 0 END) EXTENSIONS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 2 THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) EXTENSIONS_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) EXTENSIONS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) EXTENSIONS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) EXTENSIONS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) EXTENSIONS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) EXTENSIONS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 3 THEN OPE_AMOUNT ELSE 0 END) REFUNDS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 3 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) REFUNDS_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) REFUNDS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) REFUNDS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) REFUNDS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) REFUNDS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) REFUNDS_TOTAL_AMOUNT,
		   
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -OPE_AMOUNT ELSE 0 END) TICKETPAYMENTS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) TICKETPAYMENTS_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) TICKETPAYMENTS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -OPE_AMOUNT ELSE 0 END) TICKETPAYMENTS_NON_USERS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) TICKETPAYMENTS_NON_USERS_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) TICKETPAYMENTS_NON_USERS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_TOTAL_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS = 7  AND OPE_CUSPMR_TYPE != 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGEREFUNDS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN OPE_AMOUNT ELSE 0 END) PAGATELIA_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) PAGATELIA_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PAGATELIA_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PAGATELIA_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PAGATELIA_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PAGATELIA_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) PAGATELIA_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN OPE_AMOUNT ELSE 0 END) COUPONS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) COUPONS_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) COUPONS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) COUPONS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) COUPONS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) COUPONS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) COUPONS_TOTAL_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS = 7 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) COUPONREFUNDS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 6 THEN OPE_AMOUNT ELSE 0 END) SERVICES_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 6 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) SERVICES_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) SERVICES_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) SERVICES_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) SERVICES_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) SERVICES_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) SERVICES_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_REGULAR_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_REGULAR_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_REGULAR_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_REGULAR_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_REGULAR_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_REGULAR_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_REGULAR_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_AUTOMATIC_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_AUTOMATIC_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_AUTOMATIC_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_AUTOMATIC_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_AUTOMATIC_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_AUTOMATIC_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_REGULAR_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_USERCREATION_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_USERCREATION_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_USERCREATION_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_USERCREATION_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_USERCREATION_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_USERCREATION_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_USERCREATION_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_CHANGEPM_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_CHANGEPM_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_CHANGEPM_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_CHANGEPM_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_CHANGEPM_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_CHANGEPM_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_CHANGEPM_TOTAL_AMOUNT,
		   		   
		   sum(CASE OPE_TYPE WHEN 1 THEN OPE_TIME ELSE 0 END) PARKINGS_TIME,
		   sum(CASE OPE_TYPE WHEN 2 THEN OPE_TIME ELSE 0 END) EXTENSIONS_TIME,
		   sum(CASE OPE_TYPE WHEN 3 THEN OPE_TIME ELSE 0 END) REFUNDS_TIME
	   
	FROM ALL_OPERATIONS_EXT_DB
	WHERE OPE_TYPE IN (1,2,3,4,5,12,6) AND 
		  CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_UTC_INIDATE 
			   WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN STATUS_DATE
			   ELSE OPE_UTC_DATE END >= @FromHour
	GROUP BY dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN DATEADD(hour, -DATEDIFF(hour, OPE_DATE, OPE_UTC_DATE), STATUS_DATE) 
												  ELSE OPE_DATE END), 0),
			 dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_UTC_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN STATUS_DATE
												  ELSE OPE_UTC_DATE END), 0),												   
			 OPE_INS_ID, GRP_ID, OPE_AMOUNT_CUR_ISO_CODE
	
	INSERT INTO DB_OPERATIONS_HOUR_DIST(OHD_DBOH_ID, OHD_FDO_ID, 
									    OHD_PARKINGS_AMOUNT, OHD_PARKINGS_VAT, OHD_PARKINGS_PERC_FEE, OHD_PARKINGS_PERC_FEE_VAT, OHD_PARKINGS_FIXED_FEE, OHD_PARKINGS_FIXED_FEE_VAT, OHD_PARKINGS_TOTAL_AMOUNT, 
										OHD_EXTENSIONS_AMOUNT, OHD_EXTENSIONS_VAT, OHD_EXTENSIONS_PERC_FEE, OHD_EXTENSIONS_PERC_FEE_VAT, OHD_EXTENSIONS_FIXED_FEE, OHD_EXTENSIONS_FIXED_FEE_VAT, OHD_EXTENSIONS_TOTAL_AMOUNT, 
										OHD_REFUNDS_AMOUNT, OHD_REFUNDS_VAT, OHD_REFUNDS_PERC_FEE, OHD_REFUNDS_PERC_FEE_VAT, OHD_REFUNDS_FIXED_FEE, OHD_REFUNDS_FIXED_FEE_VAT, OHD_REFUNDS_TOTAL_AMOUNT, 
										OHD_TICKETPAYMENTS_AMOUNT, OHD_TICKETPAYMENTS_VAT, OHD_TICKETPAYMENTS_PERC_FEE, OHD_TICKETPAYMENTS_PERC_FEE_VAT, OHD_TICKETPAYMENTS_FIXED_FEE, OHD_TICKETPAYMENTS_FIXED_FEE_VAT, OHD_TICKETPAYMENTS_TOTAL_AMOUNT, 										
										OHD_RECHARGES_AMOUNT, OHD_RECHARGES_VAT, OHD_RECHARGES_PERC_FEE, OHD_RECHARGES_PERC_FEE_VAT, OHD_RECHARGES_FIXED_FEE, OHD_RECHARGES_FIXED_FEE_VAT, OHD_RECHARGES_TOTAL_AMOUNT,
										OHD_COUPONS_AMOUNT, OHD_COUPONS_VAT, OHD_COUPONS_PERC_FEE, OHD_COUPONS_PERC_FEE_VAT, OHD_COUPONS_FIXED_FEE, OHD_COUPONS_FIXED_FEE_VAT, OHD_COUPONS_TOTAL_AMOUNT,
										OHD_SERVICES_AMOUNT, OHD_SERVICES_VAT, OHD_SERVICES_PERC_FEE, OHD_SERVICES_PERC_FEE_VAT, OHD_SERVICES_FIXED_FEE, OHD_SERVICES_FIXED_FEE_VAT, OHD_SERVICES_TOTAL_AMOUNT)
	SELECT DB_OPERATIONS_HOUR.DBOH_ID, FINAN_DIST_OPERATORS.FDO_ID,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_AMOUNT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_AMOUNT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, ---dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_AMOUNT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  0, ---dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_AMOUNT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_AMOUNT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_AMOUNT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_VAT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_AMOUNT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_PERC_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_PERC_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_AMOUNT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_PERC_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_PERC_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0

	FROM DB_OPERATIONS_HOUR 
		 /*LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D1
				    WHERE D1.FDOIP_OPE_TYPE = 1 AND
						  D1.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D1.FDOIP_END_APPLY_DATE >= @FromHour) DIST_PARKINGS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_PARKINGS.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_PARKINGS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D2
				    WHERE D2.FDOIP_OPE_TYPE = 2 AND
						  D2.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D2.FDOIP_END_APPLY_DATE >= @FromHour) DIST_EXTENSIONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_EXTENSIONS.FDOIP_INS_ID) AND
																					  DB_OPERATIONS_HOUR.GRP_ID = (DIST_EXTENSIONS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D3
				    WHERE D3.FDOIP_OPE_TYPE = 3 AND
						  D3.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D3.FDOIP_END_APPLY_DATE >= @FromHour) DIST_REFUNDS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_REFUNDS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_REFUNDS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D4
				    WHERE D4.FDOIP_OPE_TYPE = 4 AND
						  D4.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D4.FDOIP_END_APPLY_DATE >= @FromHour) DIST_TICKETPAYMENTS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_TICKETPAYMENTS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_TICKETPAYMENTS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D5
				    WHERE D5.FDOIP_OPE_TYPE = 5 AND
						  D5.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D5.FDOIP_END_APPLY_DATE >= @FromHour) DIST_RECHARGES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_RECHARGES.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_RECHARGES.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D12
				    WHERE D12.FDOIP_OPE_TYPE = 12 AND
						  D12.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D12.FDOIP_END_APPLY_DATE >= @FromHour) DIST_COUPONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_COUPONS.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_COUPONS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D6
				    WHERE D6.FDOIP_OPE_TYPE = 6 AND
						  D6.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D6.FDOIP_END_APPLY_DATE >= @FromHour) DIST_SERVICES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_SERVICES.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_SERVICES.FDOIP_GRP_ID)*/,

		 FINAN_DIST_OPERATORS

	WHERE HOUR_UTC >= @FromHour /*AND
		  (DIST_PARKINGS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_PARKINGS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_EXTENSIONS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_EXTENSIONS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_REFUNDS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_REFUNDS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_TICKETPAYMENTS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_TICKETPAYMENTS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_RECHARGES.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_RECHARGES.FDOIP_FDO_ID IS NULL) AND
		  (DIST_COUPONS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_COUPONS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_SERVICES.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_SERVICES.FDOIP_FDO_ID IS NULL)*/ 
		  
	
	GROUP BY DB_OPERATIONS_HOUR.DBOH_ID, FINAN_DIST_OPERATORS.FDO_ID
	
	/* PARKINGS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET

		  OHD_PARKINGS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_AMOUNT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_PARKINGS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_PARKINGS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_PARKINGS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_PARKINGS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_PARKINGS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_PARKINGS_TOTAL_AMOUNT = 0

	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D1
				    WHERE D1.FDOIP_OPE_TYPE = 1 AND
						  D1.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D1.FDOIP_END_APPLY_DATE >= @FromHour) DIST_PARKINGS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_PARKINGS.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_PARKINGS.FDOIP_GRP_ID) AND
																					 DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_PARKINGS.FDOIP_FDO_ID

	WHERE HOUR_UTC >= @FromHour 
		  		  	
	/* EXTENSIONS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_EXTENSIONS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_AMOUNT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_EXTENSIONS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_EXTENSIONS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_EXTENSIONS_PERC_FEE_VAT= dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_EXTENSIONS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_EXTENSIONS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_EXTENSIONS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D2
				    WHERE D2.FDOIP_OPE_TYPE = 2 AND
						  D2.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D2.FDOIP_END_APPLY_DATE >= @FromHour) DIST_EXTENSIONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_EXTENSIONS.FDOIP_INS_ID) AND
																					  DB_OPERATIONS_HOUR.GRP_ID = (DIST_EXTENSIONS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_EXTENSIONS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour 

	/* REFUNDS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_REFUNDS_AMOUNT = -dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_AMOUNT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_REFUNDS_VAT = -dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_REFUNDS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_REFUNDS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_REFUNDS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_REFUNDS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_REFUNDS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D3
				    WHERE D3.FDOIP_OPE_TYPE = 3 AND
						  D3.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D3.FDOIP_END_APPLY_DATE >= @FromHour) DIST_REFUNDS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_REFUNDS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_REFUNDS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_REFUNDS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* TICKETPAYMENTS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_TICKETPAYMENTS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_AMOUNT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_TICKETPAYMENTS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_TICKETPAYMENTS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_TICKETPAYMENTS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_TICKETPAYMENTS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_TICKETPAYMENTS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_TICKETPAYMENTS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D4
				    WHERE D4.FDOIP_OPE_TYPE = 4 AND
						  D4.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D4.FDOIP_END_APPLY_DATE >= @FromHour) DIST_TICKETPAYMENTS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_TICKETPAYMENTS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_TICKETPAYMENTS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_TICKETPAYMENTS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* RECHARGES */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_RECHARGES_AMOUNT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_AMOUNT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_AMOUNT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_RECHARGES_VAT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_VAT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_RECHARGES_PERC_FEE = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_RECHARGES_PERC_FEE_VAT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_RECHARGES_FIXED_FEE = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_RECHARGES_FIXED_FEE_VAT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_RECHARGES_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D5
				    WHERE D5.FDOIP_OPE_TYPE = 5 AND
						  D5.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D5.FDOIP_END_APPLY_DATE >= @FromHour) DIST_RECHARGES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_RECHARGES.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_RECHARGES.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_RECHARGES.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* COUPONS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_COUPONS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_AMOUNT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_COUPONS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_COUPONS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_PERC_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_COUPONS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_PERC_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_COUPONS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_COUPONS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_COUPONS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D12
				    WHERE D12.FDOIP_OPE_TYPE = 12 AND
						  D12.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D12.FDOIP_END_APPLY_DATE >= @FromHour) DIST_COUPONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_COUPONS.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_COUPONS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_COUPONS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* SERVICES */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_SERVICES_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_AMOUNT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_SERVICES_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_SERVICES_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_PERC_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_SERVICES_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_PERC_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_SERVICES_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_SERVICES_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_SERVICES_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D6
				    WHERE D6.FDOIP_OPE_TYPE = 6 AND
						  D6.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D6.FDOIP_END_APPLY_DATE >= @FromHour) DIST_SERVICES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_SERVICES.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_SERVICES.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_SERVICES.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

END




GO


ALTER PROCEDURE [dbo].[Update_DB_OPERATIONS_HOUR_HIS]
	@FromHour AS Datetime
AS	
BEGIN

	IF (@FromHour IS NULL)
	BEGIN
		SET @FromHour = (SELECT MAX([HOUR_UTC])
		FROM DB_OPERATIONS_HOUR
		WHERE [HOUR_UTC] < GETUTCDATE())

		IF (@FromHour IS NOT NULL)
		BEGIN
			SET @FromHour = DATEADD(HOUR, -1, @FromHour)
		END		
	END
	
	IF (@FromHour IS NULL)
	BEGIN
		SET @FromHour = (SELECT MIN(OPE_UTC_DATE)
		FROM ALL_OPERATIONS_EXT
		WHERE OPE_TYPE IN (1,2,3,4, 5))
	END	

	DELETE FROM DB_OPERATIONS_HOUR_DIST
	WHERE OHD_DBOH_ID IN (SELECT DBOH_ID
						  FROM DB_OPERATIONS_HOUR
						  WHERE CASE WHEN [HOUR_UTC] IS NULL THEN [HOUR] ELSE [HOUR_UTC] END >= @FromHour)
						  
	DELETE FROM DB_OPERATIONS_HOUR
	WHERE CASE WHEN [HOUR_UTC] IS NULL THEN [HOUR] ELSE [HOUR_UTC] END >= @FromHour
	

	INSERT INTO DB_OPERATIONS_HOUR([HOUR], HOUR_UTC, OPE_INS_ID, GRP_ID, OPE_AMOUNT_CUR_ISO_CODE, PARKINGS_COUNT, EXTENSIONS_COUNT, REFUNDS_COUNT, TICKETPAYMENTS_COUNT, RECHARGES_COUNT, PAGATELIA_COUNT, RECHARGEREFUNDS_COUNT, COUPONS_COUNT, COUPONREFUNDS_COUNT, SERVICES_COUNT, RECHARGES_REGULAR_COUNT, RECHARGES_AUTOMATIC_COUNT, RECHARGES_USERCREATION_COUNT, RECHARGES_CHANGEPM_COUNT, TICKETPAYMENTS_NON_USERS_COUNT,
								   PARKINGS_AMOUNT, PARKINGS_VAT, PARKINGS_PERC_FEE, PARKINGS_PERC_FEE_VAT, PARKINGS_FIXED_FEE, PARKINGS_FIXED_FEE_VAT, PARKINGS_TOTAL_AMOUNT, 
								   EXTENSIONS_AMOUNT, EXTENSIONS_VAT, EXTENSIONS_PERC_FEE, EXTENSIONS_PERC_FEE_VAT, EXTENSIONS_FIXED_FEE, EXTENSIONS_FIXED_FEE_VAT, EXTENSIONS_TOTAL_AMOUNT, 
								   REFUNDS_AMOUNT, REFUNDS_VAT, REFUNDS_PERC_FEE, REFUNDS_PERC_FEE_VAT, REFUNDS_FIXED_FEE, REFUNDS_FIXED_FEE_VAT, REFUNDS_TOTAL_AMOUNT, 
								   TICKETPAYMENTS_AMOUNT, TICKETPAYMENTS_VAT, TICKETPAYMENTS_PERC_FEE, TICKETPAYMENTS_PERC_FEE_VAT, TICKETPAYMENTS_FIXED_FEE, TICKETPAYMENTS_FIXED_FEE_VAT, TICKETPAYMENTS_TOTAL_AMOUNT, 
								   TICKETPAYMENTS_NON_USERS_AMOUNT, TICKETPAYMENTS_NON_USERS_VAT, TICKETPAYMENTS_NON_USERS_PERC_FEE, TICKETPAYMENTS_NON_USERS_PERC_FEE_VAT, TICKETPAYMENTS_NON_USERS_FIXED_FEE, TICKETPAYMENTS_NON_USERS_FIXED_FEE_VAT, TICKETPAYMENTS_NON_USERS_TOTAL_AMOUNT, 
								   RECHARGES_AMOUNT, RECHARGES_VAT, RECHARGES_PERC_FEE, RECHARGES_PERC_FEE_VAT, RECHARGES_FIXED_FEE, RECHARGES_FIXED_FEE_VAT, RECHARGES_TOTAL_AMOUNT, RECHARGEREFUNDS_TOTAL_AMOUNT,
								   PAGATELIA_AMOUNT, PAGATELIA_VAT, PAGATELIA_PERC_FEE, PAGATELIA_PERC_FEE_VAT, PAGATELIA_FIXED_FEE, PAGATELIA_FIXED_FEE_VAT, PAGATELIA_TOTAL_AMOUNT,
								   COUPONS_AMOUNT, COUPONS_VAT, COUPONS_PERC_FEE, COUPONS_PERC_FEE_VAT, COUPONS_FIXED_FEE, COUPONS_FIXED_FEE_VAT, COUPONS_TOTAL_AMOUNT, COUPONREFUNDS_TOTAL_AMOUNT, 
								   SERVICES_AMOUNT, SERVICES_VAT, SERVICES_PERC_FEE, SERVICES_PERC_FEE_VAT, SERVICES_FIXED_FEE, SERVICES_FIXED_FEE_VAT, SERVICES_TOTAL_AMOUNT, 
								   RECHARGES_REGULAR_AMOUNT, RECHARGES_REGULAR_VAT, RECHARGES_REGULAR_PERC_FEE, RECHARGES_REGULAR_PERC_FEE_VAT, RECHARGES_REGULAR_FIXED_FEE, RECHARGES_REGULAR_FIXED_FEE_VAT, RECHARGES_REGULAR_TOTAL_AMOUNT, 
								   RECHARGES_AUTOMATIC_AMOUNT, RECHARGES_AUTOMATIC_VAT, RECHARGES_AUTOMATIC_PERC_FEE, RECHARGES_AUTOMATIC_PERC_FEE_VAT, RECHARGES_AUTOMATIC_FIXED_FEE, RECHARGES_AUTOMATIC_FIXED_FEE_VAT, RECHARGES_AUTOMATIC_TOTAL_AMOUNT, 
								   RECHARGES_USERCREATION_AMOUNT, RECHARGES_USERCREATION_VAT, RECHARGES_USERCREATION_PERC_FEE, RECHARGES_USERCREATION_PERC_FEE_VAT, RECHARGES_USERCREATION_FIXED_FEE, RECHARGES_USERCREATION_FIXED_FEE_VAT, RECHARGES_USERCREATION_TOTAL_AMOUNT, 
								   RECHARGES_CHANGEPM_AMOUNT, RECHARGES_CHANGEPM_VAT, RECHARGES_CHANGEPM_PERC_FEE, RECHARGES_CHANGEPM_PERC_FEE_VAT, RECHARGES_CHANGEPM_FIXED_FEE, RECHARGES_CHANGEPM_FIXED_FEE_VAT, RECHARGES_CHANGEPM_TOTAL_AMOUNT,
								   PARKINGS_TIME, EXTENSIONS_TIME, REFUNDS_TIME)
	SELECT dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN DATEADD(hour, -DATEDIFF(hour, OPE_DATE, OPE_UTC_DATE), STATUS_DATE) 
												  ELSE OPE_DATE END), 0) AS HOUR, 
		   dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_UTC_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN STATUS_DATE
												  ELSE OPE_UTC_DATE END), 0) AS HOUR_UTC,
		   ISNULL(OPE_INS_ID,0), ISNULL(GRP_ID,0), OPE_AMOUNT_CUR_ISO_CODE,
		   count(distinct(CASE OPE_TYPE WHEN 1 THEN ope_id ELSE NULL END)) PARKINGS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 2 THEN ope_id ELSE NULL END)) EXTENSIONS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 3 THEN ope_id ELSE NULL END)) REFUNDS_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN ope_id ELSE NULL END)) TICKETPAYMENTS_COUNT,		   
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE != 2 THEN ope_id ELSE NULL END)) RECHARGES_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN ope_id ELSE NULL END)) PAGATELIA_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS = 7 THEN ope_id ELSE NULL END)) RECHARGEREFUNDS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 12 THEN ope_id ELSE NULL END)) COUPONS_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS = 7 THEN ope_id ELSE NULL END)) COUPONREFUNDS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 6 THEN ope_id ELSE NULL END)) SERVICES_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN ope_id ELSE NULL END)) RECHARGES_REGULAR_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN ope_id ELSE NULL END)) RECHARGES_AUTOMATIC_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN ope_id ELSE NULL END)) RECHARGES_USERCREATION_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN ope_id ELSE NULL END)) RECHARGES_CHANGEPM_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN ope_id ELSE NULL END)) TICKETPAYMENTS_NON_USERS_COUNT,

		   sum(CASE OPE_TYPE WHEN 1 THEN -OPE_AMOUNT ELSE 0 END) PARKINGS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 1 THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) PARKINGS_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PARKINGS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PARKINGS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PARKINGS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PARKINGS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) PARKINGS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 2 THEN -OPE_AMOUNT ELSE 0 END) EXTENSIONS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 2 THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) EXTENSIONS_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) EXTENSIONS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) EXTENSIONS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) EXTENSIONS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) EXTENSIONS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) EXTENSIONS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 3 THEN OPE_AMOUNT ELSE 0 END) REFUNDS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 3 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) REFUNDS_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) REFUNDS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) REFUNDS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) REFUNDS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) REFUNDS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) REFUNDS_TOTAL_AMOUNT,
		   
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -OPE_AMOUNT ELSE 0 END) TICKETPAYMENTS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) TICKETPAYMENTS_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) TICKETPAYMENTS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -OPE_AMOUNT ELSE 0 END) TICKETPAYMENTS_NON_USERS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) TICKETPAYMENTS_NON_USERS_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) TICKETPAYMENTS_NON_USERS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_TOTAL_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS = 7  AND OPE_CUSPMR_TYPE != 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGEREFUNDS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN OPE_AMOUNT ELSE 0 END) PAGATELIA_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) PAGATELIA_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PAGATELIA_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PAGATELIA_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PAGATELIA_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PAGATELIA_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) PAGATELIA_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN OPE_AMOUNT ELSE 0 END) COUPONS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) COUPONS_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) COUPONS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) COUPONS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) COUPONS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) COUPONS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) COUPONS_TOTAL_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS = 7 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) COUPONREFUNDS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 6 THEN OPE_AMOUNT ELSE 0 END) SERVICES_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 6 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) SERVICES_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) SERVICES_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) SERVICES_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) SERVICES_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) SERVICES_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) SERVICES_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_REGULAR_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_REGULAR_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_REGULAR_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_REGULAR_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_REGULAR_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_REGULAR_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_REGULAR_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_AUTOMATIC_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_AUTOMATIC_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_AUTOMATIC_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_AUTOMATIC_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_AUTOMATIC_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_AUTOMATIC_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_REGULAR_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_USERCREATION_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_USERCREATION_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_USERCREATION_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_USERCREATION_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_USERCREATION_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_USERCREATION_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_USERCREATION_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_CHANGEPM_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_CHANGEPM_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_CHANGEPM_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_CHANGEPM_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_CHANGEPM_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_CHANGEPM_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_CHANGEPM_TOTAL_AMOUNT,
		   		   
		   sum(CASE OPE_TYPE WHEN 1 THEN OPE_TIME ELSE 0 END) PARKINGS_TIME,
		   sum(CASE OPE_TYPE WHEN 2 THEN OPE_TIME ELSE 0 END) EXTENSIONS_TIME,
		   sum(CASE OPE_TYPE WHEN 3 THEN OPE_TIME ELSE 0 END) REFUNDS_TIME
	   
	FROM ALL_OPERATIONS_EXT_DB_HIS
	WHERE OPE_TYPE IN (1,2,3,4,5,12,6) AND 
		  CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_UTC_INIDATE 
			   WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN STATUS_DATE
			   ELSE OPE_UTC_DATE END >= @FromHour
	GROUP BY dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN DATEADD(hour, -DATEDIFF(hour, OPE_DATE, OPE_UTC_DATE), STATUS_DATE) 
												  ELSE OPE_DATE END), 0),
			 dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_UTC_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN STATUS_DATE
												  ELSE OPE_UTC_DATE END), 0),												   
			 OPE_INS_ID, GRP_ID, OPE_AMOUNT_CUR_ISO_CODE
	
	INSERT INTO DB_OPERATIONS_HOUR_DIST(OHD_DBOH_ID, OHD_FDO_ID, 
									    OHD_PARKINGS_AMOUNT, OHD_PARKINGS_VAT, OHD_PARKINGS_PERC_FEE, OHD_PARKINGS_PERC_FEE_VAT, OHD_PARKINGS_FIXED_FEE, OHD_PARKINGS_FIXED_FEE_VAT, OHD_PARKINGS_TOTAL_AMOUNT, 
										OHD_EXTENSIONS_AMOUNT, OHD_EXTENSIONS_VAT, OHD_EXTENSIONS_PERC_FEE, OHD_EXTENSIONS_PERC_FEE_VAT, OHD_EXTENSIONS_FIXED_FEE, OHD_EXTENSIONS_FIXED_FEE_VAT, OHD_EXTENSIONS_TOTAL_AMOUNT, 
										OHD_REFUNDS_AMOUNT, OHD_REFUNDS_VAT, OHD_REFUNDS_PERC_FEE, OHD_REFUNDS_PERC_FEE_VAT, OHD_REFUNDS_FIXED_FEE, OHD_REFUNDS_FIXED_FEE_VAT, OHD_REFUNDS_TOTAL_AMOUNT, 
										OHD_TICKETPAYMENTS_AMOUNT, OHD_TICKETPAYMENTS_VAT, OHD_TICKETPAYMENTS_PERC_FEE, OHD_TICKETPAYMENTS_PERC_FEE_VAT, OHD_TICKETPAYMENTS_FIXED_FEE, OHD_TICKETPAYMENTS_FIXED_FEE_VAT, OHD_TICKETPAYMENTS_TOTAL_AMOUNT, 
										OHD_RECHARGES_AMOUNT, OHD_RECHARGES_VAT, OHD_RECHARGES_PERC_FEE, OHD_RECHARGES_PERC_FEE_VAT, OHD_RECHARGES_FIXED_FEE, OHD_RECHARGES_FIXED_FEE_VAT, OHD_RECHARGES_TOTAL_AMOUNT,
										OHD_COUPONS_AMOUNT, OHD_COUPONS_VAT, OHD_COUPONS_PERC_FEE, OHD_COUPONS_PERC_FEE_VAT, OHD_COUPONS_FIXED_FEE, OHD_COUPONS_FIXED_FEE_VAT, OHD_COUPONS_TOTAL_AMOUNT,
										OHD_SERVICES_AMOUNT, OHD_SERVICES_VAT, OHD_SERVICES_PERC_FEE, OHD_SERVICES_PERC_FEE_VAT, OHD_SERVICES_FIXED_FEE, OHD_SERVICES_FIXED_FEE_VAT, OHD_SERVICES_TOTAL_AMOUNT)
	SELECT DB_OPERATIONS_HOUR.DBOH_ID, FINAN_DIST_OPERATORS.FDO_ID,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_AMOUNT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_AMOUNT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, ---dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_AMOUNT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  0, ---dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_AMOUNT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_AMOUNT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_AMOUNT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_VAT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_AMOUNT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_PERC_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_PERC_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_AMOUNT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_PERC_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_PERC_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0

	FROM DB_OPERATIONS_HOUR 
		 /*LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D1
				    WHERE D1.FDOIP_OPE_TYPE = 1 AND
						  D1.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D1.FDOIP_END_APPLY_DATE >= @FromHour) DIST_PARKINGS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_PARKINGS.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_PARKINGS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D2
				    WHERE D2.FDOIP_OPE_TYPE = 2 AND
						  D2.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D2.FDOIP_END_APPLY_DATE >= @FromHour) DIST_EXTENSIONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_EXTENSIONS.FDOIP_INS_ID) AND
																					  DB_OPERATIONS_HOUR.GRP_ID = (DIST_EXTENSIONS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D3
				    WHERE D3.FDOIP_OPE_TYPE = 3 AND
						  D3.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D3.FDOIP_END_APPLY_DATE >= @FromHour) DIST_REFUNDS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_REFUNDS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_REFUNDS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D4
				    WHERE D4.FDOIP_OPE_TYPE = 4 AND
						  D4.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D4.FDOIP_END_APPLY_DATE >= @FromHour) DIST_TICKETPAYMENTS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_TICKETPAYMENTS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_TICKETPAYMENTS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D5
				    WHERE D5.FDOIP_OPE_TYPE = 5 AND
						  D5.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D5.FDOIP_END_APPLY_DATE >= @FromHour) DIST_RECHARGES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_RECHARGES.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_RECHARGES.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D12
				    WHERE D12.FDOIP_OPE_TYPE = 12 AND
						  D12.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D12.FDOIP_END_APPLY_DATE >= @FromHour) DIST_COUPONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_COUPONS.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_COUPONS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D6
				    WHERE D6.FDOIP_OPE_TYPE = 6 AND
						  D6.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D6.FDOIP_END_APPLY_DATE >= @FromHour) DIST_SERVICES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_SERVICES.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_SERVICES.FDOIP_GRP_ID)*/,

		 FINAN_DIST_OPERATORS

	WHERE HOUR_UTC >= @FromHour /*AND
		  (DIST_PARKINGS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_PARKINGS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_EXTENSIONS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_EXTENSIONS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_REFUNDS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_REFUNDS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_TICKETPAYMENTS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_TICKETPAYMENTS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_RECHARGES.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_RECHARGES.FDOIP_FDO_ID IS NULL) AND
		  (DIST_COUPONS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_COUPONS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_SERVICES.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_SERVICES.FDOIP_FDO_ID IS NULL)*/ 
		  
	
	GROUP BY DB_OPERATIONS_HOUR.DBOH_ID, FINAN_DIST_OPERATORS.FDO_ID
	
	/* PARKINGS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET

		  OHD_PARKINGS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_AMOUNT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_PARKINGS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_PARKINGS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_PARKINGS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_PARKINGS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_PARKINGS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_PARKINGS_TOTAL_AMOUNT = 0

	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D1
				    WHERE D1.FDOIP_OPE_TYPE = 1 AND
						  D1.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D1.FDOIP_END_APPLY_DATE >= @FromHour) DIST_PARKINGS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_PARKINGS.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_PARKINGS.FDOIP_GRP_ID) AND
																					 DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_PARKINGS.FDOIP_FDO_ID

	WHERE HOUR_UTC >= @FromHour 
		  		  	
	/* EXTENSIONS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_EXTENSIONS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_AMOUNT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_EXTENSIONS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_EXTENSIONS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_EXTENSIONS_PERC_FEE_VAT= dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_EXTENSIONS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_EXTENSIONS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_EXTENSIONS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D2
				    WHERE D2.FDOIP_OPE_TYPE = 2 AND
						  D2.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D2.FDOIP_END_APPLY_DATE >= @FromHour) DIST_EXTENSIONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_EXTENSIONS.FDOIP_INS_ID) AND
																					  DB_OPERATIONS_HOUR.GRP_ID = (DIST_EXTENSIONS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_EXTENSIONS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour 

	/* REFUNDS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_REFUNDS_AMOUNT = -dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_AMOUNT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_REFUNDS_VAT = -dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_REFUNDS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_REFUNDS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_REFUNDS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_REFUNDS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_REFUNDS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D3
				    WHERE D3.FDOIP_OPE_TYPE = 3 AND
						  D3.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D3.FDOIP_END_APPLY_DATE >= @FromHour) DIST_REFUNDS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_REFUNDS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_REFUNDS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_REFUNDS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* TICKETPAYMENTS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_TICKETPAYMENTS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_AMOUNT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_TICKETPAYMENTS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_TICKETPAYMENTS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_TICKETPAYMENTS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_TICKETPAYMENTS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_TICKETPAYMENTS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_TICKETPAYMENTS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D4
				    WHERE D4.FDOIP_OPE_TYPE = 4 AND
						  D4.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D4.FDOIP_END_APPLY_DATE >= @FromHour) DIST_TICKETPAYMENTS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_TICKETPAYMENTS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_TICKETPAYMENTS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_TICKETPAYMENTS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* RECHARGES */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_RECHARGES_AMOUNT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_AMOUNT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_AMOUNT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_RECHARGES_VAT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_VAT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_RECHARGES_PERC_FEE = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_RECHARGES_PERC_FEE_VAT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_RECHARGES_FIXED_FEE = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_RECHARGES_FIXED_FEE_VAT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_RECHARGES_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D5
				    WHERE D5.FDOIP_OPE_TYPE = 5 AND
						  D5.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D5.FDOIP_END_APPLY_DATE >= @FromHour) DIST_RECHARGES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_RECHARGES.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_RECHARGES.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_RECHARGES.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* COUPONS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_COUPONS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_AMOUNT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_COUPONS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_COUPONS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_PERC_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_COUPONS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_PERC_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_COUPONS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_COUPONS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_COUPONS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D12
				    WHERE D12.FDOIP_OPE_TYPE = 12 AND
						  D12.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D12.FDOIP_END_APPLY_DATE >= @FromHour) DIST_COUPONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_COUPONS.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_COUPONS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_COUPONS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* SERVICES */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_SERVICES_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_AMOUNT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_SERVICES_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_SERVICES_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_PERC_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_SERVICES_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_PERC_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_SERVICES_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_SERVICES_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_SERVICES_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D6
				    WHERE D6.FDOIP_OPE_TYPE = 6 AND
						  D6.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D6.FDOIP_END_APPLY_DATE >= @FromHour) DIST_SERVICES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_SERVICES.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_SERVICES.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_SERVICES.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

END




GO


ALTER PROCEDURE [dbo].[Update_DB_OPERATIONS_HOUR_HIS2]
	@FromHour AS Datetime
AS	
BEGIN

	IF (@FromHour IS NULL)
	BEGIN
		SET @FromHour = (SELECT MAX([HOUR_UTC])
		FROM DB_OPERATIONS_HOUR
		WHERE [HOUR_UTC] < GETUTCDATE())

		IF (@FromHour IS NOT NULL)
		BEGIN
			SET @FromHour = DATEADD(HOUR, -1, @FromHour)
		END		
	END
	
	IF (@FromHour IS NULL)
	BEGIN
		SET @FromHour = (SELECT MIN(OPE_UTC_DATE)
		FROM ALL_OPERATIONS_EXT
		WHERE OPE_TYPE IN (1,2,3,4, 5))
	END	

	DELETE FROM DB_OPERATIONS_HOUR_DIST
	WHERE OHD_DBOH_ID IN (SELECT DBOH_ID
						  FROM DB_OPERATIONS_HOUR
						  WHERE CASE WHEN [HOUR_UTC] IS NULL THEN [HOUR] ELSE [HOUR_UTC] END >= @FromHour)
						  
	DELETE FROM DB_OPERATIONS_HOUR
	WHERE CASE WHEN [HOUR_UTC] IS NULL THEN [HOUR] ELSE [HOUR_UTC] END >= @FromHour
	

	INSERT INTO DB_OPERATIONS_HOUR([HOUR], HOUR_UTC, OPE_INS_ID, GRP_ID, OPE_AMOUNT_CUR_ISO_CODE, PARKINGS_COUNT, EXTENSIONS_COUNT, REFUNDS_COUNT, TICKETPAYMENTS_COUNT, RECHARGES_COUNT, PAGATELIA_COUNT, RECHARGEREFUNDS_COUNT, COUPONS_COUNT, COUPONREFUNDS_COUNT, SERVICES_COUNT, RECHARGES_REGULAR_COUNT, RECHARGES_AUTOMATIC_COUNT, RECHARGES_USERCREATION_COUNT, RECHARGES_CHANGEPM_COUNT, TICKETPAYMENTS_NON_USERS_COUNT,
								   PARKINGS_AMOUNT, PARKINGS_VAT, PARKINGS_PERC_FEE, PARKINGS_PERC_FEE_VAT, PARKINGS_FIXED_FEE, PARKINGS_FIXED_FEE_VAT, PARKINGS_TOTAL_AMOUNT, 
								   EXTENSIONS_AMOUNT, EXTENSIONS_VAT, EXTENSIONS_PERC_FEE, EXTENSIONS_PERC_FEE_VAT, EXTENSIONS_FIXED_FEE, EXTENSIONS_FIXED_FEE_VAT, EXTENSIONS_TOTAL_AMOUNT, 
								   REFUNDS_AMOUNT, REFUNDS_VAT, REFUNDS_PERC_FEE, REFUNDS_PERC_FEE_VAT, REFUNDS_FIXED_FEE, REFUNDS_FIXED_FEE_VAT, REFUNDS_TOTAL_AMOUNT, 
								   TICKETPAYMENTS_AMOUNT, TICKETPAYMENTS_VAT, TICKETPAYMENTS_PERC_FEE, TICKETPAYMENTS_PERC_FEE_VAT, TICKETPAYMENTS_FIXED_FEE, TICKETPAYMENTS_FIXED_FEE_VAT, TICKETPAYMENTS_TOTAL_AMOUNT, 
								   TICKETPAYMENTS_NON_USERS_AMOUNT, TICKETPAYMENTS_NON_USERS_VAT, TICKETPAYMENTS_NON_USERS_PERC_FEE, TICKETPAYMENTS_NON_USERS_PERC_FEE_VAT, TICKETPAYMENTS_NON_USERS_FIXED_FEE, TICKETPAYMENTS_NON_USERS_FIXED_FEE_VAT, TICKETPAYMENTS_NON_USERS_TOTAL_AMOUNT, 
								   RECHARGES_AMOUNT, RECHARGES_VAT, RECHARGES_PERC_FEE, RECHARGES_PERC_FEE_VAT, RECHARGES_FIXED_FEE, RECHARGES_FIXED_FEE_VAT, RECHARGES_TOTAL_AMOUNT, RECHARGEREFUNDS_TOTAL_AMOUNT,
								   PAGATELIA_AMOUNT, PAGATELIA_VAT, PAGATELIA_PERC_FEE, PAGATELIA_PERC_FEE_VAT, PAGATELIA_FIXED_FEE, PAGATELIA_FIXED_FEE_VAT, PAGATELIA_TOTAL_AMOUNT,
								   COUPONS_AMOUNT, COUPONS_VAT, COUPONS_PERC_FEE, COUPONS_PERC_FEE_VAT, COUPONS_FIXED_FEE, COUPONS_FIXED_FEE_VAT, COUPONS_TOTAL_AMOUNT, COUPONREFUNDS_TOTAL_AMOUNT, 
								   SERVICES_AMOUNT, SERVICES_VAT, SERVICES_PERC_FEE, SERVICES_PERC_FEE_VAT, SERVICES_FIXED_FEE, SERVICES_FIXED_FEE_VAT, SERVICES_TOTAL_AMOUNT, 
								   RECHARGES_REGULAR_AMOUNT, RECHARGES_REGULAR_VAT, RECHARGES_REGULAR_PERC_FEE, RECHARGES_REGULAR_PERC_FEE_VAT, RECHARGES_REGULAR_FIXED_FEE, RECHARGES_REGULAR_FIXED_FEE_VAT, RECHARGES_REGULAR_TOTAL_AMOUNT, 
								   RECHARGES_AUTOMATIC_AMOUNT, RECHARGES_AUTOMATIC_VAT, RECHARGES_AUTOMATIC_PERC_FEE, RECHARGES_AUTOMATIC_PERC_FEE_VAT, RECHARGES_AUTOMATIC_FIXED_FEE, RECHARGES_AUTOMATIC_FIXED_FEE_VAT, RECHARGES_AUTOMATIC_TOTAL_AMOUNT, 
								   RECHARGES_USERCREATION_AMOUNT, RECHARGES_USERCREATION_VAT, RECHARGES_USERCREATION_PERC_FEE, RECHARGES_USERCREATION_PERC_FEE_VAT, RECHARGES_USERCREATION_FIXED_FEE, RECHARGES_USERCREATION_FIXED_FEE_VAT, RECHARGES_USERCREATION_TOTAL_AMOUNT, 
								   RECHARGES_CHANGEPM_AMOUNT, RECHARGES_CHANGEPM_VAT, RECHARGES_CHANGEPM_PERC_FEE, RECHARGES_CHANGEPM_PERC_FEE_VAT, RECHARGES_CHANGEPM_FIXED_FEE, RECHARGES_CHANGEPM_FIXED_FEE_VAT, RECHARGES_CHANGEPM_TOTAL_AMOUNT,
								   PARKINGS_TIME, EXTENSIONS_TIME, REFUNDS_TIME)
	SELECT dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN DATEADD(hour, -DATEDIFF(hour, OPE_DATE, OPE_UTC_DATE), STATUS_DATE) 
												  ELSE OPE_DATE END), 0) AS HOUR, 
		   dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_UTC_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN STATUS_DATE
												  ELSE OPE_UTC_DATE END), 0) AS HOUR_UTC,
		   ISNULL(OPE_INS_ID,0), ISNULL(GRP_ID,0), OPE_AMOUNT_CUR_ISO_CODE,
		   count(distinct(CASE OPE_TYPE WHEN 1 THEN ope_id ELSE NULL END)) PARKINGS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 2 THEN ope_id ELSE NULL END)) EXTENSIONS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 3 THEN ope_id ELSE NULL END)) REFUNDS_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN ope_id ELSE NULL END)) TICKETPAYMENTS_COUNT,		   
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE != 2 THEN ope_id ELSE NULL END)) RECHARGES_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN ope_id ELSE NULL END)) PAGATELIA_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS = 7 THEN ope_id ELSE NULL END)) RECHARGEREFUNDS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 12 THEN ope_id ELSE NULL END)) COUPONS_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS = 7 THEN ope_id ELSE NULL END)) COUPONREFUNDS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 6 THEN ope_id ELSE NULL END)) SERVICES_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN ope_id ELSE NULL END)) RECHARGES_REGULAR_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN ope_id ELSE NULL END)) RECHARGES_AUTOMATIC_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN ope_id ELSE NULL END)) RECHARGES_USERCREATION_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN ope_id ELSE NULL END)) RECHARGES_CHANGEPM_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN ope_id ELSE NULL END)) TICKETPAYMENTS_NON_USERS_COUNT,

		   sum(CASE OPE_TYPE WHEN 1 THEN -OPE_AMOUNT ELSE 0 END) PARKINGS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 1 THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) PARKINGS_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PARKINGS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PARKINGS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PARKINGS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PARKINGS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) PARKINGS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 2 THEN -OPE_AMOUNT ELSE 0 END) EXTENSIONS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 2 THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) EXTENSIONS_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) EXTENSIONS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) EXTENSIONS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) EXTENSIONS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) EXTENSIONS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) EXTENSIONS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 3 THEN OPE_AMOUNT ELSE 0 END) REFUNDS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 3 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) REFUNDS_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) REFUNDS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) REFUNDS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) REFUNDS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) REFUNDS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) REFUNDS_TOTAL_AMOUNT,
		   
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -OPE_AMOUNT ELSE 0 END) TICKETPAYMENTS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) TICKETPAYMENTS_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) TICKETPAYMENTS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -OPE_AMOUNT ELSE 0 END) TICKETPAYMENTS_NON_USERS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) TICKETPAYMENTS_NON_USERS_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) TICKETPAYMENTS_NON_USERS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_TOTAL_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS = 7  AND OPE_CUSPMR_TYPE != 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGEREFUNDS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN OPE_AMOUNT ELSE 0 END) PAGATELIA_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) PAGATELIA_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PAGATELIA_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PAGATELIA_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PAGATELIA_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PAGATELIA_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) PAGATELIA_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN OPE_AMOUNT ELSE 0 END) COUPONS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) COUPONS_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) COUPONS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) COUPONS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) COUPONS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) COUPONS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) COUPONS_TOTAL_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS = 7 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) COUPONREFUNDS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 6 THEN OPE_AMOUNT ELSE 0 END) SERVICES_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 6 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) SERVICES_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) SERVICES_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) SERVICES_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) SERVICES_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) SERVICES_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) SERVICES_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_REGULAR_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_REGULAR_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_REGULAR_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_REGULAR_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_REGULAR_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_REGULAR_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_REGULAR_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_AUTOMATIC_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_AUTOMATIC_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_AUTOMATIC_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_AUTOMATIC_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_AUTOMATIC_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_AUTOMATIC_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_REGULAR_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_USERCREATION_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_USERCREATION_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_USERCREATION_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_USERCREATION_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_USERCREATION_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_USERCREATION_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_USERCREATION_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_CHANGEPM_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_CHANGEPM_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_CHANGEPM_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_CHANGEPM_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_CHANGEPM_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_CHANGEPM_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_CHANGEPM_TOTAL_AMOUNT,
		   		   
		   sum(CASE OPE_TYPE WHEN 1 THEN OPE_TIME ELSE 0 END) PARKINGS_TIME,
		   sum(CASE OPE_TYPE WHEN 2 THEN OPE_TIME ELSE 0 END) EXTENSIONS_TIME,
		   sum(CASE OPE_TYPE WHEN 3 THEN OPE_TIME ELSE 0 END) REFUNDS_TIME
	   
	FROM ALL_OPERATIONS_EXT_DB_HIS
	WHERE OPE_TYPE IN (1,2,3,4,5,12,6) AND 
		  CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_UTC_INIDATE 
			   WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN STATUS_DATE
			   ELSE OPE_UTC_DATE END >= @FromHour
	GROUP BY dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN DATEADD(hour, -DATEDIFF(hour, OPE_DATE, OPE_UTC_DATE), STATUS_DATE) 
												  ELSE OPE_DATE END), 0),
			 dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_UTC_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN STATUS_DATE
												  ELSE OPE_UTC_DATE END), 0),												   
			 OPE_INS_ID, GRP_ID, OPE_AMOUNT_CUR_ISO_CODE
	
	INSERT INTO DB_OPERATIONS_HOUR_DIST(OHD_DBOH_ID, OHD_FDO_ID, 
									    OHD_PARKINGS_AMOUNT, OHD_PARKINGS_VAT, OHD_PARKINGS_PERC_FEE, OHD_PARKINGS_PERC_FEE_VAT, OHD_PARKINGS_FIXED_FEE, OHD_PARKINGS_FIXED_FEE_VAT, OHD_PARKINGS_TOTAL_AMOUNT, 
										OHD_EXTENSIONS_AMOUNT, OHD_EXTENSIONS_VAT, OHD_EXTENSIONS_PERC_FEE, OHD_EXTENSIONS_PERC_FEE_VAT, OHD_EXTENSIONS_FIXED_FEE, OHD_EXTENSIONS_FIXED_FEE_VAT, OHD_EXTENSIONS_TOTAL_AMOUNT, 
										OHD_REFUNDS_AMOUNT, OHD_REFUNDS_VAT, OHD_REFUNDS_PERC_FEE, OHD_REFUNDS_PERC_FEE_VAT, OHD_REFUNDS_FIXED_FEE, OHD_REFUNDS_FIXED_FEE_VAT, OHD_REFUNDS_TOTAL_AMOUNT, 
										OHD_TICKETPAYMENTS_AMOUNT, OHD_TICKETPAYMENTS_VAT, OHD_TICKETPAYMENTS_PERC_FEE, OHD_TICKETPAYMENTS_PERC_FEE_VAT, OHD_TICKETPAYMENTS_FIXED_FEE, OHD_TICKETPAYMENTS_FIXED_FEE_VAT, OHD_TICKETPAYMENTS_TOTAL_AMOUNT, 
										OHD_RECHARGES_AMOUNT, OHD_RECHARGES_VAT, OHD_RECHARGES_PERC_FEE, OHD_RECHARGES_PERC_FEE_VAT, OHD_RECHARGES_FIXED_FEE, OHD_RECHARGES_FIXED_FEE_VAT, OHD_RECHARGES_TOTAL_AMOUNT,
										OHD_COUPONS_AMOUNT, OHD_COUPONS_VAT, OHD_COUPONS_PERC_FEE, OHD_COUPONS_PERC_FEE_VAT, OHD_COUPONS_FIXED_FEE, OHD_COUPONS_FIXED_FEE_VAT, OHD_COUPONS_TOTAL_AMOUNT,
										OHD_SERVICES_AMOUNT, OHD_SERVICES_VAT, OHD_SERVICES_PERC_FEE, OHD_SERVICES_PERC_FEE_VAT, OHD_SERVICES_FIXED_FEE, OHD_SERVICES_FIXED_FEE_VAT, OHD_SERVICES_TOTAL_AMOUNT)
	SELECT DB_OPERATIONS_HOUR.DBOH_ID, FINAN_DIST_OPERATORS.FDO_ID,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_AMOUNT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_AMOUNT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, ---dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_AMOUNT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  0, ---dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_AMOUNT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_AMOUNT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_AMOUNT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_VAT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_AMOUNT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_PERC_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_PERC_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_AMOUNT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_PERC_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_PERC_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0

	FROM DB_OPERATIONS_HOUR 
		 /*LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D1
				    WHERE D1.FDOIP_OPE_TYPE = 1 AND
						  D1.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D1.FDOIP_END_APPLY_DATE >= @FromHour) DIST_PARKINGS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_PARKINGS.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_PARKINGS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D2
				    WHERE D2.FDOIP_OPE_TYPE = 2 AND
						  D2.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D2.FDOIP_END_APPLY_DATE >= @FromHour) DIST_EXTENSIONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_EXTENSIONS.FDOIP_INS_ID) AND
																					  DB_OPERATIONS_HOUR.GRP_ID = (DIST_EXTENSIONS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D3
				    WHERE D3.FDOIP_OPE_TYPE = 3 AND
						  D3.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D3.FDOIP_END_APPLY_DATE >= @FromHour) DIST_REFUNDS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_REFUNDS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_REFUNDS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D4
				    WHERE D4.FDOIP_OPE_TYPE = 4 AND
						  D4.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D4.FDOIP_END_APPLY_DATE >= @FromHour) DIST_TICKETPAYMENTS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_TICKETPAYMENTS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_TICKETPAYMENTS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D5
				    WHERE D5.FDOIP_OPE_TYPE = 5 AND
						  D5.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D5.FDOIP_END_APPLY_DATE >= @FromHour) DIST_RECHARGES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_RECHARGES.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_RECHARGES.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D12
				    WHERE D12.FDOIP_OPE_TYPE = 12 AND
						  D12.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D12.FDOIP_END_APPLY_DATE >= @FromHour) DIST_COUPONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_COUPONS.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_COUPONS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D6
				    WHERE D6.FDOIP_OPE_TYPE = 6 AND
						  D6.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D6.FDOIP_END_APPLY_DATE >= @FromHour) DIST_SERVICES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_SERVICES.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_SERVICES.FDOIP_GRP_ID)*/,

		 FINAN_DIST_OPERATORS

	WHERE HOUR_UTC >= @FromHour /*AND
		  (DIST_PARKINGS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_PARKINGS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_EXTENSIONS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_EXTENSIONS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_REFUNDS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_REFUNDS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_TICKETPAYMENTS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_TICKETPAYMENTS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_RECHARGES.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_RECHARGES.FDOIP_FDO_ID IS NULL) AND
		  (DIST_COUPONS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_COUPONS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_SERVICES.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_SERVICES.FDOIP_FDO_ID IS NULL)*/ 
		  
	
	GROUP BY DB_OPERATIONS_HOUR.DBOH_ID, FINAN_DIST_OPERATORS.FDO_ID
	
	/* PARKINGS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET

		  OHD_PARKINGS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_AMOUNT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_PARKINGS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_PARKINGS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_PARKINGS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_PARKINGS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_PARKINGS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_PARKINGS_TOTAL_AMOUNT = 0

	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D1
				    WHERE D1.FDOIP_OPE_TYPE = 1 AND
						  D1.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D1.FDOIP_END_APPLY_DATE >= @FromHour) DIST_PARKINGS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_PARKINGS.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_PARKINGS.FDOIP_GRP_ID) AND
																					 DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_PARKINGS.FDOIP_FDO_ID

	WHERE HOUR_UTC >= @FromHour 
		  		  	
	/* EXTENSIONS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_EXTENSIONS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_AMOUNT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_EXTENSIONS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_EXTENSIONS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_EXTENSIONS_PERC_FEE_VAT= dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_EXTENSIONS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_EXTENSIONS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_EXTENSIONS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D2
				    WHERE D2.FDOIP_OPE_TYPE = 2 AND
						  D2.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D2.FDOIP_END_APPLY_DATE >= @FromHour) DIST_EXTENSIONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_EXTENSIONS.FDOIP_INS_ID) AND
																					  DB_OPERATIONS_HOUR.GRP_ID = (DIST_EXTENSIONS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_EXTENSIONS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour 

	/* REFUNDS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_REFUNDS_AMOUNT = -dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_AMOUNT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_REFUNDS_VAT = -dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_REFUNDS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_REFUNDS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_REFUNDS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_REFUNDS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_REFUNDS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D3
				    WHERE D3.FDOIP_OPE_TYPE = 3 AND
						  D3.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D3.FDOIP_END_APPLY_DATE >= @FromHour) DIST_REFUNDS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_REFUNDS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_REFUNDS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_REFUNDS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* TICKETPAYMENTS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_TICKETPAYMENTS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_AMOUNT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_TICKETPAYMENTS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_TICKETPAYMENTS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_TICKETPAYMENTS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_TICKETPAYMENTS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_TICKETPAYMENTS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_TICKETPAYMENTS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D4
				    WHERE D4.FDOIP_OPE_TYPE = 4 AND
						  D4.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D4.FDOIP_END_APPLY_DATE >= @FromHour) DIST_TICKETPAYMENTS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_TICKETPAYMENTS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_TICKETPAYMENTS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_TICKETPAYMENTS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* RECHARGES */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_RECHARGES_AMOUNT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_AMOUNT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_AMOUNT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_RECHARGES_VAT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_VAT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_RECHARGES_PERC_FEE = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_RECHARGES_PERC_FEE_VAT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_RECHARGES_FIXED_FEE = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_RECHARGES_FIXED_FEE_VAT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_RECHARGES_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D5
				    WHERE D5.FDOIP_OPE_TYPE = 5 AND
						  D5.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D5.FDOIP_END_APPLY_DATE >= @FromHour) DIST_RECHARGES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_RECHARGES.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_RECHARGES.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_RECHARGES.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* COUPONS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_COUPONS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_AMOUNT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_COUPONS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_COUPONS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_PERC_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_COUPONS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_PERC_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_COUPONS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_COUPONS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_COUPONS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D12
				    WHERE D12.FDOIP_OPE_TYPE = 12 AND
						  D12.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D12.FDOIP_END_APPLY_DATE >= @FromHour) DIST_COUPONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_COUPONS.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_COUPONS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_COUPONS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* SERVICES */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_SERVICES_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_AMOUNT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_SERVICES_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_SERVICES_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_PERC_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_SERVICES_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_PERC_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_SERVICES_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_SERVICES_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_SERVICES_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D6
				    WHERE D6.FDOIP_OPE_TYPE = 6 AND
						  D6.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D6.FDOIP_END_APPLY_DATE >= @FromHour) DIST_SERVICES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_SERVICES.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_SERVICES.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_SERVICES.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

END





GO


ALTER PROCEDURE [dbo].[Update_DB_OPERATIONS_HOUR2]
	@FromHour AS Datetime,
	@ToHour AS Datetime
AS	
BEGIN

	IF (@FromHour IS NULL)
	BEGIN
		SET @FromHour = (SELECT MAX([HOUR_UTC])
		FROM DB_OPERATIONS_HOUR
		WHERE [HOUR_UTC] < GETUTCDATE())
	END
	
	IF (@FromHour IS NULL)
	BEGIN
		SET @FromHour = (SELECT MIN(OPE_UTC_DATE)
		FROM ALL_OPERATIONS_EXT
		WHERE OPE_TYPE IN (1,2,3,4, 5))
	END	

	DELETE FROM DB_OPERATIONS_HOUR_DIST
	WHERE OHD_DBOH_ID IN (SELECT DBOH_ID
						  FROM DB_OPERATIONS_HOUR
						  WHERE CASE WHEN [HOUR_UTC] IS NULL THEN [HOUR] ELSE [HOUR_UTC] END >= @FromHour AND
								CASE WHEN [HOUR_UTC] IS NULL THEN [HOUR] ELSE [HOUR_UTC] END < @ToHour)
						  
	DELETE FROM DB_OPERATIONS_HOUR
	WHERE CASE WHEN [HOUR_UTC] IS NULL THEN [HOUR] ELSE [HOUR_UTC] END >= @FromHour AND
		  CASE WHEN [HOUR_UTC] IS NULL THEN [HOUR] ELSE [HOUR_UTC] END < @ToHour
	

	INSERT INTO DB_OPERATIONS_HOUR([HOUR], OPE_INS_ID, GRP_ID, OPE_AMOUNT_CUR_ISO_CODE, PARKINGS_COUNT, EXTENSIONS_COUNT, REFUNDS_COUNT, TICKETPAYMENTS_COUNT, RECHARGES_COUNT, RECHARGEREFUNDS_COUNT, COUPONS_COUNT, COUPONREFUNDS_COUNT, SERVICES_COUNT, TICKETPAYMENTS_NON_USERS_COUNT,
								   PARKINGS_AMOUNT, PARKINGS_VAT, PARKINGS_PERC_FEE, PARKINGS_PERC_FEE_VAT, PARKINGS_FIXED_FEE, PARKINGS_FIXED_FEE_VAT, PARKINGS_TOTAL_AMOUNT, 
								   EXTENSIONS_AMOUNT, EXTENSIONS_VAT, EXTENSIONS_PERC_FEE, EXTENSIONS_PERC_FEE_VAT, EXTENSIONS_FIXED_FEE, EXTENSIONS_FIXED_FEE_VAT, EXTENSIONS_TOTAL_AMOUNT, 
								   REFUNDS_AMOUNT, REFUNDS_VAT, REFUNDS_PERC_FEE, REFUNDS_PERC_FEE_VAT, REFUNDS_FIXED_FEE, REFUNDS_FIXED_FEE_VAT, REFUNDS_TOTAL_AMOUNT, 
								   TICKETPAYMENTS_AMOUNT, TICKETPAYMENTS_VAT, TICKETPAYMENTS_PERC_FEE, TICKETPAYMENTS_PERC_FEE_VAT, TICKETPAYMENTS_FIXED_FEE, TICKETPAYMENTS_FIXED_FEE_VAT, TICKETPAYMENTS_TOTAL_AMOUNT, 
								   TICKETPAYMENTS_NON_USERS_AMOUNT, TICKETPAYMENTS_NON_USERS_VAT, TICKETPAYMENTS_NON_USERS_PERC_FEE, TICKETPAYMENTS_NON_USERS_PERC_FEE_VAT, TICKETPAYMENTS_NON_USERS_FIXED_FEE, TICKETPAYMENTS_NON_USERS_FIXED_FEE_VAT, TICKETPAYMENTS_NON_USERS_TOTAL_AMOUNT, 
								   RECHARGES_AMOUNT, RECHARGES_VAT, RECHARGES_PERC_FEE, RECHARGES_PERC_FEE_VAT, RECHARGES_FIXED_FEE, RECHARGES_FIXED_FEE_VAT, RECHARGES_TOTAL_AMOUNT, RECHARGEREFUNDS_TOTAL_AMOUNT,
								   COUPONS_AMOUNT, COUPONS_VAT, COUPONS_PERC_FEE, COUPONS_PERC_FEE_VAT, COUPONS_FIXED_FEE, COUPONS_FIXED_FEE_VAT, COUPONS_TOTAL_AMOUNT, COUPONREFUNDS_TOTAL_AMOUNT, 
								   SERVICES_AMOUNT, SERVICES_VAT, SERVICES_PERC_FEE, SERVICES_PERC_FEE_VAT, SERVICES_FIXED_FEE, SERVICES_FIXED_FEE_VAT, SERVICES_TOTAL_AMOUNT, 
								   PARKINGS_TIME, EXTENSIONS_TIME, REFUNDS_TIME, HOUR_UTC)
	SELECT dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN DATEADD(hour, -DATEDIFF(hour, OPE_DATE, OPE_UTC_DATE), STATUS_DATE) 
												  ELSE OPE_DATE END), 0) AS HOUR, 
		   ISNULL(OPE_INS_ID,0), ISNULL(GRP_ID,0), OPE_AMOUNT_CUR_ISO_CODE,
		   count(distinct(CASE OPE_TYPE WHEN 1 THEN ope_id ELSE NULL END)) PARKINGS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 2 THEN ope_id ELSE NULL END)) EXTENSIONS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 3 THEN ope_id ELSE NULL END)) REFUNDS_COUNT,		   
		   count(distinct(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN ope_id ELSE NULL END)) TICKETPAYMENTS_COUNT,		   
		   count(distinct(CASE OPE_TYPE WHEN 5 THEN ope_id ELSE NULL END)) RECHARGES_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS = 7 THEN ope_id ELSE NULL END)) RECHARGEREFUNDS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 12 THEN ope_id ELSE NULL END)) COUPONS_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS = 7 THEN ope_id ELSE NULL END)) COUPONREFUNDS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 6 THEN ope_id ELSE NULL END)) SERVICES_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN ope_id ELSE NULL END)) TICKETPAYMENTS_NON_USERS_COUNT,

		   sum(CASE OPE_TYPE WHEN 1 THEN -OPE_AMOUNT ELSE 0 END) PARKINGS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 1 THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) PARKINGS_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PARKINGS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PARKINGS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PARKINGS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PARKINGS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) PARKINGS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 2 THEN -OPE_AMOUNT ELSE 0 END) EXTENSIONS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 2 THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) EXTENSIONS_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) EXTENSIONS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) EXTENSIONS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) EXTENSIONS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) EXTENSIONS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) EXTENSIONS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 3 THEN OPE_AMOUNT ELSE 0 END) REFUNDS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 3 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) REFUNDS_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) REFUNDS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) REFUNDS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) REFUNDS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) REFUNDS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) REFUNDS_TOTAL_AMOUNT,
		   
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -OPE_AMOUNT ELSE 0 END) TICKETPAYMENTS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) TICKETPAYMENTS_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) TICKETPAYMENTS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -OPE_AMOUNT ELSE 0 END) TICKETPAYMENTS_NON_USERS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) TICKETPAYMENTS_NON_USERS_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) TICKETPAYMENTS_NON_USERS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_TOTAL_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS = 7 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGEREFUNDS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN OPE_AMOUNT ELSE 0 END) COUPONS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) COUPONS_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) COUPONS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) COUPONS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) COUPONS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) COUPONS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) COUPONS_TOTAL_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS = 7 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) COUPONREFUNDS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 6 THEN OPE_AMOUNT ELSE 0 END) SERVICES_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 6 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) SERVICES_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) SERVICES_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) SERVICES_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) SERVICES_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) SERVICES_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) SERVICES_TOTAL_AMOUNT,
		   		   
		   sum(CASE OPE_TYPE WHEN 1 THEN OPE_TIME ELSE 0 END) PARKINGS_TIME,
		   sum(CASE OPE_TYPE WHEN 2 THEN OPE_TIME ELSE 0 END) EXTENSIONS_TIME,
		   sum(CASE OPE_TYPE WHEN 3 THEN OPE_TIME ELSE 0 END) REFUNDS_TIME,
		   MAX(dateadd(hour, datediff(hour, 0, OPE_UTC_DATE), 0))
	   
	FROM ALL_OPERATIONS_EXT_DB
	WHERE OPE_TYPE IN (1,2,3,4,5,12,6) AND 
		  OPE_UTC_DATE >= @FromHour AND
		  OPE_UTC_DATE < @ToHour
	GROUP BY dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN DATEADD(hour, -DATEDIFF(hour, OPE_DATE, OPE_UTC_DATE), STATUS_DATE) 
												  ELSE OPE_DATE END), 0), 
			 OPE_INS_ID, GRP_ID, OPE_AMOUNT_CUR_ISO_CODE
	
	INSERT INTO DB_OPERATIONS_HOUR_DIST(OHD_DBOH_ID, OHD_FDO_ID, 
									    OHD_PARKINGS_AMOUNT, OHD_PARKINGS_VAT, OHD_PARKINGS_PERC_FEE, OHD_PARKINGS_PERC_FEE_VAT, OHD_PARKINGS_FIXED_FEE, OHD_PARKINGS_FIXED_FEE_VAT, OHD_PARKINGS_TOTAL_AMOUNT, 
										OHD_EXTENSIONS_AMOUNT, OHD_EXTENSIONS_VAT, OHD_EXTENSIONS_PERC_FEE, OHD_EXTENSIONS_PERC_FEE_VAT, OHD_EXTENSIONS_FIXED_FEE, OHD_EXTENSIONS_FIXED_FEE_VAT, OHD_EXTENSIONS_TOTAL_AMOUNT, 
										OHD_REFUNDS_AMOUNT, OHD_REFUNDS_VAT, OHD_REFUNDS_PERC_FEE, OHD_REFUNDS_PERC_FEE_VAT, OHD_REFUNDS_FIXED_FEE, OHD_REFUNDS_FIXED_FEE_VAT, OHD_REFUNDS_TOTAL_AMOUNT, 
										OHD_TICKETPAYMENTS_AMOUNT, OHD_TICKETPAYMENTS_VAT, OHD_TICKETPAYMENTS_PERC_FEE, OHD_TICKETPAYMENTS_PERC_FEE_VAT, OHD_TICKETPAYMENTS_FIXED_FEE, OHD_TICKETPAYMENTS_FIXED_FEE_VAT, OHD_TICKETPAYMENTS_TOTAL_AMOUNT, 
										OHD_RECHARGES_AMOUNT, OHD_RECHARGES_VAT, OHD_RECHARGES_PERC_FEE, OHD_RECHARGES_PERC_FEE_VAT, OHD_RECHARGES_FIXED_FEE, OHD_RECHARGES_FIXED_FEE_VAT, OHD_RECHARGES_TOTAL_AMOUNT,
										OHD_COUPONS_AMOUNT, OHD_COUPONS_VAT, OHD_COUPONS_PERC_FEE, OHD_COUPONS_PERC_FEE_VAT, OHD_COUPONS_FIXED_FEE, OHD_COUPONS_FIXED_FEE_VAT, OHD_COUPONS_TOTAL_AMOUNT,
										OHD_SERVICES_AMOUNT, OHD_SERVICES_VAT, OHD_SERVICES_PERC_FEE, OHD_SERVICES_PERC_FEE_VAT, OHD_SERVICES_FIXED_FEE, OHD_SERVICES_FIXED_FEE_VAT, OHD_SERVICES_TOTAL_AMOUNT)
	SELECT DB_OPERATIONS_HOUR.DBOH_ID, FINAN_DIST_OPERATORS.FDO_ID,

		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_AMOUNT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_AMOUNT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  -dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_AMOUNT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  -dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_AMOUNT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.RECHARGES_AMOUNT * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.RECHARGES_VAT * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE_VAT * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE_VAT * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_AMOUNT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_PERC_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_PERC_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_AMOUNT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_PERC_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_PERC_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0

	FROM DB_OPERATIONS_HOUR 
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D1
				    WHERE D1.FDOIP_OPE_TYPE = 1 AND
						  D1.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D1.FDOIP_END_APPLY_DATE >= @FromHour) DIST_PARKINGS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_PARKINGS.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_PARKINGS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D2
				    WHERE D2.FDOIP_OPE_TYPE = 2 AND
						  D2.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D2.FDOIP_END_APPLY_DATE >= @FromHour) DIST_EXTENSIONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_EXTENSIONS.FDOIP_INS_ID) AND
																					  DB_OPERATIONS_HOUR.GRP_ID = (DIST_EXTENSIONS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D3
				    WHERE D3.FDOIP_OPE_TYPE = 3 AND
						  D3.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D3.FDOIP_END_APPLY_DATE >= @FromHour) DIST_REFUNDS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_REFUNDS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_REFUNDS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D4
				    WHERE D4.FDOIP_OPE_TYPE = 4 AND
						  D4.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D4.FDOIP_END_APPLY_DATE >= @FromHour) DIST_TICKETPAYMENTS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_TICKETPAYMENTS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_TICKETPAYMENTS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D5
				    WHERE D5.FDOIP_OPE_TYPE = 5 AND
						  D5.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D5.FDOIP_END_APPLY_DATE >= @FromHour) DIST_RECHARGES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_RECHARGES.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_RECHARGES.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D12
				    WHERE D12.FDOIP_OPE_TYPE = 12 AND
						  D12.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D12.FDOIP_END_APPLY_DATE >= @FromHour) DIST_COUPONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_COUPONS.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_COUPONS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D6
				    WHERE D6.FDOIP_OPE_TYPE = 6 AND
						  D6.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D6.FDOIP_END_APPLY_DATE >= @FromHour) DIST_SERVICES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_SERVICES.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_SERVICES.FDOIP_GRP_ID),

		 FINAN_DIST_OPERATORS

	WHERE HOUR_UTC >= @FromHour AND
		  HOUR_UTC < @ToHour AND
		  (DIST_PARKINGS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_PARKINGS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_EXTENSIONS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_EXTENSIONS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_REFUNDS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_REFUNDS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_TICKETPAYMENTS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_TICKETPAYMENTS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_RECHARGES.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_RECHARGES.FDOIP_FDO_ID IS NULL) AND
		  (DIST_COUPONS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_COUPONS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_SERVICES.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_SERVICES.FDOIP_FDO_ID IS NULL) 
		  
	
	GROUP BY DB_OPERATIONS_HOUR.DBOH_ID, FINAN_DIST_OPERATORS.FDO_ID
	
END



GO
