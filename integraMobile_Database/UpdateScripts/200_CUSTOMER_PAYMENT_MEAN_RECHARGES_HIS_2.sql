
/****** Object:  View [dbo].[ALL_OPERATIONS]    Script Date: 7/8/2021 4:53:41 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER VIEW [dbo].[ALL_OPERATIONS]
AS
SELECT        CASE ISNULL(TAR_TYPE, 0) WHEN 1 THEN 19 ELSE OPE_TYPE END AS OPE_TYPE, OPE_USR_ID, OPE_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, OPE_DATE, OPE_UTC_DATE, OPE_INIDATE, OPE_ENDDATE, 
                         OPE_REFUND_PREVIOUS_ENDDATE, CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_AMOUNT ELSE - OPE_AMOUNT END AS int) OPE_AMOUNT, CAST(CASE WHEN OPE_TYPE = 3 THEN ISNULL(OPE_REAL_AMOUNT, 
                         OPE_AMOUNT) ELSE - ISNULL(OPE_REAL_AMOUNT, OPE_AMOUNT) END AS int) OPE_REAL_AMOUNT, OPE_TIME, OPE_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, 
                         cast(CUR1.CUR_MINOR_UNIT AS int) OPE_AMOUNT_CUR_MINOR_UNIT, CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_FINAL_AMOUNT ELSE - OPE_FINAL_AMOUNT END AS int) OPE_FINAL_AMOUNT, OPE_BALANCE_CUR_ID, 
                         CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, cast(CUR2.CUR_MINOR_UNIT AS int) OPE_BALANCE_CUR_MINOR_UNIT, OPE_CHANGE_APPLIED, USER_PLATES.USRP_ID, USER_PLATES.USRP_PLATE, NULL 
                         TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, GRP_ID, TAR_ID, GRP_DESCRIPTION, TAR_DESCRIPTION, OPE_SUSCRIPTION_TYPE, OPE_BALANCE_BEFORE, OPE_INSERTION_UTC_DATE, 
                         OPE_DATE_UTC_OFFSET, OPE_INIDATE_UTC_OFFSET, OPE_ENDDATE_UTC_OFFSET, 1 EPO_SRCTYPE, NULL EPO_SRCIDENT, OPE_PERC_VAT1, OPE_PERC_VAT2, 
                         CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_VAT1 ELSE - OPE_PARTIAL_VAT1 END AS int) OPE_PARTIAL_VAT1, OPE_PERC_FEE, OPE_PERC_FEE_TOPPED, 
                         CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_PERC_FEE ELSE - OPE_PARTIAL_PERC_FEE END AS int) OPE_PARTIAL_PERC_FEE, OPE_FIXED_FEE, 
                         CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_FIXED_FEE ELSE - OPE_PARTIAL_FIXED_FEE END AS int) OPE_PARTIAL_FIXED_FEE, CAST(CASE WHEN OPE_TYPE = 3 THEN ISNULL(OPE_TOTAL_AMOUNT, 
                         OPE_AMOUNT) ELSE - ISNULL(OPE_TOTAL_AMOUNT, OPE_AMOUNT) END AS int) OPE_TOTAL_AMOUNT, CASE WHEN ISNULL(OPE_PERC_FEE_TOPPED, 0) > 0 AND ISNULL(OPE_PERC_FEE_TOPPED, 0) 
                         < (OPE_AMOUNT * ISNULL(OPE_PERC_FEE, 0)) THEN OPE_PERC_FEE_TOPPED ELSE (OPE_AMOUNT * ISNULL(OPE_PERC_FEE, 0)) END + ISNULL(OPE_FIXED_FEE, 0) OPE_FEE, CASE WHEN ISNULL(OPE_PERC_BONUS, 0) 
                         > 0 THEN - OPE_PERC_BONUS * (CASE WHEN ISNULL(OPE_PERC_FEE_TOPPED, 0) > 0 AND ISNULL(OPE_PERC_FEE_TOPPED, 0) < (OPE_AMOUNT * ISNULL(OPE_PERC_FEE, 0)) 
                         THEN OPE_PERC_FEE_TOPPED ELSE (OPE_AMOUNT * ISNULL(OPE_PERC_FEE, 0)) END + ISNULL(OPE_FIXED_FEE, 0)) ELSE 0 END OPE_BONUS, ISNULL(OPE_PARTIAL_VAT1, 0) 
                         + ((CASE WHEN ISNULL(OPE_PERC_FEE_TOPPED, 0) > 0 AND ISNULL(OPE_PERC_FEE_TOPPED, 0) < (OPE_AMOUNT * ISNULL(OPE_PERC_FEE, 0)) 
                         THEN OPE_PERC_FEE_TOPPED ELSE (OPE_AMOUNT * ISNULL(OPE_PERC_FEE, 0)) END) * ISNULL(OPE_PERC_VAT2, 0)) + (ISNULL(OPE_FIXED_FEE, 0) * ISNULL(OPE_PERC_VAT2, 0)) 
                         - CASE WHEN ISNULL(OPE_PERC_BONUS, 0) > 0 THEN OPE_PARTIAL_BONUS_FEE - (OPE_PERC_BONUS * (CASE WHEN ISNULL(OPE_PERC_FEE_TOPPED, 0) > 0 AND ISNULL(OPE_PERC_FEE_TOPPED, 0) 
                         < (OPE_AMOUNT * ISNULL(OPE_PERC_FEE, 0)) THEN OPE_PERC_FEE_TOPPED ELSE (OPE_AMOUNT * ISNULL(OPE_PERC_FEE, 0)) END + ISNULL(OPE_FIXED_FEE, 0))) ELSE 0 END OPE_VAT, NULL 
                         OPE_ADDITIONAL_USR_ID, NULL OPE_ADDITIONAL_USR_USERNAME, NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, 
                         CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_TIME_BALANCE_USED ELSE - OPE_TIME_BALANCE_USED END AS int) OPE_TIME_BALANCE_USED, OPE_TIME_BALANCE_BEFORE, OPE_POSTPAY, OPE_SHOPKEEPER_OP, 
                         OPE_SHOPKEEPER_AMOUNT, OPE_SHOPKEEPER_PROFIT, TAR_TYPE, UP2.USRP_PLATE USRP_PLATE2, UP3.USRP_PLATE USRP_PLATE3, UP4.USRP_PLATE USRP_PLATE4, UP5.USRP_PLATE USRP_PLATE5, 
                         UP6.USRP_PLATE USRP_PLATE6, UP7.USRP_PLATE USRP_PLATE7, UP8.USRP_PLATE USRP_PLATE8, UP9.USRP_PLATE USRP_PLATE9, UP10.USRP_PLATE USRP_PLATE10, OPE_PLATE2_USRP_ID, 
						 OPE_PLATE3_USRP_ID, OPE_PLATE4_USRP_ID, OPE_PLATE5_USRP_ID, OPE_PLATE6_USRP_ID, OPE_PLATE7_USRP_ID, OPE_PLATE8_USRP_ID, OPE_PLATE9_USRP_ID, OPE_PLATE10_USRP_ID,
						 OPE_ID, OPE_LATITUDE, OPE_LONGITUDE, OPE_EXTERNAL_BASE_ID1, OPE_EXTERNAL_BASE_ID2, OPE_EXTERNAL_BASE_ID3
FROM            dbo.HIS_OPERATIONS LEFT OUTER JOIN
                         dbo.USER_PLATES ON dbo.HIS_OPERATIONS.OPE_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                         dbo.CURRENCIES CUR1 ON OPE_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON OPE_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                         dbo.GROUPS ON OPE_GRP_ID = GRP_ID LEFT OUTER JOIN
                         dbo.TARIFFS ON OPE_TAR_ID = TAR_ID LEFT OUTER JOIN
                         dbo.USER_PLATES UP2 ON dbo.HIS_OPERATIONS.OPE_PLATE2_USRP_ID = UP2.USRP_ID LEFT OUTER JOIN
                         dbo.USER_PLATES UP3 ON dbo.HIS_OPERATIONS.OPE_PLATE3_USRP_ID = UP3.USRP_ID LEFT OUTER JOIN
                         dbo.USER_PLATES UP4 ON dbo.HIS_OPERATIONS.OPE_PLATE4_USRP_ID = UP4.USRP_ID LEFT OUTER JOIN
                         dbo.USER_PLATES UP5 ON dbo.HIS_OPERATIONS.OPE_PLATE5_USRP_ID = UP5.USRP_ID LEFT OUTER JOIN
                         dbo.USER_PLATES UP6 ON dbo.HIS_OPERATIONS.OPE_PLATE6_USRP_ID = UP6.USRP_ID LEFT OUTER JOIN
                         dbo.USER_PLATES UP7 ON dbo.HIS_OPERATIONS.OPE_PLATE7_USRP_ID = UP7.USRP_ID LEFT OUTER JOIN
                         dbo.USER_PLATES UP8 ON dbo.HIS_OPERATIONS.OPE_PLATE8_USRP_ID = UP8.USRP_ID LEFT OUTER JOIN
                         dbo.USER_PLATES UP9 ON dbo.HIS_OPERATIONS.OPE_PLATE9_USRP_ID = UP9.USRP_ID LEFT OUTER JOIN
                         dbo.USER_PLATES UP10 ON dbo.HIS_OPERATIONS.OPE_PLATE10_USRP_ID = UP10.USRP_ID, INSTALLATIONS
WHERE        OPE_INS_ID = INS_ID
UNION ALL
SELECT        4 OPE_TYPE, TIPA_USR_ID, TIPA_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, TIPA_DATE, TIPA_UTC_DATE, NULL, NULL, NULL, - TIPA_AMOUNT TIPA_AMOUNT, - TIPA_AMOUNT, NULL, TIPA_AMOUNT_CUR_ID, 
                         CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, cast(CUR1.CUR_MINOR_UNIT AS int) OPE_AMOUNT_CUR_MINOR_UNIT, - TIPA_FINAL_AMOUNT, TIPA_BALANCE_CUR_ID, 
                         CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, cast(CUR2.CUR_MINOR_UNIT AS int) OPE_BALANCE_CUR_MINOR_UNIT, TIPA_CHANGE_APPLIED, USRP_ID, TIPA_PLATE_STRING, TIPA_TICKET_NUMBER, 
                         TIPA_TICKET_DATA, NULL, NULL, NULL, NULL, NULL, TIPA_SUSCRIPTION_TYPE, TIPA_BALANCE_BEFORE, TIPA_INSERTION_UTC_DATE, TIPA_DATE_UTC_OFFSET, NULL, NULL, 1 EPO_SRCTYPE, NULL EPO_SRCIDENT, 
                         TIPA_PERC_VAT1, TIPA_PERC_VAT2, - TIPA_PARTIAL_VAT1, TIPA_PERC_FEE, TIPA_PERC_FEE_TOPPED, - TIPA_PARTIAL_PERC_FEE, TIPA_FIXED_FEE, - TIPA_PARTIAL_FIXED_FEE, - ISNULL(TIPA_TOTAL_AMOUNT, 
                         TIPA_AMOUNT), CASE WHEN ISNULL(TIPA_PERC_FEE_TOPPED, 0) > 0 AND ISNULL(TIPA_PERC_FEE_TOPPED, 0) < (TIPA_AMOUNT * ISNULL(TIPA_PERC_FEE, 0)) 
                         THEN TIPA_PERC_FEE_TOPPED ELSE (TIPA_AMOUNT * ISNULL(TIPA_PERC_FEE, 0)) END + ISNULL(TIPA_FIXED_FEE, 0), 0, ISNULL(TIPA_PARTIAL_VAT1, 0) + ((CASE WHEN ISNULL(TIPA_PERC_FEE_TOPPED, 0) > 0 AND 
                         ISNULL(TIPA_PERC_FEE_TOPPED, 0) < (TIPA_AMOUNT * ISNULL(TIPA_PERC_FEE, 0)) THEN TIPA_PERC_FEE_TOPPED ELSE (TIPA_AMOUNT * ISNULL(TIPA_PERC_FEE, 0)) END) * ISNULL(TIPA_PERC_VAT2, 0)) 
                         + (ISNULL(TIPA_FIXED_FEE, 0) * ISNULL(TIPA_PERC_VAT2, 0)), NULL, NULL, NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL 
                         OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT, 0 TAR_TYPE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
						 NULL, NULL, NULL, NULL, NULL, NULL, NULL,
						 TIPA_ID, TIPA_LATITUDE, TIPA_LONGITUDE, NULL, NULL, NULL
FROM            dbo.TICKET_PAYMENTS LEFT OUTER JOIN
                         dbo.USER_PLATES ON dbo.TICKET_PAYMENTS.TIPA_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                         dbo.CURRENCIES CUR1 ON TIPA_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON TIPA_BALANCE_CUR_ID = CUR2.CUR_ID, INSTALLATIONS
WHERE        TIPA_INS_ID = INS_ID
UNION ALL
SELECT        5 OPE_TYPE, CUSPMR_USR_ID, NULL, NULL, NULL, CUSPMR_DATE, CUSPMR_UTC_DATE, NULL, NULL, NULL, CUSPMR_AMOUNT, CUSPMR_AMOUNT, NULL, CUSPMR_CUR_ID, CUR_ISO_CODE, 
                         cast(CUR_MINOR_UNIT AS int), NULL, CUSPMR_CUR_ID, CUR_ISO_CODE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, CUSPMR_SUSCRIPTION_TYPE, CUSPMR_BALANCE_BEFORE, 
                         CUSPMR_INSERTION_UTC_DATE, CUSPMR_DATE_UTC_OFFSET, NULL, NULL, 1 EPO_SRCTYPE, NULL EPO_SRCIDENT, CUSPMR_PERC_VAT1, CUSPMR_PERC_VAT2, CUSPMR_PARTIAL_VAT1, CUSPMR_PERC_FEE, 
                         CUSPMR_PERC_FEE_TOPPED, CUSPMR_PARTIAL_PERC_FEE, CUSPMR_FIXED_FEE, CUSPMR_PARTIAL_FIXED_FEE, ISNULL(CUSPMR_TOTAL_AMOUNT_CHARGED, CUSPMR_AMOUNT), 
                         CASE WHEN ISNULL(CUSPMR_PERC_FEE_TOPPED, 0) > 0 AND ISNULL(CUSPMR_PERC_FEE_TOPPED, 0) < (CUSPMR_AMOUNT * ISNULL(CUSPMR_PERC_FEE, 0)) 
                         THEN CUSPMR_PERC_FEE_TOPPED ELSE (CUSPMR_AMOUNT * ISNULL(CUSPMR_PERC_FEE, 0)) END + ISNULL(CUSPMR_FIXED_FEE, 0), 0, ISNULL(CUSPMR_PARTIAL_VAT1, 0) 
                         + ((CASE WHEN ISNULL(CUSPMR_PERC_FEE_TOPPED, 0) > 0 AND ISNULL(CUSPMR_PERC_FEE_TOPPED, 0) < (CUSPMR_AMOUNT * ISNULL(CUSPMR_PERC_FEE, 0)) 
                         THEN CUSPMR_PERC_FEE_TOPPED ELSE (CUSPMR_AMOUNT * ISNULL(CUSPMR_PERC_FEE, 0)) END) * ISNULL(CUSPMR_PERC_VAT2, 0)) + (ISNULL(CUSPMR_FIXED_FEE, 0) * ISNULL(CUSPMR_PERC_VAT2, 
                         0)), NULL, NULL, CUSPMR_TYPE OPE_CUSPMR_TYPE, CUSPMR_PAGATELIA_NEW_BALANCE OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL 
                         OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT, 0 TAR_TYPE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
						 NULL, NULL, NULL, NULL, NULL, NULL, NULL,
						 CUSPMR_ID, CUSPMR_LATITUDE, CUSPMR_LONGITUDE, NULL, NULL, NULL
FROM            dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS, dbo.CURRENCIES
WHERE        CUSPMR_CUR_ID = CUR_ID AND (CUSPMR_SUSCRIPTION_TYPE = 1 OR
                         CUSPMR_SUSCRIPTION_TYPE IS NULL) AND (CUSPMR_TRANS_STATUS IN (1, 2, 3, 4) OR
                         CUSPMR_RCOUP_ID IS NOT NULL OR
                         CUSPMR_TYPE IN (3, 4, 6))
UNION ALL
SELECT        6 OPE_TYPE, SECH_USR_ID, NULL, NULL, NULL, SECH_DATE, SECH_UTC_DATE, NULL, NULL, NULL, - SECH_AMOUNT, - SECH_AMOUNT, NULL, SECH_AMOUNT_CUR_ID, 
                         CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, cast(CUR1.CUR_MINOR_UNIT AS int) OPE_AMOUNT_CUR_MINOR_UNIT, - SECH_FINAL_AMOUNT, SECH_BALANCE_CUR_ID, 
                         CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, cast(CUR2.CUR_MINOR_UNIT AS int) OPE_BALANCE_CUR_MINOR_UNIT, SECH_CHANGE_APPLIED, NULL, NULL, NULL, NULL, 
                         SECH_SECHT_ID, NULL, NULL, NULL, NULL, SECH_SUSCRIPTION_TYPE, SECH_BALANCE_BEFORE, SECH_INSERTION_UTC_DATE, SECH_DATE_UTC_OFFSET, NULL, NULL, 1 EPO_SRCTYPE, NULL EPO_SRCIDENT, 
                         SECH_PERC_VAT1, SECH_PERC_VAT2, - SECH_PARTIAL_VAT1, SECH_PERC_FEE, SECH_PERC_FEE_TOPPED, - SECH_PARTIAL_PERC_FEE, SECH_FIXED_FEE, - SECH_PARTIAL_FIXED_FEE, - ISNULL(SECH_TOTAL_AMOUNT, 
                         SECH_AMOUNT), CASE WHEN ISNULL(SECH_PERC_FEE_TOPPED, 0) > 0 AND ISNULL(SECH_PERC_FEE_TOPPED, 0) < (SECH_AMOUNT * ISNULL(SECH_PERC_FEE, 0)) 
                         THEN SECH_PERC_FEE_TOPPED ELSE (SECH_AMOUNT * ISNULL(SECH_PERC_FEE, 0)) END + ISNULL(SECH_FIXED_FEE, 0), 0, ISNULL(SECH_PARTIAL_VAT1, 0) + ((CASE WHEN ISNULL(SECH_PERC_FEE_TOPPED, 0) > 0 AND
                          ISNULL(SECH_PERC_FEE_TOPPED, 0) < (SECH_AMOUNT * ISNULL(SECH_PERC_FEE, 0)) THEN SECH_PERC_FEE_TOPPED ELSE (SECH_AMOUNT * ISNULL(SECH_PERC_FEE, 0)) END) * ISNULL(SECH_PERC_VAT2, 0)) 
                         + (ISNULL(SECH_FIXED_FEE, 0) * ISNULL(SECH_PERC_VAT2, 0)), NULL, NULL, NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL 
                         OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT, 0 TAR_TYPE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
						 NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
						 SECH_ID, NULL, NULL, NULL, NULL, NULL
FROM            dbo.SERVICE_CHARGES INNER JOIN
                         dbo.CURRENCIES CUR1 ON SECH_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON SECH_BALANCE_CUR_ID = CUR2.CUR_ID
UNION ALL
SELECT        7 OPE_TYPE, OPEDIS_USR_ID, NULL, NULL, NULL, OPEDIS_DATE, OPEDIS_UTC_DATE, NULL, NULL, NULL, OPEDIS_AMOUNT, OPEDIS_AMOUNT, NULL, OPEDIS_AMOUNT_CUR_ID, 
                         CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, cast(CUR1.CUR_MINOR_UNIT AS int) OPE_AMOUNT_CUR_MINOR_UNIT, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, 
                         CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, cast(CUR2.CUR_MINOR_UNIT AS int) OPE_BALANCE_CUR_MINOR_UNIT, OPEDIS_CHANGE_APPLIED, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
                         OPEDIS_SUSCRIPTION_TYPE, OPEDIS_BALANCE_BEFORE, OPEDIS_INSERTION_UTC_DATE, OPEDIS_DATE_UTC_OFFSET, NULL, NULL, 1 EPO_SRCTYPE, NULL EPO_SRCIDENT, OPEDIS_PERC_VAT1, OPEDIS_PERC_VAT2, 
                         OPEDIS_PARTIAL_VAT1, OPEDIS_PERC_FEE, OPEDIS_PERC_FEE_TOPPED, OPEDIS_PARTIAL_PERC_FEE, OPEDIS_FIXED_FEE, OPEDIS_PARTIAL_FIXED_FEE, ISNULL(OPEDIS_TOTAL_AMOUNT, OPEDIS_AMOUNT), 
                         CASE WHEN ISNULL(OPEDIS_PERC_FEE_TOPPED, 0) > 0 AND ISNULL(OPEDIS_PERC_FEE_TOPPED, 0) < (OPEDIS_AMOUNT * ISNULL(OPEDIS_PERC_FEE, 0)) 
                         THEN OPEDIS_PERC_FEE_TOPPED ELSE (OPEDIS_AMOUNT * ISNULL(OPEDIS_PERC_FEE, 0)) END + ISNULL(OPEDIS_FIXED_FEE, 0), 0, ISNULL(OPEDIS_PARTIAL_VAT1, 0) 
                         + ((CASE WHEN ISNULL(OPEDIS_PERC_FEE_TOPPED, 0) > 0 AND ISNULL(OPEDIS_PERC_FEE_TOPPED, 0) < (OPEDIS_AMOUNT * ISNULL(OPEDIS_PERC_FEE, 0)) 
                         THEN OPEDIS_PERC_FEE_TOPPED ELSE (OPEDIS_AMOUNT * ISNULL(OPEDIS_PERC_FEE, 0)) END) * ISNULL(OPEDIS_PERC_VAT2, 0)) + (ISNULL(OPEDIS_FIXED_FEE, 0) * ISNULL(OPEDIS_PERC_VAT2, 0)), NULL, NULL, NULL 
                         OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 
                         0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT, 0 TAR_TYPE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
						 OPEDIS_ID, NULL,NULL, NULL, NULL, NULL
FROM            dbo.OPERATIONS_DISCOUNTS INNER JOIN
                         dbo.CURRENCIES CUR1 ON OPEDIS_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON OPEDIS_BALANCE_CUR_ID = CUR2.CUR_ID
UNION ALL
SELECT        EPO_TYPE, USRP_USR_ID, EPO_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, EPO_DATE, EPO_DATE_UTC, EPO_INIDATE, EPO_ENDDATE, NULL, - EPO_AMOUNT, - EPO_AMOUNT, EPO_TIME, INS_CUR_ID, CUR_ISO_CODE, 
                         cast(CUR_MINOR_UNIT AS int), - EPO_AMOUNT, NULL, NULL, NULL, 1, USRP_ID, USRP_PLATE, NULL, NULL, NULL SECH_SECHT_ID, GRP_ID, TAR_ID, GRP_DESCRIPTION, TAR_DESCRIPTION, NULL, NULL, 
                         EPO_INSERTION_UTC_DATE, EPO_DATE_UTC_OFFSET, EPO_INIDATE_UTC_OFFSET, EPO_ENDDATE_UTC_OFFSET, EPO_SRCTYPE, EPO_SRCIDENT, 0, 0, 0, 0, 0, 0, 0, 0, - EPO_AMOUNT, 0, 0, 0, NULL, NULL, NULL 
                         OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 
                         0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT, 0 TAR_TYPE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
						 EPO_ID, NULL, NULL, NULL, NULL, NULL
FROM            dbo.EXTERNAL_PARKING_OPERATIONS LEFT JOIN
                         GROUPS ON EPO_ZONE = GRP_ID LEFT JOIN
                         TARIFFS ON EPO_TARIFF = TAR_ID, dbo.USER_PLATES, dbo.INSTALLATIONS, dbo.CURRENCIES
WHERE        EPO_PLATE = USRP_PLATE AND USRP_ENABLED = 1 AND EPO_INS_ID = INS_ID AND INS_CUR_ID = CUR_ID
UNION ALL
SELECT        OPEOFF_TYPE, OPEOFF_USR_ID, OPEOFF_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, CASE OPEOFF_TYPE WHEN 8 THEN OPEOFF_NOTIFY_ENTRY_DATE ELSE OPEOFF_PAYMENT_DATE END, 
                         CASE OPEOFF_TYPE WHEN 8 THEN OPEOFF_UTC_NOTIFY_ENTRY_DATE ELSE OPEOFF_UTC_PAYMENT_DATE END, OPEOFF_ENTRY_DATE, OPEOFF_END_DATE, NULL, - OPEOFF_AMOUNT, - OPEOFF_AMOUNT, 
                         OPEOFF_TIME, CAST(OPEOFF_AMOUNT_CUR_ID AS int), CUR1.CUR_ISO_CODE, cast(CUR1.CUR_MINOR_UNIT AS int), CAST(- OPEOFF_FINAL_AMOUNT AS int), OPEOFF_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE, 
                         cast(CUR2.CUR_MINOR_UNIT AS int) OPE_BALANCE_CUR_MINOR_UNIT, OPEOFF_CHANGE_APPLIED, USRP_ID, USRP_PLATE, NULL, NULL, NULL, GRP_ID, NULL, GRP_DESCRIPTION, OPEOFF_TARIFF, 
                         OPEOFF_SUSCRIPTION_TYPE, OPEOFF_BALANCE_BEFORE, OPEOFF_INSERTION_UTC_DATE, 
                         CASE OPEOFF_TYPE WHEN 8 THEN OPEOFF_NOTIFY_ENTRY_DATE_UTC_OFFSET ELSE OPEOFF_PAYMENT_DATE_UTC_OFFSET END, OPEOFF_ENTRY_DATE_UTC_OFFSET, OPEOFF_END_DATE_UTC_OFFSET, 1, NULL, 0, 
                         0, 0, 0, 0, 0, 0, 0, - OPEOFF_AMOUNT, 0, 0, 0, NULL, NULL, NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL 
                         OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT, 0 TAR_TYPE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
						 OPEOFF_ID, OPEOFF_LATITUDE, OPEOFF_LONGITUDE, NULL, NULL, NULL
FROM            dbo.OPERATIONS_OFFSTREET LEFT OUTER JOIN
                         dbo.USER_PLATES ON dbo.OPERATIONS_OFFSTREET.OPEOFF_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                         dbo.CURRENCIES CUR1 ON OPEOFF_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON OPEOFF_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                         dbo.GROUPS ON OPEOFF_GRP_ID = GRP_ID, INSTALLATIONS
WHERE        OPEOFF_INS_ID = INS_ID
UNION ALL
SELECT        14, BAT_SRC_USR_ID, NULL, NULL, NULL, BAT_DATE, BAT_UTC_DATE, NULL, NULL, NULL, - BAT_AMOUNT, - BAT_AMOUNT, NULL, BAT_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE, cast(CUR1.CUR_MINOR_UNIT AS int), 
                         - BAT_AMOUNT, BAT_DST_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE, cast(CUR2.CUR_MINOR_UNIT AS int), BAT_CHANGE_APPLIED, NULL, NULL, NULL TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL 
                         SECH_SECHT_ID, NULL, NULL, NULL, NULL, NULL, BAT_SRC_BALANCE_BEFORE, BAT_INSERTION_UTC_DATE, BAT_DATE_UTC_OFFSET, NULL, NULL, 1 EPO_SRCTYPE, NULL EPO_SRCIDENT, NULL, NULL, NULL 
                         OPE_PARTIAL_VAT1, NULL, NULL, NULL OPE_PARTIAL_PERC_FEE, NULL, NULL OPE_PARTIAL_FIXED_FEE, - BAT_AMOUNT, 0 OPE_FEE, 0 OPE_BONUS, 0 OPE_VAT, BAT_DST_USR_ID, USR_USERNAME, NULL 
                         OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, BAT_SHOPKEEPER_OP, 
                         BAT_SHOPKEEPER_COLLECTED_AMOUNT, BAT_SHOPKEEPER_PROFIT, 0 TAR_TYPE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
						 BAT_ID, NULL, NULL, NULL, NULL, NULL
FROM            dbo.BALANCE_TRANSFERS INNER JOIN
                         dbo.CURRENCIES CUR1 ON BAT_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON BAT_DST_BALANCE_CUR_ID = CUR2.CUR_ID INNER JOIN
                         dbo.USERS ON BAT_DST_USR_ID = USR_ID
UNION ALL
SELECT        15, BAT_DST_USR_ID, NULL, NULL, NULL, BAT_DATE, BAT_UTC_DATE, NULL, NULL, NULL, BAT_DST_AMOUNT, BAT_DST_AMOUNT, NULL, BAT_DST_BALANCE_CUR_ID, CUR_ISO_CODE, 
                         cast(CUR_MINOR_UNIT AS int), NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, BAT_DST_BALANCE_BEFORE, BAT_INSERTION_UTC_DATE, 
                         BAT_DATE_UTC_OFFSET, NULL, NULL, 1 EPO_SRCTYPE, NULL EPO_SRCIDENT, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, BAT_DST_AMOUNT, 0, 0, 0, BAT_SRC_USR_ID, USR_USERNAME, NULL 
                         OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, BAT_SHOPKEEPER_OP, 
                         BAT_SHOPKEEPER_COLLECTED_AMOUNT, BAT_SHOPKEEPER_PROFIT, 0 TAR_TYPE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
						 BAT_ID, NULL, NULL, NULL, NULL, NULL
FROM            dbo.BALANCE_TRANSFERS, dbo.CURRENCIES, dbo.USERS
WHERE        BAT_DST_BALANCE_CUR_ID = CUR_ID AND BAT_SRC_USR_ID = USR_ID
UNION ALL
SELECT        TOLM_TYPE, TOLM_USR_ID, TOLM_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, TOLM_DATE, TOLM_UTC_DATE, NULL, NULL, NULL, 
                         CAST(CASE WHEN TOLM_TYPE = 18 THEN TOLM_AMOUNT ELSE - TOLM_AMOUNT END AS int) OPE_AMOUNT, CAST(CASE WHEN TOLM_TYPE = 2 THEN TOLM_AMOUNT ELSE - TOLM_AMOUNT END AS int) 
                         OPE_REAL_AMOUNT, /*CAST(  -TOLM_AMOUNT AS int) OPE_AMOUNT,*/ NULL, TOLM_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, cast(CUR1.CUR_MINOR_UNIT AS int) 
                         OPE_AMOUNT_CUR_MINOR_UNIT, CAST(CASE WHEN TOLM_TYPE = 18 THEN TOLM_FINAL_AMOUNT ELSE - TOLM_FINAL_AMOUNT END AS int) OPE_FINAL_AMOUNT, TOLM_BALANCE_CUR_ID, 
                         CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, cast(CUR2.CUR_MINOR_UNIT AS int) OPE_BALANCE_CUR_MINOR_UNIT, TOLM_CHANGE_APPLIED, USRP_ID, USRP_PLATE, NULL TIPA_TICKET_NUMBER, NULL 
                         TIPA_TICKET_DATA, NULL SECH_SECHT_ID, TOLM_TOL_ID, NULL, TOL_DESCRIPTION, TOLM_TOL_TARIFF, NULL, TOLM_BALANCE_BEFORE, TOLM_INSERTION_UTC_DATE, TOLM_DATE_UTC_OFFSET, NULL, NULL, 
                         1 EPO_SRCTYPE, NULL EPO_SRCIDENT, TOLM_PERC_VAT1, TOLM_PERC_VAT2, CAST(CASE WHEN TOLM_TYPE = 18 THEN TOLM_PARTIAL_VAT1 ELSE - TOLM_PARTIAL_VAT1 END AS int) OPE_PARTIAL_VAT1, 
                         TOLM_PERC_FEE, TOLM_PERC_FEE_TOPPED, CAST(CASE WHEN TOLM_TYPE = 18 THEN TOLM_PARTIAL_PERC_FEE ELSE - TOLM_PARTIAL_PERC_FEE END AS int) OPE_PARTIAL_PERC_FEE, TOLM_FIXED_FEE, 
                         CAST(CASE WHEN TOLM_TYPE = 18 THEN TOLM_PARTIAL_FIXED_FEE ELSE - TOLM_PARTIAL_FIXED_FEE END AS int) OPE_PARTIAL_FIXED_FEE, CAST(CASE WHEN TOLM_TYPE = 18 THEN ISNULL(TOLM_TOTAL_AMOUNT, 
                         TOLM_AMOUNT) ELSE - ISNULL(TOLM_TOTAL_AMOUNT, TOLM_AMOUNT) END AS int) OPE_TOTAL_AMOUNT, CASE WHEN ISNULL(TOLM_PERC_FEE_TOPPED, 0) > 0 AND ISNULL(TOLM_PERC_FEE_TOPPED, 0) 
                         < (TOLM_AMOUNT * ISNULL(TOLM_PERC_FEE, 0)) THEN TOLM_PERC_FEE_TOPPED ELSE (TOLM_AMOUNT * ISNULL(TOLM_PERC_FEE, 0)) END + ISNULL(TOLM_FIXED_FEE, 0) OPE_FEE, 0 OPE_BONUS, 
                         ISNULL(TOLM_PARTIAL_VAT1, 0) + ((CASE WHEN ISNULL(TOLM_PERC_FEE_TOPPED, 0) > 0 AND ISNULL(TOLM_PERC_FEE_TOPPED, 0) < (TOLM_AMOUNT * ISNULL(TOLM_PERC_FEE, 0)) 
                         THEN TOLM_PERC_FEE_TOPPED ELSE (TOLM_AMOUNT * ISNULL(TOLM_PERC_FEE, 0)) END) * ISNULL(TOLM_PERC_VAT2, 0)) + (ISNULL(TOLM_FIXED_FEE, 0) * ISNULL(TOLM_PERC_VAT2, 0)) OPE_VAT, NULL 
                         OPE_ADDITIONAL_USR_ID, NULL OPE_ADDITIONAL_USR_USERNAME, TOLM_TYPE OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL 
                         OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT, 0 TAR_TYPE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
						 NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
						 TOLM_ID, TOLM_LATITUDE, TOLM_LONGITUDE, NULL, NULL, NULL
FROM            dbo.TOLL_MOVEMENTS LEFT OUTER JOIN
                         dbo.USER_PLATES ON dbo.TOLL_MOVEMENTS.TOLM_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                         dbo.CURRENCIES CUR1 ON TOLM_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON TOLM_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                         dbo.TOLLS ON TOLM_TOL_ID = TOL_ID, INSTALLATIONS
WHERE        TOLM_INS_ID = INS_ID

GO



/****** Object:  View [dbo].[ALL_OPERATIONS_EXT]    Script Date: 7/8/2021 4:55:10 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER VIEW [dbo].[ALL_OPERATIONS_EXT]
AS
SELECT        CASE ISNULL(TAR_TYPE, 0) WHEN 1 THEN 19 ELSE OPE_TYPE END AS OPE_TYPE, OPE_USR_ID, OPE_MOSE_OS, OPE_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, OPE_DATE, OPE_UTC_DATE, OPE_INIDATE, OPE_ENDDATE, 
                         CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_AMOUNT ELSE - OPE_AMOUNT END AS int) OPE_AMOUNT, 
						  CAST( CASE 
					  WHEN OPE_TYPE = 3
						 THEN ISNULL(OPE_REAL_AMOUNT,OPE_AMOUNT) 
					  ELSE -ISNULL(OPE_REAL_AMOUNT,OPE_AMOUNT) 
				 END AS int) OPE_REAL_AMOUNT,
						 OPE_TIME, OPE_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, 
                         CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_FINAL_AMOUNT ELSE - OPE_FINAL_AMOUNT END AS int) OPE_FINAL_AMOUNT, OPE_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
                         OPE_CHANGE_APPLIED, USER_PLATES.USRP_ID, USER_PLATES.USRP_PLATE, NULL TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, GRP_ID, TAR_ID, ISNULL(GRP_DESCRIPTION2,GRP_DESCRIPTION) GRP_DESCRIPTION, TAR_DESCRIPTION, 
                         OPE_SUSCRIPTION_TYPE, OPE_BALANCE_BEFORE, OPE_INSERTION_UTC_DATE, OPE_CUSPMR_ID, OPE_OPEDIS_ID, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, 
                         CUR3.CUR_ISO_CODE CUSPMR_AMOUNT_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, OPEDIS_DATE, OPEDIS_AMOUNT, OPEDIS_AMOUNT_CUR_ID, 
                         CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, 
                         OPEDIS_BALANCE_BEFORE, OPEDIS_INSERTION_UTC_DATE,  CUSPMR_OP_REFERENCE,  CUSPMR_TRANSACTION_ID,  CUSPMR_AUTH_CODE,  CUSPMR_CARD_HASH,  
                         CUSPMR_CARD_REFERENCE,  CUSPMR_CARD_SCHEME,  CUSPMR_MASKED_CARD_NUMBER,  CUSPMR_CARD_EXPIRATION_DATE, OPE_DATE_UTC_OFFSET, OPE_INIDATE_UTC_OFFSET, 
                         OPE_ENDDATE_UTC_OFFSET, CUSPMR_DATE_UTC_OFFSET OPE_CUSPMR_DATE_UTC_OFFSET, OPEDIS_DATE_UTC_OFFSET OPE_OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, 
                         CUR1.CUR_NAME OPE_AMOUNT_CUR_NAME, CUR2.CUR_NAME OPE_BALANCE_CUR_NAME, CUR3.CUR_NAME CUSPMR_CUR_NAME, CUR4.CUR_NAME OPEDIS_AMOUNT_CUR_NAME, 
                         CUR5.CUR_NAME OPEDIS_BALANCE_CUR_NAME, HIS_OPERATIONS.OPE_EXTERNAL_ID1, HIS_OPERATIONS.OPE_EXTERNAL_ID2, HIS_OPERATIONS.OPE_EXTERNAL_ID3, 
				OPE_CONFIRMED_IN_WS1, OPE_CONFIRMED_IN_WS2, OPE_CONFIRMED_IN_WS3,
				OPE_CONFIRMATION_TIME_IN_WS1, OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS1,OPE_CONFIRMATION_TIME_IN_WS2, OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS2,OPE_CONFIRMATION_TIME_IN_WS3, OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS3,
				OPE_LATITUDE, OPE_LONGITUDE, OPE_ID,OPE_APP_VERSION,
				NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE,
				NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE,
				NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION,
				OPE_PERC_VAT1, OPE_PERC_VAT2, CAST( CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_VAT1 ELSE -OPE_PARTIAL_VAT1 END AS int) OPE_PARTIAL_VAT1,
				OPE_PERC_FEE, OPE_PERC_FEE_TOPPED, CAST( CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_PERC_FEE ELSE -OPE_PARTIAL_PERC_FEE END AS int) OPE_PARTIAL_PERC_FEE,
				OPE_FIXED_FEE, CAST( CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_FIXED_FEE ELSE -OPE_PARTIAL_FIXED_FEE END AS int) OPE_PARTIAL_FIXED_FEE,
				ISNULL(OPE_PERC_BONUS, 0) OPE_PERC_BONUS, CAST ( ISNULL(OPE_PARTIAL_BONUS_FEE, 0) AS int) OPE_PARTIAL_BONUS_FEE,
				CAST( CASE WHEN OPE_TYPE = 3 THEN ISNULL(OPE_TOTAL_AMOUNT, OPE_AMOUNT) ELSE -ISNULL(OPE_TOTAL_AMOUNT, OPE_AMOUNT) END AS int) OPE_TOTAL_AMOUNT,
				NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE,
					CAST( CASE 
					  WHEN OPE_TYPE = 3
						 THEN OPE_TIME_BALANCE_USED 
					  ELSE -OPE_TIME_BALANCE_USED 
				 END AS int) OPE_TIME_BALANCE_USED, OPE_TIME_BALANCE_BEFORE, OPE_POSTPAY, OPE_SHOPKEEPER_OP, OPE_SHOPKEEPER_AMOUNT, OPE_SHOPKEEPER_PROFIT,
				 INSTALLATIONS.INS_STANDARD_CITY_ID,
				 UP2.USRP_PLATE USRP_PLATE2, UP3.USRP_PLATE USRP_PLATE3, UP4.USRP_PLATE USRP_PLATE4, UP5.USRP_PLATE USRP_PLATE5, 
				 UP6.USRP_PLATE USRP_PLATE6, UP7.USRP_PLATE USRP_PLATE7, UP8.USRP_PLATE USRP_PLATE8, UP9.USRP_PLATE USRP_PLATE9, UP10.USRP_PLATE USRP_PLATE10,
				 OPE_PERMIT_AUTO_RENEW, OPE_PERMIT_EXPIRATION_TIME,
				 NULL AS OPE_TRANS_STATUS, NULL AS OPE_REFUND_AMOUNT,
				 /* START IPS-328 */
				 CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_AMOUNT_WITHOUT_BON ELSE - OPE_AMOUNT_WITHOUT_BON END AS int) OPE_AMOUNT_WITHOUT_BON,
				 OPE_BON_MLT,
				 OPE_VEHICLE_TYPE
				 /* END IPS-328 */
FROM            dbo.HIS_OPERATIONS LEFT OUTER JOIN
                         dbo.USER_PLATES ON dbo.HIS_OPERATIONS.OPE_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                         dbo.CURRENCIES CUR1 ON OPE_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON OPE_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                         dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON dbo.HIS_OPERATIONS.OPE_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID LEFT OUTER JOIN
                         dbo.OPERATIONS_DISCOUNTS ON dbo.HIS_OPERATIONS.OPE_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID INNER JOIN
                         dbo.USERS ON OPE_USR_ID = USR_ID LEFT OUTER JOIN
                         dbo.GROUPS ON OPE_GRP_ID = GRP_ID LEFT OUTER JOIN
                         dbo.TARIFFS ON OPE_TAR_ID = TAR_ID
						 LEFT OUTER JOIN dbo.USER_PLATES UP2 ON dbo.HIS_OPERATIONS.OPE_PLATE2_USRP_ID = UP2.USRP_ID
						 LEFT OUTER JOIN dbo.USER_PLATES UP3 ON dbo.HIS_OPERATIONS.OPE_PLATE3_USRP_ID = UP3.USRP_ID
						 LEFT OUTER JOIN dbo.USER_PLATES UP4 ON dbo.HIS_OPERATIONS.OPE_PLATE4_USRP_ID = UP4.USRP_ID
						 LEFT OUTER JOIN dbo.USER_PLATES UP5 ON dbo.HIS_OPERATIONS.OPE_PLATE5_USRP_ID = UP5.USRP_ID
						 LEFT OUTER JOIN dbo.USER_PLATES UP6 ON dbo.HIS_OPERATIONS.OPE_PLATE6_USRP_ID = UP6.USRP_ID
						 LEFT OUTER JOIN dbo.USER_PLATES UP7 ON dbo.HIS_OPERATIONS.OPE_PLATE7_USRP_ID = UP7.USRP_ID
						 LEFT OUTER JOIN dbo.USER_PLATES UP8 ON dbo.HIS_OPERATIONS.OPE_PLATE8_USRP_ID = UP8.USRP_ID
						 LEFT OUTER JOIN dbo.USER_PLATES UP9 ON dbo.HIS_OPERATIONS.OPE_PLATE9_USRP_ID = UP9.USRP_ID
						 LEFT OUTER JOIN dbo.USER_PLATES UP10 ON dbo.HIS_OPERATIONS.OPE_PLATE10_USRP_ID = UP10.USRP_ID
						 , INSTALLATIONS
WHERE        OPE_INS_ID = INS_ID
UNION ALL
SELECT        4 OPE_TYPE, TIPA_USR_ID, TIPA_MOSE_OS, TIPA_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, TIPA_DATE, TIPA_UTC_DATE, TIPA_DATE, NULL, - TIPA_AMOUNT TIPA_AMOUNT,-TIPA_AMOUNT, NULL, TIPA_AMOUNT_CUR_ID, 
                         CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, - TIPA_FINAL_AMOUNT, TIPA_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, TIPA_CHANGE_APPLIED, USRP_ID, 
                         TIPA_PLATE_STRING, TIPA_TICKET_NUMBER, TIPA_TICKET_DATA, NULL, GRP_ID, NULL, ISNULL(GRP_DESCRIPTION2,GRP_DESCRIPTION) GRP_DESCRIPTION, NULL, TIPA_SUSCRIPTION_TYPE, TIPA_BALANCE_BEFORE, TIPA_INSERTION_UTC_DATE, TIPA_CUSPMR_ID, 
                         TIPA_OPEDIS_ID, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, CUR3.CUR_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, OPEDIS_DATE, OPEDIS_AMOUNT, 
                         OPEDIS_AMOUNT_CUR_ID, CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, 
                         OPEDIS_CHANGE_APPLIED, OPEDIS_BALANCE_BEFORE, OPEDIS_INSERTION_UTC_DATE, CUSPMR_OP_REFERENCE,  CUSPMR_TRANSACTION_ID,  CUSPMR_AUTH_CODE,  
                         CUSPMR_CARD_HASH,  CUSPMR_CARD_REFERENCE,  CUSPMR_CARD_SCHEME,  CUSPMR_MASKED_CARD_NUMBER,  CUSPMR_CARD_EXPIRATION_DATE, 
                         TIPA_DATE_UTC_OFFSET, NULL, NULL, CUSPMR_DATE_UTC_OFFSET, OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, CUR1.CUR_NAME, CUR2.CUR_NAME, CUR3.CUR_NAME, CUR4.CUR_NAME, 
                         CUR5.CUR_NAME, NULL, NULL, NULL, TIPA_CONFIRMED_IN_WS,NULL,NULL,
						 TIPA_CONFIRMATION_TIME_IN_WS, TIPA_QUEUE_LENGTH_BEFORE_CONFIRM_WS, NULL,NULL,NULL,NULL,
						 TIPA_LATITUDE, TIPA_LONGITUDE, TIPA_ID,TIPA_APP_VERSION,
						 NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE,
						 NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE,
						 NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION,
						 TIPA_PERC_VAT1, TIPA_PERC_VAT2, - TIPA_PARTIAL_VAT1,
						 TIPA_PERC_FEE, TIPA_PERC_FEE_TOPPED, - TIPA_PARTIAL_PERC_FEE,
						 TIPA_FIXED_FEE, - TIPA_PARTIAL_FIXED_FEE,
						 0, 0,
						 -ISNULL(TIPA_TOTAL_AMOUNT, TIPA_AMOUNT),
						 NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
						 INSTALLATIONS.INS_STANDARD_CITY_ID,
						 NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
						 NULL, NULL,
						 NULL, NULL,
						 /* START IPS-328 */
						 NULL,
						 NULL,
						 NULL
						 /* END IPS-328 */
FROM            dbo.TICKET_PAYMENTS LEFT OUTER JOIN
                         dbo.USER_PLATES ON dbo.TICKET_PAYMENTS.TIPA_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                         dbo.CURRENCIES CUR1 ON TIPA_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON TIPA_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                         dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON dbo.TICKET_PAYMENTS.TIPA_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID LEFT OUTER JOIN
                         dbo.OPERATIONS_DISCOUNTS ON dbo.TICKET_PAYMENTS.TIPA_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID INNER JOIN
                         dbo.USERS ON TIPA_USR_ID = USR_ID LEFT OUTER JOIN
						 dbo.GROUPS ON TIPA_GRP_ID = GRP_ID,
						 INSTALLATIONS 
WHERE        TIPA_INS_ID = INS_ID
UNION ALL
SELECT        5 OPE_TYPE, CUSPMR_USR_ID, CUSPMR_MOSE_OS, NULL, NULL, NULL, CUSPMR_DATE, CUSPMR_UTC_DATE, CUSPMR_DATE, NULL, CUSPMR_AMOUNT,CUSPMR_AMOUNT, NULL, CUSPMR_CUR_ID, 
                          CUR_ISO_CODE, NULL, CUSPMR_CUR_ID, CUR_ISO_CODE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, CUSPMR_SUSCRIPTION_TYPE, CUSPMR_BALANCE_BEFORE, 
                          CUSPMR_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, CUSPMR_OP_REFERENCE, 
                          CUSPMR_TRANSACTION_ID, CUSPMR_AUTH_CODE, CUSPMR_CARD_HASH, CUSPMR_CARD_REFERENCE, CUSPMR_CARD_SCHEME, CUSPMR_MASKED_CARD_NUMBER, CUSPMR_CARD_EXPIRATION_DATE,
                          CUSPMR_DATE_UTC_OFFSET, NULL, NULL, NULL, NULL, USR_USERNAME, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,NULL,NULL,NULL,NULL,CUSPMR_LATITUDE, CUSPMR_LONGITUDE, CUSPMR_ID,CUSPMR_APP_VERSION,
						  NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE,
						  NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE,
						  NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION,
						  CUSPMR_PERC_VAT1, CUSPMR_PERC_VAT2, CUSPMR_PARTIAL_VAT1,
						  CUSPMR_PERC_FEE, CUSPMR_PERC_FEE_TOPPED, CUSPMR_PARTIAL_PERC_FEE,
						  CUSPMR_FIXED_FEE, CUSPMR_PARTIAL_FIXED_FEE,
						  0, 0,
						  ISNULL(CUSPMR_TOTAL_AMOUNT_CHARGED, CUSPMR_AMOUNT),
						  CUSPMR_TYPE OPE_CUSPMR_TYPE, CUSPMR_PAGATELIA_NEW_BALANCE OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
						  NULL,
						  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
						 NULL, NULL,
						 CUSPMR_TRANS_STATUS, CASE WHEN CUSPMR_TRANS_STATUS = 10 AND ISNULL(CUSPMR_REFUND_AMOUNT,0) = 0 THEN CUSPMR_TOTAL_AMOUNT_CHARGED ELSE ISNULL(CUSPMR_REFUND_AMOUNT,0) END,
						 /* START IPS-328 */
						 NULL,
						 NULL,
						 NULL
						 /* END IPS-328 */
FROM            dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS INNER JOIN
                         dbo.USERS ON CUSPMR_USR_ID = USR_ID, dbo.CURRENCIES
WHERE        CUSPMR_CUR_ID = CUR_ID AND (CUSPMR_SUSCRIPTION_TYPE = 1 OR
                         CUSPMR_SUSCRIPTION_TYPE IS NULL) AND (CUSPMR_TRANS_STATUS IN (1, 2, 3, 4, 8, 9, 10) OR CUSPMR_RCOUP_ID IS NOT NULL OR CUSPMR_TYPE IN (3,4,6))

UNION ALL
SELECT        6 OPE_TYPE, SECH_USR_ID, SECH_MOSE_OS, NULL, NULL, NULL, SECH_DATE, SECH_UTC_DATE, SECH_DATE, NULL, - SECH_AMOUNT,-SECH_AMOUNT, NULL, SECH_AMOUNT_CUR_ID, 
                         CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, - SECH_FINAL_AMOUNT, SECH_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
                         SECH_CHANGE_APPLIED, NULL, NULL, NULL, NULL, SECH_SECHT_ID, NULL, NULL, NULL, NULL, SECH_SUSCRIPTION_TYPE, SECH_BALANCE_BEFORE, SECH_INSERTION_UTC_DATE, 
                         SECH_CUSPMR_ID, NULL, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, CUR3.CUR_ISO_CODE, CUSPMR_BALANCE_BEFORE, 
                         CUSPMR_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL 
                         CUSPMR_CARD_HASH, NULL CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, 
                         SECH_DATE_UTC_OFFSET, NULL, NULL, CUSPMR_DATE_UTC_OFFSET, NULL, USR_USERNAME, CUR1.CUR_NAME, CUR2.CUR_NAME, CUR3.CUR_NAME, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,NULL,NULL,NULL,
                         SECH_ID,SECH_APP_VERSION,
						 NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE,
						 NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE,
						 NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION,
						 SECH_PERC_VAT1, SECH_PERC_VAT2, - SECH_PARTIAL_VAT1,
						 SECH_PERC_FEE, SECH_PERC_FEE_TOPPED, - SECH_PARTIAL_PERC_FEE,
						 SECH_FIXED_FEE, - SECH_PARTIAL_FIXED_FEE,
						 0, 0,
						 - ISNULL(SECH_TOTAL_AMOUNT, SECH_AMOUNT),
						 NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
						 NULL,
						 NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
						 NULL, NULL,
						 NULL, NULL,
						 /* START IPS-328 */
						 NULL,
						 NULL,
						 NULL
						 /* END IPS-328 */
FROM            dbo.SERVICE_CHARGES INNER JOIN
                         dbo.CURRENCIES CUR1 ON SECH_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON SECH_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                         dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON dbo.SERVICE_CHARGES.SECH_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID INNER JOIN
                         dbo.USERS ON SECH_USR_ID = USR_ID
UNION ALL
SELECT        7 OPE_TYPE, OPEDIS_USR_ID, OPEDIS_MOSE_OS, NULL, NULL, NULL, OPEDIS_DATE, OPEDIS_UTC_DATE, OPEDIS_DATE, NULL, OPEDIS_AMOUNT,OPEDIS_AMOUNT, NULL, OPEDIS_AMOUNT_CUR_ID, 
                         CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
                         OPEDIS_CHANGE_APPLIED, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, OPEDIS_SUSCRIPTION_TYPE, OPEDIS_BALANCE_BEFORE, 
                         OPEDIS_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL CUSPMR_OP_REFERENCE, NULL 
                         CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL 
                         CUSPMR_CARD_EXPIRATION_DATE, OPEDIS_DATE_UTC_OFFSET, NULL, NULL, NULL, NULL, USR_USERNAME, CUR1.CUR_NAME, CUR2.CUR_NAME, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,NULL,NULL,NULL,
                         OPEDIS_LATITUDE, OPEDIS_LONGITUDE, OPEDIS_ID,OPEDIS_APP_VERSION,
						 NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE,
						 NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE,
						 NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION,
						 OPEDIS_PERC_VAT1, OPEDIS_PERC_VAT2, OPEDIS_PARTIAL_VAT1,
						 OPEDIS_PERC_FEE, OPEDIS_PERC_FEE_TOPPED, OPEDIS_PARTIAL_PERC_FEE,
						 OPEDIS_FIXED_FEE, OPEDIS_PARTIAL_FIXED_FEE,
						 0, 0,
						 ISNULL(OPEDIS_TOTAL_AMOUNT, OPEDIS_AMOUNT),
						 NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
						 NULL,
						 NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
						 NULL, NULL,
						 NULL, NULL,
						 /* START IPS-328 */
						 NULL,
						 NULL,
						 NULL
						 /* END IPS-328 */
FROM            dbo.OPERATIONS_DISCOUNTS INNER JOIN
                         dbo.CURRENCIES CUR1 ON OPEDIS_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON OPEDIS_BALANCE_CUR_ID = CUR2.CUR_ID INNER JOIN
                         dbo.USERS ON OPEDIS_USR_ID = USR_ID

UNION ALL
SELECT        OPEOFF_TYPE, OPEOFF_USR_ID, OPEOFF_MOSE_OS, OPEOFF_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, 
				CASE OPEOFF_TYPE WHEN 8 THEN OPEOFF_NOTIFY_ENTRY_DATE ELSE OPEOFF_PAYMENT_DATE END, 
				CASE OPEOFF_TYPE WHEN 8 THEN OPEOFF_UTC_NOTIFY_ENTRY_DATE ELSE OPEOFF_UTC_PAYMENT_DATE END, 
				OPEOFF_ENTRY_DATE, OPEOFF_END_DATE, 
                CAST(-OPEOFF_AMOUNT AS int),CAST(-OPEOFF_AMOUNT AS int), OPEOFF_TIME, OPEOFF_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, 
                CAST(-OPEOFF_FINAL_AMOUNT AS int), OPEOFF_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
                OPEOFF_CHANGE_APPLIED, USRP_ID, USRP_PLATE, NULL TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, GRP_ID, NULL, ISNULL(GRP_DESCRIPTION2,GRP_DESCRIPTION) GRP_DESCRIPTION, NULL, 
                OPEOFF_SUSCRIPTION_TYPE, OPEOFF_BALANCE_BEFORE, OPEOFF_INSERTION_UTC_DATE, OPEOFF_CUSPMR_ID, OPEOFF_OPEDIS_ID, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, 
                CUR3.CUR_ISO_CODE CUSPMR_AMOUNT_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, OPEDIS_DATE, OPEDIS_AMOUNT, OPEDIS_AMOUNT_CUR_ID, 
                CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, 
                OPEDIS_BALANCE_BEFORE, OPEDIS_INSERTION_UTC_DATE, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
                CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, 
				CASE OPEOFF_TYPE WHEN 8 THEN OPEOFF_NOTIFY_ENTRY_DATE_UTC_OFFSET ELSE OPEOFF_PAYMENT_DATE_UTC_OFFSET END,
				OPEOFF_ENTRY_DATE_UTC_OFFSET, OPEOFF_END_DATE_UTC_OFFSET, 
				CUSPMR_DATE_UTC_OFFSET OPE_CUSPMR_DATE_UTC_OFFSET, OPEDIS_DATE_UTC_OFFSET OPE_OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, 
                CUR1.CUR_NAME OPE_AMOUNT_CUR_NAME, CUR2.CUR_NAME OPE_BALANCE_CUR_NAME, CUR3.CUR_NAME CUSPMR_CUR_NAME, CUR4.CUR_NAME OPEDIS_AMOUNT_CUR_NAME, 
                CUR5.CUR_NAME OPEDIS_BALANCE_CUR_NAME, OPEOFF_EXTERNAL_ID1, OPEOFF_EXTERNAL_ID2, OPEOFF_EXTERNAL_ID3, 
				OPEOFF_CONFIRMED_IN_WS1, OPEOFF_CONFIRMED_IN_WS2, OPEOFF_CONFIRMED_IN_WS3,
				OPEOFF_CONFIRMATION_TIME_IN_WS1, OPEOFF_QUEUE_LENGTH_BEFORE_CONFIRM_WS1,OPEOFF_CONFIRMATION_TIME_IN_WS2, OPEOFF_QUEUE_LENGTH_BEFORE_CONFIRM_WS2,OPEOFF_CONFIRMATION_TIME_IN_WS3, OPEOFF_QUEUE_LENGTH_BEFORE_CONFIRM_WS3,
				OPEOFF_LATITUDE, OPEOFF_LONGITUDE, OPEOFF_ID, OPEOFF_APP_VERSION,
				OPEOFF_ENTRY_DATE, OPEOFF_NOTIFY_ENTRY_DATE, OPEOFF_PAYMENT_DATE, OPEOFF_END_DATE, OPEOFF_EXIT_LIMIT_DATE, OPEOFF_EXIT_DATE,
				OPEOFF_UTC_ENTRY_DATE, OPEOFF_UTC_NOTIFY_ENTRY_DATE, OPEOFF_UTC_PAYMENT_DATE, OPEOFF_UTC_END_DATE, OPEOFF_UTC_EXIT_LIMIT_DATE, OPEOFF_UTC_EXIT_DATE,
				OPEOFF_LOGICAL_ID, OPEOFF_TARIFF, OPEOFF_GATE, OPEOFF_SPACE_DESCRIPTION,
				OPEOFF_PERC_VAT1, OPEOFF_PERC_VAT2, -OPEOFF_PARTIAL_VAT1,
				OPEOFF_PERC_FEE, OPEOFF_PERC_FEE_TOPPED, -OPEOFF_PARTIAL_PERC_FEE,
				OPEOFF_FIXED_FEE, -OPEOFF_PARTIAL_FIXED_FEE,
				0,0,
				-ISNULL(OPEOFF_TOTAL_AMOUNT, OPEOFF_AMOUNT) OPE_TOTAL_AMOUNT,
				NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
				INSTALLATIONS.INS_STANDARD_CITY_ID,
				NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
				 NULL, NULL,
				 NULL, NULL,
				 /* START IPS-328 */
				 NULL,
				 NULL,
				 NULL
				 /* END IPS-328 */
FROM            dbo.OPERATIONS_OFFSTREET LEFT OUTER JOIN
                         dbo.USER_PLATES ON dbo.OPERATIONS_OFFSTREET.OPEOFF_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                         dbo.CURRENCIES CUR1 ON OPEOFF_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON OPEOFF_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                         dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON dbo.OPERATIONS_OFFSTREET.OPEOFF_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID LEFT OUTER JOIN
                         dbo.OPERATIONS_DISCOUNTS ON dbo.OPERATIONS_OFFSTREET.OPEOFF_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID INNER JOIN
                         dbo.USERS ON OPEOFF_USR_ID = USR_ID LEFT OUTER JOIN
                         dbo.GROUPS ON OPEOFF_GRP_ID = GRP_ID, INSTALLATIONS
WHERE        OPEOFF_INS_ID = INS_ID

UNION ALL

SELECT        14, BAT_SRC_USR_ID, BAT_MOSE_OS, NULL, NULL, NULL, BAT_DATE, BAT_UTC_DATE, BAT_DATE, NULL, 
                         -BAT_AMOUNT,-BAT_AMOUNT, NULL, BAT_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, 
                         -BAT_AMOUNT, BAT_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
                         BAT_CHANGE_APPLIED, NULL, NULL, NULL TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, NULL, NULL, NULL GRP_DESCRIPTION, NULL, 
                         1 OPE_SUSCRIPTION_TYPE, BAT_SRC_BALANCE_BEFORE, BAT_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, 
                         NULL, NULL, NULL, NULL, NULL, NULL, 
                         NULL, NULL, NULL, NULL, NULL, 
                         NULL, NULL, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
                         CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, NULL, NULL, 
                         NULL, NULL, NULL, USR_USERNAME, 
                         CUR1.CUR_NAME OPE_AMOUNT_CUR_NAME, CUR1.CUR_NAME OPE_BALANCE_CUR_NAME, NULL, NULL, 
                         NULL OPEDIS_BALANCE_CUR_NAME, NULL, NULL, NULL, 
						 NULL, NULL, NULL,
						 NULL, NULL, NULL, NULL, NULL , NULL,
						 NULL, NULL, BAT_ID, BAT_APP_VERSION,
						 NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE,
						 NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE,
						 NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION,
						 NULL, NULL, NULL OPE_PARTIAL_VAT1,
						 NULL, NULL, NULL OPE_PARTIAL_PERC_FEE,
						 NULL, NULL OPE_PARTIAL_FIXED_FEE,
						 NULL OPE_PERC_BONUS, NULL OPE_PARTIAL_BONUS_FEE,
						 -BAT_AMOUNT OPE_TOTAL_AMOUNT,
						 NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY,
						 BAT_SHOPKEEPER_OP, BAT_SHOPKEEPER_COLLECTED_AMOUNT, BAT_SHOPKEEPER_PROFIT,
						 NULL,
						 NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
						 NULL, NULL,
						 NULL, NULL,
						 /* START IPS-328 */
						 NULL,
						 NULL,
						 NULL
						 /* END IPS-328 */
FROM            dbo.BALANCE_TRANSFERS LEFT OUTER JOIN                         
                         dbo.CURRENCIES CUR1 ON BAT_AMOUNT_CUR_ID = CUR1.CUR_ID LEFT OUTER JOIN                                                  
                         dbo.USERS ON BAT_SRC_USR_ID = USR_ID

UNION ALL

SELECT        15, BAT_DST_USR_ID, BAT_MOSE_OS, NULL, NULL, NULL, BAT_DATE, BAT_UTC_DATE, BAT_DATE, NULL, 
                         BAT_DST_AMOUNT,BAT_DST_AMOUNT, NULL, BAT_DST_BALANCE_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, 
                         BAT_DST_AMOUNT, BAT_DST_BALANCE_CUR_ID, CUR1.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
                         BAT_CHANGE_APPLIED, NULL, NULL, NULL TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, NULL, NULL, NULL GRP_DESCRIPTION, NULL, 
                         1 OPE_SUSCRIPTION_TYPE, BAT_DST_BALANCE_BEFORE, BAT_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, 
                         NULL, NULL, NULL, NULL, NULL, NULL, 
                         NULL, NULL, NULL, NULL, NULL, 
                         NULL, NULL, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
                         CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, NULL, NULL, 
                         NULL, NULL, NULL, USR_USERNAME, 
                         CUR1.CUR_NAME OPE_AMOUNT_CUR_NAME, CUR1.CUR_NAME OPE_BALANCE_CUR_NAME, NULL, NULL, 
                         NULL OPEDIS_BALANCE_CUR_NAME, NULL, NULL, NULL, 
						 NULL, NULL, NULL,
						 NULL, NULL, NULL, NULL, NULL , NULL,
						 NULL, NULL, BAT_ID, BAT_APP_VERSION,
						 NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE,
						 NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE,
						 NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION,
						 NULL, NULL, NULL OPE_PARTIAL_VAT1,
						 NULL, NULL, NULL OPE_PARTIAL_PERC_FEE,
						 NULL, NULL OPE_PARTIAL_FIXED_FEE,
						 NULL OPE_PERC_BONUS, NULL OPE_PARTIAL_BONUS_FEE,
						 BAT_AMOUNT OPE_TOTAL_AMOUNT,
						 NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY,
						 BAT_SHOPKEEPER_OP, BAT_SHOPKEEPER_COLLECTED_AMOUNT, BAT_SHOPKEEPER_PROFIT,
						 NULL,
						 NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
						 NULL, NULL,
						 NULL, NULL,
						 /* START IPS-328 */
						 NULL,
						 NULL,
						 NULL
						 /* END IPS-328 */
FROM            dbo.BALANCE_TRANSFERS LEFT OUTER JOIN                                                  
                         dbo.CURRENCIES CUR1 ON BAT_DST_BALANCE_CUR_ID = CUR1.CUR_ID LEFT OUTER JOIN                                                  
                         dbo.USERS ON BAT_DST_USR_ID = USR_ID

UNION ALL

SELECT        TOLM_TYPE, TOLM_USR_ID, TOLM_MOSE_OS, TOLM_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, TOLM_DATE, TOLM_UTC_DATE, TOLM_DATE, NULL, 
                         CAST(CASE WHEN TOLM_TYPE = 18 THEN TOLM_AMOUNT ELSE - TOLM_AMOUNT END AS int) OPE_AMOUNT, 
						 CAST(CASE WHEN TOLM_TYPE = 18 THEN TOLM_AMOUNT ELSE - TOLM_AMOUNT END AS int) OPE_REAL_AMOUNT,NULL, TOLM_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, 
                         CAST(CASE WHEN TOLM_TYPE = 18 THEN TOLM_FINAL_AMOUNT ELSE - TOLM_FINAL_AMOUNT END AS int) OPE_FINAL_AMOUNT, TOLM_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
                         TOLM_CHANGE_APPLIED, USRP_ID, USRP_PLATE, NULL TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, NULL/*TOL_ID*/, NULL, NULL, TOLM_TOL_TARIFF, 
                         TOLM_SUSCRIPTION_TYPE, TOLM_BALANCE_BEFORE, TOLM_INSERTION_UTC_DATE, TOLM_CUSPMR_ID, NULL, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, 
                         CUR3.CUR_ISO_CODE CUSPMR_AMOUNT_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, NULL, NULL, NULL, 
                         NULL OPEDIS_AMOUNT_CUR_ISO_CODE, NULL, NULL, NULL OPEDIS_BALANCE_CUR_ISO_CODE, NULL, 
                         NULL, NULL, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
                         CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, TOLM_DATE_UTC_OFFSET, NULL, 
                         NULL, CUSPMR_DATE_UTC_OFFSET OPE_CUSPMR_DATE_UTC_OFFSET, NULL OPE_OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, 
                         CUR1.CUR_NAME OPE_AMOUNT_CUR_NAME, CUR2.CUR_NAME OPE_BALANCE_CUR_NAME, CUR3.CUR_NAME CUSPMR_CUR_NAME, NULL OPEDIS_AMOUNT_CUR_NAME, 
                         NULL OPEDIS_BALANCE_CUR_NAME, TOLM_EXTERNAL_ID, NULL, NULL, 
				NULL, NULL, NULL,
				NULL, NULL,NULL, NULL,NULL, NULL,
				TOLM_LATITUDE, TOLM_LONGITUDE, TOLM_ID,TOLM_APP_VERSION,
				NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE,
				NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE,
				NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION,
				TOLM_PERC_VAT1, TOLM_PERC_VAT2, CAST( CASE WHEN TOLM_TYPE = 18 THEN TOLM_PARTIAL_VAT1 ELSE -TOLM_PARTIAL_VAT1 END AS int) OPE_PARTIAL_VAT1,
				TOLM_PERC_FEE, TOLM_PERC_FEE_TOPPED, CAST( CASE WHEN TOLM_TYPE = 18 THEN TOLM_PARTIAL_PERC_FEE ELSE -TOLM_PARTIAL_PERC_FEE END AS int) OPE_PARTIAL_PERC_FEE,
				TOLM_FIXED_FEE, CAST( CASE WHEN TOLM_TYPE = 18 THEN TOLM_PARTIAL_FIXED_FEE ELSE -TOLM_PARTIAL_FIXED_FEE END AS int) OPE_PARTIAL_FIXED_FEE,
				0 OPE_PERC_BONUS, 0 OPE_PARTIAL_BONUS_FEE,
				CAST( CASE WHEN TOLM_TYPE = 18 THEN ISNULL(TOLM_TOTAL_AMOUNT, TOLM_AMOUNT) ELSE -ISNULL(TOLM_TOTAL_AMOUNT, TOLM_AMOUNT) END AS int) OPE_TOTAL_AMOUNT,
				NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
				INSTALLATIONS.INS_STANDARD_CITY_ID,
				NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
						 NULL, NULL,
						 NULL, NULL,
						 /* START IPS-328 */
						 NULL,
						 NULL,
						 NULL
						 /* END IPS-328 */
FROM            dbo.TOLL_MOVEMENTS LEFT OUTER JOIN
                         dbo.USER_PLATES ON dbo.TOLL_MOVEMENTS.TOLM_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                         dbo.CURRENCIES CUR1 ON TOLM_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON TOLM_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                         dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON dbo.TOLL_MOVEMENTS.TOLM_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID LEFT OUTER JOIN                         
                         dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                         dbo.USERS ON TOLM_USR_ID = USR_ID LEFT OUTER JOIN
                         dbo.TOLLS ON TOLM_TOL_ID = TOL_ID, INSTALLATIONS
WHERE        TOLM_INS_ID = INS_ID



GO




/****** Object:  View [dbo].[ALL_OPERATIONS_EXT_CHECK_BALANCE]    Script Date: 7/8/2021 4:59:48 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





ALTER VIEW [dbo].[ALL_OPERATIONS_EXT_CHECK_BALANCE]
AS
SELECT        CASE ISNULL(TAR_TYPE, 0) WHEN 1 THEN 19 ELSE OPE_TYPE END AS OPE_TYPE, OPE_USR_ID, OPE_MOSE_OS, OPE_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, OPE_DATE, OPE_UTC_DATE, OPE_INIDATE, OPE_ENDDATE, 
                         CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_AMOUNT ELSE - OPE_AMOUNT END AS int) OPE_AMOUNT, 
						  CAST( CASE 
					  WHEN OPE_TYPE = 3
						 THEN ISNULL(OPE_REAL_AMOUNT,OPE_AMOUNT) 
					  ELSE -ISNULL(OPE_REAL_AMOUNT,OPE_AMOUNT) 
				 END AS int) OPE_REAL_AMOUNT,
						 OPE_TIME, OPE_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, 
                         CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_FINAL_AMOUNT ELSE - OPE_FINAL_AMOUNT END AS int) OPE_FINAL_AMOUNT, OPE_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
                         OPE_CHANGE_APPLIED, USER_PLATES.USRP_ID, USER_PLATES.USRP_PLATE, NULL TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, GRP_ID, TAR_ID, ISNULL(GRP_DESCRIPTION2,GRP_DESCRIPTION) GRP_DESCRIPTION, TAR_DESCRIPTION, 
                         OPE_SUSCRIPTION_TYPE, OPE_BALANCE_BEFORE, OPE_INSERTION_UTC_DATE, OPE_CUSPMR_ID, OPE_OPEDIS_ID, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, 
                         CUR3.CUR_ISO_CODE CUSPMR_AMOUNT_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, OPEDIS_DATE, OPEDIS_AMOUNT, OPEDIS_AMOUNT_CUR_ID, 
                         CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, 
                         OPEDIS_BALANCE_BEFORE, OPEDIS_INSERTION_UTC_DATE, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
                         CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, OPE_DATE_UTC_OFFSET, OPE_INIDATE_UTC_OFFSET, 
                         OPE_ENDDATE_UTC_OFFSET, CUSPMR_DATE_UTC_OFFSET OPE_CUSPMR_DATE_UTC_OFFSET, OPEDIS_DATE_UTC_OFFSET OPE_OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, 
                         CUR1.CUR_NAME OPE_AMOUNT_CUR_NAME, CUR2.CUR_NAME OPE_BALANCE_CUR_NAME, CUR3.CUR_NAME CUSPMR_CUR_NAME, CUR4.CUR_NAME OPEDIS_AMOUNT_CUR_NAME, 
                         CUR5.CUR_NAME OPEDIS_BALANCE_CUR_NAME, HIS_OPERATIONS.OPE_EXTERNAL_ID1, HIS_OPERATIONS.OPE_EXTERNAL_ID2, HIS_OPERATIONS.OPE_EXTERNAL_ID3, 
				OPE_CONFIRMED_IN_WS1, OPE_CONFIRMED_IN_WS2, OPE_CONFIRMED_IN_WS3,
				OPE_CONFIRMATION_TIME_IN_WS1, OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS1,OPE_CONFIRMATION_TIME_IN_WS2, OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS2,OPE_CONFIRMATION_TIME_IN_WS3, OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS3,
				OPE_LATITUDE, OPE_LONGITUDE, OPE_ID,OPE_APP_VERSION,
				NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE,
				NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE,
				NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION,
				OPE_PERC_VAT1, OPE_PERC_VAT2, CAST( CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_VAT1 ELSE -OPE_PARTIAL_VAT1 END AS int) OPE_PARTIAL_VAT1,
				OPE_PERC_FEE, OPE_PERC_FEE_TOPPED, CAST( CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_PERC_FEE ELSE -OPE_PARTIAL_PERC_FEE END AS int) OPE_PARTIAL_PERC_FEE,
				OPE_FIXED_FEE, CAST( CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_FIXED_FEE ELSE -OPE_PARTIAL_FIXED_FEE END AS int) OPE_PARTIAL_FIXED_FEE,
				ISNULL(OPE_PERC_BONUS, 0) OPE_PERC_BONUS, CAST ( ISNULL(OPE_PARTIAL_BONUS_FEE, 0) AS int) OPE_PARTIAL_BONUS_FEE,
				CAST( CASE WHEN OPE_TYPE = 3 THEN ISNULL(OPE_TOTAL_AMOUNT, OPE_AMOUNT) ELSE -ISNULL(OPE_TOTAL_AMOUNT, OPE_AMOUNT) END AS int) OPE_TOTAL_AMOUNT,
				NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE,
					CAST( CASE 
					  WHEN OPE_TYPE = 3
						 THEN OPE_TIME_BALANCE_USED 
					  ELSE -OPE_TIME_BALANCE_USED 
				 END AS int) OPE_TIME_BALANCE_USED, OPE_TIME_BALANCE_BEFORE, OPE_POSTPAY, OPE_SHOPKEEPER_OP, OPE_SHOPKEEPER_AMOUNT, OPE_SHOPKEEPER_PROFIT,
				 UP2.USRP_PLATE USRP_PLATE2, UP3.USRP_PLATE USRP_PLATE3, UP4.USRP_PLATE USRP_PLATE4, UP5.USRP_PLATE USRP_PLATE5, 
							 UP6.USRP_PLATE USRP_PLATE6, UP7.USRP_PLATE USRP_PLATE7, UP8.USRP_PLATE USRP_PLATE8, UP9.USRP_PLATE USRP_PLATE9, UP10.USRP_PLATE USRP_PLATE10
FROM            dbo.HIS_OPERATIONS LEFT OUTER JOIN
                         dbo.USER_PLATES ON dbo.HIS_OPERATIONS.OPE_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                         dbo.CURRENCIES CUR1 ON OPE_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON OPE_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                         dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON dbo.HIS_OPERATIONS.OPE_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID LEFT OUTER JOIN
                         dbo.OPERATIONS_DISCOUNTS ON dbo.HIS_OPERATIONS.OPE_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID INNER JOIN
                         dbo.USERS ON OPE_USR_ID = USR_ID LEFT OUTER JOIN
                         dbo.GROUPS ON OPE_GRP_ID = GRP_ID LEFT OUTER JOIN
                         dbo.TARIFFS ON OPE_TAR_ID = TAR_ID
						 LEFT OUTER JOIN dbo.USER_PLATES UP2 ON dbo.HIS_OPERATIONS.OPE_PLATE2_USRP_ID = UP2.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP3 ON dbo.HIS_OPERATIONS.OPE_PLATE3_USRP_ID = UP3.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP4 ON dbo.HIS_OPERATIONS.OPE_PLATE4_USRP_ID = UP4.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP5 ON dbo.HIS_OPERATIONS.OPE_PLATE5_USRP_ID = UP5.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP6 ON dbo.HIS_OPERATIONS.OPE_PLATE6_USRP_ID = UP6.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP7 ON dbo.HIS_OPERATIONS.OPE_PLATE7_USRP_ID = UP7.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP8 ON dbo.HIS_OPERATIONS.OPE_PLATE8_USRP_ID = UP8.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP9 ON dbo.HIS_OPERATIONS.OPE_PLATE9_USRP_ID = UP9.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP10 ON dbo.HIS_OPERATIONS.OPE_PLATE10_USRP_ID = UP10.USRP_ID
						 , INSTALLATIONS
WHERE        OPE_INS_ID = INS_ID
UNION ALL
SELECT        4 OPE_TYPE, TIPA_USR_ID, TIPA_MOSE_OS, TIPA_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, TIPA_DATE, TIPA_UTC_DATE, NULL, NULL, - TIPA_AMOUNT TIPA_AMOUNT,-TIPA_AMOUNT, NULL, TIPA_AMOUNT_CUR_ID, 
                         CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, - TIPA_FINAL_AMOUNT, TIPA_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, TIPA_CHANGE_APPLIED, USRP_ID, 
                         TIPA_PLATE_STRING, TIPA_TICKET_NUMBER, TIPA_TICKET_DATA, NULL, GRP_ID, NULL, ISNULL(GRP_DESCRIPTION2,GRP_DESCRIPTION) GRP_DESCRIPTION, NULL, TIPA_SUSCRIPTION_TYPE, TIPA_BALANCE_BEFORE, TIPA_INSERTION_UTC_DATE, TIPA_CUSPMR_ID, 
                         TIPA_OPEDIS_ID, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, CUR3.CUR_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, OPEDIS_DATE, OPEDIS_AMOUNT, 
                         OPEDIS_AMOUNT_CUR_ID, CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, 
                         OPEDIS_CHANGE_APPLIED, OPEDIS_BALANCE_BEFORE, OPEDIS_INSERTION_UTC_DATE, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL 
                         CUSPMR_CARD_HASH, NULL CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, 
                         TIPA_DATE_UTC_OFFSET, NULL, NULL, CUSPMR_DATE_UTC_OFFSET, OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, CUR1.CUR_NAME, CUR2.CUR_NAME, CUR3.CUR_NAME, CUR4.CUR_NAME, 
                         CUR5.CUR_NAME, NULL, NULL, NULL, TIPA_CONFIRMED_IN_WS,NULL,NULL,
						 TIPA_CONFIRMATION_TIME_IN_WS, TIPA_QUEUE_LENGTH_BEFORE_CONFIRM_WS, NULL,NULL,NULL,NULL,
						 TIPA_LATITUDE, TIPA_LONGITUDE, TIPA_ID,TIPA_APP_VERSION,
						 NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE,
						 NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE,
						 NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION,
						 TIPA_PERC_VAT1, TIPA_PERC_VAT2, - TIPA_PARTIAL_VAT1,
						 TIPA_PERC_FEE, TIPA_PERC_FEE_TOPPED, - TIPA_PARTIAL_PERC_FEE,
						 TIPA_FIXED_FEE, - TIPA_PARTIAL_FIXED_FEE,
						 0, 0,
						 -ISNULL(TIPA_TOTAL_AMOUNT, TIPA_AMOUNT),
						 NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
						 NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM            dbo.TICKET_PAYMENTS LEFT OUTER JOIN
                         dbo.USER_PLATES ON dbo.TICKET_PAYMENTS.TIPA_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                         dbo.CURRENCIES CUR1 ON TIPA_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON TIPA_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                         dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON dbo.TICKET_PAYMENTS.TIPA_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID LEFT OUTER JOIN
                         dbo.OPERATIONS_DISCOUNTS ON dbo.TICKET_PAYMENTS.TIPA_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID INNER JOIN
                         dbo.USERS ON TIPA_USR_ID = USR_ID LEFT OUTER JOIN
						 dbo.GROUPS ON TIPA_GRP_ID = GRP_ID,
						 INSTALLATIONS 
WHERE        TIPA_INS_ID = INS_ID
UNION ALL
SELECT        5 OPE_TYPE, CUSPMR_USR_ID, CUSPMR_MOSE_OS, NULL, NULL, NULL, CUSPMR_DATE, CUSPMR_UTC_DATE, NULL, NULL, CUSPMR_AMOUNT,CUSPMR_AMOUNT, NULL, CUSPMR_CUR_ID, 
                          CUR_ISO_CODE, NULL, CUSPMR_CUR_ID, CUR_ISO_CODE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, CUSPMR_SUSCRIPTION_TYPE, CUSPMR_BALANCE_BEFORE, 
                          CUSPMR_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, CUSPMR_OP_REFERENCE, 
                          CUSPMR_TRANSACTION_ID, CUSPMR_AUTH_CODE, CUSPMR_CARD_HASH, CUSPMR_CARD_REFERENCE, CUSPMR_CARD_SCHEME, CUSPMR_MASKED_CARD_NUMBER, CUSPMR_CARD_EXPIRATION_DATE,
                          CUSPMR_DATE_UTC_OFFSET, NULL, NULL, NULL, NULL, USR_USERNAME, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,NULL,NULL,NULL,NULL,CUSPMR_LATITUDE, CUSPMR_LONGITUDE, CUSPMR_ID,CUSPMR_APP_VERSION,
						  NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE,
						  NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE,
						  NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION,
						  CUSPMR_PERC_VAT1, CUSPMR_PERC_VAT2, CUSPMR_PARTIAL_VAT1,
						  CUSPMR_PERC_FEE, CUSPMR_PERC_FEE_TOPPED, CUSPMR_PARTIAL_PERC_FEE,
						  CUSPMR_FIXED_FEE, CUSPMR_PARTIAL_FIXED_FEE,
						  0, 0,
						  ISNULL(CUSPMR_TOTAL_AMOUNT_CHARGED, CUSPMR_AMOUNT),
						  CUSPMR_TYPE OPE_CUSPMR_TYPE, CUSPMR_PAGATELIA_NEW_BALANCE OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
						  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM            dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS INNER JOIN
                         dbo.USERS ON CUSPMR_USR_ID = USR_ID, dbo.CURRENCIES
WHERE        CUSPMR_CUR_ID = CUR_ID  AND (CUSPMR_TRANS_STATUS IN (1, 2, 3, 4) OR CUSPMR_RCOUP_ID IS NOT NULL OR CUSPMR_TYPE IN (3,4,6))
UNION ALL
SELECT        6 OPE_TYPE, SECH_USR_ID, SECH_MOSE_OS, NULL, NULL, NULL, SECH_DATE, SECH_UTC_DATE, NULL, NULL, - SECH_AMOUNT,-SECH_AMOUNT, NULL, SECH_AMOUNT_CUR_ID, 
                         CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, - SECH_FINAL_AMOUNT, SECH_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
                         SECH_CHANGE_APPLIED, NULL, NULL, NULL, NULL, SECH_SECHT_ID, NULL, NULL, NULL, NULL, SECH_SUSCRIPTION_TYPE, SECH_BALANCE_BEFORE, SECH_INSERTION_UTC_DATE, 
                         SECH_CUSPMR_ID, NULL, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, CUR3.CUR_ISO_CODE, CUSPMR_BALANCE_BEFORE, 
                         CUSPMR_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL 
                         CUSPMR_CARD_HASH, NULL CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, 
                         SECH_DATE_UTC_OFFSET, NULL, NULL, CUSPMR_DATE_UTC_OFFSET, NULL, USR_USERNAME, CUR1.CUR_NAME, CUR2.CUR_NAME, CUR3.CUR_NAME, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,NULL,NULL,NULL,
                         SECH_ID,SECH_APP_VERSION,
						 NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE,
						 NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE,
						 NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION,
						 SECH_PERC_VAT1, SECH_PERC_VAT2, - SECH_PARTIAL_VAT1,
						 SECH_PERC_FEE, SECH_PERC_FEE_TOPPED, - SECH_PARTIAL_PERC_FEE,
						 SECH_FIXED_FEE, - SECH_PARTIAL_FIXED_FEE,
						 0, 0,
						 - ISNULL(SECH_TOTAL_AMOUNT, SECH_AMOUNT),
						 NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
						 NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM            dbo.SERVICE_CHARGES INNER JOIN
                         dbo.CURRENCIES CUR1 ON SECH_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON SECH_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                         dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON dbo.SERVICE_CHARGES.SECH_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID INNER JOIN
                         dbo.USERS ON SECH_USR_ID = USR_ID
UNION ALL
SELECT        7 OPE_TYPE, OPEDIS_USR_ID, OPEDIS_MOSE_OS, NULL, NULL, NULL, OPEDIS_DATE, OPEDIS_UTC_DATE, NULL, NULL, OPEDIS_AMOUNT,OPEDIS_AMOUNT, NULL, OPEDIS_AMOUNT_CUR_ID, 
                         CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
                         OPEDIS_CHANGE_APPLIED, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, OPEDIS_SUSCRIPTION_TYPE, OPEDIS_BALANCE_BEFORE, 
                         OPEDIS_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL CUSPMR_OP_REFERENCE, NULL 
                         CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL 
                         CUSPMR_CARD_EXPIRATION_DATE, OPEDIS_DATE_UTC_OFFSET, NULL, NULL, NULL, NULL, USR_USERNAME, CUR1.CUR_NAME, CUR2.CUR_NAME, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,NULL,NULL,NULL,
                         OPEDIS_LATITUDE, OPEDIS_LONGITUDE, OPEDIS_ID,OPEDIS_APP_VERSION,
						 NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE,
						 NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE,
						 NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION,
						 OPEDIS_PERC_VAT1, OPEDIS_PERC_VAT2, OPEDIS_PARTIAL_VAT1,
						 OPEDIS_PERC_FEE, OPEDIS_PERC_FEE_TOPPED, OPEDIS_PARTIAL_PERC_FEE,
						 OPEDIS_FIXED_FEE, OPEDIS_PARTIAL_FIXED_FEE,
						 0, 0,
						 ISNULL(OPEDIS_TOTAL_AMOUNT, OPEDIS_AMOUNT),
						 NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
						 NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM            dbo.OPERATIONS_DISCOUNTS INNER JOIN
                         dbo.CURRENCIES CUR1 ON OPEDIS_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON OPEDIS_BALANCE_CUR_ID = CUR2.CUR_ID INNER JOIN
                         dbo.USERS ON OPEDIS_USR_ID = USR_ID

UNION ALL
SELECT        OPEOFF_TYPE, OPEOFF_USR_ID, OPEOFF_MOSE_OS, OPEOFF_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, 
				CASE OPEOFF_TYPE WHEN 8 THEN OPEOFF_NOTIFY_ENTRY_DATE ELSE OPEOFF_PAYMENT_DATE END, 
				CASE OPEOFF_TYPE WHEN 8 THEN OPEOFF_UTC_NOTIFY_ENTRY_DATE ELSE OPEOFF_UTC_PAYMENT_DATE END, 
				OPEOFF_ENTRY_DATE, OPEOFF_END_DATE, 
                CAST(-OPEOFF_AMOUNT AS int),CAST(-OPEOFF_AMOUNT AS int), OPEOFF_TIME, OPEOFF_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, 
                CAST(-OPEOFF_FINAL_AMOUNT AS int), OPEOFF_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
                OPEOFF_CHANGE_APPLIED, USRP_ID, USRP_PLATE, NULL TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, GRP_ID, NULL, ISNULL(GRP_DESCRIPTION2,GRP_DESCRIPTION) GRP_DESCRIPTION, NULL, 
                OPEOFF_SUSCRIPTION_TYPE, OPEOFF_BALANCE_BEFORE, OPEOFF_INSERTION_UTC_DATE, OPEOFF_CUSPMR_ID, OPEOFF_OPEDIS_ID, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, 
                CUR3.CUR_ISO_CODE CUSPMR_AMOUNT_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, OPEDIS_DATE, OPEDIS_AMOUNT, OPEDIS_AMOUNT_CUR_ID, 
                CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, 
                OPEDIS_BALANCE_BEFORE, OPEDIS_INSERTION_UTC_DATE, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
                CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, 
				CASE OPEOFF_TYPE WHEN 8 THEN OPEOFF_NOTIFY_ENTRY_DATE_UTC_OFFSET ELSE OPEOFF_PAYMENT_DATE_UTC_OFFSET END,
				OPEOFF_ENTRY_DATE_UTC_OFFSET, OPEOFF_END_DATE_UTC_OFFSET, 
				CUSPMR_DATE_UTC_OFFSET OPE_CUSPMR_DATE_UTC_OFFSET, OPEDIS_DATE_UTC_OFFSET OPE_OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, 
                CUR1.CUR_NAME OPE_AMOUNT_CUR_NAME, CUR2.CUR_NAME OPE_BALANCE_CUR_NAME, CUR3.CUR_NAME CUSPMR_CUR_NAME, CUR4.CUR_NAME OPEDIS_AMOUNT_CUR_NAME, 
                CUR5.CUR_NAME OPEDIS_BALANCE_CUR_NAME, OPEOFF_EXTERNAL_ID1, OPEOFF_EXTERNAL_ID2, OPEOFF_EXTERNAL_ID3, 
				OPEOFF_CONFIRMED_IN_WS1, OPEOFF_CONFIRMED_IN_WS2, OPEOFF_CONFIRMED_IN_WS3,
				OPEOFF_CONFIRMATION_TIME_IN_WS1, OPEOFF_QUEUE_LENGTH_BEFORE_CONFIRM_WS1,OPEOFF_CONFIRMATION_TIME_IN_WS2, OPEOFF_QUEUE_LENGTH_BEFORE_CONFIRM_WS2,OPEOFF_CONFIRMATION_TIME_IN_WS3, OPEOFF_QUEUE_LENGTH_BEFORE_CONFIRM_WS3,
				OPEOFF_LATITUDE, OPEOFF_LONGITUDE, OPEOFF_ID, OPEOFF_APP_VERSION,
				OPEOFF_ENTRY_DATE, OPEOFF_NOTIFY_ENTRY_DATE, OPEOFF_PAYMENT_DATE, OPEOFF_END_DATE, OPEOFF_EXIT_LIMIT_DATE, OPEOFF_EXIT_DATE,
				OPEOFF_UTC_ENTRY_DATE, OPEOFF_UTC_NOTIFY_ENTRY_DATE, OPEOFF_UTC_PAYMENT_DATE, OPEOFF_UTC_END_DATE, OPEOFF_UTC_EXIT_LIMIT_DATE, OPEOFF_UTC_EXIT_DATE,
				OPEOFF_LOGICAL_ID, OPEOFF_TARIFF, OPEOFF_GATE, OPEOFF_SPACE_DESCRIPTION,
				OPEOFF_PERC_VAT1, OPEOFF_PERC_VAT2, -OPEOFF_PARTIAL_VAT1,
				OPEOFF_PERC_FEE, OPEOFF_PERC_FEE_TOPPED, -OPEOFF_PARTIAL_PERC_FEE,
				OPEOFF_FIXED_FEE, -OPEOFF_PARTIAL_FIXED_FEE,
				0,0,
				-ISNULL(OPEOFF_TOTAL_AMOUNT, OPEOFF_AMOUNT) OPE_TOTAL_AMOUNT,
				NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
				NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM            dbo.OPERATIONS_OFFSTREET LEFT OUTER JOIN
                         dbo.USER_PLATES ON dbo.OPERATIONS_OFFSTREET.OPEOFF_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                         dbo.CURRENCIES CUR1 ON OPEOFF_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON OPEOFF_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                         dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON dbo.OPERATIONS_OFFSTREET.OPEOFF_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID LEFT OUTER JOIN
                         dbo.OPERATIONS_DISCOUNTS ON dbo.OPERATIONS_OFFSTREET.OPEOFF_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID INNER JOIN
                         dbo.USERS ON OPEOFF_USR_ID = USR_ID LEFT OUTER JOIN
                         dbo.GROUPS ON OPEOFF_GRP_ID = GRP_ID, INSTALLATIONS
WHERE        OPEOFF_INS_ID = INS_ID

UNION ALL

SELECT        14, BAT_SRC_USR_ID, BAT_MOSE_OS, NULL, NULL, NULL, BAT_DATE, BAT_UTC_DATE, NULL, NULL, 
                         -BAT_AMOUNT,-BAT_AMOUNT, NULL, BAT_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, 
                         -BAT_AMOUNT, BAT_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
                         BAT_CHANGE_APPLIED, NULL, NULL, NULL TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, NULL, NULL, NULL GRP_DESCRIPTION, NULL, 
                         1 OPE_SUSCRIPTION_TYPE, BAT_SRC_BALANCE_BEFORE, BAT_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, 
                         NULL, NULL, NULL, NULL, NULL, NULL, 
                         NULL, NULL, NULL, NULL, NULL, 
                         NULL, NULL, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
                         CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, NULL, NULL, 
                         NULL, NULL, NULL, USR_USERNAME, 
                         CUR1.CUR_NAME OPE_AMOUNT_CUR_NAME, CUR1.CUR_NAME OPE_BALANCE_CUR_NAME, NULL, NULL, 
                         NULL OPEDIS_BALANCE_CUR_NAME, NULL, NULL, NULL, 
						 NULL, NULL, NULL,
						 NULL, NULL, NULL, NULL, NULL , NULL,
						 NULL, NULL, BAT_ID, BAT_APP_VERSION,
						 NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE,
						 NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE,
						 NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION,
						 NULL, NULL, NULL OPE_PARTIAL_VAT1,
						 NULL, NULL, NULL OPE_PARTIAL_PERC_FEE,
						 NULL, NULL OPE_PARTIAL_FIXED_FEE,
						 NULL OPE_PERC_BONUS, NULL OPE_PARTIAL_BONUS_FEE,
						 -BAT_AMOUNT OPE_TOTAL_AMOUNT,
						 NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY,
						 BAT_SHOPKEEPER_OP, BAT_SHOPKEEPER_COLLECTED_AMOUNT, BAT_SHOPKEEPER_PROFIT,
						 NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM            dbo.BALANCE_TRANSFERS LEFT OUTER JOIN                         
                         dbo.CURRENCIES CUR1 ON BAT_AMOUNT_CUR_ID = CUR1.CUR_ID LEFT OUTER JOIN                                                  
                         dbo.USERS ON BAT_SRC_USR_ID = USR_ID

UNION ALL

SELECT        15, BAT_DST_USR_ID, BAT_MOSE_OS, NULL, NULL, NULL, BAT_DATE, BAT_UTC_DATE, NULL, NULL, 
                         BAT_DST_AMOUNT,BAT_DST_AMOUNT, NULL, BAT_DST_BALANCE_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, 
                         BAT_DST_AMOUNT, BAT_DST_BALANCE_CUR_ID, CUR1.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
                         BAT_CHANGE_APPLIED, NULL, NULL, NULL TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, NULL, NULL, NULL GRP_DESCRIPTION, NULL, 
                         1 OPE_SUSCRIPTION_TYPE, BAT_DST_BALANCE_BEFORE, BAT_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, 
                         NULL, NULL, NULL, NULL, NULL, NULL, 
                         NULL, NULL, NULL, NULL, NULL, 
                         NULL, NULL, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
                         CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, NULL, NULL, 
                         NULL, NULL, NULL, USR_USERNAME, 
                         CUR1.CUR_NAME OPE_AMOUNT_CUR_NAME, CUR1.CUR_NAME OPE_BALANCE_CUR_NAME, NULL, NULL, 
                         NULL OPEDIS_BALANCE_CUR_NAME, NULL, NULL, NULL, 
						 NULL, NULL, NULL,
						 NULL, NULL, NULL, NULL, NULL , NULL,
						 NULL, NULL, BAT_ID, BAT_APP_VERSION,
						 NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE,
						 NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE,
						 NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION,
						 NULL, NULL, NULL OPE_PARTIAL_VAT1,
						 NULL, NULL, NULL OPE_PARTIAL_PERC_FEE,
						 NULL, NULL OPE_PARTIAL_FIXED_FEE,
						 NULL OPE_PERC_BONUS, NULL OPE_PARTIAL_BONUS_FEE,
						 BAT_AMOUNT OPE_TOTAL_AMOUNT,
						 NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY,
						 BAT_SHOPKEEPER_OP, BAT_SHOPKEEPER_COLLECTED_AMOUNT, BAT_SHOPKEEPER_PROFIT,
						 NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM            dbo.BALANCE_TRANSFERS LEFT OUTER JOIN                                                  
                         dbo.CURRENCIES CUR1 ON BAT_DST_BALANCE_CUR_ID = CUR1.CUR_ID LEFT OUTER JOIN                                                  
                         dbo.USERS ON BAT_DST_USR_ID = USR_ID

UNION ALL

SELECT        TOLM_TYPE, TOLM_USR_ID, TOLM_MOSE_OS, TOLM_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, TOLM_DATE, TOLM_UTC_DATE, NULL, NULL, 
                         CAST(CASE WHEN TOLM_TYPE = 18 THEN TOLM_AMOUNT ELSE - TOLM_AMOUNT END AS int) OPE_AMOUNT, 
						 CAST(CASE WHEN TOLM_TYPE = 18 THEN TOLM_AMOUNT ELSE - TOLM_AMOUNT END AS int) OPE_REAL_AMOUNT,NULL, TOLM_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, 
                         CAST(CASE WHEN TOLM_TYPE = 18 THEN TOLM_FINAL_AMOUNT ELSE - TOLM_FINAL_AMOUNT END AS int) OPE_FINAL_AMOUNT, TOLM_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
                         TOLM_CHANGE_APPLIED, USRP_ID, USRP_PLATE, NULL TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, NULL/*TOL_ID*/, NULL, NULL, TOLM_TOL_TARIFF, 
                         TOLM_SUSCRIPTION_TYPE, TOLM_BALANCE_BEFORE, TOLM_INSERTION_UTC_DATE, TOLM_CUSPMR_ID, NULL, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, 
                         CUR3.CUR_ISO_CODE CUSPMR_AMOUNT_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, NULL, NULL, NULL, 
                         NULL OPEDIS_AMOUNT_CUR_ISO_CODE, NULL, NULL, NULL OPEDIS_BALANCE_CUR_ISO_CODE, NULL, 
                         NULL, NULL, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
                         CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, TOLM_DATE_UTC_OFFSET, NULL, 
                         NULL, CUSPMR_DATE_UTC_OFFSET OPE_CUSPMR_DATE_UTC_OFFSET, NULL OPE_OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, 
                         CUR1.CUR_NAME OPE_AMOUNT_CUR_NAME, CUR2.CUR_NAME OPE_BALANCE_CUR_NAME, CUR3.CUR_NAME CUSPMR_CUR_NAME, NULL OPEDIS_AMOUNT_CUR_NAME, 
                         NULL OPEDIS_BALANCE_CUR_NAME, TOLM_EXTERNAL_ID, NULL, NULL, 
				NULL, NULL, NULL,
				NULL, NULL,NULL, NULL,NULL, NULL,
				TOLM_LATITUDE, TOLM_LONGITUDE, TOLM_ID,TOLM_APP_VERSION,
				NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE,
				NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE,
				NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION,
				TOLM_PERC_VAT1, TOLM_PERC_VAT2, CAST( CASE WHEN TOLM_TYPE = 18 THEN TOLM_PARTIAL_VAT1 ELSE -TOLM_PARTIAL_VAT1 END AS int) OPE_PARTIAL_VAT1,
				TOLM_PERC_FEE, TOLM_PERC_FEE_TOPPED, CAST( CASE WHEN TOLM_TYPE = 18 THEN TOLM_PARTIAL_PERC_FEE ELSE -TOLM_PARTIAL_PERC_FEE END AS int) OPE_PARTIAL_PERC_FEE,
				TOLM_FIXED_FEE, CAST( CASE WHEN TOLM_TYPE = 18 THEN TOLM_PARTIAL_FIXED_FEE ELSE -TOLM_PARTIAL_FIXED_FEE END AS int) OPE_PARTIAL_FIXED_FEE,
				0 OPE_PERC_BONUS, 0 OPE_PARTIAL_BONUS_FEE,
				CAST( CASE WHEN TOLM_TYPE = 18 THEN ISNULL(TOLM_TOTAL_AMOUNT, TOLM_AMOUNT) ELSE -ISNULL(TOLM_TOTAL_AMOUNT, TOLM_AMOUNT) END AS int) OPE_TOTAL_AMOUNT,
				NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
				NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM            dbo.TOLL_MOVEMENTS LEFT OUTER JOIN
                         dbo.USER_PLATES ON dbo.TOLL_MOVEMENTS.TOLM_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                         dbo.CURRENCIES CUR1 ON TOLM_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON TOLM_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                         dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON dbo.TOLL_MOVEMENTS.TOLM_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID LEFT OUTER JOIN                         
                         dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                         dbo.USERS ON TOLM_USR_ID = USR_ID LEFT OUTER JOIN
                         dbo.TOLLS ON TOLM_TOL_ID = TOL_ID, INSTALLATIONS
WHERE        TOLM_INS_ID = INS_ID

GO




/****** Object:  View [dbo].[ALL_OPERATIONS_EXT_NORECHARGES]    Script Date: 7/8/2021 5:13:35 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER VIEW [dbo].[ALL_OPERATIONS_EXT_NORECHARGES]
AS
SELECT        CASE ISNULL(TAR_TYPE, 0) WHEN 1 THEN 19 ELSE OPE_TYPE END AS OPE_TYPE, OPE_USR_ID, OPE_MOSE_OS, OPE_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, OPE_DATE, OPE_UTC_DATE, OPE_INIDATE, OPE_ENDDATE, 
                         CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_AMOUNT ELSE - OPE_AMOUNT END AS int) OPE_AMOUNT, 
						 CAST( CASE 
					  WHEN OPE_TYPE = 3
						 THEN ISNULL(OPE_REAL_AMOUNT,OPE_AMOUNT) 
					  ELSE -ISNULL(OPE_REAL_AMOUNT,OPE_AMOUNT) 
				 END AS int) OPE_REAL_AMOUNT,
						 OPE_TIME, OPE_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, 
                         CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_FINAL_AMOUNT ELSE - OPE_FINAL_AMOUNT END AS int) OPE_FINAL_AMOUNT, OPE_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
                         OPE_CHANGE_APPLIED, USER_PLATES.USRP_ID, USER_PLATES.USRP_PLATE, NULL TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, GRP_ID, TAR_ID, ISNULL(GRP_DESCRIPTION2,GRP_DESCRIPTION) GRP_DESCRIPTION, TAR_DESCRIPTION, 
                         OPE_SUSCRIPTION_TYPE, OPE_BALANCE_BEFORE, OPE_INSERTION_UTC_DATE, OPE_CUSPMR_ID, OPE_OPEDIS_ID, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, 
                         CUR3.CUR_ISO_CODE CUSPMR_AMOUNT_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, OPEDIS_DATE, OPEDIS_AMOUNT, OPEDIS_AMOUNT_CUR_ID, 
                         CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, 
                         OPEDIS_BALANCE_BEFORE, OPEDIS_INSERTION_UTC_DATE, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
                         CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, OPE_DATE_UTC_OFFSET, OPE_INIDATE_UTC_OFFSET, 
                         OPE_ENDDATE_UTC_OFFSET, CUSPMR_DATE_UTC_OFFSET OPE_CUSPMR_DATE_UTC_OFFSET, OPEDIS_DATE_UTC_OFFSET OPE_OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, 
                         CUR1.CUR_NAME OPE_AMOUNT_CUR_NAME, CUR2.CUR_NAME OPE_BALANCE_CUR_NAME, CUR3.CUR_NAME CUSPMR_CUR_NAME, CUR4.CUR_NAME OPEDIS_AMOUNT_CUR_NAME, 
                         CUR5.CUR_NAME OPEDIS_BALANCE_CUR_NAME, HIS_OPERATIONS.OPE_EXTERNAL_ID1, HIS_OPERATIONS.OPE_EXTERNAL_ID2, HIS_OPERATIONS.OPE_EXTERNAL_ID3, 
				OPE_CONFIRMED_IN_WS1, OPE_CONFIRMED_IN_WS2, OPE_CONFIRMED_IN_WS3,
				OPE_CONFIRMATION_TIME_IN_WS1, OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS1,OPE_CONFIRMATION_TIME_IN_WS2, OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS2,OPE_CONFIRMATION_TIME_IN_WS3, OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS3,
				OPE_LATITUDE, OPE_LONGITUDE, OPE_ID,OPE_APP_VERSION,
				NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE,
				NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE,
				NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION,
				OPE_PERC_VAT1, OPE_PERC_VAT2, CAST( CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_VAT1 ELSE -OPE_PARTIAL_VAT1 END AS int) OPE_PARTIAL_VAT1,
				OPE_PERC_FEE, OPE_PERC_FEE_TOPPED, CAST( CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_PERC_FEE ELSE -OPE_PARTIAL_PERC_FEE END AS int) OPE_PARTIAL_PERC_FEE,
				OPE_FIXED_FEE, CAST( CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_FIXED_FEE ELSE -OPE_PARTIAL_FIXED_FEE END AS int) OPE_PARTIAL_FIXED_FEE,
				ISNULL(OPE_PERC_BONUS, 0) OPE_PERC_BONUS, CAST ( ISNULL(OPE_PARTIAL_BONUS_FEE, 0) AS int) OPE_PARTIAL_BONUS_FEE,
				CAST( CASE WHEN OPE_TYPE = 3 THEN ISNULL(OPE_TOTAL_AMOUNT, OPE_AMOUNT) ELSE -ISNULL(OPE_TOTAL_AMOUNT, OPE_AMOUNT) END AS int) OPE_TOTAL_AMOUNT,
					CAST( CASE 
					  WHEN OPE_TYPE = 3
						 THEN OPE_TIME_BALANCE_USED 
					  ELSE -OPE_TIME_BALANCE_USED 
				 END AS int) OPE_TIME_BALANCE_USED, OPE_TIME_BALANCE_BEFORE, OPE_POSTPAY, OPE_SHOPKEEPER_OP, OPE_SHOPKEEPER_AMOUNT, OPE_SHOPKEEPER_PROFIT,
				 INSTALLATIONS.INS_STANDARD_CITY_ID,
				 UP2.USRP_PLATE USRP_PLATE2, UP3.USRP_PLATE USRP_PLATE3, UP4.USRP_PLATE USRP_PLATE4, UP5.USRP_PLATE USRP_PLATE5, 
							 UP6.USRP_PLATE USRP_PLATE6, UP7.USRP_PLATE USRP_PLATE7, UP8.USRP_PLATE USRP_PLATE8, UP9.USRP_PLATE USRP_PLATE9, UP10.USRP_PLATE USRP_PLATE10
FROM            dbo.HIS_OPERATIONS LEFT OUTER JOIN
                         dbo.USER_PLATES ON dbo.HIS_OPERATIONS.OPE_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                         dbo.CURRENCIES CUR1 ON OPE_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON OPE_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                         dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON dbo.HIS_OPERATIONS.OPE_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID LEFT OUTER JOIN
                         dbo.OPERATIONS_DISCOUNTS ON dbo.HIS_OPERATIONS.OPE_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID INNER JOIN
                         dbo.USERS ON OPE_USR_ID = USR_ID LEFT OUTER JOIN
                         dbo.GROUPS ON OPE_GRP_ID = GRP_ID LEFT OUTER JOIN
                         dbo.TARIFFS ON OPE_TAR_ID = TAR_ID
						 LEFT OUTER JOIN dbo.USER_PLATES UP2 ON dbo.HIS_OPERATIONS.OPE_PLATE2_USRP_ID = UP2.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP3 ON dbo.HIS_OPERATIONS.OPE_PLATE3_USRP_ID = UP3.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP4 ON dbo.HIS_OPERATIONS.OPE_PLATE4_USRP_ID = UP4.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP5 ON dbo.HIS_OPERATIONS.OPE_PLATE5_USRP_ID = UP5.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP6 ON dbo.HIS_OPERATIONS.OPE_PLATE6_USRP_ID = UP6.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP7 ON dbo.HIS_OPERATIONS.OPE_PLATE7_USRP_ID = UP7.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP8 ON dbo.HIS_OPERATIONS.OPE_PLATE8_USRP_ID = UP8.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP9 ON dbo.HIS_OPERATIONS.OPE_PLATE9_USRP_ID = UP9.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP10 ON dbo.HIS_OPERATIONS.OPE_PLATE10_USRP_ID = UP10.USRP_ID
						 , INSTALLATIONS
WHERE        OPE_INS_ID = INS_ID
UNION ALL
SELECT        4 OPE_TYPE, TIPA_USR_ID, TIPA_MOSE_OS, TIPA_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, TIPA_DATE, TIPA_UTC_DATE, NULL, NULL, - TIPA_AMOUNT TIPA_AMOUNT, -TIPA_AMOUNT, NULL, TIPA_AMOUNT_CUR_ID, 
                         CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, - TIPA_FINAL_AMOUNT, TIPA_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, TIPA_CHANGE_APPLIED, USRP_ID, 
                         TIPA_PLATE_STRING, TIPA_TICKET_NUMBER, TIPA_TICKET_DATA, NULL, GRP_ID, NULL, ISNULL(GRP_DESCRIPTION2,GRP_DESCRIPTION) GRP_DESCRIPTION, NULL, TIPA_SUSCRIPTION_TYPE, TIPA_BALANCE_BEFORE, TIPA_INSERTION_UTC_DATE, TIPA_CUSPMR_ID, 
                         TIPA_OPEDIS_ID, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, CUR3.CUR_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, OPEDIS_DATE, OPEDIS_AMOUNT, 
                         OPEDIS_AMOUNT_CUR_ID, CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, 
                         OPEDIS_CHANGE_APPLIED, OPEDIS_BALANCE_BEFORE, OPEDIS_INSERTION_UTC_DATE, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL 
                         CUSPMR_CARD_HASH, NULL CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, 
                         TIPA_DATE_UTC_OFFSET, NULL, NULL, CUSPMR_DATE_UTC_OFFSET, OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, CUR1.CUR_NAME, CUR2.CUR_NAME, CUR3.CUR_NAME, CUR4.CUR_NAME, 
                         CUR5.CUR_NAME, NULL, NULL, NULL, TIPA_CONFIRMED_IN_WS,NULL,NULL,
						 TIPA_CONFIRMATION_TIME_IN_WS, TIPA_QUEUE_LENGTH_BEFORE_CONFIRM_WS, NULL,NULL,NULL,NULL,
						 TIPA_LATITUDE, TIPA_LONGITUDE, TIPA_ID,TIPA_APP_VERSION,
						 NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE,
						 NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE,
						 NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION,
						 TIPA_PERC_VAT1, TIPA_PERC_VAT2, - TIPA_PARTIAL_VAT1,
						 TIPA_PERC_FEE, TIPA_PERC_FEE_TOPPED, - TIPA_PARTIAL_PERC_FEE,
						 TIPA_FIXED_FEE, - TIPA_PARTIAL_FIXED_FEE,
						 0, 0,
						 -ISNULL(TIPA_TOTAL_AMOUNT, TIPA_AMOUNT), NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
						 INSTALLATIONS.INS_STANDARD_CITY_ID,
						 NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM            dbo.TICKET_PAYMENTS LEFT OUTER JOIN
                         dbo.USER_PLATES ON dbo.TICKET_PAYMENTS.TIPA_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                         dbo.CURRENCIES CUR1 ON TIPA_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON TIPA_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                         dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON dbo.TICKET_PAYMENTS.TIPA_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID LEFT OUTER JOIN
                         dbo.OPERATIONS_DISCOUNTS ON dbo.TICKET_PAYMENTS.TIPA_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID INNER JOIN
                         dbo.USERS ON TIPA_USR_ID = USR_ID LEFT OUTER JOIN
						 dbo.GROUPS ON TIPA_GRP_ID = GRP_ID,
						 INSTALLATIONS 
WHERE        TIPA_INS_ID = INS_ID
UNION ALL
SELECT        6 OPE_TYPE, SECH_USR_ID, SECH_MOSE_OS, NULL, NULL, NULL, SECH_DATE, SECH_UTC_DATE, NULL, NULL, - SECH_AMOUNT, -SECH_AMOUNT, NULL, SECH_AMOUNT_CUR_ID, 
                         CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, - SECH_FINAL_AMOUNT, SECH_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
                         SECH_CHANGE_APPLIED, NULL, NULL, NULL, NULL, SECH_SECHT_ID, NULL, NULL, NULL, NULL, SECH_SUSCRIPTION_TYPE, SECH_BALANCE_BEFORE, SECH_INSERTION_UTC_DATE, 
                         SECH_CUSPMR_ID, NULL, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, CUR3.CUR_ISO_CODE, CUSPMR_BALANCE_BEFORE, 
                         CUSPMR_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL 
                         CUSPMR_CARD_HASH, NULL CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, 
                         SECH_DATE_UTC_OFFSET, NULL, NULL, CUSPMR_DATE_UTC_OFFSET, NULL, USR_USERNAME, CUR1.CUR_NAME, CUR2.CUR_NAME, CUR3.CUR_NAME, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,NULL,NULL,NULL,
                         SECH_ID,SECH_APP_VERSION,
						 NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE,
						 NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE,
						 NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION,
						 SECH_PERC_VAT1, SECH_PERC_VAT2, - SECH_PARTIAL_VAT1,
						 SECH_PERC_FEE, SECH_PERC_FEE_TOPPED, - SECH_PARTIAL_PERC_FEE,
						 SECH_FIXED_FEE, - SECH_PARTIAL_FIXED_FEE,
						 0, 0,
						 - ISNULL(SECH_TOTAL_AMOUNT, SECH_AMOUNT), NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
						 NULL,
						 NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM            dbo.SERVICE_CHARGES INNER JOIN
                         dbo.CURRENCIES CUR1 ON SECH_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON SECH_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                         dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON dbo.SERVICE_CHARGES.SECH_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID INNER JOIN
                         dbo.USERS ON SECH_USR_ID = USR_ID
UNION ALL
SELECT        7 OPE_TYPE, OPEDIS_USR_ID, OPEDIS_MOSE_OS, NULL, NULL, NULL, OPEDIS_DATE, OPEDIS_UTC_DATE, NULL, NULL, OPEDIS_AMOUNT, OPEDIS_AMOUNT, NULL, OPEDIS_AMOUNT_CUR_ID, 
                         CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
                         OPEDIS_CHANGE_APPLIED, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, OPEDIS_SUSCRIPTION_TYPE, OPEDIS_BALANCE_BEFORE, 
                         OPEDIS_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL CUSPMR_OP_REFERENCE, NULL 
                         CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL 
                         CUSPMR_CARD_EXPIRATION_DATE, OPEDIS_DATE_UTC_OFFSET, NULL, NULL, NULL, NULL, USR_USERNAME, CUR1.CUR_NAME, CUR2.CUR_NAME, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,NULL,NULL,NULL,
                         OPEDIS_LATITUDE, OPEDIS_LONGITUDE, OPEDIS_ID,OPEDIS_APP_VERSION,
						 NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE,
						 NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE,
						 NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION,
						 OPEDIS_PERC_VAT1, OPEDIS_PERC_VAT2, OPEDIS_PARTIAL_VAT1,
						 OPEDIS_PERC_FEE, OPEDIS_PERC_FEE_TOPPED, OPEDIS_PARTIAL_PERC_FEE,
						 OPEDIS_FIXED_FEE, OPEDIS_PARTIAL_FIXED_FEE,
						 0, 0,
						 ISNULL(OPEDIS_TOTAL_AMOUNT, OPEDIS_AMOUNT), NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
						 NULL,
						 NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM            dbo.OPERATIONS_DISCOUNTS INNER JOIN
                         dbo.CURRENCIES CUR1 ON OPEDIS_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON OPEDIS_BALANCE_CUR_ID = CUR2.CUR_ID INNER JOIN
                         dbo.USERS ON OPEDIS_USR_ID = USR_ID

UNION ALL
SELECT        OPEOFF_TYPE, OPEOFF_USR_ID, OPEOFF_MOSE_OS, OPEOFF_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, 
				CASE OPEOFF_TYPE WHEN 8 THEN OPEOFF_NOTIFY_ENTRY_DATE ELSE OPEOFF_PAYMENT_DATE END, 
				CASE OPEOFF_TYPE WHEN 8 THEN OPEOFF_UTC_NOTIFY_ENTRY_DATE ELSE OPEOFF_UTC_PAYMENT_DATE END, 
				OPEOFF_ENTRY_DATE, OPEOFF_END_DATE, 
                CAST(-OPEOFF_AMOUNT AS int), CAST(-OPEOFF_AMOUNT AS int),OPEOFF_TIME, OPEOFF_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, 
                CAST(-OPEOFF_FINAL_AMOUNT AS int), OPEOFF_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
                OPEOFF_CHANGE_APPLIED, USRP_ID, USRP_PLATE, NULL TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, GRP_ID, NULL, ISNULL(GRP_DESCRIPTION2,GRP_DESCRIPTION) GRP_DESCRIPTION, NULL, 
                OPEOFF_SUSCRIPTION_TYPE, OPEOFF_BALANCE_BEFORE, OPEOFF_INSERTION_UTC_DATE, OPEOFF_CUSPMR_ID, OPEOFF_OPEDIS_ID, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, 
                CUR3.CUR_ISO_CODE CUSPMR_AMOUNT_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, OPEDIS_DATE, OPEDIS_AMOUNT, OPEDIS_AMOUNT_CUR_ID, 
                CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, 
                OPEDIS_BALANCE_BEFORE, OPEDIS_INSERTION_UTC_DATE, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
                CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, 
				CASE OPEOFF_TYPE WHEN 8 THEN OPEOFF_NOTIFY_ENTRY_DATE_UTC_OFFSET ELSE OPEOFF_PAYMENT_DATE_UTC_OFFSET END,
				OPEOFF_ENTRY_DATE_UTC_OFFSET, OPEOFF_END_DATE_UTC_OFFSET, 
				CUSPMR_DATE_UTC_OFFSET OPE_CUSPMR_DATE_UTC_OFFSET, OPEDIS_DATE_UTC_OFFSET OPE_OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, 
                CUR1.CUR_NAME OPE_AMOUNT_CUR_NAME, CUR2.CUR_NAME OPE_BALANCE_CUR_NAME, CUR3.CUR_NAME CUSPMR_CUR_NAME, CUR4.CUR_NAME OPEDIS_AMOUNT_CUR_NAME, 
                CUR5.CUR_NAME OPEDIS_BALANCE_CUR_NAME, OPEOFF_EXTERNAL_ID1, OPEOFF_EXTERNAL_ID2, OPEOFF_EXTERNAL_ID3, 
				OPEOFF_CONFIRMED_IN_WS1, OPEOFF_CONFIRMED_IN_WS2, OPEOFF_CONFIRMED_IN_WS3,
				OPEOFF_CONFIRMATION_TIME_IN_WS1, OPEOFF_QUEUE_LENGTH_BEFORE_CONFIRM_WS1,OPEOFF_CONFIRMATION_TIME_IN_WS2, OPEOFF_QUEUE_LENGTH_BEFORE_CONFIRM_WS2,OPEOFF_CONFIRMATION_TIME_IN_WS3, OPEOFF_QUEUE_LENGTH_BEFORE_CONFIRM_WS3,
				OPEOFF_LATITUDE, OPEOFF_LONGITUDE, OPEOFF_ID, OPEOFF_APP_VERSION,
				OPEOFF_ENTRY_DATE, OPEOFF_NOTIFY_ENTRY_DATE, OPEOFF_PAYMENT_DATE, OPEOFF_END_DATE, OPEOFF_EXIT_LIMIT_DATE, OPEOFF_EXIT_DATE,
				OPEOFF_UTC_ENTRY_DATE, OPEOFF_UTC_NOTIFY_ENTRY_DATE, OPEOFF_UTC_PAYMENT_DATE, OPEOFF_UTC_END_DATE, OPEOFF_UTC_EXIT_LIMIT_DATE, OPEOFF_UTC_EXIT_DATE,
				OPEOFF_LOGICAL_ID, OPEOFF_TARIFF, OPEOFF_GATE, OPEOFF_SPACE_DESCRIPTION,
				0, 0, 0,
				0, 0, 0,
				0, 0,
				0, 0,
				- OPEOFF_AMOUNT, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
				INSTALLATIONS.INS_STANDARD_CITY_ID,
						 NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM            dbo.OPERATIONS_OFFSTREET LEFT OUTER JOIN
                         dbo.USER_PLATES ON dbo.OPERATIONS_OFFSTREET.OPEOFF_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                         dbo.CURRENCIES CUR1 ON OPEOFF_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON OPEOFF_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                         dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON dbo.OPERATIONS_OFFSTREET.OPEOFF_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID LEFT OUTER JOIN
                         dbo.OPERATIONS_DISCOUNTS ON dbo.OPERATIONS_OFFSTREET.OPEOFF_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID INNER JOIN
                         dbo.USERS ON OPEOFF_USR_ID = USR_ID LEFT OUTER JOIN
                         dbo.GROUPS ON OPEOFF_GRP_ID = GRP_ID, INSTALLATIONS
WHERE        OPEOFF_INS_ID = INS_ID

GO


/****** Object:  View [dbo].[VW_CASH_RECHARGES_HOUR]    Script Date: 7/8/2021 5:15:01 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






ALTER VIEW [dbo].[VW_CASH_RECHARGES_HOUR]
AS
SELECT dateadd(hour, datediff(hour, 0, CUSPMR_UTC_DATE), 0) AS HOUR_UTC,
	   CUSPMR_FDO_ID FDO_ID, CUSPMR_INS_ID INS_ID, CUSPMR_BACKOFFICE_USR BACKOFFICE_USR,
	   CUR_ISO_CODE,
	   sum(CUSPMR_AMOUNT) AMOUNT,	   
	   sum(ISNULL(CUSPMR_PARTIAL_VAT1,0)) VAT,
	   sum(dbo.ToInt(  (ISNULL(CUSPMR_PARTIAL_PERC_FEE,0) - ((ISNULL(CUSPMR_PARTIAL_PERC_FEE,0) * ISNULL(CUSPMR_PERC_VAT2,0)) / (1 + ISNULL(CUSPMR_PERC_VAT2,0))))  )) PERC_FEE,
	   sum(dbo.ToInt(  ((ISNULL(CUSPMR_PARTIAL_PERC_FEE,0) * ISNULL(CUSPMR_PERC_VAT2,0)) / (1 + ISNULL(CUSPMR_PERC_VAT2,0)))  )) PERC_FEE_VAT,
	   sum(dbo.ToInt(  (ISNULL(CUSPMR_PARTIAL_FIXED_FEE,0) - ((ISNULL(CUSPMR_PARTIAL_FIXED_FEE,0) * ISNULL(CUSPMR_PERC_VAT2,0)) / (1 + ISNULL(CUSPMR_PERC_VAT2,0))))  )) FIXED_FEE,
	   sum(dbo.ToInt(  ((ISNULL(CUSPMR_PARTIAL_FIXED_FEE,0) * ISNULL(CUSPMR_PERC_VAT2,0)) / (1 + ISNULL(CUSPMR_PERC_VAT2,0)))  )) FIXED_FEE_VAT,
	   sum(ISNULL(ISNULL(CUSPMR_TOTAL_AMOUNT_CHARGED, CUSPMR_AMOUNT),0)) TOTAL_AMOUNT		   

FROM CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS 
		INNER JOIN CURRENCIES ON CUSPMR_CUR_ID = CUR_ID
		
WHERE CUSPMR_TYPE = 6
GROUP BY dateadd(hour, datediff(hour, 0, CUSPMR_UTC_DATE), 0), CUSPMR_FDO_ID, CUSPMR_INS_ID, CUSPMR_BACKOFFICE_USR, CUR_ISO_CODE








GO


/****** Object:  View [dbo].[VW_CUSTOMER_PAYMENT_MEANS_RECHARGES]    Script Date: 7/8/2021 5:16:08 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[VW_CUSTOMER_PAYMENT_MEANS_RECHARGES]
AS
SELECT        5 OPE_TYPE, CUSPMR_USR_ID, CUSPMR_MOSE_OS, CUSPMR_DATE, CUSPMR_UTC_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, 
                          CUR_ISO_CODE, CUSPMR_SUSCRIPTION_TYPE, CUSPMR_BALANCE_BEFORE, 
                          CUSPMR_INSERTION_UTC_DATE, CUSPMR_OP_REFERENCE, 
                          CUSPMR_TRANSACTION_ID, CUSPMR_AUTH_CODE, CUSPMR_CARD_HASH, CUSPMR_CARD_REFERENCE, CUSPMR_CARD_SCHEME, CUSPMR_MASKED_CARD_NUMBER, CUSPMR_CARD_EXPIRATION_DATE,
                          CUSPMR_DATE_UTC_OFFSET, USR_USERNAME, CUSPMR_LATITUDE, CUSPMR_LONGITUDE, CUSPMR_ID,CUSPMR_APP_VERSION,						  
						  CUSPMR_PERC_VAT1, CUSPMR_PERC_VAT2, CUSPMR_PARTIAL_VAT1,
						  CUSPMR_PERC_FEE, CUSPMR_PERC_FEE_TOPPED, CUSPMR_PARTIAL_PERC_FEE,
						  CUSPMR_FIXED_FEE, CUSPMR_PARTIAL_FIXED_FEE,
						  ISNULL(CUSPMR_TOTAL_AMOUNT_CHARGED, CUSPMR_AMOUNT) CUSPMR_TOTAL_AMOUNT,
						  USR_MAIN_TEL,
						  CUSPMR_TYPE, CUSPMR_PAGATELIA_NEW_BALANCE,
						  CUSPMR_CREATION_TYPE,
						  CUSPMR_PAYPAL_INTENT, CUSPMR_PAYPAL_TRANSACTION_FEE_VALUE, CUSPMR_PAYPAL_TRANSACTION_FEE_CURRENCY_ISOCODE, CUSPMR_PAYPAL_TRANSACTION_URL, CUSPMR_PAYPAL_TRANSACTION_REFUND_URL,
						  CUSPMR_INS_ID, INS_DESCRIPTION, INS_SHORTDESC,
						  CUSPMR_FDO_ID, CUSPMR_BACKOFFICE_USR,						  
						  CUSPMR_SRC_CUR_ID, CUSPMR_SRC_AMOUNT, CUSPMR_SRC_CHANGE_APPLIED, CUSPMR_SRC_CHANGE_FEE_APPLIED,
						  CUSPMR_CASHPAY_EXPIRATION_DATE, CUSPMR_CASHPAY_BARCODE, CUSPMR_CASHPAY_REFERENCE, CUSPMR_CASHPAY_PAYU_URL,
						  CUSPMR_BALANCE_BONIFICATION_AMOUNT
FROM            dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS INNER JOIN
                         dbo.USERS ON CUSPMR_USR_ID = USR_ID
						 LEFT JOIN INSTALLATIONS ON CUSPMR_INS_ID = INS_ID
						 , dbo.CURRENCIES
WHERE        CUSPMR_CUR_ID = CUR_ID AND (CUSPMR_SUSCRIPTION_TYPE = 1 OR
                         CUSPMR_SUSCRIPTION_TYPE IS NULL) AND (CUSPMR_TRANS_STATUS IN (1, 2, 3, 4, 7) OR CUSPMR_RCOUP_ID IS NOT NULL OR CUSPMR_TYPE IN (3,4, 6))

GO


/****** Object:  View [dbo].[VW_HIS_OPERATIONS]    Script Date: 7/8/2021 5:16:43 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER VIEW [dbo].[VW_HIS_OPERATIONS]
AS
SELECT        OPE_TYPE, OPE_USR_ID, OPE_MOSE_OS, OPE_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, OPE_DATE, OPE_UTC_DATE, OPE_INIDATE, OPE_ENDDATE, 
                         CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_AMOUNT ELSE - OPE_AMOUNT END AS int) OPE_AMOUNT, 
						  CAST( CASE 
					  WHEN OPE_TYPE = 3
						 THEN ISNULL(OPE_REAL_AMOUNT,OPE_AMOUNT) 
					  ELSE -ISNULL(OPE_REAL_AMOUNT,OPE_AMOUNT) 
				 END AS int) OPE_REAL_AMOUNT,
						 OPE_TIME, OPE_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, 
                         CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_FINAL_AMOUNT ELSE - OPE_FINAL_AMOUNT END AS int) OPE_FINAL_AMOUNT, OPE_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
                         OPE_CHANGE_APPLIED, USRP_ID, USRP_PLATE, NULL TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, GRP_ID, TAR_ID, ISNULL(GRP_DESCRIPTION2,GRP_DESCRIPTION) GRP_DESCRIPTION, TAR_DESCRIPTION, 
                         OPE_SUSCRIPTION_TYPE, OPE_BALANCE_BEFORE, OPE_INSERTION_UTC_DATE, OPE_CUSPMR_ID, OPE_OPEDIS_ID, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, 
                         CUR3.CUR_ISO_CODE CUSPMR_AMOUNT_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, OPEDIS_DATE, OPEDIS_AMOUNT, OPEDIS_AMOUNT_CUR_ID, 
                         CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, 
                         OPEDIS_BALANCE_BEFORE, OPEDIS_INSERTION_UTC_DATE,  CUSPMR_OP_REFERENCE,  CUSPMR_TRANSACTION_ID,  CUSPMR_AUTH_CODE,  CUSPMR_CARD_HASH,  
                         CUSPMR_CARD_REFERENCE,  CUSPMR_CARD_SCHEME,  CUSPMR_MASKED_CARD_NUMBER,  CUSPMR_CARD_EXPIRATION_DATE, OPE_DATE_UTC_OFFSET, OPE_INIDATE_UTC_OFFSET, 
                         OPE_ENDDATE_UTC_OFFSET, CUSPMR_DATE_UTC_OFFSET OPE_CUSPMR_DATE_UTC_OFFSET, OPEDIS_DATE_UTC_OFFSET OPE_OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, 
                         CUR1.CUR_NAME OPE_AMOUNT_CUR_NAME, CUR2.CUR_NAME OPE_BALANCE_CUR_NAME, CUR3.CUR_NAME CUSPMR_CUR_NAME, CUR4.CUR_NAME OPEDIS_AMOUNT_CUR_NAME, 
                         CUR5.CUR_NAME OPEDIS_BALANCE_CUR_NAME, HIS_OPERATIONS.OPE_EXTERNAL_ID1, HIS_OPERATIONS.OPE_EXTERNAL_ID2, HIS_OPERATIONS.OPE_EXTERNAL_ID3, 
				OPE_CONFIRMED_IN_WS1, OPE_CONFIRMED_IN_WS2, OPE_CONFIRMED_IN_WS3,
				OPE_CONFIRMATION_TIME_IN_WS1, OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS1,OPE_CONFIRMATION_TIME_IN_WS2, OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS2,OPE_CONFIRMATION_TIME_IN_WS3, OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS3,
				OPE_LATITUDE, OPE_LONGITUDE, OPE_ID,OPE_APP_VERSION,				
				OPE_PERC_VAT1, OPE_PERC_VAT2, CAST( CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_VAT1 ELSE -OPE_PARTIAL_VAT1 END AS int) OPE_PARTIAL_VAT1,
				OPE_PERC_FEE, OPE_PERC_FEE_TOPPED, CAST( CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_PERC_FEE ELSE -OPE_PARTIAL_PERC_FEE END AS int) OPE_PARTIAL_PERC_FEE,
				OPE_FIXED_FEE, CAST( CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_FIXED_FEE ELSE -OPE_PARTIAL_FIXED_FEE END AS int) OPE_PARTIAL_FIXED_FEE,
				ISNULL(OPE_PERC_BONUS, 0) OPE_PERC_BONUS, CAST ( ISNULL(OPE_PARTIAL_BONUS_FEE, 0) AS int) OPE_PARTIAL_BONUS_FEE,
				CAST( CASE WHEN OPE_TYPE = 3 THEN ISNULL(OPE_TOTAL_AMOUNT, OPE_AMOUNT) ELSE -ISNULL(OPE_TOTAL_AMOUNT, OPE_AMOUNT) END AS int) OPE_TOTAL_AMOUNT,
				USR_MAIN_TEL,
					CAST( CASE 
					  WHEN OPE_TYPE = 3
						 THEN OPE_TIME_BALANCE_USED 
					  ELSE -OPE_TIME_BALANCE_USED 
				 END AS int) OPE_TIME_BALANCE_USED, OPE_TIME_BALANCE_BEFORE, OPE_POSTPAY, OPE_SHOPKEEPER_OP, OPE_SHOPKEEPER_AMOUNT, OPE_SHOPKEEPER_PROFIT,
				 INSTALLATIONS.INS_STANDARD_CITY_ID
FROM            dbo.HIS_OPERATIONS LEFT OUTER JOIN
                         dbo.USER_PLATES ON dbo.HIS_OPERATIONS.OPE_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                         dbo.CURRENCIES CUR1 ON OPE_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON OPE_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                         dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON dbo.HIS_OPERATIONS.OPE_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID LEFT OUTER JOIN
                         dbo.OPERATIONS_DISCOUNTS ON dbo.HIS_OPERATIONS.OPE_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID INNER JOIN
                         dbo.USERS ON OPE_USR_ID = USR_ID LEFT OUTER JOIN
                         dbo.GROUPS ON OPE_GRP_ID = GRP_ID LEFT OUTER JOIN
                         dbo.TARIFFS ON OPE_TAR_ID = TAR_ID, INSTALLATIONS
WHERE        OPE_INS_ID = INS_ID







GO


/****** Object:  View [dbo].[VW_HIS_OPERATIONS_RESTRICTED]    Script Date: 7/8/2021 5:17:29 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER VIEW [dbo].[VW_HIS_OPERATIONS_RESTRICTED]
AS
SELECT        OPE_TYPE, OPE_USR_ID, OPE_MOSE_OS, OPE_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, OPE_DATE, OPE_UTC_DATE, OPE_INIDATE, OPE_ENDDATE, 
                         CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_AMOUNT ELSE - OPE_AMOUNT END AS int) OPE_AMOUNT, 
						 CAST( CASE 
					  WHEN OPE_TYPE = 3
						 THEN ISNULL(OPE_REAL_AMOUNT,OPE_AMOUNT) 
					  ELSE -ISNULL(OPE_REAL_AMOUNT,OPE_AMOUNT) 
				 END AS int) OPE_REAL_AMOUNT,
						 OPE_TIME, OPE_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, 
                         CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_FINAL_AMOUNT ELSE - OPE_FINAL_AMOUNT END AS int) OPE_FINAL_AMOUNT, OPE_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
                         OPE_CHANGE_APPLIED, USRP_ID, USRP_PLATE, NULL TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, GRP_ID, TAR_ID, ISNULL(GRP_DESCRIPTION2,GRP_DESCRIPTION) GRP_DESCRIPTION, TAR_DESCRIPTION, 
                         OPE_SUSCRIPTION_TYPE, OPE_BALANCE_BEFORE, OPE_INSERTION_UTC_DATE, OPE_CUSPMR_ID, OPE_OPEDIS_ID, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, 
                         CUR3.CUR_ISO_CODE CUSPMR_AMOUNT_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, OPEDIS_DATE, OPEDIS_AMOUNT, OPEDIS_AMOUNT_CUR_ID, 
                         CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, 
                         OPEDIS_BALANCE_BEFORE, OPEDIS_INSERTION_UTC_DATE, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
                         CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, OPE_DATE_UTC_OFFSET, OPE_INIDATE_UTC_OFFSET, 
                         OPE_ENDDATE_UTC_OFFSET, CUSPMR_DATE_UTC_OFFSET OPE_CUSPMR_DATE_UTC_OFFSET, OPEDIS_DATE_UTC_OFFSET OPE_OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, 
                         CUR1.CUR_NAME OPE_AMOUNT_CUR_NAME, CUR2.CUR_NAME OPE_BALANCE_CUR_NAME, CUR3.CUR_NAME CUSPMR_CUR_NAME, CUR4.CUR_NAME OPEDIS_AMOUNT_CUR_NAME, 
                         CUR5.CUR_NAME OPEDIS_BALANCE_CUR_NAME, HIS_OPERATIONS.OPE_EXTERNAL_ID1, HIS_OPERATIONS.OPE_EXTERNAL_ID2, HIS_OPERATIONS.OPE_EXTERNAL_ID3, 
				OPE_CONFIRMED_IN_WS1, OPE_CONFIRMED_IN_WS2, OPE_CONFIRMED_IN_WS3,
				OPE_CONFIRMATION_TIME_IN_WS1, OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS1,OPE_CONFIRMATION_TIME_IN_WS2, OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS2,OPE_CONFIRMATION_TIME_IN_WS3, OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS3,
				OPE_LATITUDE, OPE_LONGITUDE, OPE_ID,OPE_APP_VERSION,				
				OPE_PERC_VAT1, OPE_PERC_VAT2, CAST( CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_VAT1 ELSE -OPE_PARTIAL_VAT1 END AS int) OPE_PARTIAL_VAT1,
				OPE_PERC_FEE, OPE_PERC_FEE_TOPPED, CAST( CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_PERC_FEE ELSE -OPE_PARTIAL_PERC_FEE END AS int) OPE_PARTIAL_PERC_FEE,
				OPE_FIXED_FEE, CAST( CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_FIXED_FEE ELSE -OPE_PARTIAL_FIXED_FEE END AS int) OPE_PARTIAL_FIXED_FEE,
				ISNULL(OPE_PERC_BONUS, 0) OPE_PERC_BONUS, CAST ( ISNULL(OPE_PARTIAL_BONUS_FEE, 0) AS int) OPE_PARTIAL_BONUS_FEE,
				CAST( CASE WHEN OPE_TYPE = 3 THEN ISNULL(OPE_TOTAL_AMOUNT, OPE_AMOUNT) ELSE -ISNULL(OPE_TOTAL_AMOUNT, OPE_AMOUNT) END AS int) OPE_TOTAL_AMOUNT,
				USR_MAIN_TEL,
					CAST( CASE 
					  WHEN OPE_TYPE = 3
						 THEN OPE_TIME_BALANCE_USED 
					  ELSE -OPE_TIME_BALANCE_USED 
				 END AS int) OPE_TIME_BALANCE_USED, OPE_TIME_BALANCE_BEFORE, OPE_POSTPAY, OPE_SHOPKEEPER_OP, OPE_SHOPKEEPER_AMOUNT, OPE_SHOPKEEPER_PROFIT
FROM            dbo.HIS_OPERATIONS LEFT OUTER JOIN
                         dbo.USER_PLATES ON dbo.HIS_OPERATIONS.OPE_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                         dbo.CURRENCIES CUR1 ON OPE_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON OPE_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                         dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON dbo.HIS_OPERATIONS.OPE_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID LEFT OUTER JOIN
                         dbo.OPERATIONS_DISCOUNTS ON dbo.HIS_OPERATIONS.OPE_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID INNER JOIN
                         dbo.USERS ON OPE_USR_ID = USR_ID LEFT OUTER JOIN
                         dbo.GROUPS ON OPE_GRP_ID = GRP_ID LEFT OUTER JOIN
                         dbo.TARIFFS ON OPE_TAR_ID = TAR_ID, INSTALLATIONS
WHERE        OPE_INS_ID = INS_ID

UNION ALL

SELECT        4 OPE_TYPE, TIPA_USR_ID, TIPA_MOSE_OS, TIPA_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, TIPA_DATE, TIPA_UTC_DATE, NULL, NULL, - TIPA_AMOUNT TIPA_AMOUNT, -TIPA_AMOUNT, NULL, TIPA_AMOUNT_CUR_ID, 
                         CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, - TIPA_FINAL_AMOUNT, TIPA_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, TIPA_CHANGE_APPLIED, USRP_ID, 
                         TIPA_PLATE_STRING, TIPA_TICKET_NUMBER, TIPA_TICKET_DATA,  NULL, GRP_ID, NULL, ISNULL(GRP_DESCRIPTION2,GRP_DESCRIPTION) GRP_DESCRIPTION, NULL, TIPA_SUSCRIPTION_TYPE, TIPA_BALANCE_BEFORE, TIPA_INSERTION_UTC_DATE, TIPA_CUSPMR_ID, 
                         TIPA_OPEDIS_ID, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, CUR3.CUR_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, OPEDIS_DATE, OPEDIS_AMOUNT, 
                         OPEDIS_AMOUNT_CUR_ID, CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, 
                         OPEDIS_CHANGE_APPLIED, OPEDIS_BALANCE_BEFORE, OPEDIS_INSERTION_UTC_DATE, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL 
                         CUSPMR_CARD_HASH, NULL CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, 
                         TIPA_DATE_UTC_OFFSET, NULL, NULL, CUSPMR_DATE_UTC_OFFSET, OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, CUR1.CUR_NAME, CUR2.CUR_NAME, CUR3.CUR_NAME, CUR4.CUR_NAME, 
                         CUR5.CUR_NAME, NULL, NULL, NULL, TIPA_CONFIRMED_IN_WS,NULL,NULL,
						 TIPA_CONFIRMATION_TIME_IN_WS, TIPA_QUEUE_LENGTH_BEFORE_CONFIRM_WS, NULL,NULL,NULL,NULL,
						 TIPA_LATITUDE, TIPA_LONGITUDE, TIPA_ID,TIPA_APP_VERSION,						 
						 TIPA_PERC_VAT1, TIPA_PERC_VAT2, - TIPA_PARTIAL_VAT1,
						 TIPA_PERC_FEE, TIPA_PERC_FEE_TOPPED, - TIPA_PARTIAL_PERC_FEE,
						 TIPA_FIXED_FEE, - TIPA_PARTIAL_FIXED_FEE,
						 0, 0,
						 -ISNULL(TIPA_TOTAL_AMOUNT, TIPA_AMOUNT),
						 USR_MAIN_TEL, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY,0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT
FROM            dbo.TICKET_PAYMENTS LEFT OUTER JOIN
                         dbo.USER_PLATES ON dbo.TICKET_PAYMENTS.TIPA_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                         dbo.CURRENCIES CUR1 ON TIPA_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON TIPA_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                         dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON dbo.TICKET_PAYMENTS.TIPA_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID LEFT OUTER JOIN
                         dbo.OPERATIONS_DISCOUNTS ON dbo.TICKET_PAYMENTS.TIPA_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID INNER JOIN
                         dbo.USERS ON TIPA_USR_ID = USR_ID LEFT OUTER JOIN
						 dbo.GROUPS ON TIPA_GRP_ID = GRP_ID,
						 INSTALLATIONS 
WHERE        TIPA_INS_ID = INS_ID





GO







/****** Object:  View [dbo].[VW_START_STOP_HIS_OPERATIONS]    Script Date: 7/8/2021 5:20:07 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER VIEW [dbo].[VW_START_STOP_HIS_OPERATIONS]
AS

SELECT
	 OPE_TYPE, OPE_PARKING_MODE_STATUS, OPE_USR_ID, OPE_MOSE_OS, OPE_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, 
	 OPE_DATE, OPE_INIDATE, OPE_ENDDATE, OPE_UTC_DATE, OPE_UTC_INIDATE, OPE_UTC_ENDDATE, OPE_DATE_UTC_OFFSET, OPE_INIDATE_UTC_OFFSET, OPE_ENDDATE_UTC_OFFSET,
     OPE_AMOUNT,
	 ISNULL(OPE_REAL_AMOUNT, OPE_AMOUNT) OPE_REAL_AMOUNT,
	 OPE_FINAL_AMOUNT,
	 ISNULL(OPE_TOTAL_AMOUNT, OPE_AMOUNT) OPE_TOTAL_AMOUNT,
	 OPE_TIME, OPE_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, 
     OPE_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
     OPE_CHANGE_APPLIED, USRP_ID, USRP_PLATE, NULL TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, GRP_ID, TAR_ID, ISNULL(GRP_DESCRIPTION2,GRP_DESCRIPTION) GRP_DESCRIPTION, TAR_DESCRIPTION, 
     OPE_SUSCRIPTION_TYPE, OPE_BALANCE_BEFORE, OPE_INSERTION_UTC_DATE, OPE_CUSPMR_ID, OPE_OPEDIS_ID, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, 
     CUR3.CUR_ISO_CODE CUSPMR_AMOUNT_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, OPEDIS_DATE, OPEDIS_AMOUNT, OPEDIS_AMOUNT_CUR_ID, 
     CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, 
     OPEDIS_BALANCE_BEFORE, OPEDIS_INSERTION_UTC_DATE, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
     CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, CUSPMR_DATE_UTC_OFFSET OPE_CUSPMR_DATE_UTC_OFFSET, OPEDIS_DATE_UTC_OFFSET OPE_OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, 
     CUR1.CUR_NAME OPE_AMOUNT_CUR_NAME, CUR2.CUR_NAME OPE_BALANCE_CUR_NAME, CUR3.CUR_NAME CUSPMR_CUR_NAME, CUR4.CUR_NAME OPEDIS_AMOUNT_CUR_NAME, 
     CUR5.CUR_NAME OPEDIS_BALANCE_CUR_NAME, OPE_EXTERNAL_ID1, OPE_EXTERNAL_ID2, OPE_EXTERNAL_ID3, OPE_EXTERNAL_BASE_ID1, OPE_EXTERNAL_BASE_ID2, OPE_EXTERNAL_BASE_ID3,
	 OPE_LATITUDE, OPE_LONGITUDE, OPE_ID,OPE_APP_VERSION,					 
	 USR_MAIN_TEL,	 
	 INS_STANDARD_CITY_ID

FROM HIS_OPERATIONS
		LEFT OUTER JOIN dbo.USER_PLATES ON OPE_USRP_ID = USER_PLATES.USRP_ID 
		INNER JOIN CURRENCIES CUR1 ON OPE_AMOUNT_CUR_ID = CUR1.CUR_ID 
		INNER JOIN CURRENCIES CUR2 ON OPE_BALANCE_CUR_ID = CUR2.CUR_ID 
		LEFT OUTER JOIN dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON OPE_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID 
		LEFT OUTER JOIN dbo.OPERATIONS_DISCOUNTS ON OPE_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID 
		LEFT OUTER JOIN dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID 
		LEFT OUTER JOIN dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID 
		LEFT OUTER JOIN dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID 
		INNER JOIN dbo.USERS ON OPE_USR_ID = USR_ID 
		LEFT OUTER JOIN dbo.GROUPS ON OPE_GRP_ID = GRP_ID 
		LEFT OUTER JOIN dbo.TARIFFS ON OPE_TAR_ID = TAR_ID
		INNER JOIN INSTALLATIONS ON OPE_INS_ID = INS_ID
WHERE OPE_PARKING_MODE = 1 AND OPE_PARKING_MODE_STATUS = 2

UNION ALL

SELECT 
	 opStop.OPE_TYPE, opStop.OPE_PARKING_MODE_STATUS, opStop.OPE_USR_ID, opStop.OPE_MOSE_OS, opStop.OPE_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, 
	 opStop.OPE_DATE, opStop.OPE_INIDATE, opStop.OPE_ENDDATE, opStop.OPE_UTC_DATE, opStop.OPE_UTC_INIDATE, opStop.OPE_UTC_ENDDATE, opStop.OPE_DATE_UTC_OFFSET, opStop.OPE_INIDATE_UTC_OFFSET, opStop.OPE_ENDDATE_UTC_OFFSET,
	 opStart.OPE_AMOUNT - opStop.OPE_AMOUNT OPE_AMOUNT,
	 ISNULL(opStart.OPE_REAL_AMOUNT, opStart.OPE_AMOUNT) - ISNULL(opStop.OPE_REAL_AMOUNT, opStop.OPE_AMOUNT) OPE_REAL_AMOUNT,
	 opStart.OPE_FINAL_AMOUNT - opStop.OPE_FINAL_AMOUNT OPE_FINAL_AMOUNT,
	 ISNULL(opStart.OPE_TOTAL_AMOUNT, opStart.OPE_AMOUNT) - ISNULL(opStop.OPE_TOTAL_AMOUNT, opStop.OPE_AMOUNT) OPE_TOTAL_AMOUNT,
	 opStart.OPE_TIME - opStop.OPE_TIME OPE_TIME, 
	 opStop.OPE_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, 
     opStop.OPE_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
     opStop.OPE_CHANGE_APPLIED, USRP_ID, USRP_PLATE, NULL TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, GRP_ID, TAR_ID, ISNULL(GRP_DESCRIPTION2,GRP_DESCRIPTION) GRP_DESCRIPTION, TAR_DESCRIPTION, 
     opStop.OPE_SUSCRIPTION_TYPE, opStop.OPE_BALANCE_BEFORE, opStop.OPE_INSERTION_UTC_DATE, opStop.OPE_CUSPMR_ID, opStop.OPE_OPEDIS_ID, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, 
     CUR3.CUR_ISO_CODE CUSPMR_AMOUNT_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, OPEDIS_DATE, OPEDIS_AMOUNT, OPEDIS_AMOUNT_CUR_ID, 
     CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, 
     OPEDIS_BALANCE_BEFORE, OPEDIS_INSERTION_UTC_DATE, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
     CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, CUSPMR_DATE_UTC_OFFSET OPE_CUSPMR_DATE_UTC_OFFSET, OPEDIS_DATE_UTC_OFFSET OPE_OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, 
     CUR1.CUR_NAME OPE_AMOUNT_CUR_NAME, CUR2.CUR_NAME OPE_BALANCE_CUR_NAME, CUR3.CUR_NAME CUSPMR_CUR_NAME, CUR4.CUR_NAME OPEDIS_AMOUNT_CUR_NAME, 
     CUR5.CUR_NAME OPEDIS_BALANCE_CUR_NAME, opStop.OPE_EXTERNAL_ID1, opStop.OPE_EXTERNAL_ID2, opStop.OPE_EXTERNAL_ID3, opStop.OPE_EXTERNAL_BASE_ID1, opStop.OPE_EXTERNAL_BASE_ID2, opStop.OPE_EXTERNAL_BASE_ID3,
	 opStop.OPE_LATITUDE, opStop.OPE_LONGITUDE, opStop.OPE_ID, opStop.OPE_APP_VERSION,					 
	 USR_MAIN_TEL,	 
	 INS_STANDARD_CITY_ID

 FROM HIS_OPERATIONS opStart
		INNER JOIN HIS_OPERATIONS opStop ON opStart.OPE_EXTERNAL_BASE_ID1 = opStop.OPE_EXTERNAL_BASE_ID1
		LEFT OUTER JOIN dbo.USER_PLATES ON opStop.OPE_USRP_ID = USER_PLATES.USRP_ID 
		INNER JOIN CURRENCIES CUR1 ON opStop.OPE_AMOUNT_CUR_ID = CUR1.CUR_ID 
		INNER JOIN CURRENCIES CUR2 ON opStop.OPE_BALANCE_CUR_ID = CUR2.CUR_ID 
		LEFT OUTER JOIN dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON opStop.OPE_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID 
		LEFT OUTER JOIN dbo.OPERATIONS_DISCOUNTS ON opStop.OPE_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID 
		LEFT OUTER JOIN dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID 
		LEFT OUTER JOIN dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID 
		LEFT OUTER JOIN dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID 
		INNER JOIN dbo.USERS ON opStop.OPE_USR_ID = USR_ID 
		LEFT OUTER JOIN dbo.GROUPS ON opStop.OPE_GRP_ID = GRP_ID 
		LEFT OUTER JOIN dbo.TARIFFS ON opStop.OPE_TAR_ID = TAR_ID
		INNER JOIN INSTALLATIONS ON opStop.OPE_INS_ID = INS_ID
WHERE  opStart.OPE_PARKING_MODE = 1 AND opStart.OPE_PARKING_MODE_STATUS = 1 AND opStart.OPE_TYPE = 1 AND
       opStop.OPE_PARKING_MODE = 1 AND opStop.OPE_PARKING_MODE_STATUS = 1 AND opStop.OPE_TYPE = 3
       
UNION ALL

SELECT

	 OPE_TYPE, OPE_PARKING_MODE_STATUS, OPE_USR_ID, OPE_MOSE_OS, OPE_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, 
	 OPE_DATE, OPE_INIDATE, NULL OPE_ENDDATE, OPE_UTC_DATE, OPE_UTC_INIDATE, NULL OPE_UTC_ENDDATE, OPE_DATE_UTC_OFFSET, OPE_INIDATE_UTC_OFFSET, NULL OPE_ENDDATE_UTC_OFFSET,
     OPE_AMOUNT,
	 ISNULL(OPE_REAL_AMOUNT, OPE_AMOUNT) OPE_REAL_AMOUNT,
	 OPE_FINAL_AMOUNT,
	 ISNULL(OPE_TOTAL_AMOUNT, OPE_AMOUNT) OPE_TOTAL_AMOUNT,
	 OPE_TIME, OPE_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, 
     OPE_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
     OPE_CHANGE_APPLIED, USRP_ID, USRP_PLATE, NULL TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, GRP_ID, TAR_ID, ISNULL(GRP_DESCRIPTION2,GRP_DESCRIPTION) GRP_DESCRIPTION, TAR_DESCRIPTION, 
     OPE_SUSCRIPTION_TYPE, OPE_BALANCE_BEFORE, OPE_INSERTION_UTC_DATE, OPE_CUSPMR_ID, OPE_OPEDIS_ID, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, 
     CUR3.CUR_ISO_CODE CUSPMR_AMOUNT_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, OPEDIS_DATE, OPEDIS_AMOUNT, OPEDIS_AMOUNT_CUR_ID, 
     CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, 
     OPEDIS_BALANCE_BEFORE, OPEDIS_INSERTION_UTC_DATE, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
     CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, CUSPMR_DATE_UTC_OFFSET OPE_CUSPMR_DATE_UTC_OFFSET, OPEDIS_DATE_UTC_OFFSET OPE_OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, 
     CUR1.CUR_NAME OPE_AMOUNT_CUR_NAME, CUR2.CUR_NAME OPE_BALANCE_CUR_NAME, CUR3.CUR_NAME CUSPMR_CUR_NAME, CUR4.CUR_NAME OPEDIS_AMOUNT_CUR_NAME, 
     CUR5.CUR_NAME OPEDIS_BALANCE_CUR_NAME, OPE_EXTERNAL_ID1, OPE_EXTERNAL_ID2, OPE_EXTERNAL_ID3, OPE_EXTERNAL_BASE_ID1, OPE_EXTERNAL_BASE_ID2, OPE_EXTERNAL_BASE_ID3,
	 OPE_LATITUDE, OPE_LONGITUDE, OPE_ID,OPE_APP_VERSION,					 
	 USR_MAIN_TEL,	 
	 INS_STANDARD_CITY_ID

FROM HIS_OPERATIONS
		LEFT OUTER JOIN dbo.USER_PLATES ON OPE_USRP_ID = USER_PLATES.USRP_ID 
		INNER JOIN CURRENCIES CUR1 ON OPE_AMOUNT_CUR_ID = CUR1.CUR_ID 
		INNER JOIN CURRENCIES CUR2 ON OPE_BALANCE_CUR_ID = CUR2.CUR_ID 
		LEFT OUTER JOIN dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON OPE_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID 
		LEFT OUTER JOIN dbo.OPERATIONS_DISCOUNTS ON OPE_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID 
		LEFT OUTER JOIN dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID 
		LEFT OUTER JOIN dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID 
		LEFT OUTER JOIN dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID 
		INNER JOIN dbo.USERS ON OPE_USR_ID = USR_ID 
		LEFT OUTER JOIN dbo.GROUPS ON OPE_GRP_ID = GRP_ID 
		LEFT OUTER JOIN dbo.TARIFFS ON OPE_TAR_ID = TAR_ID
		INNER JOIN INSTALLATIONS ON OPE_INS_ID = INS_ID
WHERE OPE_PARKING_MODE = 1 AND OPE_PARKING_MODE_STATUS = 0






GO


/****** Object:  View [dbo].[VW_TICKET_PAYMENTS]    Script Date: 7/8/2021 5:22:02 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER VIEW [dbo].[VW_TICKET_PAYMENTS]
AS
SELECT        4 OPE_TYPE, TIPA_USR_ID, TIPA_MOSE_OS, TIPA_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, TIPA_DATE, TIPA_UTC_DATE, - TIPA_AMOUNT TIPA_AMOUNT, TIPA_AMOUNT_CUR_ID, 
                         CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, - TIPA_FINAL_AMOUNT AS TIPA_FINAL_AMOUNT, TIPA_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE TIPA_BALANCE_CUR_ISO_CODE, TIPA_CHANGE_APPLIED, USRP_ID, 
                         TIPA_PLATE_STRING, TIPA_TICKET_NUMBER, TIPA_TICKET_DATA, GRP_ID, TIPA_SUSCRIPTION_TYPE, TIPA_BALANCE_BEFORE, TIPA_INSERTION_UTC_DATE, TIPA_CUSPMR_ID, 
                         TIPA_OPEDIS_ID, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, CUR3.CUR_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, OPEDIS_DATE, OPEDIS_AMOUNT, 
                         OPEDIS_AMOUNT_CUR_ID, CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, 
                         OPEDIS_CHANGE_APPLIED, OPEDIS_BALANCE_BEFORE, OPEDIS_INSERTION_UTC_DATE, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL 
                         CUSPMR_CARD_HASH, NULL CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, 
                         TIPA_DATE_UTC_OFFSET, CUSPMR_DATE_UTC_OFFSET, OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, 
						 CUR1.CUR_NAME TIPA_AMOUNT_CUR_NAME, CUR2.CUR_NAME TIPA_BALANCE_CUR_NAME, CUR3.CUR_NAME CUSPMR_CUR_NAME, CUR4.CUR_NAME OPEDIS_AMOUNT_CUR_NAME, 
                         CUR5.CUR_NAME OPEDIS_BALANCE_CUR_NAME, 
						 TIPA_CONFIRMED_IN_WS,
						 TIPA_CONFIRMATION_TIME_IN_WS, TIPA_QUEUE_LENGTH_BEFORE_CONFIRM_WS, 
						 TIPA_LATITUDE, TIPA_LONGITUDE, TIPA_ID,TIPA_APP_VERSION,						 
						 TIPA_PERC_VAT1, TIPA_PERC_VAT2, - TIPA_PARTIAL_VAT1 TIPA_PARTIAL_VAT1,
						 TIPA_PERC_FEE, TIPA_PERC_FEE_TOPPED, - TIPA_PARTIAL_PERC_FEE TIPA_PARTIAL_PERC_FEE,
						 TIPA_FIXED_FEE, - TIPA_PARTIAL_FIXED_FEE TIPA_PARTIAL_FIXED_FEE,
						 -ISNULL(TIPA_TOTAL_AMOUNT, TIPA_AMOUNT) TIPA_TOTAL_AMOUNT,
						 USR_MAIN_TEL,
						 INSTALLATIONS.INS_STANDARD_CITY_ID
FROM            dbo.TICKET_PAYMENTS LEFT OUTER JOIN
                         dbo.USER_PLATES ON dbo.TICKET_PAYMENTS.TIPA_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                         dbo.CURRENCIES CUR1 ON TIPA_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                         dbo.CURRENCIES CUR2 ON TIPA_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                         dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON dbo.TICKET_PAYMENTS.TIPA_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID LEFT OUTER JOIN
                         dbo.OPERATIONS_DISCOUNTS ON dbo.TICKET_PAYMENTS.TIPA_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                         dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID INNER JOIN
                         dbo.USERS ON TIPA_USR_ID = USR_ID LEFT OUTER JOIN
						 dbo.GROUPS ON TIPA_GRP_ID = GRP_ID,
						 INSTALLATIONS 
WHERE        TIPA_INS_ID = INS_ID






GO


/****** Object:  StoredProcedure [dbo].[Report_BANK]    Script Date: 7/8/2021 5:34:29 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[Report_BANK]
	@GroupHour AS int,
	@GroupMinute AS int,
	@DateIni AS datetime,
	@DateEnd AS Datetime
AS	
BEGIN
	
	SELECT CASE WHEN @GroupHour = 0 THEN  DATEADD(DD, DATEDIFF(DD,0,CUSPMR_UTC_DATE), 0) 
				WHEN @GroupHour < 12 THEN 
						CASE WHEN DATEPART(hour, CUSPMR_UTC_DATE) < @GroupHour THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_UTC_DATE), -1) 
							 WHEN DATEPART(hour, CUSPMR_UTC_DATE) = @GroupHour AND DATEPART(minute, CUSPMR_UTC_DATE) <= @GroupMinute THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_UTC_DATE), -1)
							 ELSE DATEADD(DD, DATEDIFF(DD,0,CUSPMR_UTC_DATE), 0) END				
				ELSE
						CASE WHEN DATEPART(hour, CUSPMR_UTC_DATE) < @GroupHour THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_UTC_DATE), 0) 
							 WHEN DATEPART(hour, CUSPMR_UTC_DATE) = @GroupHour AND DATEPART(minute, CUSPMR_UTC_DATE) <= @GroupMinute THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_UTC_DATE), 0)
							 ELSE DATEADD(DD, DATEDIFF(DD,0,CUSPMR_UTC_DATE), 1) END				
				END RECHARGES_DATE,
		   COUNT(CUSPMR_ID) RECARGES_COUNT, 
		   SUM(dbo.AmountChanged(CUSPMR_TOTAL_AMOUNT_CHARGED, CUSPMR_CUR_ID)) RECHARGES_AMOUNT,
		   dbo.DefaultCurIso() CUR_ISO_CODE
	FROM CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS
	WHERE CUSPMR_TRANS_STATUS = 4 AND
		  --CUSPMR_UTC_DATE >= @DateIni AND CUSPMR_UTC_DATE <= @DateEnd
			CASE WHEN @GroupHour = 0 THEN  DATEADD(DD, DATEDIFF(DD,0,CUSPMR_UTC_DATE), 0) 
				WHEN @GroupHour < 12 THEN 
						CASE WHEN DATEPART(hour, CUSPMR_UTC_DATE) < @GroupHour THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_UTC_DATE), -1) 
							 WHEN DATEPART(hour, CUSPMR_UTC_DATE) = @GroupHour AND DATEPART(minute, CUSPMR_UTC_DATE) <= @GroupMinute THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_UTC_DATE), -1)
							 ELSE DATEADD(DD, DATEDIFF(DD,0,CUSPMR_UTC_DATE), 0) END				
				ELSE
						CASE WHEN DATEPART(hour, CUSPMR_UTC_DATE) < @GroupHour THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_UTC_DATE), 0) 
							 WHEN DATEPART(hour, CUSPMR_UTC_DATE) = @GroupHour AND DATEPART(minute, CUSPMR_UTC_DATE) <= @GroupMinute THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_UTC_DATE), 0)
							 ELSE DATEADD(DD, DATEDIFF(DD,0,CUSPMR_UTC_DATE), 1) END				
				END BETWEEN @DateIni AND @DateEnd
	GROUP BY CASE WHEN @GroupHour = 0 THEN  DATEADD(DD, DATEDIFF(DD,0,CUSPMR_UTC_DATE), 0) 
				WHEN @GroupHour < 12 THEN 
						CASE WHEN DATEPART(hour, CUSPMR_UTC_DATE) < @GroupHour THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_UTC_DATE), -1) 
							 WHEN DATEPART(hour, CUSPMR_UTC_DATE) = @GroupHour AND DATEPART(minute, CUSPMR_UTC_DATE) <= @GroupMinute THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_UTC_DATE), -1)
							 ELSE DATEADD(DD, DATEDIFF(DD,0,CUSPMR_UTC_DATE), 0) END				
				ELSE
						CASE WHEN DATEPART(hour, CUSPMR_UTC_DATE) < @GroupHour THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_UTC_DATE), 0) 
							 WHEN DATEPART(hour, CUSPMR_UTC_DATE) = @GroupHour AND DATEPART(minute, CUSPMR_UTC_DATE) <= @GroupMinute THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_UTC_DATE), 0)
							 ELSE DATEADD(DD, DATEDIFF(DD,0,CUSPMR_UTC_DATE), 1) END				
				END

	UNION

	SELECT CASE WHEN @GroupHour = 0 THEN  DATEADD(DD, DATEDIFF(DD,0,CUSPMR_STATUS_DATE), 0) 
				WHEN @GroupHour < 12 THEN 
						CASE WHEN DATEPART(hour, CUSPMR_STATUS_DATE) < @GroupHour THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_STATUS_DATE), -1) 
							 WHEN DATEPART(hour, CUSPMR_STATUS_DATE) = @GroupHour AND DATEPART(minute, CUSPMR_STATUS_DATE) <= @GroupMinute THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_STATUS_DATE), -1)
							 ELSE DATEADD(DD, DATEDIFF(DD,0,CUSPMR_STATUS_DATE), 0) END				
				ELSE
						CASE WHEN DATEPART(hour, CUSPMR_STATUS_DATE) < @GroupHour THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_STATUS_DATE), 0) 
							 WHEN DATEPART(hour, CUSPMR_STATUS_DATE) = @GroupHour AND DATEPART(minute, CUSPMR_STATUS_DATE) <= @GroupMinute THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_STATUS_DATE), 0)
							 ELSE DATEADD(DD, DATEDIFF(DD,0,CUSPMR_STATUS_DATE), 1) END				
				END,	
		   COUNT(CUSPMR_ID), 
		   SUM(dbo.AmountChanged(-CUSPMR_TOTAL_AMOUNT_CHARGED, CUSPMR_CUR_ID)),
		   dbo.DefaultCurIso()
	FROM CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS
	WHERE CUSPMR_TRANS_STATUS = 7 AND
		  --CUSPMR_UTC_DATE >= @DateIni AND CUSPMR_UTC_DATE <= @DateEnd
		  CASE WHEN @GroupHour = 0 THEN  DATEADD(DD, DATEDIFF(DD,0,CUSPMR_STATUS_DATE), 0) 
				WHEN @GroupHour < 12 THEN 
						CASE WHEN DATEPART(hour, CUSPMR_STATUS_DATE) < @GroupHour THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_STATUS_DATE), -1) 
							 WHEN DATEPART(hour, CUSPMR_STATUS_DATE) = @GroupHour AND DATEPART(minute, CUSPMR_STATUS_DATE) <= @GroupMinute THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_STATUS_DATE), -1)
							 ELSE DATEADD(DD, DATEDIFF(DD,0,CUSPMR_STATUS_DATE), 0) END				
				ELSE
						CASE WHEN DATEPART(hour, CUSPMR_STATUS_DATE) < @GroupHour THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_STATUS_DATE), 0) 
							 WHEN DATEPART(hour, CUSPMR_STATUS_DATE) = @GroupHour AND DATEPART(minute, CUSPMR_STATUS_DATE) <= @GroupMinute THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_STATUS_DATE), 0)
							 ELSE DATEADD(DD, DATEDIFF(DD,0,CUSPMR_STATUS_DATE), 1) END				
				END BETWEEN @DateIni AND @DateEnd
	GROUP BY CASE WHEN @GroupHour = 0 THEN  DATEADD(DD, DATEDIFF(DD,0,CUSPMR_STATUS_DATE), 0) 
				WHEN @GroupHour < 12 THEN 
						CASE WHEN DATEPART(hour, CUSPMR_STATUS_DATE) < @GroupHour THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_STATUS_DATE), -1) 
							 WHEN DATEPART(hour, CUSPMR_STATUS_DATE) = @GroupHour AND DATEPART(minute, CUSPMR_STATUS_DATE) <= @GroupMinute THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_STATUS_DATE), -1)
							 ELSE DATEADD(DD, DATEDIFF(DD,0,CUSPMR_STATUS_DATE), 0) END				
				ELSE
						CASE WHEN DATEPART(hour, CUSPMR_STATUS_DATE) < @GroupHour THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_STATUS_DATE), 0) 
							 WHEN DATEPART(hour, CUSPMR_STATUS_DATE) = @GroupHour AND DATEPART(minute, CUSPMR_STATUS_DATE) <= @GroupMinute THEN DATEADD(DD, DATEDIFF(DD,0,CUSPMR_STATUS_DATE), 0)
							 ELSE DATEADD(DD, DATEDIFF(DD,0,CUSPMR_STATUS_DATE), 1) END				
				END

	UNION

	SELECT CASE WHEN @GroupHour = 0 THEN  DATEADD(DD, DATEDIFF(DD,0,RTLPY_INSERTION_UTC_DATE), 0) 
				WHEN @GroupHour < 12 THEN 
						CASE WHEN DATEPART(hour, RTLPY_INSERTION_UTC_DATE) < @GroupHour THEN DATEADD(DD, DATEDIFF(DD,0,RTLPY_INSERTION_UTC_DATE), -1) 
							 WHEN DATEPART(hour, RTLPY_INSERTION_UTC_DATE) = @GroupHour AND DATEPART(minute, RTLPY_INSERTION_UTC_DATE) <= @GroupMinute THEN DATEADD(DD, DATEDIFF(DD,0,RTLPY_INSERTION_UTC_DATE), -1)
							 ELSE DATEADD(DD, DATEDIFF(DD,0,RTLPY_INSERTION_UTC_DATE), 0) END
				ELSE
						CASE WHEN DATEPART(hour, RTLPY_INSERTION_UTC_DATE) < @GroupHour THEN DATEADD(DD, DATEDIFF(DD,0,RTLPY_INSERTION_UTC_DATE), 0) 
							 WHEN DATEPART(hour, RTLPY_INSERTION_UTC_DATE) = @GroupHour AND DATEPART(minute, RTLPY_INSERTION_UTC_DATE) <= @GroupMinute THEN DATEADD(DD, DATEDIFF(DD,0,RTLPY_INSERTION_UTC_DATE), 0)
							 ELSE DATEADD(DD, DATEDIFF(DD,0,RTLPY_INSERTION_UTC_DATE), 1) END				
				END,	
		   COUNT(RTLPY_ID), 
		   SUM(dbo.AmountChanged(RTLPY_TOTAL_AMOUNT_CHARGED, RTLPY_CUR_ID)),
		   dbo.DefaultCurIso()
	FROM RETAILER_PAYMENTS
	WHERE RTLPY_TRANS_STATUS = 4 AND		  
		  CASE WHEN @GroupHour = 0 THEN  DATEADD(DD, DATEDIFF(DD,0,RTLPY_INSERTION_UTC_DATE), 0) 
				WHEN @GroupHour < 12 THEN 
						CASE WHEN DATEPART(hour, RTLPY_INSERTION_UTC_DATE) < @GroupHour THEN DATEADD(DD, DATEDIFF(DD,0,RTLPY_INSERTION_UTC_DATE), -1) 
							 WHEN DATEPART(hour, RTLPY_INSERTION_UTC_DATE) = @GroupHour AND DATEPART(minute, RTLPY_INSERTION_UTC_DATE) <= @GroupMinute THEN DATEADD(DD, DATEDIFF(DD,0,RTLPY_INSERTION_UTC_DATE), -1)
							 ELSE DATEADD(DD, DATEDIFF(DD,0,RTLPY_INSERTION_UTC_DATE), 0) END				
				ELSE
						CASE WHEN DATEPART(hour, RTLPY_INSERTION_UTC_DATE) < @GroupHour THEN DATEADD(DD, DATEDIFF(DD,0,RTLPY_INSERTION_UTC_DATE), 0) 
							 WHEN DATEPART(hour, RTLPY_INSERTION_UTC_DATE) = @GroupHour AND DATEPART(minute, RTLPY_INSERTION_UTC_DATE) <= @GroupMinute THEN DATEADD(DD, DATEDIFF(DD,0,RTLPY_INSERTION_UTC_DATE), 0)
							 ELSE DATEADD(DD, DATEDIFF(DD,0,RTLPY_INSERTION_UTC_DATE), 1) END				
				END BETWEEN @DateIni AND @DateEnd
	GROUP BY CASE WHEN @GroupHour = 0 THEN  DATEADD(DD, DATEDIFF(DD,0,RTLPY_INSERTION_UTC_DATE), 0) 
				WHEN @GroupHour < 12 THEN 
						CASE WHEN DATEPART(hour, RTLPY_INSERTION_UTC_DATE) < @GroupHour THEN DATEADD(DD, DATEDIFF(DD,0,RTLPY_INSERTION_UTC_DATE), -1) 
							 WHEN DATEPART(hour, RTLPY_INSERTION_UTC_DATE) = @GroupHour AND DATEPART(minute, RTLPY_INSERTION_UTC_DATE) <= @GroupMinute THEN DATEADD(DD, DATEDIFF(DD,0,RTLPY_INSERTION_UTC_DATE), -1)
							 ELSE DATEADD(DD, DATEDIFF(DD,0,RTLPY_INSERTION_UTC_DATE), 0) END				
				ELSE
						CASE WHEN DATEPART(hour, RTLPY_INSERTION_UTC_DATE) < @GroupHour THEN DATEADD(DD, DATEDIFF(DD,0,RTLPY_INSERTION_UTC_DATE), 0) 
							 WHEN DATEPART(hour, RTLPY_INSERTION_UTC_DATE) = @GroupHour AND DATEPART(minute, RTLPY_INSERTION_UTC_DATE) <= @GroupMinute THEN DATEADD(DD, DATEDIFF(DD,0,RTLPY_INSERTION_UTC_DATE), 0)
							 ELSE DATEADD(DD, DATEDIFF(DD,0,RTLPY_INSERTION_UTC_DATE), 1) END				
				END

END


GO


/****** Object:  StoredProcedure [dbo].[Report_INVOICERECHARGES]    Script Date: 7/8/2021 5:39:22 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[Report_INVOICERECHARGES]
	@InvoiceId AS numeric
AS	
BEGIN
	
SELECT H1.*, CURRENCIES.*, USERS.*,			
			ROUND(CASE WHEN ISNULL(CUSPMR_PERC_FEE_TOPPED,0) > 0 AND ISNULL(CUSPMR_PERC_FEE_TOPPED,0) < (CUSPMR_AMOUNT * ISNULL(CUSPMR_PERC_FEE,0)) THEN CUSPMR_PERC_FEE_TOPPED ELSE (CUSPMR_AMOUNT * ISNULL(CUSPMR_PERC_FEE,0)) END + ISNULL(CUSPMR_FIXED_FEE, 0), 0) CUSPMR_FEE,
			ROUND(ISNULL(CUSPMR_PARTIAL_VAT1, 0) + 
			((CASE WHEN ISNULL(CUSPMR_PERC_FEE_TOPPED,0) > 0 AND ISNULL(CUSPMR_PERC_FEE_TOPPED,0) < (CUSPMR_AMOUNT * ISNULL(CUSPMR_PERC_FEE,0)) THEN CUSPMR_PERC_FEE_TOPPED ELSE (CUSPMR_AMOUNT * ISNULL(CUSPMR_PERC_FEE,0)) END)  * ISNULL(CUSPMR_PERC_VAT2,0)) +
			(ISNULL(CUSPMR_FIXED_FEE,0)  * ISNULL(CUSPMR_PERC_VAT2,0)), 0) CUSPMR_VAT,
			(SELECT COUNT(DISTINCT H2.CUSPMR_PERC_VAT2) FROM CUSTOMER_PAYMENT_MEANS_RECHARGES H2 WHERE ISNULL(H2.CUSPMR_PERC_VAT2, 0) <> 0 AND H2.CUSPMR_CUSINV_ID = H1.CUSPMR_CUSINV_ID) NUM_VATS,
			(SELECT TOP 1 H2.CUSPMR_PERC_VAT2 FROM CUSTOMER_PAYMENT_MEANS_RECHARGES H2 WHERE ISNULL(H2.CUSPMR_PERC_VAT2, 0) <> 0 AND H2.CUSPMR_CUSINV_ID = H1.CUSPMR_CUSINV_ID) VAT

FROM CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS H1
		INNER JOIN CURRENCIES ON CUSPMR_CUR_ID = CUR_ID
		INNER JOIN USERS ON CUSPMR_CUS_ID = USR_CUS_ID
WHERE CUSPMR_CUSINV_ID = @InvoiceId AND
	  (CUSPMR_TRANS_STATUS IN (1, 2, 3, 4) OR CUSPMR_RCOUP_ID IS NOT NULL)

END



GO


/****** Object:  StoredProcedure [dbo].[Select_DB_RECHARGE_COUPONS_HOUR]    Script Date: 7/8/2021 5:42:49 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[Select_DB_RECHARGE_COUPONS_HOUR]
	@FromHour AS Datetime,
	@ToHour AS Datetime
AS	
BEGIN
	

	;WITH /*_timetable AS 
	(
		--SELECT _hour = DATEADD(HOUR, -(DATEPART(HOUR, @FromHour) - 1), @FromHour)
		SELECT _hour = dateadd(hour, datediff(hour, 0, @FromHour),0)

		UNION ALL

		SELECT DATEADD(HOUR, 1, _hour)
		FROM _timetable		
		WHERE _hour <= DATEADD(HOUR, -1, @ToHour)
	), */
	_rechargeCoupons
		( ROWNUM, [HOUR], PURCHASED, USED)
		AS
		( /*SELECT
			ROW_NUMBER() OVER(ORDER BY _hour) AS ROWNUM,
			_hour AS [HOUR],
			COUNT(DISTINCT(RCOUP_ID)) AS PURCHASED,

			(SELECT COUNT(*) FROM CUSTOMER_PAYMENT_MEANS_RECHARGES P 
			 WHERE P.CUSPMR_RCOUP_ID IS NOT NULL AND dateadd(hour, datediff(hour, 0, P.CUSPMR_DATE),0) = _hour) AS USED
		  FROM _timetable 
					LEFT JOIN RETAILER_PAYMENTS ON _hour = dateadd(hour, datediff(hour, 0, RTLPY_DATE),0)
					LEFT JOIN RECHARGE_COUPONS ON RTLPY_ID = RCOUP_RTLPY_ID

		  GROUP BY _hour*/
		  SELECT
			ROW_NUMBER() OVER(ORDER BY dateadd(hour, datediff(hour, 0, RTLPY_DATE),0)) AS ROWNUM,
			dateadd(hour, datediff(hour, 0, RTLPY_DATE),0) AS [HOUR],
			COUNT(DISTINCT(RCOUP_ID)) AS PURCHASED,

			(SELECT COUNT(*) FROM CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS P 
			 WHERE P.CUSPMR_RCOUP_ID IS NOT NULL AND dateadd(hour, datediff(hour, 0, P.CUSPMR_DATE),0) = dateadd(hour, datediff(hour, 0, RTLPY_DATE),0)) AS USED
		  FROM RETAILER_PAYMENTS 
					LEFT JOIN RECHARGE_COUPONS ON RTLPY_ID = RCOUP_RTLPY_ID

		  GROUP BY dateadd(hour, datediff(hour, 0, RTLPY_DATE),0)
		)

	SELECT [HOUR],
		   PURCHASED, USED
	FROM _rechargeCoupons A
	ORDER BY ROWNUM
	option (maxrecursion 0);



END
GO

/****** Object:  StoredProcedure [dbo].[Select_DB_RECHARGE_COUPONS_HOUR]    Script Date: 7/8/2021 5:42:49 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[Select_DB_RECHARGE_COUPONS_HOUR]
	@FromHour AS Datetime,
	@ToHour AS Datetime
AS	
BEGIN
	

	;WITH /*_timetable AS 
	(
		--SELECT _hour = DATEADD(HOUR, -(DATEPART(HOUR, @FromHour) - 1), @FromHour)
		SELECT _hour = dateadd(hour, datediff(hour, 0, @FromHour),0)

		UNION ALL

		SELECT DATEADD(HOUR, 1, _hour)
		FROM _timetable		
		WHERE _hour <= DATEADD(HOUR, -1, @ToHour)
	), */
	_rechargeCoupons
		( ROWNUM, [HOUR], PURCHASED, USED)
		AS
		( /*SELECT
			ROW_NUMBER() OVER(ORDER BY _hour) AS ROWNUM,
			_hour AS [HOUR],
			COUNT(DISTINCT(RCOUP_ID)) AS PURCHASED,

			(SELECT COUNT(*) FROM CUSTOMER_PAYMENT_MEANS_RECHARGES P 
			 WHERE P.CUSPMR_RCOUP_ID IS NOT NULL AND dateadd(hour, datediff(hour, 0, P.CUSPMR_DATE),0) = _hour) AS USED
		  FROM _timetable 
					LEFT JOIN RETAILER_PAYMENTS ON _hour = dateadd(hour, datediff(hour, 0, RTLPY_DATE),0)
					LEFT JOIN RECHARGE_COUPONS ON RTLPY_ID = RCOUP_RTLPY_ID

		  GROUP BY _hour*/
		  SELECT
			ROW_NUMBER() OVER(ORDER BY dateadd(hour, datediff(hour, 0, RTLPY_DATE),0)) AS ROWNUM,
			dateadd(hour, datediff(hour, 0, RTLPY_DATE),0) AS [HOUR],
			COUNT(DISTINCT(RCOUP_ID)) AS PURCHASED,

			(SELECT COUNT(*) FROM CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS P 
			 WHERE P.CUSPMR_RCOUP_ID IS NOT NULL AND dateadd(hour, datediff(hour, 0, P.CUSPMR_DATE),0) = dateadd(hour, datediff(hour, 0, RTLPY_DATE),0)) AS USED
		  FROM RETAILER_PAYMENTS 
					LEFT JOIN RECHARGE_COUPONS ON RTLPY_ID = RCOUP_RTLPY_ID

		  GROUP BY dateadd(hour, datediff(hour, 0, RTLPY_DATE),0)
		)

	SELECT [HOUR],
		   PURCHASED, USED
	FROM _rechargeCoupons A
	ORDER BY ROWNUM
	option (maxrecursion 0);



END
GO


/****** Object:  View [dbo].[ALL_OPERATIONS_EXT_DB_HIS]    Script Date: 7/8/2021 5:04:22 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER VIEW [dbo].[ALL_OPERATIONS_EXT_DB_HIS]
AS
SELECT     CASE ISNULL(TAR_TYPE, 0) WHEN 1 THEN 19 ELSE OPE_TYPE END AS OPE_TYPE, OPE_USR_ID, OPE_MOSE_OS, OPE_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, OPE_DATE, OPE_UTC_DATE, OPE_INIDATE, OPE_ENDDATE, 
                      CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_AMOUNT ELSE - OPE_AMOUNT END AS int) OPE_AMOUNT, 
					   CAST( CASE 
					  WHEN OPE_TYPE = 3
						 THEN ISNULL(OPE_REAL_AMOUNT,OPE_AMOUNT) 
					  ELSE -ISNULL(OPE_REAL_AMOUNT,OPE_AMOUNT) 
				 END AS int) OPE_REAL_AMOUNT,
					  OPE_TIME, OPE_AMOUNT_CUR_ID, 
                      CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_FINAL_AMOUNT ELSE - OPE_FINAL_AMOUNT END AS int) 
                      OPE_FINAL_AMOUNT, OPE_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, OPE_CHANGE_APPLIED, USER_PLATES.USRP_ID, USER_PLATES.USRP_PLATE, NULL 
                      TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, GRP_ID, TAR_ID, ISNULL(GRP_DESCRIPTION2, GRP_DESCRIPTION) GRP_DESCRIPTION, 
                      TAR_DESCRIPTION, OPE_SUSCRIPTION_TYPE, OPE_BALANCE_BEFORE, OPE_INSERTION_UTC_DATE, OPE_CUSPMR_ID, OPE_OPEDIS_ID, CUSPMR_DATE, 
                      CUSPMR_AMOUNT, CUSPMR_CUR_ID, CUR3.CUR_ISO_CODE CUSPMR_AMOUNT_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, 
                      OPEDIS_DATE, OPEDIS_AMOUNT, OPEDIS_AMOUNT_CUR_ID, CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, 
                      OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, OPEDIS_BALANCE_BEFORE, 
                      OPEDIS_INSERTION_UTC_DATE, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL 
                      CUSPMR_CARD_HASH, NULL CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL 
                      CUSPMR_CARD_EXPIRATION_DATE, OPE_DATE_UTC_OFFSET, OPE_INIDATE_UTC_OFFSET, OPE_ENDDATE_UTC_OFFSET, 
                      CUSPMR_DATE_UTC_OFFSET OPE_CUSPMR_DATE_UTC_OFFSET, OPEDIS_DATE_UTC_OFFSET OPE_OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, 
                      CUR1.CUR_NAME OPE_AMOUNT_CUR_NAME, CUR2.CUR_NAME OPE_BALANCE_CUR_NAME, CUR3.CUR_NAME CUSPMR_CUR_NAME, 
                      CUR4.CUR_NAME OPEDIS_AMOUNT_CUR_NAME, CUR5.CUR_NAME OPEDIS_BALANCE_CUR_NAME, HIS_OPERATIONS.OPE_EXTERNAL_ID1, 
                      HIS_OPERATIONS.OPE_EXTERNAL_ID2, HIS_OPERATIONS.OPE_EXTERNAL_ID3, OPE_CONFIRMED_IN_WS1, OPE_CONFIRMED_IN_WS2, 
                      OPE_CONFIRMED_IN_WS3, OPE_CONFIRMATION_TIME_IN_WS1, OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS1, OPE_CONFIRMATION_TIME_IN_WS2, 
                      OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS2, OPE_CONFIRMATION_TIME_IN_WS3, OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS3, OPE_LATITUDE, 
                      OPE_LONGITUDE, OPE_ID, OPE_APP_VERSION, NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL 
                      OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE, NULL OPEOFF_UTC_ENTRY_DATE, NULL 
                      OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL 
                      OPEOFF_UTC_EXIT_DATE, NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION, OPE_PERC_VAT1, 
                      OPE_PERC_VAT2, CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_VAT1 ELSE - OPE_PARTIAL_VAT1 END AS int) OPE_PARTIAL_VAT1, OPE_PERC_FEE, 
                      OPE_PERC_FEE_TOPPED, CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_PERC_FEE ELSE - OPE_PARTIAL_PERC_FEE END AS int) 
                      OPE_PARTIAL_PERC_FEE, OPE_FIXED_FEE, CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_FIXED_FEE ELSE - OPE_PARTIAL_FIXED_FEE END AS int) 
                      OPE_PARTIAL_FIXED_FEE, ISNULL(OPE_PERC_BONUS, 0) OPE_PERC_BONUS, CAST(ISNULL(OPE_PARTIAL_BONUS_FEE, 0) AS int) OPE_PARTIAL_BONUS_FEE, 
                      CAST(CASE WHEN OPE_TYPE = 3 THEN ISNULL(OPE_TOTAL_AMOUNT, OPE_AMOUNT) ELSE - ISNULL(OPE_TOTAL_AMOUNT, OPE_AMOUNT) END AS int) 
                      OPE_TOTAL_AMOUNT, NULL TRANS_STATUS, NULL STATUS_DATE, OPE_UTC_INIDATE, OPE_UTC_ENDDATE, NULL OPE_CUSPMR_TYPE, NULL 
                      OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_CUSPMR_CREATION_TYPE,
					CAST( CASE 
					  WHEN OPE_TYPE = 3
						 THEN OPE_TIME_BALANCE_USED 
					  ELSE -OPE_TIME_BALANCE_USED 
				 END AS int) OPE_TIME_BALANCE_USED, OPE_TIME_BALANCE_BEFORE, OPE_POSTPAY, OPE_SHOPKEEPER_OP, OPE_SHOPKEEPER_AMOUNT, OPE_SHOPKEEPER_PROFIT,
				 UP2.USRP_PLATE USRP_PLATE2, UP3.USRP_PLATE USRP_PLATE3, UP4.USRP_PLATE USRP_PLATE4, UP5.USRP_PLATE USRP_PLATE5, 
							 UP6.USRP_PLATE USRP_PLATE6, UP7.USRP_PLATE USRP_PLATE7, UP8.USRP_PLATE USRP_PLATE8, UP9.USRP_PLATE USRP_PLATE9, UP10.USRP_PLATE USRP_PLATE10
FROM         dbo.HIS_OPERATIONS LEFT OUTER JOIN
                      dbo.USER_PLATES ON dbo.HIS_OPERATIONS.OPE_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                      dbo.CURRENCIES CUR1 ON OPE_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                      dbo.CURRENCIES CUR2 ON OPE_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                      dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON 
                      dbo.HIS_OPERATIONS.OPE_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID LEFT OUTER JOIN
                      dbo.OPERATIONS_DISCOUNTS ON dbo.HIS_OPERATIONS.OPE_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID INNER JOIN
                      dbo.USERS ON OPE_USR_ID = USR_ID LEFT OUTER JOIN
                      dbo.GROUPS ON OPE_GRP_ID = GRP_ID LEFT OUTER JOIN
                      dbo.TARIFFS ON OPE_TAR_ID = TAR_ID
					  LEFT OUTER JOIN dbo.USER_PLATES UP2 ON dbo.HIS_OPERATIONS.OPE_PLATE2_USRP_ID = UP2.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP3 ON dbo.HIS_OPERATIONS.OPE_PLATE3_USRP_ID = UP3.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP4 ON dbo.HIS_OPERATIONS.OPE_PLATE4_USRP_ID = UP4.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP5 ON dbo.HIS_OPERATIONS.OPE_PLATE5_USRP_ID = UP5.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP6 ON dbo.HIS_OPERATIONS.OPE_PLATE6_USRP_ID = UP6.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP7 ON dbo.HIS_OPERATIONS.OPE_PLATE7_USRP_ID = UP7.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP8 ON dbo.HIS_OPERATIONS.OPE_PLATE8_USRP_ID = UP8.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP9 ON dbo.HIS_OPERATIONS.OPE_PLATE9_USRP_ID = UP9.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP10 ON dbo.HIS_OPERATIONS.OPE_PLATE10_USRP_ID = UP10.USRP_ID
					  , INSTALLATIONS
WHERE     OPE_INS_ID = INS_ID
UNION ALL
SELECT     4 OPE_TYPE, TIPA_USR_ID, TIPA_MOSE_OS, TIPA_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, TIPA_DATE, TIPA_UTC_DATE, NULL, NULL, 
                      - TIPA_AMOUNT TIPA_AMOUNT, -TIPA_AMOUNT, NULL, TIPA_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, - TIPA_FINAL_AMOUNT, 
                      TIPA_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, TIPA_CHANGE_APPLIED, USRP_ID, TIPA_PLATE_STRING, TIPA_TICKET_NUMBER, 
                      TIPA_TICKET_DATA, NULL, GRP_ID, NULL, ISNULL(GRP_DESCRIPTION2,GRP_DESCRIPTION) GRP_DESCRIPTION, NULL, TIPA_SUSCRIPTION_TYPE, TIPA_BALANCE_BEFORE, TIPA_INSERTION_UTC_DATE, TIPA_CUSPMR_ID, 
                      TIPA_OPEDIS_ID, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, CUR3.CUR_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, 
                      OPEDIS_DATE, OPEDIS_AMOUNT, OPEDIS_AMOUNT_CUR_ID, CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, 
                      OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, OPEDIS_BALANCE_BEFORE, 
                      OPEDIS_INSERTION_UTC_DATE, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL 
                      CUSPMR_CARD_HASH, NULL CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL 
                      CUSPMR_CARD_EXPIRATION_DATE, TIPA_DATE_UTC_OFFSET, NULL, NULL, CUSPMR_DATE_UTC_OFFSET, OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, 
                      CUR1.CUR_NAME, CUR2.CUR_NAME, CUR3.CUR_NAME, CUR4.CUR_NAME, CUR5.CUR_NAME, NULL, NULL, NULL, TIPA_CONFIRMED_IN_WS, NULL, NULL, 
                      TIPA_CONFIRMATION_TIME_IN_WS, TIPA_QUEUE_LENGTH_BEFORE_CONFIRM_WS, NULL, NULL, NULL, NULL, TIPA_LATITUDE, TIPA_LONGITUDE, TIPA_ID, 
                      TIPA_APP_VERSION, NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL 
                      OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE, NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL 
                      OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE, NULL 
                      OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION, TIPA_PERC_VAT1, TIPA_PERC_VAT2, 
                      - TIPA_PARTIAL_VAT1, TIPA_PERC_FEE, TIPA_PERC_FEE_TOPPED, - TIPA_PARTIAL_PERC_FEE, TIPA_FIXED_FEE, - TIPA_PARTIAL_FIXED_FEE, 0, 0, 
                      - ISNULL(TIPA_TOTAL_AMOUNT, TIPA_AMOUNT), NULL TRANS_STATUS, NULL STATUS_DATE, NULL, NULL, NULL OPE_CUSPMR_TYPE, NULL 
                      OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_CUSPMR_CREATION_TYPE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 
					  0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
					  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM         dbo.TICKET_PAYMENTS LEFT OUTER JOIN
                      dbo.USER_PLATES ON dbo.TICKET_PAYMENTS.TIPA_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                      dbo.CURRENCIES CUR1 ON TIPA_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                      dbo.CURRENCIES CUR2 ON TIPA_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                      dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON 
                      dbo.TICKET_PAYMENTS.TIPA_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID LEFT OUTER JOIN
                      dbo.OPERATIONS_DISCOUNTS ON dbo.TICKET_PAYMENTS.TIPA_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID INNER JOIN
                      dbo.USERS ON TIPA_USR_ID = USR_ID LEFT OUTER JOIN
                      dbo.GROUPS ON TIPA_GRP_ID = GRP_ID, INSTALLATIONS
WHERE     TIPA_INS_ID = INS_ID
UNION ALL
SELECT     4 OPE_TYPE, NULL, 5, TIPANU_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, TIPANU_DATE, TIPANU_UTC_DATE, NULL, NULL, 
                      - TIPANU_AMOUNT TIPA_AMOUNT,-TIPANU_AMOUNT, NULL, TIPANU_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, - TIPANU_FINAL_AMOUNT, 
                      TIPANU_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, TIPANU_CHANGE_APPLIED, USRP_ID, TIPANU_PLATE_STRING, TIPANU_TICKET_NUMBER, 
                      TIPANU_TICKET_DATA, NULL, GRP_ID, NULL, ISNULL(GRP_DESCRIPTION2,GRP_DESCRIPTION) GRP_DESCRIPTION, NULL, TIPANU_SUSCRIPTION_TYPE, TIPANU_BALANCE_BEFORE, TIPANU_INSERTION_UTC_DATE, NULL, 
                      TIPANU_OPEDIS_ID, NULL, NULL, NULL, NULL, NULL, NULL, 
                      OPEDIS_DATE, OPEDIS_AMOUNT, OPEDIS_AMOUNT_CUR_ID, CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, 
                      OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, OPEDIS_BALANCE_BEFORE, 
                      OPEDIS_INSERTION_UTC_DATE, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL 
                      CUSPMR_CARD_HASH, NULL CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL 
                      CUSPMR_CARD_EXPIRATION_DATE, TIPANU_DATE_UTC_OFFSET, NULL, NULL, NULL, OPEDIS_DATE_UTC_OFFSET, NULL, 
                      CUR1.CUR_NAME, CUR2.CUR_NAME, NULL, CUR4.CUR_NAME, CUR5.CUR_NAME, NULL, NULL, NULL, TIPANU_CONFIRMED_IN_WS, NULL, NULL, 
                      TIPANU_CONFIRMATION_TIME_IN_WS, TIPANU_QUEUE_LENGTH_BEFORE_CONFIRM_WS, NULL, NULL, NULL, NULL, TIPANU_LATITUDE, TIPANU_LONGITUDE, TIPANU_ID, 
                      TIPANU_APP_VERSION, NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL 
                      OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE, NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL 
                      OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE, NULL 
                      OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION, TIPANU_PERC_VAT1, TIPANU_PERC_VAT2, 
                      - TIPANU_PARTIAL_VAT1, TIPANU_PERC_FEE, TIPANU_PERC_FEE_TOPPED, - TIPANU_PARTIAL_PERC_FEE, TIPANU_FIXED_FEE, - TIPANU_PARTIAL_FIXED_FEE, 0, 0, 
                      - ISNULL(TIPANU_TOTAL_AMOUNT, TIPANU_AMOUNT), NULL TRANS_STATUS, NULL STATUS_DATE, NULL, NULL, NULL OPE_CUSPMR_TYPE, NULL 
                      OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_CUSPMR_CREATION_TYPE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 
					  0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
					  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM         dbo.TICKET_PAYMENTS_NON_USERS LEFT OUTER JOIN
                      dbo.USER_PLATES ON dbo.TICKET_PAYMENTS_NON_USERS.TIPANU_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                      dbo.CURRENCIES CUR1 ON TIPANU_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                      dbo.CURRENCIES CUR2 ON TIPANU_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                      dbo.OPERATIONS_DISCOUNTS ON dbo.TICKET_PAYMENTS_NON_USERS.TIPANU_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID LEFT OUTER JOIN
                      dbo.GROUPS ON TIPANU_GRP_ID = GRP_ID, INSTALLATIONS
WHERE     TIPANU_INS_ID = INS_ID
UNION ALL
SELECT     5 OPE_TYPE, CUSPMR_USR_ID, CUSPMR_MOSE_OS, NULL , NULL, NULL, CUSPMR_DATE, CUSPMR_UTC_DATE, NULL, NULL, CUSPMR_AMOUNT, CUSPMR_AMOUNT, NULL, 
                      CUSPMR_CUR_ID, CUR_ISO_CODE, NULL, CUSPMR_CUR_ID, CUR_ISO_CODE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
                      CUSPMR_SUSCRIPTION_TYPE, CUSPMR_BALANCE_BEFORE, 
                      CUSPMR_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
                      CUSPMR_OP_REFERENCE COLLATE Modern_Spanish_CI_AS, CUSPMR_TRANSACTION_ID COLLATE Modern_Spanish_CI_AS, CUSPMR_AUTH_CODE COLLATE Modern_Spanish_CI_AS, 
					  CUSPMR_CARD_HASH COLLATE Modern_Spanish_CI_AS, CUSPMR_CARD_REFERENCE COLLATE Modern_Spanish_CI_AS, CUSPMR_CARD_SCHEME COLLATE Modern_Spanish_CI_AS, 
                      CUSPMR_MASKED_CARD_NUMBER COLLATE Modern_Spanish_CI_AS, CUSPMR_CARD_EXPIRATION_DATE, CUSPMR_DATE_UTC_OFFSET, NULL, NULL, NULL, NULL, 
                      USR_USERNAME COLLATE Modern_Spanish_CI_AS, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, CUSPMR_LATITUDE, 
                      CUSPMR_LONGITUDE, CUSPMR_ID, CUSPMR_APP_VERSION COLLATE Modern_Spanish_CI_AS, NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL 
                      OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE, NULL OPEOFF_UTC_ENTRY_DATE, NULL 
                      OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL 
                      OPEOFF_UTC_EXIT_DATE, NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION, CUSPMR_PERC_VAT1, 
                      CUSPMR_PERC_VAT2, CUSPMR_PARTIAL_VAT1, CUSPMR_PERC_FEE, CUSPMR_PERC_FEE_TOPPED, CUSPMR_PARTIAL_PERC_FEE, CUSPMR_FIXED_FEE, 
                      CUSPMR_PARTIAL_FIXED_FEE, 0, 0, ISNULL(CUSPMR_TOTAL_AMOUNT_CHARGED, CUSPMR_AMOUNT), CUSPMR_TRANS_STATUS TRANS_STATUS, 
                      CUSPMR_STATUS_DATE STATUS_DATE, NULL, NULL, CUSPMR_TYPE OPE_CUSPMR_TYPE, 
                      CUSPMR_PAGATELIA_NEW_BALANCE OPE_CUSPMR_PAGATELIA_NEW_BALANCE, CUSPMR_CREATION_TYPE OPE_CUSPMR_CREATION_TYPE, NULL OPE_TIME_BALANCE_USED, 
					  NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
					  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM         dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS INNER JOIN
                      dbo.USERS ON CUSPMR_USR_ID = USR_ID, dbo.CURRENCIES
WHERE     CUSPMR_CUR_ID = CUR_ID AND (CUSPMR_SUSCRIPTION_TYPE = 1 OR
                      CUSPMR_SUSCRIPTION_TYPE IS NULL) AND ((CUSPMR_TRANS_STATUS IN (1, 2, 3, 4, 7) AND CUSPMR_RCOUP_ID IS NULL) OR
                      CUSPMR_TYPE IN (3, 4,6))
UNION ALL
SELECT     6 OPE_TYPE, SECH_USR_ID, SECH_MOSE_OS, NULL, NULL, NULL, SECH_DATE, SECH_UTC_DATE, NULL, NULL, - SECH_AMOUNT, -SECH_AMOUNT, NULL, SECH_AMOUNT_CUR_ID, 
                      CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, - SECH_FINAL_AMOUNT, SECH_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
                      SECH_CHANGE_APPLIED, NULL, NULL, NULL, NULL, SECH_SECHT_ID, NULL, NULL, NULL, NULL, SECH_SUSCRIPTION_TYPE, SECH_BALANCE_BEFORE, 
                      SECH_INSERTION_UTC_DATE, SECH_CUSPMR_ID, NULL, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, CUR3.CUR_ISO_CODE, 
                      CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL 
                      CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
                      CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, 
                      SECH_DATE_UTC_OFFSET, NULL, NULL, CUSPMR_DATE_UTC_OFFSET, NULL, USR_USERNAME, CUR1.CUR_NAME, CUR2.CUR_NAME, 
                      CUR3.CUR_NAME, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, SECH_ID, SECH_APP_VERSION, NULL 
                      OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL
                       OPEOFF_EXIT_DATE, NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL 
                      OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE, NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL 
                      OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION, SECH_PERC_VAT1, SECH_PERC_VAT2, - SECH_PARTIAL_VAT1, SECH_PERC_FEE, 
                      SECH_PERC_FEE_TOPPED, - SECH_PARTIAL_PERC_FEE, SECH_FIXED_FEE, - SECH_PARTIAL_FIXED_FEE, 0, 0, - ISNULL(SECH_TOTAL_AMOUNT, 
                      SECH_AMOUNT), NULL TRANS_STATUS, NULL STATUS_DATE, NULL, NULL, NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_CUSPMR_CREATION_TYPE, 
					  NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
					  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM         dbo.SERVICE_CHARGES INNER JOIN
                      dbo.CURRENCIES CUR1 ON SECH_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                      dbo.CURRENCIES CUR2 ON SECH_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                      dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON 
                      dbo.SERVICE_CHARGES.SECH_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID INNER JOIN
                      dbo.USERS ON SECH_USR_ID = USR_ID
UNION ALL
SELECT     7 OPE_TYPE, OPEDIS_USR_ID, OPEDIS_MOSE_OS, NULL, NULL, NULL, OPEDIS_DATE, OPEDIS_UTC_DATE, NULL, NULL, OPEDIS_AMOUNT,OPEDIS_AMOUNT, NULL, 
                      OPEDIS_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, 
                      CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
                      OPEDIS_SUSCRIPTION_TYPE, OPEDIS_BALANCE_BEFORE, 
                      OPEDIS_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL 
                      CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
                      CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, 
                      OPEDIS_DATE_UTC_OFFSET, NULL, NULL, NULL, NULL, USR_USERNAME, CUR1.CUR_NAME, 
                      CUR2.CUR_NAME, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, OPEDIS_LATITUDE, OPEDIS_LONGITUDE, 
                      OPEDIS_ID, OPEDIS_APP_VERSION, NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL 
                      OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE, NULL OPEOFF_UTC_ENTRY_DATE, NULL 
                      OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL 
                      OPEOFF_UTC_EXIT_DATE, NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION, OPEDIS_PERC_VAT1, 
                      OPEDIS_PERC_VAT2, OPEDIS_PARTIAL_VAT1, OPEDIS_PERC_FEE, OPEDIS_PERC_FEE_TOPPED, OPEDIS_PARTIAL_PERC_FEE, OPEDIS_FIXED_FEE, 
                      OPEDIS_PARTIAL_FIXED_FEE, 0, 0, ISNULL(OPEDIS_TOTAL_AMOUNT, OPEDIS_AMOUNT), NULL TRANS_STATUS, NULL STATUS_DATE, NULL, NULL, NULL 
                      OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_CUSPMR_CREATION_TYPE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, 
					  NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
					  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM         dbo.OPERATIONS_DISCOUNTS INNER JOIN
                      dbo.CURRENCIES CUR1 ON OPEDIS_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                      dbo.CURRENCIES CUR2 ON OPEDIS_BALANCE_CUR_ID = CUR2.CUR_ID INNER JOIN
                      dbo.USERS ON OPEDIS_USR_ID = USR_ID
UNION ALL
SELECT     OPEOFF_TYPE, OPEOFF_USR_ID, OPEOFF_MOSE_OS, OPEOFF_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, 
                      CASE OPEOFF_TYPE WHEN 8 THEN OPEOFF_NOTIFY_ENTRY_DATE ELSE OPEOFF_PAYMENT_DATE END, 
                      CASE OPEOFF_TYPE WHEN 8 THEN OPEOFF_UTC_NOTIFY_ENTRY_DATE ELSE OPEOFF_UTC_PAYMENT_DATE END, OPEOFF_ENTRY_DATE, OPEOFF_END_DATE, 
                      CAST(- OPEOFF_AMOUNT AS int),CAST(- OPEOFF_AMOUNT AS int), OPEOFF_TIME, OPEOFF_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, 
                      CAST(- OPEOFF_FINAL_AMOUNT AS int), OPEOFF_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, OPEOFF_CHANGE_APPLIED, 
                      USRP_ID, USRP_PLATE, NULL TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, GRP_ID, NULL, ISNULL(GRP_DESCRIPTION2, 
                      GRP_DESCRIPTION) GRP_DESCRIPTION, NULL, OPEOFF_SUSCRIPTION_TYPE, OPEOFF_BALANCE_BEFORE, OPEOFF_INSERTION_UTC_DATE, 
                      OPEOFF_CUSPMR_ID, OPEOFF_OPEDIS_ID, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, CUR3.CUR_ISO_CODE CUSPMR_AMOUNT_ISO_CODE, 
                      CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, OPEDIS_DATE, OPEDIS_AMOUNT, OPEDIS_AMOUNT_CUR_ID, 
                      CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, 
                      CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, OPEDIS_BALANCE_BEFORE, OPEDIS_INSERTION_UTC_DATE, NULL 
                      CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
                      CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, 
                      CASE OPEOFF_TYPE WHEN 8 THEN OPEOFF_NOTIFY_ENTRY_DATE_UTC_OFFSET ELSE OPEOFF_PAYMENT_DATE_UTC_OFFSET END, 
                      OPEOFF_ENTRY_DATE_UTC_OFFSET, OPEOFF_END_DATE_UTC_OFFSET, CUSPMR_DATE_UTC_OFFSET OPE_CUSPMR_DATE_UTC_OFFSET, 
                      OPEDIS_DATE_UTC_OFFSET OPE_OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, CUR1.CUR_NAME OPE_AMOUNT_CUR_NAME, 
                      CUR2.CUR_NAME OPE_BALANCE_CUR_NAME, CUR3.CUR_NAME CUSPMR_CUR_NAME, CUR4.CUR_NAME OPEDIS_AMOUNT_CUR_NAME, 
                      CUR5.CUR_NAME OPEDIS_BALANCE_CUR_NAME, OPEOFF_EXTERNAL_ID1, OPEOFF_EXTERNAL_ID2, OPEOFF_EXTERNAL_ID3, OPEOFF_CONFIRMED_IN_WS1, 
                      OPEOFF_CONFIRMED_IN_WS2, OPEOFF_CONFIRMED_IN_WS3, OPEOFF_CONFIRMATION_TIME_IN_WS1, OPEOFF_QUEUE_LENGTH_BEFORE_CONFIRM_WS1, 
                      OPEOFF_CONFIRMATION_TIME_IN_WS2, OPEOFF_QUEUE_LENGTH_BEFORE_CONFIRM_WS2, OPEOFF_CONFIRMATION_TIME_IN_WS3, 
                      OPEOFF_QUEUE_LENGTH_BEFORE_CONFIRM_WS3, OPEOFF_LATITUDE, OPEOFF_LONGITUDE, OPEOFF_ID, OPEOFF_APP_VERSION, OPEOFF_ENTRY_DATE, 
                      OPEOFF_NOTIFY_ENTRY_DATE, OPEOFF_PAYMENT_DATE, OPEOFF_END_DATE, OPEOFF_EXIT_LIMIT_DATE, OPEOFF_EXIT_DATE, OPEOFF_UTC_ENTRY_DATE, 
                      OPEOFF_UTC_NOTIFY_ENTRY_DATE, OPEOFF_UTC_PAYMENT_DATE, OPEOFF_UTC_END_DATE, OPEOFF_UTC_EXIT_LIMIT_DATE, OPEOFF_UTC_EXIT_DATE, 
                      OPEOFF_LOGICAL_ID, OPEOFF_TARIFF, OPEOFF_GATE, OPEOFF_SPACE_DESCRIPTION, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, - OPEOFF_AMOUNT, NULL TRANS_STATUS, NULL 
                      STATUS_DATE, OPEOFF_UTC_ENTRY_DATE, OPEOFF_UTC_END_DATE, NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_CUSPMR_CREATION_TYPE, 
					  NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
					  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM         dbo.OPERATIONS_OFFSTREET LEFT OUTER JOIN
                      dbo.USER_PLATES ON dbo.OPERATIONS_OFFSTREET.OPEOFF_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                      dbo.CURRENCIES CUR1 ON OPEOFF_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                      dbo.CURRENCIES CUR2 ON OPEOFF_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                      dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS ON 
                      dbo.OPERATIONS_OFFSTREET.OPEOFF_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES_HIS.CUSPMR_ID LEFT OUTER JOIN
                      dbo.OPERATIONS_DISCOUNTS ON dbo.OPERATIONS_OFFSTREET.OPEOFF_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID INNER JOIN
                      dbo.USERS ON OPEOFF_USR_ID = USR_ID LEFT OUTER JOIN
                      dbo.GROUPS ON OPEOFF_GRP_ID = GRP_ID, INSTALLATIONS
WHERE     OPEOFF_INS_ID = INS_ID
UNION ALL
SELECT     12 OPE_TYPE, NULL, 5, NULL, NULL, NULL, RTLPY_DATE, RTLPY_INSERTION_UTC_DATE, NULL, NULL, RTLPY_AMOUNT,RTLPY_AMOUNT, NULL, RTLPY_CUR_ID, 
                      CUR_ISO_CODE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, RTLPY_SUSCRIPTION_TYPE, NULL, 
                      RTLPY_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
                      RTLPY_OP_REFERENCE, RTLPY_TRANSACTION_ID, RTLPY_AUTH_CODE, RTLPY_CARD_HASH, RTLPY_CARD_REFERENCE, RTLPY_CARD_SCHEME, 
                      RTLPY_MASKED_CARD_NUMBER, 
                      RTLPY_CARD_EXPIRATION_DATE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
                       NULL, NULL, NULL, NULL, NULL, RTLPY_ID, NULL, NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL 
                      OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE, NULL OPEOFF_UTC_ENTRY_DATE, NULL 
                      OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL 
                      OPEOFF_UTC_EXIT_DATE, NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION, RTLPY_PERC_VAT1, 
                      RTLPY_PERC_VAT2, RTLPY_PARTIAL_VAT1, RTLPY_PERC_FEE, RTLPY_PERC_FEE_TOPPED, RTLPY_PARTIAL_PERC_FEE, RTLPY_FIXED_FEE, 
                      RTLPY_PARTIAL_FIXED_FEE, 0, 0, ISNULL(RTLPY_TOTAL_AMOUNT_CHARGED, RTLPY_AMOUNT), RTLPY_TRANS_STATUS TRANS_STATUS, 
                      RTLPY_STATUS_DATE STATUS_DATE, NULL, NULL, NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_CUSPMR_CREATION_TYPE, 
					  NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
					  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM         dbo.RETAILER_PAYMENTS, dbo.CURRENCIES
WHERE     RTLPY_CUR_ID = CUR_ID AND (RTLPY_SUSCRIPTION_TYPE = 1 OR
                      RTLPY_SUSCRIPTION_TYPE IS NULL) AND RTLPY_TRANS_STATUS IN (1, 2, 3, 4, 7)

GO




