/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.DB_OPERATIONS_HOUR ADD
	TICKETPAYMENTS_NON_USERS_COUNT int NULL,
	TICKETPAYMENTS_NON_USERS_AMOUNT int NULL,
	TICKETPAYMENTS_NON_USERS_VAT int NULL,
	TICKETPAYMENTS_NON_USERS_PERC_FEE int NULL,
	TICKETPAYMENTS_NON_USERS_PERC_FEE_VAT int NULL,
	TICKETPAYMENTS_NON_USERS_FIXED_FEE int NULL,
	TICKETPAYMENTS_NON_USERS_FIXED_FEE_VAT int NULL,
	TICKETPAYMENTS_NON_USERS_TOTAL_AMOUNT int NULL
GO
ALTER TABLE dbo.DB_OPERATIONS_HOUR SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
GO

/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.DB_OPERATIONS_MINUTE ADD
	TICKETPAYMENTS_NON_USERS_COUNT int NULL
GO
ALTER TABLE dbo.DB_OPERATIONS_MINUTE SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
GO

ALTER VIEW [dbo].[ALL_OPERATIONS_EXT_DB]
AS
SELECT     CASE ISNULL(TAR_TYPE, 0) WHEN 1 THEN 19 ELSE OPE_TYPE END AS OPE_TYPE, OPE_USR_ID, OPE_MOSE_OS, OPE_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, OPE_DATE, OPE_UTC_DATE, OPE_INIDATE, OPE_ENDDATE, 
                      CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_AMOUNT ELSE - OPE_AMOUNT END AS int) OPE_AMOUNT, 
					   CAST( CASE 
					  WHEN OPE_TYPE = 3
						 THEN ISNULL(OPE_REAL_AMOUNT,OPE_AMOUNT) 
					  ELSE -ISNULL(OPE_REAL_AMOUNT,OPE_AMOUNT) 
				 END AS int) OPE_REAL_AMOUNT,
					  OPE_TIME, OPE_AMOUNT_CUR_ID, 
                      CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_FINAL_AMOUNT ELSE - OPE_FINAL_AMOUNT END AS int) 
                      OPE_FINAL_AMOUNT, OPE_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, OPE_CHANGE_APPLIED, USER_PLATES.USRP_ID, USER_PLATES.USRP_PLATE, NULL 
                      TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, GRP_ID, TAR_ID, ISNULL(GRP_DESCRIPTION2, GRP_DESCRIPTION) GRP_DESCRIPTION, 
                      TAR_DESCRIPTION, OPE_SUSCRIPTION_TYPE, OPE_BALANCE_BEFORE, OPE_INSERTION_UTC_DATE, OPE_CUSPMR_ID, OPE_OPEDIS_ID, CUSPMR_DATE, 
                      CUSPMR_AMOUNT, CUSPMR_CUR_ID, CUR3.CUR_ISO_CODE CUSPMR_AMOUNT_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, 
                      OPEDIS_DATE, OPEDIS_AMOUNT, OPEDIS_AMOUNT_CUR_ID, CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, 
                      OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, OPEDIS_BALANCE_BEFORE, 
                      OPEDIS_INSERTION_UTC_DATE, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL 
                      CUSPMR_CARD_HASH, NULL CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL 
                      CUSPMR_CARD_EXPIRATION_DATE, OPE_DATE_UTC_OFFSET, OPE_INIDATE_UTC_OFFSET, OPE_ENDDATE_UTC_OFFSET, 
                      CUSPMR_DATE_UTC_OFFSET OPE_CUSPMR_DATE_UTC_OFFSET, OPEDIS_DATE_UTC_OFFSET OPE_OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, 
                      CUR1.CUR_NAME OPE_AMOUNT_CUR_NAME, CUR2.CUR_NAME OPE_BALANCE_CUR_NAME, CUR3.CUR_NAME CUSPMR_CUR_NAME, 
                      CUR4.CUR_NAME OPEDIS_AMOUNT_CUR_NAME, CUR5.CUR_NAME OPEDIS_BALANCE_CUR_NAME, OPERATIONS.OPE_EXTERNAL_ID1, 
                      OPERATIONS.OPE_EXTERNAL_ID2, OPERATIONS.OPE_EXTERNAL_ID3, OPE_CONFIRMED_IN_WS1, OPE_CONFIRMED_IN_WS2, 
                      OPE_CONFIRMED_IN_WS3, OPE_CONFIRMATION_TIME_IN_WS1, OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS1, OPE_CONFIRMATION_TIME_IN_WS2, 
                      OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS2, OPE_CONFIRMATION_TIME_IN_WS3, OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS3, OPE_LATITUDE, 
                      OPE_LONGITUDE, OPE_ID, OPE_APP_VERSION, NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL 
                      OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE, NULL OPEOFF_UTC_ENTRY_DATE, NULL 
                      OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL 
                      OPEOFF_UTC_EXIT_DATE, NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION, OPE_PERC_VAT1, 
                      OPE_PERC_VAT2, CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_VAT1 ELSE - OPE_PARTIAL_VAT1 END AS int) OPE_PARTIAL_VAT1, OPE_PERC_FEE, 
                      OPE_PERC_FEE_TOPPED, CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_PERC_FEE ELSE - OPE_PARTIAL_PERC_FEE END AS int) 
                      OPE_PARTIAL_PERC_FEE, OPE_FIXED_FEE, CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_FIXED_FEE ELSE - OPE_PARTIAL_FIXED_FEE END AS int) 
                      OPE_PARTIAL_FIXED_FEE, ISNULL(OPE_PERC_BONUS, 0) OPE_PERC_BONUS, CAST(ISNULL(OPE_PARTIAL_BONUS_FEE, 0) AS int) OPE_PARTIAL_BONUS_FEE, 
                      CAST(CASE WHEN OPE_TYPE = 3 THEN ISNULL(OPE_TOTAL_AMOUNT, OPE_AMOUNT) ELSE - ISNULL(OPE_TOTAL_AMOUNT, OPE_AMOUNT) END AS int) 
                      OPE_TOTAL_AMOUNT, NULL TRANS_STATUS, NULL STATUS_DATE, OPE_UTC_INIDATE, OPE_UTC_ENDDATE, NULL OPE_CUSPMR_TYPE, NULL 
                      OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_CUSPMR_CREATION_TYPE,
					CAST( CASE 
					  WHEN OPE_TYPE = 3
						 THEN OPE_TIME_BALANCE_USED 
					  ELSE -OPE_TIME_BALANCE_USED 
				 END AS int) OPE_TIME_BALANCE_USED, OPE_TIME_BALANCE_BEFORE, OPE_POSTPAY, OPE_SHOPKEEPER_OP, OPE_SHOPKEEPER_AMOUNT, OPE_SHOPKEEPER_PROFIT,
				 UP2.USRP_PLATE USRP_PLATE2, UP3.USRP_PLATE USRP_PLATE3, UP4.USRP_PLATE USRP_PLATE4, UP5.USRP_PLATE USRP_PLATE5, 
							 UP6.USRP_PLATE USRP_PLATE6, UP7.USRP_PLATE USRP_PLATE7, UP8.USRP_PLATE USRP_PLATE8, UP9.USRP_PLATE USRP_PLATE9, UP10.USRP_PLATE USRP_PLATE10
FROM         dbo.OPERATIONS LEFT OUTER JOIN
                      dbo.USER_PLATES ON dbo.OPERATIONS.OPE_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                      dbo.CURRENCIES CUR1 ON OPE_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                      dbo.CURRENCIES CUR2 ON OPE_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                      dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES ON 
                      dbo.OPERATIONS.OPE_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES.CUSPMR_ID LEFT OUTER JOIN
                      dbo.OPERATIONS_DISCOUNTS ON dbo.OPERATIONS.OPE_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID INNER JOIN
                      dbo.USERS ON OPE_USR_ID = USR_ID LEFT OUTER JOIN
                      dbo.GROUPS ON OPE_GRP_ID = GRP_ID LEFT OUTER JOIN
                      dbo.TARIFFS ON OPE_TAR_ID = TAR_ID
					  LEFT OUTER JOIN dbo.USER_PLATES UP2 ON dbo.OPERATIONS.OPE_PLATE2_USRP_ID = UP2.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP3 ON dbo.OPERATIONS.OPE_PLATE3_USRP_ID = UP3.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP4 ON dbo.OPERATIONS.OPE_PLATE4_USRP_ID = UP4.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP5 ON dbo.OPERATIONS.OPE_PLATE5_USRP_ID = UP5.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP6 ON dbo.OPERATIONS.OPE_PLATE6_USRP_ID = UP6.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP7 ON dbo.OPERATIONS.OPE_PLATE7_USRP_ID = UP7.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP8 ON dbo.OPERATIONS.OPE_PLATE8_USRP_ID = UP8.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP9 ON dbo.OPERATIONS.OPE_PLATE9_USRP_ID = UP9.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP10 ON dbo.OPERATIONS.OPE_PLATE10_USRP_ID = UP10.USRP_ID
					  , INSTALLATIONS
WHERE     OPE_INS_ID = INS_ID
UNION ALL
SELECT     4 OPE_TYPE, TIPA_USR_ID, TIPA_MOSE_OS, TIPA_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, TIPA_DATE, TIPA_UTC_DATE, NULL, NULL, 
                      - TIPA_AMOUNT TIPA_AMOUNT,-TIPA_AMOUNT, NULL, TIPA_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, - TIPA_FINAL_AMOUNT, 
                      TIPA_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, TIPA_CHANGE_APPLIED, USRP_ID, TIPA_PLATE_STRING, TIPA_TICKET_NUMBER, 
                      TIPA_TICKET_DATA, NULL, NULL, GRP_ID, NULL, NULL, TIPA_SUSCRIPTION_TYPE, TIPA_BALANCE_BEFORE, TIPA_INSERTION_UTC_DATE, TIPA_CUSPMR_ID, 
                      TIPA_OPEDIS_ID, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, CUR3.CUR_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, 
                      OPEDIS_DATE, OPEDIS_AMOUNT, OPEDIS_AMOUNT_CUR_ID, CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, 
                      OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, OPEDIS_BALANCE_BEFORE, 
                      OPEDIS_INSERTION_UTC_DATE, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL 
                      CUSPMR_CARD_HASH, NULL CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL 
                      CUSPMR_CARD_EXPIRATION_DATE, TIPA_DATE_UTC_OFFSET, NULL, NULL, CUSPMR_DATE_UTC_OFFSET, OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, 
                      CUR1.CUR_NAME, CUR2.CUR_NAME, CUR3.CUR_NAME, CUR4.CUR_NAME, CUR5.CUR_NAME, NULL, NULL, NULL, TIPA_CONFIRMED_IN_WS, NULL, NULL, 
                      TIPA_CONFIRMATION_TIME_IN_WS, TIPA_QUEUE_LENGTH_BEFORE_CONFIRM_WS, NULL, NULL, NULL, NULL, TIPA_LATITUDE, TIPA_LONGITUDE, TIPA_ID, 
                      TIPA_APP_VERSION, NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL 
                      OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE, NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL 
                      OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE, NULL 
                      OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION, TIPA_PERC_VAT1, TIPA_PERC_VAT2, 
                      - TIPA_PARTIAL_VAT1, TIPA_PERC_FEE, TIPA_PERC_FEE_TOPPED, - TIPA_PARTIAL_PERC_FEE, TIPA_FIXED_FEE, - TIPA_PARTIAL_FIXED_FEE, 0, 0, 
                      - ISNULL(TIPA_TOTAL_AMOUNT, TIPA_AMOUNT), NULL TRANS_STATUS, NULL STATUS_DATE, NULL, NULL, NULL OPE_CUSPMR_TYPE, NULL 
                      OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_CUSPMR_CREATION_TYPE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 
					  0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
					  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM         dbo.TICKET_PAYMENTS LEFT OUTER JOIN
                      dbo.USER_PLATES ON dbo.TICKET_PAYMENTS.TIPA_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                      dbo.CURRENCIES CUR1 ON TIPA_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                      dbo.CURRENCIES CUR2 ON TIPA_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                      dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES ON 
                      dbo.TICKET_PAYMENTS.TIPA_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES.CUSPMR_ID LEFT OUTER JOIN
                      dbo.OPERATIONS_DISCOUNTS ON dbo.TICKET_PAYMENTS.TIPA_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID INNER JOIN
                      dbo.USERS ON TIPA_USR_ID = USR_ID LEFT OUTER JOIN
                      dbo.GROUPS ON TIPA_GRP_ID = GRP_ID, INSTALLATIONS
WHERE     TIPA_INS_ID = INS_ID
UNION ALL
SELECT     4 OPE_TYPE, NULL, 5, TIPANU_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, TIPANU_DATE, TIPANU_UTC_DATE, NULL, NULL, 
                      - TIPANU_AMOUNT TIPA_AMOUNT,-TIPANU_AMOUNT, NULL, TIPANU_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, - TIPANU_FINAL_AMOUNT, 
                      TIPANU_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, TIPANU_CHANGE_APPLIED, USRP_ID, TIPANU_PLATE_STRING, TIPANU_TICKET_NUMBER, 
                      TIPANU_TICKET_DATA, NULL, NULL, GRP_ID, NULL, NULL, TIPANU_SUSCRIPTION_TYPE, TIPANU_BALANCE_BEFORE, TIPANU_INSERTION_UTC_DATE, NULL, 
                      TIPANU_OPEDIS_ID, NULL, NULL, NULL, NULL, NULL, NULL, 
                      OPEDIS_DATE, OPEDIS_AMOUNT, OPEDIS_AMOUNT_CUR_ID, CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, 
                      OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, OPEDIS_BALANCE_BEFORE, 
                      OPEDIS_INSERTION_UTC_DATE, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL 
                      CUSPMR_CARD_HASH, NULL CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL 
                      CUSPMR_CARD_EXPIRATION_DATE, TIPANU_DATE_UTC_OFFSET, NULL, NULL, NULL, OPEDIS_DATE_UTC_OFFSET, NULL, 
                      CUR1.CUR_NAME, CUR2.CUR_NAME, NULL, CUR4.CUR_NAME, CUR5.CUR_NAME, NULL, NULL, NULL, TIPANU_CONFIRMED_IN_WS, NULL, NULL, 
                      TIPANU_CONFIRMATION_TIME_IN_WS, TIPANU_QUEUE_LENGTH_BEFORE_CONFIRM_WS, NULL, NULL, NULL, NULL, TIPANU_LATITUDE, TIPANU_LONGITUDE, TIPANU_ID, 
                      TIPANU_APP_VERSION, NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL 
                      OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE, NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL 
                      OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE, NULL 
                      OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION, TIPANU_PERC_VAT1, TIPANU_PERC_VAT2, 
                      - TIPANU_PARTIAL_VAT1, TIPANU_PERC_FEE, TIPANU_PERC_FEE_TOPPED, - TIPANU_PARTIAL_PERC_FEE, TIPANU_FIXED_FEE, - TIPANU_PARTIAL_FIXED_FEE, 0, 0, 
                      - ISNULL(TIPANU_TOTAL_AMOUNT, TIPANU_AMOUNT), NULL TRANS_STATUS, NULL STATUS_DATE, NULL, NULL, NULL OPE_CUSPMR_TYPE, NULL 
                      OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_CUSPMR_CREATION_TYPE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 
					  0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
					  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM         dbo.TICKET_PAYMENTS_NON_USERS LEFT OUTER JOIN
                      dbo.USER_PLATES ON dbo.TICKET_PAYMENTS_NON_USERS.TIPANU_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                      dbo.CURRENCIES CUR1 ON TIPANU_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                      dbo.CURRENCIES CUR2 ON TIPANU_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                      dbo.OPERATIONS_DISCOUNTS ON dbo.TICKET_PAYMENTS_NON_USERS.TIPANU_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID LEFT OUTER JOIN
                      dbo.GROUPS ON TIPANU_GRP_ID = GRP_ID, INSTALLATIONS
WHERE     TIPANU_INS_ID = INS_ID
UNION ALL
SELECT     5 OPE_TYPE, CUSPMR_USR_ID, CUSPMR_MOSE_OS, NULL, NULL, NULL, CUSPMR_DATE, CUSPMR_UTC_DATE, NULL, NULL, CUSPMR_AMOUNT, CUSPMR_AMOUNT, NULL, 
                      CUSPMR_CUR_ID, CUR_ISO_CODE, NULL, CUSPMR_CUR_ID, CUR_ISO_CODE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
                      CUSPMR_SUSCRIPTION_TYPE, CUSPMR_BALANCE_BEFORE, 
                      CUSPMR_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
                      CUSPMR_OP_REFERENCE, CUSPMR_TRANSACTION_ID, CUSPMR_AUTH_CODE, CUSPMR_CARD_HASH, CUSPMR_CARD_REFERENCE, CUSPMR_CARD_SCHEME, 
                      CUSPMR_MASKED_CARD_NUMBER, CUSPMR_CARD_EXPIRATION_DATE, CUSPMR_DATE_UTC_OFFSET, NULL, NULL, NULL, NULL, 
                      USR_USERNAME, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, CUSPMR_LATITUDE, 
                      CUSPMR_LONGITUDE, CUSPMR_ID, CUSPMR_APP_VERSION, NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL 
                      OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE, NULL OPEOFF_UTC_ENTRY_DATE, NULL 
                      OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL 
                      OPEOFF_UTC_EXIT_DATE, NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION, CUSPMR_PERC_VAT1, 
                      CUSPMR_PERC_VAT2, CUSPMR_PARTIAL_VAT1, CUSPMR_PERC_FEE, CUSPMR_PERC_FEE_TOPPED, CUSPMR_PARTIAL_PERC_FEE, CUSPMR_FIXED_FEE, 
                      CUSPMR_PARTIAL_FIXED_FEE, 0, 0, ISNULL(CUSPMR_TOTAL_AMOUNT_CHARGED, CUSPMR_AMOUNT), CUSPMR_TRANS_STATUS TRANS_STATUS, 
                      CUSPMR_STATUS_DATE STATUS_DATE, NULL, NULL, CUSPMR_TYPE OPE_CUSPMR_TYPE, 
                      CUSPMR_PAGATELIA_NEW_BALANCE OPE_CUSPMR_PAGATELIA_NEW_BALANCE, CUSPMR_CREATION_TYPE OPE_CUSPMR_CREATION_TYPE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 
					  0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
					  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM         dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES INNER JOIN
                      dbo.USERS ON CUSPMR_USR_ID = USR_ID, dbo.CURRENCIES
WHERE     CUSPMR_CUR_ID = CUR_ID AND (CUSPMR_SUSCRIPTION_TYPE = 1 OR
                      CUSPMR_SUSCRIPTION_TYPE IS NULL) AND ((CUSPMR_TRANS_STATUS IN (1, 2, 3, 4, 7) AND CUSPMR_RCOUP_ID IS NULL) OR
                      CUSPMR_TYPE IN (3, 4,6))
UNION ALL
SELECT     6 OPE_TYPE, SECH_USR_ID, SECH_MOSE_OS, NULL, NULL, NULL, SECH_DATE, SECH_UTC_DATE, NULL, NULL, - SECH_AMOUNT, -SECH_AMOUNT, NULL, SECH_AMOUNT_CUR_ID, 
                      CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, - SECH_FINAL_AMOUNT, SECH_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
                      SECH_CHANGE_APPLIED, NULL, NULL, NULL, NULL, SECH_SECHT_ID, NULL, NULL, NULL, NULL, SECH_SUSCRIPTION_TYPE, SECH_BALANCE_BEFORE, 
                      SECH_INSERTION_UTC_DATE, SECH_CUSPMR_ID, NULL, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, CUR3.CUR_ISO_CODE, 
                      CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL 
                      CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
                      CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, 
                      SECH_DATE_UTC_OFFSET, NULL, NULL, CUSPMR_DATE_UTC_OFFSET, NULL, USR_USERNAME, CUR1.CUR_NAME, CUR2.CUR_NAME, 
                      CUR3.CUR_NAME, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, SECH_ID, SECH_APP_VERSION, NULL 
                      OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL
                       OPEOFF_EXIT_DATE, NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL 
                      OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE, NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL 
                      OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION, SECH_PERC_VAT1, SECH_PERC_VAT2, - SECH_PARTIAL_VAT1, SECH_PERC_FEE, 
                      SECH_PERC_FEE_TOPPED, - SECH_PARTIAL_PERC_FEE, SECH_FIXED_FEE, - SECH_PARTIAL_FIXED_FEE, 0, 0, - ISNULL(SECH_TOTAL_AMOUNT, 
                      SECH_AMOUNT), NULL TRANS_STATUS, NULL STATUS_DATE, NULL, NULL, NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_CUSPMR_CREATION_TYPE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY,
					  0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
					  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM         dbo.SERVICE_CHARGES INNER JOIN
                      dbo.CURRENCIES CUR1 ON SECH_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                      dbo.CURRENCIES CUR2 ON SECH_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                      dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES ON 
                      dbo.SERVICE_CHARGES.SECH_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES.CUSPMR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID INNER JOIN
                      dbo.USERS ON SECH_USR_ID = USR_ID
UNION ALL
SELECT     7 OPE_TYPE, OPEDIS_USR_ID, OPEDIS_MOSE_OS, NULL, NULL, NULL, OPEDIS_DATE, OPEDIS_UTC_DATE, NULL, NULL, OPEDIS_AMOUNT,OPEDIS_AMOUNT,  NULL, 
                      OPEDIS_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, 
                      CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
                      OPEDIS_SUSCRIPTION_TYPE, OPEDIS_BALANCE_BEFORE, 
                      OPEDIS_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL 
                      CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
                      CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, 
                      OPEDIS_DATE_UTC_OFFSET, NULL, NULL, NULL, NULL, USR_USERNAME, CUR1.CUR_NAME, 
                      CUR2.CUR_NAME, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, OPEDIS_LATITUDE, OPEDIS_LONGITUDE, 
                      OPEDIS_ID, OPEDIS_APP_VERSION, NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL 
                      OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE, NULL OPEOFF_UTC_ENTRY_DATE, NULL 
                      OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL 
                      OPEOFF_UTC_EXIT_DATE, NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION, OPEDIS_PERC_VAT1, 
                      OPEDIS_PERC_VAT2, OPEDIS_PARTIAL_VAT1, OPEDIS_PERC_FEE, OPEDIS_PERC_FEE_TOPPED, OPEDIS_PARTIAL_PERC_FEE, OPEDIS_FIXED_FEE, 
                      OPEDIS_PARTIAL_FIXED_FEE, 0, 0, ISNULL(OPEDIS_TOTAL_AMOUNT, OPEDIS_AMOUNT), NULL TRANS_STATUS, NULL STATUS_DATE, NULL, NULL, NULL 
                      OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_CUSPMR_CREATION_TYPE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 
					  0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
					  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM         dbo.OPERATIONS_DISCOUNTS INNER JOIN
                      dbo.CURRENCIES CUR1 ON OPEDIS_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                      dbo.CURRENCIES CUR2 ON OPEDIS_BALANCE_CUR_ID = CUR2.CUR_ID INNER JOIN
                      dbo.USERS ON OPEDIS_USR_ID = USR_ID
UNION ALL
SELECT     OPEOFF_TYPE, OPEOFF_USR_ID, OPEOFF_MOSE_OS, OPEOFF_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, 
                      CASE OPEOFF_TYPE WHEN 8 THEN OPEOFF_NOTIFY_ENTRY_DATE ELSE OPEOFF_PAYMENT_DATE END, 
                      CASE OPEOFF_TYPE WHEN 8 THEN OPEOFF_UTC_NOTIFY_ENTRY_DATE ELSE OPEOFF_UTC_PAYMENT_DATE END, OPEOFF_ENTRY_DATE, OPEOFF_END_DATE, 
                      CAST(- OPEOFF_AMOUNT AS int),CAST(- OPEOFF_AMOUNT AS int), OPEOFF_TIME, OPEOFF_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, 
                      CAST(- OPEOFF_FINAL_AMOUNT AS int), OPEOFF_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, OPEOFF_CHANGE_APPLIED, 
                      USRP_ID, USRP_PLATE, NULL TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, GRP_ID, NULL, ISNULL(GRP_DESCRIPTION2, 
                      GRP_DESCRIPTION) GRP_DESCRIPTION, NULL, OPEOFF_SUSCRIPTION_TYPE, OPEOFF_BALANCE_BEFORE, OPEOFF_INSERTION_UTC_DATE, 
                      OPEOFF_CUSPMR_ID, OPEOFF_OPEDIS_ID, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, CUR3.CUR_ISO_CODE CUSPMR_AMOUNT_ISO_CODE, 
                      CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, OPEDIS_DATE, OPEDIS_AMOUNT, OPEDIS_AMOUNT_CUR_ID, 
                      CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, 
                      CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, OPEDIS_BALANCE_BEFORE, OPEDIS_INSERTION_UTC_DATE, NULL 
                      CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
                      CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, 
                      CASE OPEOFF_TYPE WHEN 8 THEN OPEOFF_NOTIFY_ENTRY_DATE_UTC_OFFSET ELSE OPEOFF_PAYMENT_DATE_UTC_OFFSET END, 
                      OPEOFF_ENTRY_DATE_UTC_OFFSET, OPEOFF_END_DATE_UTC_OFFSET, CUSPMR_DATE_UTC_OFFSET OPE_CUSPMR_DATE_UTC_OFFSET, 
                      OPEDIS_DATE_UTC_OFFSET OPE_OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, CUR1.CUR_NAME OPE_AMOUNT_CUR_NAME, 
                      CUR2.CUR_NAME OPE_BALANCE_CUR_NAME, CUR3.CUR_NAME CUSPMR_CUR_NAME, CUR4.CUR_NAME OPEDIS_AMOUNT_CUR_NAME, 
                      CUR5.CUR_NAME OPEDIS_BALANCE_CUR_NAME, OPEOFF_EXTERNAL_ID1, OPEOFF_EXTERNAL_ID2, OPEOFF_EXTERNAL_ID3, OPEOFF_CONFIRMED_IN_WS1, 
                      OPEOFF_CONFIRMED_IN_WS2, OPEOFF_CONFIRMED_IN_WS3, OPEOFF_CONFIRMATION_TIME_IN_WS1, OPEOFF_QUEUE_LENGTH_BEFORE_CONFIRM_WS1, 
                      OPEOFF_CONFIRMATION_TIME_IN_WS2, OPEOFF_QUEUE_LENGTH_BEFORE_CONFIRM_WS2, OPEOFF_CONFIRMATION_TIME_IN_WS3, 
                      OPEOFF_QUEUE_LENGTH_BEFORE_CONFIRM_WS3, OPEOFF_LATITUDE, OPEOFF_LONGITUDE, OPEOFF_ID, OPEOFF_APP_VERSION, OPEOFF_ENTRY_DATE, 
                      OPEOFF_NOTIFY_ENTRY_DATE, OPEOFF_PAYMENT_DATE, OPEOFF_END_DATE, OPEOFF_EXIT_LIMIT_DATE, OPEOFF_EXIT_DATE, OPEOFF_UTC_ENTRY_DATE, 
                      OPEOFF_UTC_NOTIFY_ENTRY_DATE, OPEOFF_UTC_PAYMENT_DATE, OPEOFF_UTC_END_DATE, OPEOFF_UTC_EXIT_LIMIT_DATE, OPEOFF_UTC_EXIT_DATE, 
                      OPEOFF_LOGICAL_ID, OPEOFF_TARIFF, OPEOFF_GATE, OPEOFF_SPACE_DESCRIPTION, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, - OPEOFF_AMOUNT, NULL TRANS_STATUS, NULL 
                      STATUS_DATE, OPEOFF_UTC_ENTRY_DATE, OPEOFF_UTC_END_DATE, NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_CUSPMR_CREATION_TYPE, 
					  NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
					  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM         dbo.OPERATIONS_OFFSTREET LEFT OUTER JOIN
                      dbo.USER_PLATES ON dbo.OPERATIONS_OFFSTREET.OPEOFF_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                      dbo.CURRENCIES CUR1 ON OPEOFF_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                      dbo.CURRENCIES CUR2 ON OPEOFF_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                      dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES ON 
                      dbo.OPERATIONS_OFFSTREET.OPEOFF_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES.CUSPMR_ID LEFT OUTER JOIN
                      dbo.OPERATIONS_DISCOUNTS ON dbo.OPERATIONS_OFFSTREET.OPEOFF_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID INNER JOIN
                      dbo.USERS ON OPEOFF_USR_ID = USR_ID LEFT OUTER JOIN
                      dbo.GROUPS ON OPEOFF_GRP_ID = GRP_ID, INSTALLATIONS
WHERE     OPEOFF_INS_ID = INS_ID
UNION ALL
SELECT     12 OPE_TYPE, NULL, 5, NULL, NULL, NULL, RTLPY_DATE, RTLPY_INSERTION_UTC_DATE, NULL, NULL, RTLPY_AMOUNT, RTLPY_AMOUNT, NULL, RTLPY_CUR_ID, 
                      CUR_ISO_CODE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, RTLPY_SUSCRIPTION_TYPE, NULL, 
                      RTLPY_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
                      RTLPY_OP_REFERENCE, RTLPY_TRANSACTION_ID, RTLPY_AUTH_CODE, RTLPY_CARD_HASH, RTLPY_CARD_REFERENCE, RTLPY_CARD_SCHEME, 
                      RTLPY_MASKED_CARD_NUMBER, 
                      RTLPY_CARD_EXPIRATION_DATE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
                       NULL, NULL, NULL, NULL, NULL, RTLPY_ID, NULL, NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL 
                      OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE, NULL OPEOFF_UTC_ENTRY_DATE, NULL 
                      OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL 
                      OPEOFF_UTC_EXIT_DATE, NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION, RTLPY_PERC_VAT1, 
                      RTLPY_PERC_VAT2, RTLPY_PARTIAL_VAT1, RTLPY_PERC_FEE, RTLPY_PERC_FEE_TOPPED, RTLPY_PARTIAL_PERC_FEE, RTLPY_FIXED_FEE, 
                      RTLPY_PARTIAL_FIXED_FEE, 0, 0, ISNULL(RTLPY_TOTAL_AMOUNT_CHARGED, RTLPY_AMOUNT), RTLPY_TRANS_STATUS TRANS_STATUS, 
                      RTLPY_STATUS_DATE STATUS_DATE, NULL, NULL, NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_CUSPMR_CREATION_TYPE, 
					  NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
					  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM         dbo.RETAILER_PAYMENTS, dbo.CURRENCIES
WHERE     RTLPY_CUR_ID = CUR_ID AND (RTLPY_SUSCRIPTION_TYPE = 1 OR
                      RTLPY_SUSCRIPTION_TYPE IS NULL) AND RTLPY_TRANS_STATUS IN (1, 2, 3, 4, 7)









GO


ALTER VIEW [dbo].[ALL_OPERATIONS_EXT_DB_HIS]
AS
SELECT     CASE ISNULL(TAR_TYPE, 0) WHEN 1 THEN 19 ELSE OPE_TYPE END AS OPE_TYPE, OPE_USR_ID, OPE_MOSE_OS, OPE_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, OPE_DATE, OPE_UTC_DATE, OPE_INIDATE, OPE_ENDDATE, 
                      CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_AMOUNT ELSE - OPE_AMOUNT END AS int) OPE_AMOUNT, 
					   CAST( CASE 
					  WHEN OPE_TYPE = 3
						 THEN ISNULL(OPE_REAL_AMOUNT,OPE_AMOUNT) 
					  ELSE -ISNULL(OPE_REAL_AMOUNT,OPE_AMOUNT) 
				 END AS int) OPE_REAL_AMOUNT,
					  OPE_TIME, OPE_AMOUNT_CUR_ID, 
                      CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_FINAL_AMOUNT ELSE - OPE_FINAL_AMOUNT END AS int) 
                      OPE_FINAL_AMOUNT, OPE_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, OPE_CHANGE_APPLIED, USER_PLATES.USRP_ID, USER_PLATES.USRP_PLATE, NULL 
                      TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, GRP_ID, TAR_ID, ISNULL(GRP_DESCRIPTION2, GRP_DESCRIPTION) GRP_DESCRIPTION, 
                      TAR_DESCRIPTION, OPE_SUSCRIPTION_TYPE, OPE_BALANCE_BEFORE, OPE_INSERTION_UTC_DATE, OPE_CUSPMR_ID, OPE_OPEDIS_ID, CUSPMR_DATE, 
                      CUSPMR_AMOUNT, CUSPMR_CUR_ID, CUR3.CUR_ISO_CODE CUSPMR_AMOUNT_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, 
                      OPEDIS_DATE, OPEDIS_AMOUNT, OPEDIS_AMOUNT_CUR_ID, CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, 
                      OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, OPEDIS_BALANCE_BEFORE, 
                      OPEDIS_INSERTION_UTC_DATE, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL 
                      CUSPMR_CARD_HASH, NULL CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL 
                      CUSPMR_CARD_EXPIRATION_DATE, OPE_DATE_UTC_OFFSET, OPE_INIDATE_UTC_OFFSET, OPE_ENDDATE_UTC_OFFSET, 
                      CUSPMR_DATE_UTC_OFFSET OPE_CUSPMR_DATE_UTC_OFFSET, OPEDIS_DATE_UTC_OFFSET OPE_OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, 
                      CUR1.CUR_NAME OPE_AMOUNT_CUR_NAME, CUR2.CUR_NAME OPE_BALANCE_CUR_NAME, CUR3.CUR_NAME CUSPMR_CUR_NAME, 
                      CUR4.CUR_NAME OPEDIS_AMOUNT_CUR_NAME, CUR5.CUR_NAME OPEDIS_BALANCE_CUR_NAME, HIS_OPERATIONS.OPE_EXTERNAL_ID1, 
                      HIS_OPERATIONS.OPE_EXTERNAL_ID2, HIS_OPERATIONS.OPE_EXTERNAL_ID3, OPE_CONFIRMED_IN_WS1, OPE_CONFIRMED_IN_WS2, 
                      OPE_CONFIRMED_IN_WS3, OPE_CONFIRMATION_TIME_IN_WS1, OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS1, OPE_CONFIRMATION_TIME_IN_WS2, 
                      OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS2, OPE_CONFIRMATION_TIME_IN_WS3, OPE_QUEUE_LENGTH_BEFORE_CONFIRM_WS3, OPE_LATITUDE, 
                      OPE_LONGITUDE, OPE_ID, OPE_APP_VERSION, NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL 
                      OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE, NULL OPEOFF_UTC_ENTRY_DATE, NULL 
                      OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL 
                      OPEOFF_UTC_EXIT_DATE, NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION, OPE_PERC_VAT1, 
                      OPE_PERC_VAT2, CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_VAT1 ELSE - OPE_PARTIAL_VAT1 END AS int) OPE_PARTIAL_VAT1, OPE_PERC_FEE, 
                      OPE_PERC_FEE_TOPPED, CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_PERC_FEE ELSE - OPE_PARTIAL_PERC_FEE END AS int) 
                      OPE_PARTIAL_PERC_FEE, OPE_FIXED_FEE, CAST(CASE WHEN OPE_TYPE = 3 THEN OPE_PARTIAL_FIXED_FEE ELSE - OPE_PARTIAL_FIXED_FEE END AS int) 
                      OPE_PARTIAL_FIXED_FEE, ISNULL(OPE_PERC_BONUS, 0) OPE_PERC_BONUS, CAST(ISNULL(OPE_PARTIAL_BONUS_FEE, 0) AS int) OPE_PARTIAL_BONUS_FEE, 
                      CAST(CASE WHEN OPE_TYPE = 3 THEN ISNULL(OPE_TOTAL_AMOUNT, OPE_AMOUNT) ELSE - ISNULL(OPE_TOTAL_AMOUNT, OPE_AMOUNT) END AS int) 
                      OPE_TOTAL_AMOUNT, NULL TRANS_STATUS, NULL STATUS_DATE, OPE_UTC_INIDATE, OPE_UTC_ENDDATE, NULL OPE_CUSPMR_TYPE, NULL 
                      OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_CUSPMR_CREATION_TYPE,
					CAST( CASE 
					  WHEN OPE_TYPE = 3
						 THEN OPE_TIME_BALANCE_USED 
					  ELSE -OPE_TIME_BALANCE_USED 
				 END AS int) OPE_TIME_BALANCE_USED, OPE_TIME_BALANCE_BEFORE, OPE_POSTPAY, OPE_SHOPKEEPER_OP, OPE_SHOPKEEPER_AMOUNT, OPE_SHOPKEEPER_PROFIT,
				 UP2.USRP_PLATE USRP_PLATE2, UP3.USRP_PLATE USRP_PLATE3, UP4.USRP_PLATE USRP_PLATE4, UP5.USRP_PLATE USRP_PLATE5, 
							 UP6.USRP_PLATE USRP_PLATE6, UP7.USRP_PLATE USRP_PLATE7, UP8.USRP_PLATE USRP_PLATE8, UP9.USRP_PLATE USRP_PLATE9, UP10.USRP_PLATE USRP_PLATE10
FROM         dbo.HIS_OPERATIONS LEFT OUTER JOIN
                      dbo.USER_PLATES ON dbo.HIS_OPERATIONS.OPE_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                      dbo.CURRENCIES CUR1 ON OPE_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                      dbo.CURRENCIES CUR2 ON OPE_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                      dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES ON 
                      dbo.HIS_OPERATIONS.OPE_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES.CUSPMR_ID LEFT OUTER JOIN
                      dbo.OPERATIONS_DISCOUNTS ON dbo.HIS_OPERATIONS.OPE_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID INNER JOIN
                      dbo.USERS ON OPE_USR_ID = USR_ID LEFT OUTER JOIN
                      dbo.GROUPS ON OPE_GRP_ID = GRP_ID LEFT OUTER JOIN
                      dbo.TARIFFS ON OPE_TAR_ID = TAR_ID
					  LEFT OUTER JOIN dbo.USER_PLATES UP2 ON dbo.HIS_OPERATIONS.OPE_PLATE2_USRP_ID = UP2.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP3 ON dbo.HIS_OPERATIONS.OPE_PLATE3_USRP_ID = UP3.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP4 ON dbo.HIS_OPERATIONS.OPE_PLATE4_USRP_ID = UP4.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP5 ON dbo.HIS_OPERATIONS.OPE_PLATE5_USRP_ID = UP5.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP6 ON dbo.HIS_OPERATIONS.OPE_PLATE6_USRP_ID = UP6.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP7 ON dbo.HIS_OPERATIONS.OPE_PLATE7_USRP_ID = UP7.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP8 ON dbo.HIS_OPERATIONS.OPE_PLATE8_USRP_ID = UP8.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP9 ON dbo.HIS_OPERATIONS.OPE_PLATE9_USRP_ID = UP9.USRP_ID
							 LEFT OUTER JOIN dbo.USER_PLATES UP10 ON dbo.HIS_OPERATIONS.OPE_PLATE10_USRP_ID = UP10.USRP_ID
					  , INSTALLATIONS
WHERE     OPE_INS_ID = INS_ID
UNION ALL
SELECT     4 OPE_TYPE, TIPA_USR_ID, TIPA_MOSE_OS, TIPA_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, TIPA_DATE, TIPA_UTC_DATE, NULL, NULL, 
                      - TIPA_AMOUNT TIPA_AMOUNT, -TIPA_AMOUNT, NULL, TIPA_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, - TIPA_FINAL_AMOUNT, 
                      TIPA_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, TIPA_CHANGE_APPLIED, USRP_ID, TIPA_PLATE_STRING, TIPA_TICKET_NUMBER, 
                      TIPA_TICKET_DATA, NULL, NULL, GRP_ID, NULL, NULL, TIPA_SUSCRIPTION_TYPE, TIPA_BALANCE_BEFORE, TIPA_INSERTION_UTC_DATE, TIPA_CUSPMR_ID, 
                      TIPA_OPEDIS_ID, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, CUR3.CUR_ISO_CODE, CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, 
                      OPEDIS_DATE, OPEDIS_AMOUNT, OPEDIS_AMOUNT_CUR_ID, CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, 
                      OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, OPEDIS_BALANCE_BEFORE, 
                      OPEDIS_INSERTION_UTC_DATE, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL 
                      CUSPMR_CARD_HASH, NULL CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL 
                      CUSPMR_CARD_EXPIRATION_DATE, TIPA_DATE_UTC_OFFSET, NULL, NULL, CUSPMR_DATE_UTC_OFFSET, OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, 
                      CUR1.CUR_NAME, CUR2.CUR_NAME, CUR3.CUR_NAME, CUR4.CUR_NAME, CUR5.CUR_NAME, NULL, NULL, NULL, TIPA_CONFIRMED_IN_WS, NULL, NULL, 
                      TIPA_CONFIRMATION_TIME_IN_WS, TIPA_QUEUE_LENGTH_BEFORE_CONFIRM_WS, NULL, NULL, NULL, NULL, TIPA_LATITUDE, TIPA_LONGITUDE, TIPA_ID, 
                      TIPA_APP_VERSION, NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL 
                      OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE, NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL 
                      OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE, NULL 
                      OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION, TIPA_PERC_VAT1, TIPA_PERC_VAT2, 
                      - TIPA_PARTIAL_VAT1, TIPA_PERC_FEE, TIPA_PERC_FEE_TOPPED, - TIPA_PARTIAL_PERC_FEE, TIPA_FIXED_FEE, - TIPA_PARTIAL_FIXED_FEE, 0, 0, 
                      - ISNULL(TIPA_TOTAL_AMOUNT, TIPA_AMOUNT), NULL TRANS_STATUS, NULL STATUS_DATE, NULL, NULL, NULL OPE_CUSPMR_TYPE, NULL 
                      OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_CUSPMR_CREATION_TYPE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 
					  0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
					  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM         dbo.TICKET_PAYMENTS LEFT OUTER JOIN
                      dbo.USER_PLATES ON dbo.TICKET_PAYMENTS.TIPA_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                      dbo.CURRENCIES CUR1 ON TIPA_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                      dbo.CURRENCIES CUR2 ON TIPA_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                      dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES ON 
                      dbo.TICKET_PAYMENTS.TIPA_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES.CUSPMR_ID LEFT OUTER JOIN
                      dbo.OPERATIONS_DISCOUNTS ON dbo.TICKET_PAYMENTS.TIPA_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID INNER JOIN
                      dbo.USERS ON TIPA_USR_ID = USR_ID LEFT OUTER JOIN
                      dbo.GROUPS ON TIPA_GRP_ID = GRP_ID, INSTALLATIONS
WHERE     TIPA_INS_ID = INS_ID
UNION ALL
SELECT     4 OPE_TYPE, NULL, 5, TIPANU_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, TIPANU_DATE, TIPANU_UTC_DATE, NULL, NULL, 
                      - TIPANU_AMOUNT TIPA_AMOUNT,-TIPANU_AMOUNT, NULL, TIPANU_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, - TIPANU_FINAL_AMOUNT, 
                      TIPANU_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, TIPANU_CHANGE_APPLIED, USRP_ID, TIPANU_PLATE_STRING, TIPANU_TICKET_NUMBER, 
                      TIPANU_TICKET_DATA, NULL, NULL, GRP_ID, NULL, NULL, TIPANU_SUSCRIPTION_TYPE, TIPANU_BALANCE_BEFORE, TIPANU_INSERTION_UTC_DATE, NULL, 
                      TIPANU_OPEDIS_ID, NULL, NULL, NULL, NULL, NULL, NULL, 
                      OPEDIS_DATE, OPEDIS_AMOUNT, OPEDIS_AMOUNT_CUR_ID, CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, 
                      OPEDIS_BALANCE_CUR_ID, CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, OPEDIS_BALANCE_BEFORE, 
                      OPEDIS_INSERTION_UTC_DATE, NULL CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL 
                      CUSPMR_CARD_HASH, NULL CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL 
                      CUSPMR_CARD_EXPIRATION_DATE, TIPANU_DATE_UTC_OFFSET, NULL, NULL, NULL, OPEDIS_DATE_UTC_OFFSET, NULL, 
                      CUR1.CUR_NAME, CUR2.CUR_NAME, NULL, CUR4.CUR_NAME, CUR5.CUR_NAME, NULL, NULL, NULL, TIPANU_CONFIRMED_IN_WS, NULL, NULL, 
                      TIPANU_CONFIRMATION_TIME_IN_WS, TIPANU_QUEUE_LENGTH_BEFORE_CONFIRM_WS, NULL, NULL, NULL, NULL, TIPANU_LATITUDE, TIPANU_LONGITUDE, TIPANU_ID, 
                      TIPANU_APP_VERSION, NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL 
                      OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE, NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL 
                      OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE, NULL 
                      OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION, TIPANU_PERC_VAT1, TIPANU_PERC_VAT2, 
                      - TIPANU_PARTIAL_VAT1, TIPANU_PERC_FEE, TIPANU_PERC_FEE_TOPPED, - TIPANU_PARTIAL_PERC_FEE, TIPANU_FIXED_FEE, - TIPANU_PARTIAL_FIXED_FEE, 0, 0, 
                      - ISNULL(TIPANU_TOTAL_AMOUNT, TIPANU_AMOUNT), NULL TRANS_STATUS, NULL STATUS_DATE, NULL, NULL, NULL OPE_CUSPMR_TYPE, NULL 
                      OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_CUSPMR_CREATION_TYPE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 
					  0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
					  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM         dbo.TICKET_PAYMENTS_NON_USERS LEFT OUTER JOIN
                      dbo.USER_PLATES ON dbo.TICKET_PAYMENTS_NON_USERS.TIPANU_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                      dbo.CURRENCIES CUR1 ON TIPANU_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                      dbo.CURRENCIES CUR2 ON TIPANU_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                      dbo.OPERATIONS_DISCOUNTS ON dbo.TICKET_PAYMENTS_NON_USERS.TIPANU_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID LEFT OUTER JOIN
                      dbo.GROUPS ON TIPANU_GRP_ID = GRP_ID, INSTALLATIONS
WHERE     TIPANU_INS_ID = INS_ID
UNION ALL
SELECT     5 OPE_TYPE, CUSPMR_USR_ID, CUSPMR_MOSE_OS, NULL, NULL, NULL, CUSPMR_DATE, CUSPMR_UTC_DATE, NULL, NULL, CUSPMR_AMOUNT, CUSPMR_AMOUNT, NULL, 
                      CUSPMR_CUR_ID, CUR_ISO_CODE, NULL, CUSPMR_CUR_ID, CUR_ISO_CODE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
                      CUSPMR_SUSCRIPTION_TYPE, CUSPMR_BALANCE_BEFORE, 
                      CUSPMR_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
                      CUSPMR_OP_REFERENCE, CUSPMR_TRANSACTION_ID, CUSPMR_AUTH_CODE, CUSPMR_CARD_HASH, CUSPMR_CARD_REFERENCE, CUSPMR_CARD_SCHEME, 
                      CUSPMR_MASKED_CARD_NUMBER, CUSPMR_CARD_EXPIRATION_DATE, CUSPMR_DATE_UTC_OFFSET, NULL, NULL, NULL, NULL, 
                      USR_USERNAME, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, CUSPMR_LATITUDE, 
                      CUSPMR_LONGITUDE, CUSPMR_ID, CUSPMR_APP_VERSION, NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL 
                      OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE, NULL OPEOFF_UTC_ENTRY_DATE, NULL 
                      OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL 
                      OPEOFF_UTC_EXIT_DATE, NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION, CUSPMR_PERC_VAT1, 
                      CUSPMR_PERC_VAT2, CUSPMR_PARTIAL_VAT1, CUSPMR_PERC_FEE, CUSPMR_PERC_FEE_TOPPED, CUSPMR_PARTIAL_PERC_FEE, CUSPMR_FIXED_FEE, 
                      CUSPMR_PARTIAL_FIXED_FEE, 0, 0, ISNULL(CUSPMR_TOTAL_AMOUNT_CHARGED, CUSPMR_AMOUNT), CUSPMR_TRANS_STATUS TRANS_STATUS, 
                      CUSPMR_STATUS_DATE STATUS_DATE, NULL, NULL, CUSPMR_TYPE OPE_CUSPMR_TYPE, 
                      CUSPMR_PAGATELIA_NEW_BALANCE OPE_CUSPMR_PAGATELIA_NEW_BALANCE, CUSPMR_CREATION_TYPE OPE_CUSPMR_CREATION_TYPE, NULL OPE_TIME_BALANCE_USED, 
					  NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
					  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM         dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES INNER JOIN
                      dbo.USERS ON CUSPMR_USR_ID = USR_ID, dbo.CURRENCIES
WHERE     CUSPMR_CUR_ID = CUR_ID AND (CUSPMR_SUSCRIPTION_TYPE = 1 OR
                      CUSPMR_SUSCRIPTION_TYPE IS NULL) AND ((CUSPMR_TRANS_STATUS IN (1, 2, 3, 4, 7) AND CUSPMR_RCOUP_ID IS NULL) OR
                      CUSPMR_TYPE IN (3, 4,6))
UNION ALL
SELECT     6 OPE_TYPE, SECH_USR_ID, SECH_MOSE_OS, NULL, NULL, NULL, SECH_DATE, SECH_UTC_DATE, NULL, NULL, - SECH_AMOUNT, -SECH_AMOUNT, NULL, SECH_AMOUNT_CUR_ID, 
                      CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, - SECH_FINAL_AMOUNT, SECH_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, 
                      SECH_CHANGE_APPLIED, NULL, NULL, NULL, NULL, SECH_SECHT_ID, NULL, NULL, NULL, NULL, SECH_SUSCRIPTION_TYPE, SECH_BALANCE_BEFORE, 
                      SECH_INSERTION_UTC_DATE, SECH_CUSPMR_ID, NULL, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, CUR3.CUR_ISO_CODE, 
                      CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL 
                      CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
                      CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, 
                      SECH_DATE_UTC_OFFSET, NULL, NULL, CUSPMR_DATE_UTC_OFFSET, NULL, USR_USERNAME, CUR1.CUR_NAME, CUR2.CUR_NAME, 
                      CUR3.CUR_NAME, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, SECH_ID, SECH_APP_VERSION, NULL 
                      OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL
                       OPEOFF_EXIT_DATE, NULL OPEOFF_UTC_ENTRY_DATE, NULL OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL 
                      OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL OPEOFF_UTC_EXIT_DATE, NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL 
                      OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION, SECH_PERC_VAT1, SECH_PERC_VAT2, - SECH_PARTIAL_VAT1, SECH_PERC_FEE, 
                      SECH_PERC_FEE_TOPPED, - SECH_PARTIAL_PERC_FEE, SECH_FIXED_FEE, - SECH_PARTIAL_FIXED_FEE, 0, 0, - ISNULL(SECH_TOTAL_AMOUNT, 
                      SECH_AMOUNT), NULL TRANS_STATUS, NULL STATUS_DATE, NULL, NULL, NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_CUSPMR_CREATION_TYPE, 
					  NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
					  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM         dbo.SERVICE_CHARGES INNER JOIN
                      dbo.CURRENCIES CUR1 ON SECH_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                      dbo.CURRENCIES CUR2 ON SECH_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                      dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES ON 
                      dbo.SERVICE_CHARGES.SECH_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES.CUSPMR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID INNER JOIN
                      dbo.USERS ON SECH_USR_ID = USR_ID
UNION ALL
SELECT     7 OPE_TYPE, OPEDIS_USR_ID, OPEDIS_MOSE_OS, NULL, NULL, NULL, OPEDIS_DATE, OPEDIS_UTC_DATE, NULL, NULL, OPEDIS_AMOUNT,OPEDIS_AMOUNT, NULL, 
                      OPEDIS_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, 
                      CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
                      OPEDIS_SUSCRIPTION_TYPE, OPEDIS_BALANCE_BEFORE, 
                      OPEDIS_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL 
                      CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
                      CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, 
                      OPEDIS_DATE_UTC_OFFSET, NULL, NULL, NULL, NULL, USR_USERNAME, CUR1.CUR_NAME, 
                      CUR2.CUR_NAME, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, OPEDIS_LATITUDE, OPEDIS_LONGITUDE, 
                      OPEDIS_ID, OPEDIS_APP_VERSION, NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL 
                      OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE, NULL OPEOFF_UTC_ENTRY_DATE, NULL 
                      OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL 
                      OPEOFF_UTC_EXIT_DATE, NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION, OPEDIS_PERC_VAT1, 
                      OPEDIS_PERC_VAT2, OPEDIS_PARTIAL_VAT1, OPEDIS_PERC_FEE, OPEDIS_PERC_FEE_TOPPED, OPEDIS_PARTIAL_PERC_FEE, OPEDIS_FIXED_FEE, 
                      OPEDIS_PARTIAL_FIXED_FEE, 0, 0, ISNULL(OPEDIS_TOTAL_AMOUNT, OPEDIS_AMOUNT), NULL TRANS_STATUS, NULL STATUS_DATE, NULL, NULL, NULL 
                      OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_CUSPMR_CREATION_TYPE, NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, 
					  NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
					  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM         dbo.OPERATIONS_DISCOUNTS INNER JOIN
                      dbo.CURRENCIES CUR1 ON OPEDIS_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                      dbo.CURRENCIES CUR2 ON OPEDIS_BALANCE_CUR_ID = CUR2.CUR_ID INNER JOIN
                      dbo.USERS ON OPEDIS_USR_ID = USR_ID
UNION ALL
SELECT     OPEOFF_TYPE, OPEOFF_USR_ID, OPEOFF_MOSE_OS, OPEOFF_INS_ID, INS_DESCRIPTION, INS_SHORTDESC, 
                      CASE OPEOFF_TYPE WHEN 8 THEN OPEOFF_NOTIFY_ENTRY_DATE ELSE OPEOFF_PAYMENT_DATE END, 
                      CASE OPEOFF_TYPE WHEN 8 THEN OPEOFF_UTC_NOTIFY_ENTRY_DATE ELSE OPEOFF_UTC_PAYMENT_DATE END, OPEOFF_ENTRY_DATE, OPEOFF_END_DATE, 
                      CAST(- OPEOFF_AMOUNT AS int),CAST(- OPEOFF_AMOUNT AS int), OPEOFF_TIME, OPEOFF_AMOUNT_CUR_ID, CUR1.CUR_ISO_CODE OPE_AMOUNT_CUR_ISO_CODE, 
                      CAST(- OPEOFF_FINAL_AMOUNT AS int), OPEOFF_BALANCE_CUR_ID, CUR2.CUR_ISO_CODE OPE_BALANCE_CUR_ISO_CODE, OPEOFF_CHANGE_APPLIED, 
                      USRP_ID, USRP_PLATE, NULL TIPA_TICKET_NUMBER, NULL TIPA_TICKET_DATA, NULL SECH_SECHT_ID, GRP_ID, NULL, ISNULL(GRP_DESCRIPTION2, 
                      GRP_DESCRIPTION) GRP_DESCRIPTION, NULL, OPEOFF_SUSCRIPTION_TYPE, OPEOFF_BALANCE_BEFORE, OPEOFF_INSERTION_UTC_DATE, 
                      OPEOFF_CUSPMR_ID, OPEOFF_OPEDIS_ID, CUSPMR_DATE, CUSPMR_AMOUNT, CUSPMR_CUR_ID, CUR3.CUR_ISO_CODE CUSPMR_AMOUNT_ISO_CODE, 
                      CUSPMR_BALANCE_BEFORE, CUSPMR_INSERTION_UTC_DATE, OPEDIS_DATE, OPEDIS_AMOUNT, OPEDIS_AMOUNT_CUR_ID, 
                      CUR4.CUR_ISO_CODE OPEDIS_AMOUNT_CUR_ISO_CODE, OPEDIS_FINAL_AMOUNT, OPEDIS_BALANCE_CUR_ID, 
                      CUR5.CUR_ISO_CODE OPEDIS_BALANCE_CUR_ISO_CODE, OPEDIS_CHANGE_APPLIED, OPEDIS_BALANCE_BEFORE, OPEDIS_INSERTION_UTC_DATE, NULL 
                      CUSPMR_OP_REFERENCE, NULL CUSPMR_TRANSACTION_ID, NULL CUSPMR_AUTH_CODE, NULL CUSPMR_CARD_HASH, NULL 
                      CUSPMR_CARD_REFERENCE, NULL CUSPMR_CARD_SCHEME, NULL CUSPMR_MASKED_CARD_NUMBER, NULL CUSPMR_CARD_EXPIRATION_DATE, 
                      CASE OPEOFF_TYPE WHEN 8 THEN OPEOFF_NOTIFY_ENTRY_DATE_UTC_OFFSET ELSE OPEOFF_PAYMENT_DATE_UTC_OFFSET END, 
                      OPEOFF_ENTRY_DATE_UTC_OFFSET, OPEOFF_END_DATE_UTC_OFFSET, CUSPMR_DATE_UTC_OFFSET OPE_CUSPMR_DATE_UTC_OFFSET, 
                      OPEDIS_DATE_UTC_OFFSET OPE_OPEDIS_DATE_UTC_OFFSET, USR_USERNAME, CUR1.CUR_NAME OPE_AMOUNT_CUR_NAME, 
                      CUR2.CUR_NAME OPE_BALANCE_CUR_NAME, CUR3.CUR_NAME CUSPMR_CUR_NAME, CUR4.CUR_NAME OPEDIS_AMOUNT_CUR_NAME, 
                      CUR5.CUR_NAME OPEDIS_BALANCE_CUR_NAME, OPEOFF_EXTERNAL_ID1, OPEOFF_EXTERNAL_ID2, OPEOFF_EXTERNAL_ID3, OPEOFF_CONFIRMED_IN_WS1, 
                      OPEOFF_CONFIRMED_IN_WS2, OPEOFF_CONFIRMED_IN_WS3, OPEOFF_CONFIRMATION_TIME_IN_WS1, OPEOFF_QUEUE_LENGTH_BEFORE_CONFIRM_WS1, 
                      OPEOFF_CONFIRMATION_TIME_IN_WS2, OPEOFF_QUEUE_LENGTH_BEFORE_CONFIRM_WS2, OPEOFF_CONFIRMATION_TIME_IN_WS3, 
                      OPEOFF_QUEUE_LENGTH_BEFORE_CONFIRM_WS3, OPEOFF_LATITUDE, OPEOFF_LONGITUDE, OPEOFF_ID, OPEOFF_APP_VERSION, OPEOFF_ENTRY_DATE, 
                      OPEOFF_NOTIFY_ENTRY_DATE, OPEOFF_PAYMENT_DATE, OPEOFF_END_DATE, OPEOFF_EXIT_LIMIT_DATE, OPEOFF_EXIT_DATE, OPEOFF_UTC_ENTRY_DATE, 
                      OPEOFF_UTC_NOTIFY_ENTRY_DATE, OPEOFF_UTC_PAYMENT_DATE, OPEOFF_UTC_END_DATE, OPEOFF_UTC_EXIT_LIMIT_DATE, OPEOFF_UTC_EXIT_DATE, 
                      OPEOFF_LOGICAL_ID, OPEOFF_TARIFF, OPEOFF_GATE, OPEOFF_SPACE_DESCRIPTION, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, - OPEOFF_AMOUNT, NULL TRANS_STATUS, NULL 
                      STATUS_DATE, OPEOFF_UTC_ENTRY_DATE, OPEOFF_UTC_END_DATE, NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_CUSPMR_CREATION_TYPE, 
					  NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
					  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM         dbo.OPERATIONS_OFFSTREET LEFT OUTER JOIN
                      dbo.USER_PLATES ON dbo.OPERATIONS_OFFSTREET.OPEOFF_USRP_ID = USER_PLATES.USRP_ID INNER JOIN
                      dbo.CURRENCIES CUR1 ON OPEOFF_AMOUNT_CUR_ID = CUR1.CUR_ID INNER JOIN
                      dbo.CURRENCIES CUR2 ON OPEOFF_BALANCE_CUR_ID = CUR2.CUR_ID LEFT OUTER JOIN
                      dbo.CUSTOMER_PAYMENT_MEANS_RECHARGES ON 
                      dbo.OPERATIONS_OFFSTREET.OPEOFF_CUSPMR_ID = CUSTOMER_PAYMENT_MEANS_RECHARGES.CUSPMR_ID LEFT OUTER JOIN
                      dbo.OPERATIONS_DISCOUNTS ON dbo.OPERATIONS_OFFSTREET.OPEOFF_OPEDIS_ID = OPERATIONS_DISCOUNTS.OPEDIS_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR3 ON CUSPMR_CUR_ID = CUR3.CUR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR4 ON OPEDIS_AMOUNT_CUR_ID = CUR4.CUR_ID LEFT OUTER JOIN
                      dbo.CURRENCIES CUR5 ON OPEDIS_BALANCE_CUR_ID = CUR5.CUR_ID INNER JOIN
                      dbo.USERS ON OPEOFF_USR_ID = USR_ID LEFT OUTER JOIN
                      dbo.GROUPS ON OPEOFF_GRP_ID = GRP_ID, INSTALLATIONS
WHERE     OPEOFF_INS_ID = INS_ID
UNION ALL
SELECT     12 OPE_TYPE, NULL, 5, NULL, NULL, NULL, RTLPY_DATE, RTLPY_INSERTION_UTC_DATE, NULL, NULL, RTLPY_AMOUNT,RTLPY_AMOUNT, NULL, RTLPY_CUR_ID, 
                      CUR_ISO_CODE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, RTLPY_SUSCRIPTION_TYPE, NULL, 
                      RTLPY_INSERTION_UTC_DATE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
                      RTLPY_OP_REFERENCE, RTLPY_TRANSACTION_ID, RTLPY_AUTH_CODE, RTLPY_CARD_HASH, RTLPY_CARD_REFERENCE, RTLPY_CARD_SCHEME, 
                      RTLPY_MASKED_CARD_NUMBER, 
                      RTLPY_CARD_EXPIRATION_DATE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
                       NULL, NULL, NULL, NULL, NULL, RTLPY_ID, NULL, NULL OPEOFF_ENTRY_DATE, NULL OPEOFF_NOTIFY_ENTRY_DATE, NULL OPEOFF_PAYMENT_DATE, NULL 
                      OPEOFF_END_DATE, NULL OPEOFF_EXIT_LIMIT_DATE, NULL OPEOFF_EXIT_DATE, NULL OPEOFF_UTC_ENTRY_DATE, NULL 
                      OPEOFF_UTC_NOTIFY_ENTRY_DATE, NULL OPEOFF_UTC_PAYMENT_DATE, NULL OPEOFF_UTC_END_DATE, NULL OPEOFF_UTC_EXIT_LIMIT_DATE, NULL 
                      OPEOFF_UTC_EXIT_DATE, NULL OPEOFF_LOGICAL_ID, NULL OPEOFF_TARIFF, NULL OPEOFF_GATE, NULL OPEOFF_SPACE_DESCRIPTION, RTLPY_PERC_VAT1, 
                      RTLPY_PERC_VAT2, RTLPY_PARTIAL_VAT1, RTLPY_PERC_FEE, RTLPY_PERC_FEE_TOPPED, RTLPY_PARTIAL_PERC_FEE, RTLPY_FIXED_FEE, 
                      RTLPY_PARTIAL_FIXED_FEE, 0, 0, ISNULL(RTLPY_TOTAL_AMOUNT_CHARGED, RTLPY_AMOUNT), RTLPY_TRANS_STATUS TRANS_STATUS, 
                      RTLPY_STATUS_DATE STATUS_DATE, NULL, NULL, NULL OPE_CUSPMR_TYPE, NULL OPE_CUSPMR_PAGATELIA_NEW_BALANCE, NULL OPE_CUSPMR_CREATION_TYPE, 
					  NULL OPE_TIME_BALANCE_USED, NULL OPE_TIME_BALANCE_BEFORE, NULL OPE_POSTPAY, 0 OPE_SHOPKEEPER_OP, 0 OPE_SHOPKEEPER_AMOUNT, 0 OPE_SHOPKEEPER_PROFIT,
					  NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
FROM         dbo.RETAILER_PAYMENTS, dbo.CURRENCIES
WHERE     RTLPY_CUR_ID = CUR_ID AND (RTLPY_SUSCRIPTION_TYPE = 1 OR
                      RTLPY_SUSCRIPTION_TYPE IS NULL) AND RTLPY_TRANS_STATUS IN (1, 2, 3, 4, 7)








GO


ALTER PROCEDURE [dbo].[Update_DB_OPERATIONS_HOUR]
	@FromHour AS Datetime
AS	
BEGIN

	IF (@FromHour IS NULL)
	BEGIN
		SET @FromHour = (SELECT MAX([HOUR_UTC])
		FROM DB_OPERATIONS_HOUR
		WHERE [HOUR_UTC] < GETUTCDATE())

		IF (@FromHour IS NOT NULL)
		BEGIN
			SET @FromHour = DATEADD(HOUR, -1, @FromHour)
		END		
	END
	
	IF (@FromHour IS NULL)
	BEGIN
		SET @FromHour = (SELECT MIN(OPE_UTC_DATE)
		FROM ALL_OPERATIONS_EXT
		WHERE OPE_TYPE IN (1,2,3,4, 5))
	END	

	DELETE FROM DB_OPERATIONS_HOUR_DIST
	WHERE OHD_DBOH_ID IN (SELECT DBOH_ID
						  FROM DB_OPERATIONS_HOUR
						  WHERE CASE WHEN [HOUR_UTC] IS NULL THEN [HOUR] ELSE [HOUR_UTC] END >= @FromHour)
						  
	DELETE FROM DB_OPERATIONS_HOUR
	WHERE CASE WHEN [HOUR_UTC] IS NULL THEN [HOUR] ELSE [HOUR_UTC] END >= @FromHour
	

	INSERT INTO DB_OPERATIONS_HOUR([HOUR], HOUR_UTC, OPE_INS_ID, GRP_ID, OPE_AMOUNT_CUR_ISO_CODE, PARKINGS_COUNT, EXTENSIONS_COUNT, REFUNDS_COUNT, TICKETPAYMENTS_COUNT, RECHARGES_COUNT, PAGATELIA_COUNT, RECHARGEREFUNDS_COUNT, COUPONS_COUNT, COUPONREFUNDS_COUNT, SERVICES_COUNT, RECHARGES_REGULAR_COUNT, RECHARGES_AUTOMATIC_COUNT, RECHARGES_USERCREATION_COUNT, RECHARGES_CHANGEPM_COUNT, TICKETPAYMENTS_NON_USERS_COUNT,
								   PARKINGS_AMOUNT, PARKINGS_VAT, PARKINGS_PERC_FEE, PARKINGS_PERC_FEE_VAT, PARKINGS_FIXED_FEE, PARKINGS_FIXED_FEE_VAT, PARKINGS_TOTAL_AMOUNT, 
								   EXTENSIONS_AMOUNT, EXTENSIONS_VAT, EXTENSIONS_PERC_FEE, EXTENSIONS_PERC_FEE_VAT, EXTENSIONS_FIXED_FEE, EXTENSIONS_FIXED_FEE_VAT, EXTENSIONS_TOTAL_AMOUNT, 
								   REFUNDS_AMOUNT, REFUNDS_VAT, REFUNDS_PERC_FEE, REFUNDS_PERC_FEE_VAT, REFUNDS_FIXED_FEE, REFUNDS_FIXED_FEE_VAT, REFUNDS_TOTAL_AMOUNT, 
								   TICKETPAYMENTS_AMOUNT, TICKETPAYMENTS_VAT, TICKETPAYMENTS_PERC_FEE, TICKETPAYMENTS_PERC_FEE_VAT, TICKETPAYMENTS_FIXED_FEE, TICKETPAYMENTS_FIXED_FEE_VAT, TICKETPAYMENTS_TOTAL_AMOUNT, 
								   TICKETPAYMENTS_NON_USERS_AMOUNT, TICKETPAYMENTS_NON_USERS_VAT, TICKETPAYMENTS_NON_USERS_PERC_FEE, TICKETPAYMENTS_NON_USERS_PERC_FEE_VAT, TICKETPAYMENTS_NON_USERS_FIXED_FEE, TICKETPAYMENTS_NON_USERS_FIXED_FEE_VAT, TICKETPAYMENTS_NON_USERS_TOTAL_AMOUNT, 
								   RECHARGES_AMOUNT, RECHARGES_VAT, RECHARGES_PERC_FEE, RECHARGES_PERC_FEE_VAT, RECHARGES_FIXED_FEE, RECHARGES_FIXED_FEE_VAT, RECHARGES_TOTAL_AMOUNT, RECHARGEREFUNDS_TOTAL_AMOUNT,
								   PAGATELIA_AMOUNT, PAGATELIA_VAT, PAGATELIA_PERC_FEE, PAGATELIA_PERC_FEE_VAT, PAGATELIA_FIXED_FEE, PAGATELIA_FIXED_FEE_VAT, PAGATELIA_TOTAL_AMOUNT,
								   COUPONS_AMOUNT, COUPONS_VAT, COUPONS_PERC_FEE, COUPONS_PERC_FEE_VAT, COUPONS_FIXED_FEE, COUPONS_FIXED_FEE_VAT, COUPONS_TOTAL_AMOUNT, COUPONREFUNDS_TOTAL_AMOUNT, 
								   SERVICES_AMOUNT, SERVICES_VAT, SERVICES_PERC_FEE, SERVICES_PERC_FEE_VAT, SERVICES_FIXED_FEE, SERVICES_FIXED_FEE_VAT, SERVICES_TOTAL_AMOUNT, 
								   RECHARGES_REGULAR_AMOUNT, RECHARGES_REGULAR_VAT, RECHARGES_REGULAR_PERC_FEE, RECHARGES_REGULAR_PERC_FEE_VAT, RECHARGES_REGULAR_FIXED_FEE, RECHARGES_REGULAR_FIXED_FEE_VAT, RECHARGES_REGULAR_TOTAL_AMOUNT, 
								   RECHARGES_AUTOMATIC_AMOUNT, RECHARGES_AUTOMATIC_VAT, RECHARGES_AUTOMATIC_PERC_FEE, RECHARGES_AUTOMATIC_PERC_FEE_VAT, RECHARGES_AUTOMATIC_FIXED_FEE, RECHARGES_AUTOMATIC_FIXED_FEE_VAT, RECHARGES_AUTOMATIC_TOTAL_AMOUNT, 
								   RECHARGES_USERCREATION_AMOUNT, RECHARGES_USERCREATION_VAT, RECHARGES_USERCREATION_PERC_FEE, RECHARGES_USERCREATION_PERC_FEE_VAT, RECHARGES_USERCREATION_FIXED_FEE, RECHARGES_USERCREATION_FIXED_FEE_VAT, RECHARGES_USERCREATION_TOTAL_AMOUNT, 
								   RECHARGES_CHANGEPM_AMOUNT, RECHARGES_CHANGEPM_VAT, RECHARGES_CHANGEPM_PERC_FEE, RECHARGES_CHANGEPM_PERC_FEE_VAT, RECHARGES_CHANGEPM_FIXED_FEE, RECHARGES_CHANGEPM_FIXED_FEE_VAT, RECHARGES_CHANGEPM_TOTAL_AMOUNT,
								   PARKINGS_TIME, EXTENSIONS_TIME, REFUNDS_TIME)
	SELECT dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN DATEADD(hour, -DATEDIFF(hour, OPE_DATE, OPE_UTC_DATE), STATUS_DATE) 
												  ELSE OPE_DATE END), 0) AS HOUR, 
		   dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_UTC_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN STATUS_DATE
												  ELSE OPE_UTC_DATE END), 0) AS HOUR_UTC,
		   ISNULL(OPE_INS_ID,0), ISNULL(GRP_ID,0), OPE_AMOUNT_CUR_ISO_CODE,
		   count(distinct(CASE OPE_TYPE WHEN 1 THEN ope_id ELSE NULL END)) PARKINGS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 2 THEN ope_id ELSE NULL END)) EXTENSIONS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 3 THEN ope_id ELSE NULL END)) REFUNDS_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN ope_id ELSE NULL END)) TICKETPAYMENTS_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN ope_id ELSE NULL END)) TICKETPAYMENTS_NON_USERS_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE != 2 THEN ope_id ELSE NULL END)) RECHARGES_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN ope_id ELSE NULL END)) PAGATELIA_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS = 7 THEN ope_id ELSE NULL END)) RECHARGEREFUNDS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 12 THEN ope_id ELSE NULL END)) COUPONS_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS = 7 THEN ope_id ELSE NULL END)) COUPONREFUNDS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 6 THEN ope_id ELSE NULL END)) SERVICES_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN ope_id ELSE NULL END)) RECHARGES_REGULAR_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN ope_id ELSE NULL END)) RECHARGES_AUTOMATIC_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN ope_id ELSE NULL END)) RECHARGES_USERCREATION_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN ope_id ELSE NULL END)) RECHARGES_CHANGEPM_COUNT,

		   sum(CASE OPE_TYPE WHEN 1 THEN -OPE_AMOUNT ELSE 0 END) PARKINGS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 1 THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) PARKINGS_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PARKINGS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PARKINGS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PARKINGS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PARKINGS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) PARKINGS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 2 THEN -OPE_AMOUNT ELSE 0 END) EXTENSIONS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 2 THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) EXTENSIONS_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) EXTENSIONS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) EXTENSIONS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) EXTENSIONS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) EXTENSIONS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) EXTENSIONS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 3 THEN OPE_AMOUNT ELSE 0 END) REFUNDS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 3 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) REFUNDS_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) REFUNDS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) REFUNDS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) REFUNDS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) REFUNDS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) REFUNDS_TOTAL_AMOUNT,
		   
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -OPE_AMOUNT ELSE 0 END) TICKETPAYMENTS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) TICKETPAYMENTS_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) TICKETPAYMENTS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -OPE_AMOUNT ELSE 0 END) TICKETPAYMENTS_NON_USERS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) TICKETPAYMENTS_NON_USERS_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) TICKETPAYMENTS_NON_USERS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_TOTAL_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS = 7  AND OPE_CUSPMR_TYPE != 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGEREFUNDS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN OPE_AMOUNT ELSE 0 END) PAGATELIA_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) PAGATELIA_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PAGATELIA_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PAGATELIA_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PAGATELIA_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PAGATELIA_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) PAGATELIA_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN OPE_AMOUNT ELSE 0 END) COUPONS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) COUPONS_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) COUPONS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) COUPONS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) COUPONS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) COUPONS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) COUPONS_TOTAL_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS = 7 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) COUPONREFUNDS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 6 THEN OPE_AMOUNT ELSE 0 END) SERVICES_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 6 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) SERVICES_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) SERVICES_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) SERVICES_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) SERVICES_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) SERVICES_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) SERVICES_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_REGULAR_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_REGULAR_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_REGULAR_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_REGULAR_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_REGULAR_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_REGULAR_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_REGULAR_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_AUTOMATIC_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_AUTOMATIC_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_AUTOMATIC_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_AUTOMATIC_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_AUTOMATIC_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_AUTOMATIC_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_REGULAR_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_USERCREATION_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_USERCREATION_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_USERCREATION_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_USERCREATION_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_USERCREATION_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_USERCREATION_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_USERCREATION_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_CHANGEPM_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_CHANGEPM_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_CHANGEPM_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_CHANGEPM_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_CHANGEPM_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_CHANGEPM_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_CHANGEPM_TOTAL_AMOUNT,
		   		   
		   sum(CASE OPE_TYPE WHEN 1 THEN OPE_TIME ELSE 0 END) PARKINGS_TIME,
		   sum(CASE OPE_TYPE WHEN 2 THEN OPE_TIME ELSE 0 END) EXTENSIONS_TIME,
		   sum(CASE OPE_TYPE WHEN 3 THEN OPE_TIME ELSE 0 END) REFUNDS_TIME
	   
	FROM ALL_OPERATIONS_EXT_DB
	WHERE OPE_TYPE IN (1,2,3,4,5,12,6) AND 
		  CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_UTC_INIDATE 
			   WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN STATUS_DATE
			   ELSE OPE_UTC_DATE END >= @FromHour
	GROUP BY dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN DATEADD(hour, -DATEDIFF(hour, OPE_DATE, OPE_UTC_DATE), STATUS_DATE) 
												  ELSE OPE_DATE END), 0),
			 dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_UTC_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN STATUS_DATE
												  ELSE OPE_UTC_DATE END), 0),												   
			 OPE_INS_ID, GRP_ID, OPE_AMOUNT_CUR_ISO_CODE
	
	INSERT INTO DB_OPERATIONS_HOUR_DIST(OHD_DBOH_ID, OHD_FDO_ID, 
									    OHD_PARKINGS_AMOUNT, OHD_PARKINGS_VAT, OHD_PARKINGS_PERC_FEE, OHD_PARKINGS_PERC_FEE_VAT, OHD_PARKINGS_FIXED_FEE, OHD_PARKINGS_FIXED_FEE_VAT, OHD_PARKINGS_TOTAL_AMOUNT, 
										OHD_EXTENSIONS_AMOUNT, OHD_EXTENSIONS_VAT, OHD_EXTENSIONS_PERC_FEE, OHD_EXTENSIONS_PERC_FEE_VAT, OHD_EXTENSIONS_FIXED_FEE, OHD_EXTENSIONS_FIXED_FEE_VAT, OHD_EXTENSIONS_TOTAL_AMOUNT, 
										OHD_REFUNDS_AMOUNT, OHD_REFUNDS_VAT, OHD_REFUNDS_PERC_FEE, OHD_REFUNDS_PERC_FEE_VAT, OHD_REFUNDS_FIXED_FEE, OHD_REFUNDS_FIXED_FEE_VAT, OHD_REFUNDS_TOTAL_AMOUNT, 
										OHD_TICKETPAYMENTS_AMOUNT, OHD_TICKETPAYMENTS_VAT, OHD_TICKETPAYMENTS_PERC_FEE, OHD_TICKETPAYMENTS_PERC_FEE_VAT, OHD_TICKETPAYMENTS_FIXED_FEE, OHD_TICKETPAYMENTS_FIXED_FEE_VAT, OHD_TICKETPAYMENTS_TOTAL_AMOUNT, 										
										OHD_RECHARGES_AMOUNT, OHD_RECHARGES_VAT, OHD_RECHARGES_PERC_FEE, OHD_RECHARGES_PERC_FEE_VAT, OHD_RECHARGES_FIXED_FEE, OHD_RECHARGES_FIXED_FEE_VAT, OHD_RECHARGES_TOTAL_AMOUNT,
										OHD_COUPONS_AMOUNT, OHD_COUPONS_VAT, OHD_COUPONS_PERC_FEE, OHD_COUPONS_PERC_FEE_VAT, OHD_COUPONS_FIXED_FEE, OHD_COUPONS_FIXED_FEE_VAT, OHD_COUPONS_TOTAL_AMOUNT,
										OHD_SERVICES_AMOUNT, OHD_SERVICES_VAT, OHD_SERVICES_PERC_FEE, OHD_SERVICES_PERC_FEE_VAT, OHD_SERVICES_FIXED_FEE, OHD_SERVICES_FIXED_FEE_VAT, OHD_SERVICES_TOTAL_AMOUNT)
	SELECT DB_OPERATIONS_HOUR.DBOH_ID, FINAN_DIST_OPERATORS.FDO_ID,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_AMOUNT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_AMOUNT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, ---dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_AMOUNT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  0, ---dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_AMOUNT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_AMOUNT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_AMOUNT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_VAT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_AMOUNT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_PERC_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_PERC_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_AMOUNT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_PERC_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_PERC_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0

	FROM DB_OPERATIONS_HOUR 
		 /*LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D1
				    WHERE D1.FDOIP_OPE_TYPE = 1 AND
						  D1.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D1.FDOIP_END_APPLY_DATE >= @FromHour) DIST_PARKINGS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_PARKINGS.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_PARKINGS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D2
				    WHERE D2.FDOIP_OPE_TYPE = 2 AND
						  D2.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D2.FDOIP_END_APPLY_DATE >= @FromHour) DIST_EXTENSIONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_EXTENSIONS.FDOIP_INS_ID) AND
																					  DB_OPERATIONS_HOUR.GRP_ID = (DIST_EXTENSIONS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D3
				    WHERE D3.FDOIP_OPE_TYPE = 3 AND
						  D3.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D3.FDOIP_END_APPLY_DATE >= @FromHour) DIST_REFUNDS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_REFUNDS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_REFUNDS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D4
				    WHERE D4.FDOIP_OPE_TYPE = 4 AND
						  D4.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D4.FDOIP_END_APPLY_DATE >= @FromHour) DIST_TICKETPAYMENTS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_TICKETPAYMENTS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_TICKETPAYMENTS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D5
				    WHERE D5.FDOIP_OPE_TYPE = 5 AND
						  D5.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D5.FDOIP_END_APPLY_DATE >= @FromHour) DIST_RECHARGES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_RECHARGES.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_RECHARGES.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D12
				    WHERE D12.FDOIP_OPE_TYPE = 12 AND
						  D12.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D12.FDOIP_END_APPLY_DATE >= @FromHour) DIST_COUPONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_COUPONS.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_COUPONS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D6
				    WHERE D6.FDOIP_OPE_TYPE = 6 AND
						  D6.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D6.FDOIP_END_APPLY_DATE >= @FromHour) DIST_SERVICES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_SERVICES.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_SERVICES.FDOIP_GRP_ID)*/,

		 FINAN_DIST_OPERATORS

	WHERE HOUR_UTC >= @FromHour /*AND
		  (DIST_PARKINGS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_PARKINGS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_EXTENSIONS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_EXTENSIONS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_REFUNDS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_REFUNDS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_TICKETPAYMENTS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_TICKETPAYMENTS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_RECHARGES.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_RECHARGES.FDOIP_FDO_ID IS NULL) AND
		  (DIST_COUPONS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_COUPONS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_SERVICES.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_SERVICES.FDOIP_FDO_ID IS NULL)*/ 
		  
	
	GROUP BY DB_OPERATIONS_HOUR.DBOH_ID, FINAN_DIST_OPERATORS.FDO_ID
	
	/* PARKINGS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET

		  OHD_PARKINGS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_AMOUNT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_PARKINGS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_PARKINGS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_PARKINGS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_PARKINGS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_PARKINGS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_PARKINGS_TOTAL_AMOUNT = 0

	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D1
				    WHERE D1.FDOIP_OPE_TYPE = 1 AND
						  D1.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D1.FDOIP_END_APPLY_DATE >= @FromHour) DIST_PARKINGS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_PARKINGS.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_PARKINGS.FDOIP_GRP_ID) AND
																					 DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_PARKINGS.FDOIP_FDO_ID

	WHERE HOUR_UTC >= @FromHour 
		  		  	
	/* EXTENSIONS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_EXTENSIONS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_AMOUNT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_EXTENSIONS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_EXTENSIONS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_EXTENSIONS_PERC_FEE_VAT= dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_EXTENSIONS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_EXTENSIONS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_EXTENSIONS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D2
				    WHERE D2.FDOIP_OPE_TYPE = 2 AND
						  D2.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D2.FDOIP_END_APPLY_DATE >= @FromHour) DIST_EXTENSIONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_EXTENSIONS.FDOIP_INS_ID) AND
																					  DB_OPERATIONS_HOUR.GRP_ID = (DIST_EXTENSIONS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_EXTENSIONS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour 

	/* REFUNDS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_REFUNDS_AMOUNT = -dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_AMOUNT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_REFUNDS_VAT = -dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_REFUNDS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_REFUNDS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_REFUNDS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_REFUNDS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_REFUNDS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D3
				    WHERE D3.FDOIP_OPE_TYPE = 3 AND
						  D3.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D3.FDOIP_END_APPLY_DATE >= @FromHour) DIST_REFUNDS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_REFUNDS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_REFUNDS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_REFUNDS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* TICKETPAYMENTS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_TICKETPAYMENTS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_AMOUNT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_TICKETPAYMENTS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_TICKETPAYMENTS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_TICKETPAYMENTS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_TICKETPAYMENTS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_TICKETPAYMENTS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_TICKETPAYMENTS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D4
				    WHERE D4.FDOIP_OPE_TYPE = 4 AND
						  D4.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D4.FDOIP_END_APPLY_DATE >= @FromHour) DIST_TICKETPAYMENTS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_TICKETPAYMENTS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_TICKETPAYMENTS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_TICKETPAYMENTS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* RECHARGES */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_RECHARGES_AMOUNT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_AMOUNT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_AMOUNT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_RECHARGES_VAT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_VAT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_RECHARGES_PERC_FEE = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_RECHARGES_PERC_FEE_VAT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_RECHARGES_FIXED_FEE = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_RECHARGES_FIXED_FEE_VAT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_RECHARGES_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D5
				    WHERE D5.FDOIP_OPE_TYPE = 5 AND
						  D5.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D5.FDOIP_END_APPLY_DATE >= @FromHour) DIST_RECHARGES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_RECHARGES.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_RECHARGES.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_RECHARGES.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* COUPONS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_COUPONS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_AMOUNT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_COUPONS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_COUPONS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_PERC_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_COUPONS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_PERC_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_COUPONS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_COUPONS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_COUPONS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D12
				    WHERE D12.FDOIP_OPE_TYPE = 12 AND
						  D12.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D12.FDOIP_END_APPLY_DATE >= @FromHour) DIST_COUPONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_COUPONS.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_COUPONS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_COUPONS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* SERVICES */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_SERVICES_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_AMOUNT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_SERVICES_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_SERVICES_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_PERC_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_SERVICES_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_PERC_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_SERVICES_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_SERVICES_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_SERVICES_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D6
				    WHERE D6.FDOIP_OPE_TYPE = 6 AND
						  D6.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D6.FDOIP_END_APPLY_DATE >= @FromHour) DIST_SERVICES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_SERVICES.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_SERVICES.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_SERVICES.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

END




GO

ALTER PROCEDURE [dbo].[Update_DB_OPERATIONS_HOUR_HIS]
	@FromHour AS Datetime
AS	
BEGIN

	IF (@FromHour IS NULL)
	BEGIN
		SET @FromHour = (SELECT MAX([HOUR_UTC])
		FROM DB_OPERATIONS_HOUR
		WHERE [HOUR_UTC] < GETUTCDATE())

		IF (@FromHour IS NOT NULL)
		BEGIN
			SET @FromHour = DATEADD(HOUR, -1, @FromHour)
		END		
	END
	
	IF (@FromHour IS NULL)
	BEGIN
		SET @FromHour = (SELECT MIN(OPE_UTC_DATE)
		FROM ALL_OPERATIONS_EXT
		WHERE OPE_TYPE IN (1,2,3,4, 5))
	END	

	DELETE FROM DB_OPERATIONS_HOUR_DIST
	WHERE OHD_DBOH_ID IN (SELECT DBOH_ID
						  FROM DB_OPERATIONS_HOUR
						  WHERE CASE WHEN [HOUR_UTC] IS NULL THEN [HOUR] ELSE [HOUR_UTC] END >= @FromHour)
						  
	DELETE FROM DB_OPERATIONS_HOUR
	WHERE CASE WHEN [HOUR_UTC] IS NULL THEN [HOUR] ELSE [HOUR_UTC] END >= @FromHour
	

	INSERT INTO DB_OPERATIONS_HOUR([HOUR], HOUR_UTC, OPE_INS_ID, GRP_ID, OPE_AMOUNT_CUR_ISO_CODE, PARKINGS_COUNT, EXTENSIONS_COUNT, REFUNDS_COUNT, TICKETPAYMENTS_COUNT, RECHARGES_COUNT, PAGATELIA_COUNT, RECHARGEREFUNDS_COUNT, COUPONS_COUNT, COUPONREFUNDS_COUNT, SERVICES_COUNT, RECHARGES_REGULAR_COUNT, RECHARGES_AUTOMATIC_COUNT, RECHARGES_USERCREATION_COUNT, RECHARGES_CHANGEPM_COUNT, TICKETPAYMENTS_NON_USERS_COUNT,
								   PARKINGS_AMOUNT, PARKINGS_VAT, PARKINGS_PERC_FEE, PARKINGS_PERC_FEE_VAT, PARKINGS_FIXED_FEE, PARKINGS_FIXED_FEE_VAT, PARKINGS_TOTAL_AMOUNT, 
								   EXTENSIONS_AMOUNT, EXTENSIONS_VAT, EXTENSIONS_PERC_FEE, EXTENSIONS_PERC_FEE_VAT, EXTENSIONS_FIXED_FEE, EXTENSIONS_FIXED_FEE_VAT, EXTENSIONS_TOTAL_AMOUNT, 
								   REFUNDS_AMOUNT, REFUNDS_VAT, REFUNDS_PERC_FEE, REFUNDS_PERC_FEE_VAT, REFUNDS_FIXED_FEE, REFUNDS_FIXED_FEE_VAT, REFUNDS_TOTAL_AMOUNT, 
								   TICKETPAYMENTS_AMOUNT, TICKETPAYMENTS_VAT, TICKETPAYMENTS_PERC_FEE, TICKETPAYMENTS_PERC_FEE_VAT, TICKETPAYMENTS_FIXED_FEE, TICKETPAYMENTS_FIXED_FEE_VAT, TICKETPAYMENTS_TOTAL_AMOUNT, 
								   TICKETPAYMENTS_NON_USERS_AMOUNT, TICKETPAYMENTS_NON_USERS_VAT, TICKETPAYMENTS_NON_USERS_PERC_FEE, TICKETPAYMENTS_NON_USERS_PERC_FEE_VAT, TICKETPAYMENTS_NON_USERS_FIXED_FEE, TICKETPAYMENTS_NON_USERS_FIXED_FEE_VAT, TICKETPAYMENTS_NON_USERS_TOTAL_AMOUNT, 
								   RECHARGES_AMOUNT, RECHARGES_VAT, RECHARGES_PERC_FEE, RECHARGES_PERC_FEE_VAT, RECHARGES_FIXED_FEE, RECHARGES_FIXED_FEE_VAT, RECHARGES_TOTAL_AMOUNT, RECHARGEREFUNDS_TOTAL_AMOUNT,
								   PAGATELIA_AMOUNT, PAGATELIA_VAT, PAGATELIA_PERC_FEE, PAGATELIA_PERC_FEE_VAT, PAGATELIA_FIXED_FEE, PAGATELIA_FIXED_FEE_VAT, PAGATELIA_TOTAL_AMOUNT,
								   COUPONS_AMOUNT, COUPONS_VAT, COUPONS_PERC_FEE, COUPONS_PERC_FEE_VAT, COUPONS_FIXED_FEE, COUPONS_FIXED_FEE_VAT, COUPONS_TOTAL_AMOUNT, COUPONREFUNDS_TOTAL_AMOUNT, 
								   SERVICES_AMOUNT, SERVICES_VAT, SERVICES_PERC_FEE, SERVICES_PERC_FEE_VAT, SERVICES_FIXED_FEE, SERVICES_FIXED_FEE_VAT, SERVICES_TOTAL_AMOUNT, 
								   RECHARGES_REGULAR_AMOUNT, RECHARGES_REGULAR_VAT, RECHARGES_REGULAR_PERC_FEE, RECHARGES_REGULAR_PERC_FEE_VAT, RECHARGES_REGULAR_FIXED_FEE, RECHARGES_REGULAR_FIXED_FEE_VAT, RECHARGES_REGULAR_TOTAL_AMOUNT, 
								   RECHARGES_AUTOMATIC_AMOUNT, RECHARGES_AUTOMATIC_VAT, RECHARGES_AUTOMATIC_PERC_FEE, RECHARGES_AUTOMATIC_PERC_FEE_VAT, RECHARGES_AUTOMATIC_FIXED_FEE, RECHARGES_AUTOMATIC_FIXED_FEE_VAT, RECHARGES_AUTOMATIC_TOTAL_AMOUNT, 
								   RECHARGES_USERCREATION_AMOUNT, RECHARGES_USERCREATION_VAT, RECHARGES_USERCREATION_PERC_FEE, RECHARGES_USERCREATION_PERC_FEE_VAT, RECHARGES_USERCREATION_FIXED_FEE, RECHARGES_USERCREATION_FIXED_FEE_VAT, RECHARGES_USERCREATION_TOTAL_AMOUNT, 
								   RECHARGES_CHANGEPM_AMOUNT, RECHARGES_CHANGEPM_VAT, RECHARGES_CHANGEPM_PERC_FEE, RECHARGES_CHANGEPM_PERC_FEE_VAT, RECHARGES_CHANGEPM_FIXED_FEE, RECHARGES_CHANGEPM_FIXED_FEE_VAT, RECHARGES_CHANGEPM_TOTAL_AMOUNT,
								   PARKINGS_TIME, EXTENSIONS_TIME, REFUNDS_TIME)
	SELECT dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN DATEADD(hour, -DATEDIFF(hour, OPE_DATE, OPE_UTC_DATE), STATUS_DATE) 
												  ELSE OPE_DATE END), 0) AS HOUR, 
		   dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_UTC_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN STATUS_DATE
												  ELSE OPE_UTC_DATE END), 0) AS HOUR_UTC,
		   ISNULL(OPE_INS_ID,0), ISNULL(GRP_ID,0), OPE_AMOUNT_CUR_ISO_CODE,
		   count(distinct(CASE OPE_TYPE WHEN 1 THEN ope_id ELSE NULL END)) PARKINGS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 2 THEN ope_id ELSE NULL END)) EXTENSIONS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 3 THEN ope_id ELSE NULL END)) REFUNDS_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN ope_id ELSE NULL END)) TICKETPAYMENTS_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN ope_id ELSE NULL END)) TICKETPAYMENTS_NON_USERS_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE != 2 THEN ope_id ELSE NULL END)) RECHARGES_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN ope_id ELSE NULL END)) PAGATELIA_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS = 7 THEN ope_id ELSE NULL END)) RECHARGEREFUNDS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 12 THEN ope_id ELSE NULL END)) COUPONS_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS = 7 THEN ope_id ELSE NULL END)) COUPONREFUNDS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 6 THEN ope_id ELSE NULL END)) SERVICES_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN ope_id ELSE NULL END)) RECHARGES_REGULAR_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN ope_id ELSE NULL END)) RECHARGES_AUTOMATIC_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN ope_id ELSE NULL END)) RECHARGES_USERCREATION_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN ope_id ELSE NULL END)) RECHARGES_CHANGEPM_COUNT,

		   sum(CASE OPE_TYPE WHEN 1 THEN -OPE_AMOUNT ELSE 0 END) PARKINGS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 1 THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) PARKINGS_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PARKINGS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PARKINGS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PARKINGS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PARKINGS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) PARKINGS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 2 THEN -OPE_AMOUNT ELSE 0 END) EXTENSIONS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 2 THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) EXTENSIONS_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) EXTENSIONS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) EXTENSIONS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) EXTENSIONS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) EXTENSIONS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) EXTENSIONS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 3 THEN OPE_AMOUNT ELSE 0 END) REFUNDS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 3 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) REFUNDS_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) REFUNDS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) REFUNDS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) REFUNDS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) REFUNDS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) REFUNDS_TOTAL_AMOUNT,
		   
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -OPE_AMOUNT ELSE 0 END) TICKETPAYMENTS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) TICKETPAYMENTS_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) TICKETPAYMENTS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -OPE_AMOUNT ELSE 0 END) TICKETPAYMENTS_NON_USERS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) TICKETPAYMENTS_NON_USERS_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) TICKETPAYMENTS_NON_USERS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_TOTAL_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS = 7  AND OPE_CUSPMR_TYPE != 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGEREFUNDS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN OPE_AMOUNT ELSE 0 END) PAGATELIA_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) PAGATELIA_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PAGATELIA_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PAGATELIA_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PAGATELIA_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PAGATELIA_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) PAGATELIA_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN OPE_AMOUNT ELSE 0 END) COUPONS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) COUPONS_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) COUPONS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) COUPONS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) COUPONS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) COUPONS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) COUPONS_TOTAL_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS = 7 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) COUPONREFUNDS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 6 THEN OPE_AMOUNT ELSE 0 END) SERVICES_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 6 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) SERVICES_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) SERVICES_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) SERVICES_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) SERVICES_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) SERVICES_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) SERVICES_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_REGULAR_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_REGULAR_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_REGULAR_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_REGULAR_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_REGULAR_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_REGULAR_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_REGULAR_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_AUTOMATIC_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_AUTOMATIC_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_AUTOMATIC_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_AUTOMATIC_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_AUTOMATIC_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_AUTOMATIC_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_REGULAR_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_USERCREATION_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_USERCREATION_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_USERCREATION_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_USERCREATION_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_USERCREATION_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_USERCREATION_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_USERCREATION_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_CHANGEPM_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_CHANGEPM_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_CHANGEPM_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_CHANGEPM_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_CHANGEPM_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_CHANGEPM_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_CHANGEPM_TOTAL_AMOUNT,
		   		   
		   sum(CASE OPE_TYPE WHEN 1 THEN OPE_TIME ELSE 0 END) PARKINGS_TIME,
		   sum(CASE OPE_TYPE WHEN 2 THEN OPE_TIME ELSE 0 END) EXTENSIONS_TIME,
		   sum(CASE OPE_TYPE WHEN 3 THEN OPE_TIME ELSE 0 END) REFUNDS_TIME
	   
	FROM ALL_OPERATIONS_EXT_DB_HIS
	WHERE OPE_TYPE IN (1,2,3,4,5,12,6) AND 
		  CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_UTC_INIDATE 
			   WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN STATUS_DATE
			   ELSE OPE_UTC_DATE END >= @FromHour
	GROUP BY dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN DATEADD(hour, -DATEDIFF(hour, OPE_DATE, OPE_UTC_DATE), STATUS_DATE) 
												  ELSE OPE_DATE END), 0),
			 dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_UTC_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN STATUS_DATE
												  ELSE OPE_UTC_DATE END), 0),												   
			 OPE_INS_ID, GRP_ID, OPE_AMOUNT_CUR_ISO_CODE
	
	INSERT INTO DB_OPERATIONS_HOUR_DIST(OHD_DBOH_ID, OHD_FDO_ID, 
									    OHD_PARKINGS_AMOUNT, OHD_PARKINGS_VAT, OHD_PARKINGS_PERC_FEE, OHD_PARKINGS_PERC_FEE_VAT, OHD_PARKINGS_FIXED_FEE, OHD_PARKINGS_FIXED_FEE_VAT, OHD_PARKINGS_TOTAL_AMOUNT, 
										OHD_EXTENSIONS_AMOUNT, OHD_EXTENSIONS_VAT, OHD_EXTENSIONS_PERC_FEE, OHD_EXTENSIONS_PERC_FEE_VAT, OHD_EXTENSIONS_FIXED_FEE, OHD_EXTENSIONS_FIXED_FEE_VAT, OHD_EXTENSIONS_TOTAL_AMOUNT, 
										OHD_REFUNDS_AMOUNT, OHD_REFUNDS_VAT, OHD_REFUNDS_PERC_FEE, OHD_REFUNDS_PERC_FEE_VAT, OHD_REFUNDS_FIXED_FEE, OHD_REFUNDS_FIXED_FEE_VAT, OHD_REFUNDS_TOTAL_AMOUNT, 
										OHD_TICKETPAYMENTS_AMOUNT, OHD_TICKETPAYMENTS_VAT, OHD_TICKETPAYMENTS_PERC_FEE, OHD_TICKETPAYMENTS_PERC_FEE_VAT, OHD_TICKETPAYMENTS_FIXED_FEE, OHD_TICKETPAYMENTS_FIXED_FEE_VAT, OHD_TICKETPAYMENTS_TOTAL_AMOUNT, 
										OHD_RECHARGES_AMOUNT, OHD_RECHARGES_VAT, OHD_RECHARGES_PERC_FEE, OHD_RECHARGES_PERC_FEE_VAT, OHD_RECHARGES_FIXED_FEE, OHD_RECHARGES_FIXED_FEE_VAT, OHD_RECHARGES_TOTAL_AMOUNT,
										OHD_COUPONS_AMOUNT, OHD_COUPONS_VAT, OHD_COUPONS_PERC_FEE, OHD_COUPONS_PERC_FEE_VAT, OHD_COUPONS_FIXED_FEE, OHD_COUPONS_FIXED_FEE_VAT, OHD_COUPONS_TOTAL_AMOUNT,
										OHD_SERVICES_AMOUNT, OHD_SERVICES_VAT, OHD_SERVICES_PERC_FEE, OHD_SERVICES_PERC_FEE_VAT, OHD_SERVICES_FIXED_FEE, OHD_SERVICES_FIXED_FEE_VAT, OHD_SERVICES_TOTAL_AMOUNT)
	SELECT DB_OPERATIONS_HOUR.DBOH_ID, FINAN_DIST_OPERATORS.FDO_ID,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_AMOUNT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_AMOUNT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, ---dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_AMOUNT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  0, ---dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_AMOUNT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_AMOUNT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_AMOUNT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_VAT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_AMOUNT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_PERC_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_PERC_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_AMOUNT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_PERC_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_PERC_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0

	FROM DB_OPERATIONS_HOUR 
		 /*LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D1
				    WHERE D1.FDOIP_OPE_TYPE = 1 AND
						  D1.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D1.FDOIP_END_APPLY_DATE >= @FromHour) DIST_PARKINGS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_PARKINGS.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_PARKINGS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D2
				    WHERE D2.FDOIP_OPE_TYPE = 2 AND
						  D2.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D2.FDOIP_END_APPLY_DATE >= @FromHour) DIST_EXTENSIONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_EXTENSIONS.FDOIP_INS_ID) AND
																					  DB_OPERATIONS_HOUR.GRP_ID = (DIST_EXTENSIONS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D3
				    WHERE D3.FDOIP_OPE_TYPE = 3 AND
						  D3.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D3.FDOIP_END_APPLY_DATE >= @FromHour) DIST_REFUNDS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_REFUNDS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_REFUNDS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D4
				    WHERE D4.FDOIP_OPE_TYPE = 4 AND
						  D4.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D4.FDOIP_END_APPLY_DATE >= @FromHour) DIST_TICKETPAYMENTS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_TICKETPAYMENTS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_TICKETPAYMENTS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D5
				    WHERE D5.FDOIP_OPE_TYPE = 5 AND
						  D5.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D5.FDOIP_END_APPLY_DATE >= @FromHour) DIST_RECHARGES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_RECHARGES.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_RECHARGES.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D12
				    WHERE D12.FDOIP_OPE_TYPE = 12 AND
						  D12.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D12.FDOIP_END_APPLY_DATE >= @FromHour) DIST_COUPONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_COUPONS.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_COUPONS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D6
				    WHERE D6.FDOIP_OPE_TYPE = 6 AND
						  D6.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D6.FDOIP_END_APPLY_DATE >= @FromHour) DIST_SERVICES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_SERVICES.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_SERVICES.FDOIP_GRP_ID)*/,

		 FINAN_DIST_OPERATORS

	WHERE HOUR_UTC >= @FromHour /*AND
		  (DIST_PARKINGS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_PARKINGS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_EXTENSIONS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_EXTENSIONS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_REFUNDS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_REFUNDS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_TICKETPAYMENTS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_TICKETPAYMENTS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_RECHARGES.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_RECHARGES.FDOIP_FDO_ID IS NULL) AND
		  (DIST_COUPONS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_COUPONS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_SERVICES.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_SERVICES.FDOIP_FDO_ID IS NULL)*/ 
		  
	
	GROUP BY DB_OPERATIONS_HOUR.DBOH_ID, FINAN_DIST_OPERATORS.FDO_ID
	
	/* PARKINGS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET

		  OHD_PARKINGS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_AMOUNT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_PARKINGS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_PARKINGS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_PARKINGS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_PARKINGS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_PARKINGS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_PARKINGS_TOTAL_AMOUNT = 0

	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D1
				    WHERE D1.FDOIP_OPE_TYPE = 1 AND
						  D1.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D1.FDOIP_END_APPLY_DATE >= @FromHour) DIST_PARKINGS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_PARKINGS.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_PARKINGS.FDOIP_GRP_ID) AND
																					 DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_PARKINGS.FDOIP_FDO_ID

	WHERE HOUR_UTC >= @FromHour 
		  		  	
	/* EXTENSIONS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_EXTENSIONS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_AMOUNT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_EXTENSIONS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_EXTENSIONS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_EXTENSIONS_PERC_FEE_VAT= dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_EXTENSIONS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_EXTENSIONS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_EXTENSIONS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D2
				    WHERE D2.FDOIP_OPE_TYPE = 2 AND
						  D2.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D2.FDOIP_END_APPLY_DATE >= @FromHour) DIST_EXTENSIONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_EXTENSIONS.FDOIP_INS_ID) AND
																					  DB_OPERATIONS_HOUR.GRP_ID = (DIST_EXTENSIONS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_EXTENSIONS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour 

	/* REFUNDS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_REFUNDS_AMOUNT = -dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_AMOUNT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_REFUNDS_VAT = -dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_REFUNDS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_REFUNDS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_REFUNDS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_REFUNDS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_REFUNDS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D3
				    WHERE D3.FDOIP_OPE_TYPE = 3 AND
						  D3.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D3.FDOIP_END_APPLY_DATE >= @FromHour) DIST_REFUNDS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_REFUNDS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_REFUNDS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_REFUNDS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* TICKETPAYMENTS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_TICKETPAYMENTS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_AMOUNT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_TICKETPAYMENTS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_TICKETPAYMENTS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_TICKETPAYMENTS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_TICKETPAYMENTS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_TICKETPAYMENTS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_TICKETPAYMENTS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D4
				    WHERE D4.FDOIP_OPE_TYPE = 4 AND
						  D4.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D4.FDOIP_END_APPLY_DATE >= @FromHour) DIST_TICKETPAYMENTS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_TICKETPAYMENTS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_TICKETPAYMENTS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_TICKETPAYMENTS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* RECHARGES */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_RECHARGES_AMOUNT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_AMOUNT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_AMOUNT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_RECHARGES_VAT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_VAT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_RECHARGES_PERC_FEE = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_RECHARGES_PERC_FEE_VAT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_RECHARGES_FIXED_FEE = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_RECHARGES_FIXED_FEE_VAT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_RECHARGES_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D5
				    WHERE D5.FDOIP_OPE_TYPE = 5 AND
						  D5.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D5.FDOIP_END_APPLY_DATE >= @FromHour) DIST_RECHARGES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_RECHARGES.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_RECHARGES.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_RECHARGES.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* COUPONS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_COUPONS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_AMOUNT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_COUPONS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_COUPONS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_PERC_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_COUPONS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_PERC_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_COUPONS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_COUPONS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_COUPONS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D12
				    WHERE D12.FDOIP_OPE_TYPE = 12 AND
						  D12.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D12.FDOIP_END_APPLY_DATE >= @FromHour) DIST_COUPONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_COUPONS.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_COUPONS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_COUPONS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* SERVICES */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_SERVICES_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_AMOUNT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_SERVICES_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_SERVICES_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_PERC_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_SERVICES_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_PERC_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_SERVICES_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_SERVICES_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_SERVICES_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D6
				    WHERE D6.FDOIP_OPE_TYPE = 6 AND
						  D6.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D6.FDOIP_END_APPLY_DATE >= @FromHour) DIST_SERVICES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_SERVICES.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_SERVICES.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_SERVICES.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

END




GO

ALTER PROCEDURE [dbo].[Update_DB_OPERATIONS_HOUR_HIS2]
	@FromHour AS Datetime
AS	
BEGIN

	IF (@FromHour IS NULL)
	BEGIN
		SET @FromHour = (SELECT MAX([HOUR_UTC])
		FROM DB_OPERATIONS_HOUR
		WHERE [HOUR_UTC] < GETUTCDATE())

		IF (@FromHour IS NOT NULL)
		BEGIN
			SET @FromHour = DATEADD(HOUR, -1, @FromHour)
		END		
	END
	
	IF (@FromHour IS NULL)
	BEGIN
		SET @FromHour = (SELECT MIN(OPE_UTC_DATE)
		FROM ALL_OPERATIONS_EXT
		WHERE OPE_TYPE IN (1,2,3,4, 5))
	END	

	DELETE FROM DB_OPERATIONS_HOUR_DIST
	WHERE OHD_DBOH_ID IN (SELECT DBOH_ID
						  FROM DB_OPERATIONS_HOUR
						  WHERE CASE WHEN [HOUR_UTC] IS NULL THEN [HOUR] ELSE [HOUR_UTC] END >= @FromHour)
						  
	DELETE FROM DB_OPERATIONS_HOUR
	WHERE CASE WHEN [HOUR_UTC] IS NULL THEN [HOUR] ELSE [HOUR_UTC] END >= @FromHour
	

	INSERT INTO DB_OPERATIONS_HOUR([HOUR], HOUR_UTC, OPE_INS_ID, GRP_ID, OPE_AMOUNT_CUR_ISO_CODE, PARKINGS_COUNT, EXTENSIONS_COUNT, REFUNDS_COUNT, TICKETPAYMENTS_COUNT, RECHARGES_COUNT, PAGATELIA_COUNT, RECHARGEREFUNDS_COUNT, COUPONS_COUNT, COUPONREFUNDS_COUNT, SERVICES_COUNT, RECHARGES_REGULAR_COUNT, RECHARGES_AUTOMATIC_COUNT, RECHARGES_USERCREATION_COUNT, RECHARGES_CHANGEPM_COUNT, TICKETPAYMENTS_NON_USERS_COUNT,
								   PARKINGS_AMOUNT, PARKINGS_VAT, PARKINGS_PERC_FEE, PARKINGS_PERC_FEE_VAT, PARKINGS_FIXED_FEE, PARKINGS_FIXED_FEE_VAT, PARKINGS_TOTAL_AMOUNT, 
								   EXTENSIONS_AMOUNT, EXTENSIONS_VAT, EXTENSIONS_PERC_FEE, EXTENSIONS_PERC_FEE_VAT, EXTENSIONS_FIXED_FEE, EXTENSIONS_FIXED_FEE_VAT, EXTENSIONS_TOTAL_AMOUNT, 
								   REFUNDS_AMOUNT, REFUNDS_VAT, REFUNDS_PERC_FEE, REFUNDS_PERC_FEE_VAT, REFUNDS_FIXED_FEE, REFUNDS_FIXED_FEE_VAT, REFUNDS_TOTAL_AMOUNT, 
								   TICKETPAYMENTS_AMOUNT, TICKETPAYMENTS_VAT, TICKETPAYMENTS_PERC_FEE, TICKETPAYMENTS_PERC_FEE_VAT, TICKETPAYMENTS_FIXED_FEE, TICKETPAYMENTS_FIXED_FEE_VAT, TICKETPAYMENTS_TOTAL_AMOUNT, 
								   TICKETPAYMENTS_NON_USERS_AMOUNT, TICKETPAYMENTS_NON_USERS_VAT, TICKETPAYMENTS_NON_USERS_PERC_FEE, TICKETPAYMENTS_NON_USERS_PERC_FEE_VAT, TICKETPAYMENTS_NON_USERS_FIXED_FEE, TICKETPAYMENTS_NON_USERS_FIXED_FEE_VAT, TICKETPAYMENTS_NON_USERS_TOTAL_AMOUNT, 
								   RECHARGES_AMOUNT, RECHARGES_VAT, RECHARGES_PERC_FEE, RECHARGES_PERC_FEE_VAT, RECHARGES_FIXED_FEE, RECHARGES_FIXED_FEE_VAT, RECHARGES_TOTAL_AMOUNT, RECHARGEREFUNDS_TOTAL_AMOUNT,
								   PAGATELIA_AMOUNT, PAGATELIA_VAT, PAGATELIA_PERC_FEE, PAGATELIA_PERC_FEE_VAT, PAGATELIA_FIXED_FEE, PAGATELIA_FIXED_FEE_VAT, PAGATELIA_TOTAL_AMOUNT,
								   COUPONS_AMOUNT, COUPONS_VAT, COUPONS_PERC_FEE, COUPONS_PERC_FEE_VAT, COUPONS_FIXED_FEE, COUPONS_FIXED_FEE_VAT, COUPONS_TOTAL_AMOUNT, COUPONREFUNDS_TOTAL_AMOUNT, 
								   SERVICES_AMOUNT, SERVICES_VAT, SERVICES_PERC_FEE, SERVICES_PERC_FEE_VAT, SERVICES_FIXED_FEE, SERVICES_FIXED_FEE_VAT, SERVICES_TOTAL_AMOUNT, 
								   RECHARGES_REGULAR_AMOUNT, RECHARGES_REGULAR_VAT, RECHARGES_REGULAR_PERC_FEE, RECHARGES_REGULAR_PERC_FEE_VAT, RECHARGES_REGULAR_FIXED_FEE, RECHARGES_REGULAR_FIXED_FEE_VAT, RECHARGES_REGULAR_TOTAL_AMOUNT, 
								   RECHARGES_AUTOMATIC_AMOUNT, RECHARGES_AUTOMATIC_VAT, RECHARGES_AUTOMATIC_PERC_FEE, RECHARGES_AUTOMATIC_PERC_FEE_VAT, RECHARGES_AUTOMATIC_FIXED_FEE, RECHARGES_AUTOMATIC_FIXED_FEE_VAT, RECHARGES_AUTOMATIC_TOTAL_AMOUNT, 
								   RECHARGES_USERCREATION_AMOUNT, RECHARGES_USERCREATION_VAT, RECHARGES_USERCREATION_PERC_FEE, RECHARGES_USERCREATION_PERC_FEE_VAT, RECHARGES_USERCREATION_FIXED_FEE, RECHARGES_USERCREATION_FIXED_FEE_VAT, RECHARGES_USERCREATION_TOTAL_AMOUNT, 
								   RECHARGES_CHANGEPM_AMOUNT, RECHARGES_CHANGEPM_VAT, RECHARGES_CHANGEPM_PERC_FEE, RECHARGES_CHANGEPM_PERC_FEE_VAT, RECHARGES_CHANGEPM_FIXED_FEE, RECHARGES_CHANGEPM_FIXED_FEE_VAT, RECHARGES_CHANGEPM_TOTAL_AMOUNT,
								   PARKINGS_TIME, EXTENSIONS_TIME, REFUNDS_TIME)
	SELECT dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN DATEADD(hour, -DATEDIFF(hour, OPE_DATE, OPE_UTC_DATE), STATUS_DATE) 
												  ELSE OPE_DATE END), 0) AS HOUR, 
		   dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_UTC_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN STATUS_DATE
												  ELSE OPE_UTC_DATE END), 0) AS HOUR_UTC,
		   ISNULL(OPE_INS_ID,0), ISNULL(GRP_ID,0), OPE_AMOUNT_CUR_ISO_CODE,
		   count(distinct(CASE OPE_TYPE WHEN 1 THEN ope_id ELSE NULL END)) PARKINGS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 2 THEN ope_id ELSE NULL END)) EXTENSIONS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 3 THEN ope_id ELSE NULL END)) REFUNDS_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN ope_id ELSE NULL END)) TICKETPAYMENTS_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN ope_id ELSE NULL END)) TICKETPAYMENTS_NON_USERS_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE != 2 THEN ope_id ELSE NULL END)) RECHARGES_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN ope_id ELSE NULL END)) PAGATELIA_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS = 7 THEN ope_id ELSE NULL END)) RECHARGEREFUNDS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 12 THEN ope_id ELSE NULL END)) COUPONS_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS = 7 THEN ope_id ELSE NULL END)) COUPONREFUNDS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 6 THEN ope_id ELSE NULL END)) SERVICES_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN ope_id ELSE NULL END)) RECHARGES_REGULAR_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN ope_id ELSE NULL END)) RECHARGES_AUTOMATIC_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN ope_id ELSE NULL END)) RECHARGES_USERCREATION_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN ope_id ELSE NULL END)) RECHARGES_CHANGEPM_COUNT,

		   sum(CASE OPE_TYPE WHEN 1 THEN -OPE_AMOUNT ELSE 0 END) PARKINGS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 1 THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) PARKINGS_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PARKINGS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PARKINGS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PARKINGS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PARKINGS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) PARKINGS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 2 THEN -OPE_AMOUNT ELSE 0 END) EXTENSIONS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 2 THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) EXTENSIONS_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) EXTENSIONS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) EXTENSIONS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) EXTENSIONS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) EXTENSIONS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) EXTENSIONS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 3 THEN OPE_AMOUNT ELSE 0 END) REFUNDS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 3 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) REFUNDS_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) REFUNDS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) REFUNDS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) REFUNDS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) REFUNDS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) REFUNDS_TOTAL_AMOUNT,
		   
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -OPE_AMOUNT ELSE 0 END) TICKETPAYMENTS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) TICKETPAYMENTS_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) TICKETPAYMENTS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -OPE_AMOUNT ELSE 0 END) TICKETPAYMENTS_NON_USERS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) TICKETPAYMENTS_NON_USERS_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) TICKETPAYMENTS_NON_USERS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 AND OPE_CUSPMR_TYPE != 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_TOTAL_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS = 7  AND OPE_CUSPMR_TYPE != 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGEREFUNDS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN OPE_AMOUNT ELSE 0 END) PAGATELIA_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) PAGATELIA_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PAGATELIA_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PAGATELIA_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PAGATELIA_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PAGATELIA_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_TYPE = 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) PAGATELIA_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN OPE_AMOUNT ELSE 0 END) COUPONS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) COUPONS_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) COUPONS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) COUPONS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) COUPONS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) COUPONS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) COUPONS_TOTAL_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS = 7 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) COUPONREFUNDS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 6 THEN OPE_AMOUNT ELSE 0 END) SERVICES_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 6 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) SERVICES_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) SERVICES_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) SERVICES_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) SERVICES_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) SERVICES_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) SERVICES_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_REGULAR_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_REGULAR_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_REGULAR_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_REGULAR_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_REGULAR_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_REGULAR_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 0 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_REGULAR_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_AUTOMATIC_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_AUTOMATIC_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_AUTOMATIC_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_AUTOMATIC_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_AUTOMATIC_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_AUTOMATIC_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 1 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_REGULAR_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_USERCREATION_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_USERCREATION_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_USERCREATION_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_USERCREATION_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_USERCREATION_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_USERCREATION_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 2 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_USERCREATION_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_CHANGEPM_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_CHANGEPM_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_CHANGEPM_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_CHANGEPM_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_CHANGEPM_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_CHANGEPM_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND OPE_CUSPMR_CREATION_TYPE = 3 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_CHANGEPM_TOTAL_AMOUNT,
		   		   
		   sum(CASE OPE_TYPE WHEN 1 THEN OPE_TIME ELSE 0 END) PARKINGS_TIME,
		   sum(CASE OPE_TYPE WHEN 2 THEN OPE_TIME ELSE 0 END) EXTENSIONS_TIME,
		   sum(CASE OPE_TYPE WHEN 3 THEN OPE_TIME ELSE 0 END) REFUNDS_TIME
	   
	FROM ALL_OPERATIONS_EXT_DB_HIS
	WHERE OPE_TYPE IN (1,2,3,4,5,12,6) AND 
		  CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_UTC_INIDATE 
			   WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN STATUS_DATE
			   ELSE OPE_UTC_DATE END >= @FromHour
	GROUP BY dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN DATEADD(hour, -DATEDIFF(hour, OPE_DATE, OPE_UTC_DATE), STATUS_DATE) 
												  ELSE OPE_DATE END), 0),
			 dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_UTC_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN STATUS_DATE
												  ELSE OPE_UTC_DATE END), 0),												   
			 OPE_INS_ID, GRP_ID, OPE_AMOUNT_CUR_ISO_CODE
	
	INSERT INTO DB_OPERATIONS_HOUR_DIST(OHD_DBOH_ID, OHD_FDO_ID, 
									    OHD_PARKINGS_AMOUNT, OHD_PARKINGS_VAT, OHD_PARKINGS_PERC_FEE, OHD_PARKINGS_PERC_FEE_VAT, OHD_PARKINGS_FIXED_FEE, OHD_PARKINGS_FIXED_FEE_VAT, OHD_PARKINGS_TOTAL_AMOUNT, 
										OHD_EXTENSIONS_AMOUNT, OHD_EXTENSIONS_VAT, OHD_EXTENSIONS_PERC_FEE, OHD_EXTENSIONS_PERC_FEE_VAT, OHD_EXTENSIONS_FIXED_FEE, OHD_EXTENSIONS_FIXED_FEE_VAT, OHD_EXTENSIONS_TOTAL_AMOUNT, 
										OHD_REFUNDS_AMOUNT, OHD_REFUNDS_VAT, OHD_REFUNDS_PERC_FEE, OHD_REFUNDS_PERC_FEE_VAT, OHD_REFUNDS_FIXED_FEE, OHD_REFUNDS_FIXED_FEE_VAT, OHD_REFUNDS_TOTAL_AMOUNT, 
										OHD_TICKETPAYMENTS_AMOUNT, OHD_TICKETPAYMENTS_VAT, OHD_TICKETPAYMENTS_PERC_FEE, OHD_TICKETPAYMENTS_PERC_FEE_VAT, OHD_TICKETPAYMENTS_FIXED_FEE, OHD_TICKETPAYMENTS_FIXED_FEE_VAT, OHD_TICKETPAYMENTS_TOTAL_AMOUNT, 
										OHD_RECHARGES_AMOUNT, OHD_RECHARGES_VAT, OHD_RECHARGES_PERC_FEE, OHD_RECHARGES_PERC_FEE_VAT, OHD_RECHARGES_FIXED_FEE, OHD_RECHARGES_FIXED_FEE_VAT, OHD_RECHARGES_TOTAL_AMOUNT,
										OHD_COUPONS_AMOUNT, OHD_COUPONS_VAT, OHD_COUPONS_PERC_FEE, OHD_COUPONS_PERC_FEE_VAT, OHD_COUPONS_FIXED_FEE, OHD_COUPONS_FIXED_FEE_VAT, OHD_COUPONS_TOTAL_AMOUNT,
										OHD_SERVICES_AMOUNT, OHD_SERVICES_VAT, OHD_SERVICES_PERC_FEE, OHD_SERVICES_PERC_FEE_VAT, OHD_SERVICES_FIXED_FEE, OHD_SERVICES_FIXED_FEE_VAT, OHD_SERVICES_TOTAL_AMOUNT)
	SELECT DB_OPERATIONS_HOUR.DBOH_ID, FINAN_DIST_OPERATORS.FDO_ID,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_AMOUNT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_AMOUNT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, ---dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_AMOUNT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  0, ---dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_AMOUNT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_AMOUNT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_AMOUNT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_VAT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_AMOUNT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_PERC_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_PERC_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_AMOUNT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_PERC_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_PERC_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0, --dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0

	FROM DB_OPERATIONS_HOUR 
		 /*LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D1
				    WHERE D1.FDOIP_OPE_TYPE = 1 AND
						  D1.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D1.FDOIP_END_APPLY_DATE >= @FromHour) DIST_PARKINGS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_PARKINGS.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_PARKINGS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D2
				    WHERE D2.FDOIP_OPE_TYPE = 2 AND
						  D2.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D2.FDOIP_END_APPLY_DATE >= @FromHour) DIST_EXTENSIONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_EXTENSIONS.FDOIP_INS_ID) AND
																					  DB_OPERATIONS_HOUR.GRP_ID = (DIST_EXTENSIONS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D3
				    WHERE D3.FDOIP_OPE_TYPE = 3 AND
						  D3.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D3.FDOIP_END_APPLY_DATE >= @FromHour) DIST_REFUNDS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_REFUNDS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_REFUNDS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D4
				    WHERE D4.FDOIP_OPE_TYPE = 4 AND
						  D4.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D4.FDOIP_END_APPLY_DATE >= @FromHour) DIST_TICKETPAYMENTS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_TICKETPAYMENTS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_TICKETPAYMENTS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D5
				    WHERE D5.FDOIP_OPE_TYPE = 5 AND
						  D5.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D5.FDOIP_END_APPLY_DATE >= @FromHour) DIST_RECHARGES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_RECHARGES.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_RECHARGES.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D12
				    WHERE D12.FDOIP_OPE_TYPE = 12 AND
						  D12.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D12.FDOIP_END_APPLY_DATE >= @FromHour) DIST_COUPONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_COUPONS.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_COUPONS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D6
				    WHERE D6.FDOIP_OPE_TYPE = 6 AND
						  D6.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D6.FDOIP_END_APPLY_DATE >= @FromHour) DIST_SERVICES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_SERVICES.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_SERVICES.FDOIP_GRP_ID)*/,

		 FINAN_DIST_OPERATORS

	WHERE HOUR_UTC >= @FromHour /*AND
		  (DIST_PARKINGS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_PARKINGS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_EXTENSIONS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_EXTENSIONS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_REFUNDS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_REFUNDS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_TICKETPAYMENTS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_TICKETPAYMENTS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_RECHARGES.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_RECHARGES.FDOIP_FDO_ID IS NULL) AND
		  (DIST_COUPONS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_COUPONS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_SERVICES.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_SERVICES.FDOIP_FDO_ID IS NULL)*/ 
		  
	
	GROUP BY DB_OPERATIONS_HOUR.DBOH_ID, FINAN_DIST_OPERATORS.FDO_ID
	
	/* PARKINGS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET

		  OHD_PARKINGS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_AMOUNT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_PARKINGS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_PARKINGS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_PARKINGS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_PARKINGS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_PARKINGS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_PARKINGS_TOTAL_AMOUNT = 0

	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D1
				    WHERE D1.FDOIP_OPE_TYPE = 1 AND
						  D1.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D1.FDOIP_END_APPLY_DATE >= @FromHour) DIST_PARKINGS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_PARKINGS.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_PARKINGS.FDOIP_GRP_ID) AND
																					 DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_PARKINGS.FDOIP_FDO_ID

	WHERE HOUR_UTC >= @FromHour 
		  		  	
	/* EXTENSIONS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_EXTENSIONS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_AMOUNT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_EXTENSIONS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_EXTENSIONS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_EXTENSIONS_PERC_FEE_VAT= dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_EXTENSIONS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_EXTENSIONS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_EXTENSIONS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D2
				    WHERE D2.FDOIP_OPE_TYPE = 2 AND
						  D2.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D2.FDOIP_END_APPLY_DATE >= @FromHour) DIST_EXTENSIONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_EXTENSIONS.FDOIP_INS_ID) AND
																					  DB_OPERATIONS_HOUR.GRP_ID = (DIST_EXTENSIONS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_EXTENSIONS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour 

	/* REFUNDS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_REFUNDS_AMOUNT = -dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_AMOUNT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_REFUNDS_VAT = -dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_REFUNDS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_REFUNDS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_REFUNDS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_REFUNDS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_REFUNDS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D3
				    WHERE D3.FDOIP_OPE_TYPE = 3 AND
						  D3.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D3.FDOIP_END_APPLY_DATE >= @FromHour) DIST_REFUNDS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_REFUNDS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_REFUNDS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_REFUNDS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* TICKETPAYMENTS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_TICKETPAYMENTS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_AMOUNT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_TICKETPAYMENTS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_TICKETPAYMENTS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_TICKETPAYMENTS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_TICKETPAYMENTS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_TICKETPAYMENTS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_TICKETPAYMENTS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D4
				    WHERE D4.FDOIP_OPE_TYPE = 4 AND
						  D4.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D4.FDOIP_END_APPLY_DATE >= @FromHour) DIST_TICKETPAYMENTS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_TICKETPAYMENTS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_TICKETPAYMENTS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_TICKETPAYMENTS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* RECHARGES */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_RECHARGES_AMOUNT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_AMOUNT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_AMOUNT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_RECHARGES_VAT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_VAT,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_RECHARGES_PERC_FEE = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_RECHARGES_PERC_FEE_VAT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_PERC_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_RECHARGES_FIXED_FEE = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE,0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_RECHARGES_FIXED_FEE_VAT = dbo.ToInt(((DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE_VAT + ISNULL(DB_OPERATIONS_HOUR.PAGATELIA_FIXED_FEE_VAT, 0)) * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_RECHARGES_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D5
				    WHERE D5.FDOIP_OPE_TYPE = 5 AND
						  D5.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D5.FDOIP_END_APPLY_DATE >= @FromHour) DIST_RECHARGES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_RECHARGES.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_RECHARGES.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_RECHARGES.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* COUPONS */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_COUPONS_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_AMOUNT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_COUPONS_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_COUPONS_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_PERC_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_COUPONS_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_PERC_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_COUPONS_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_COUPONS_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_COUPONS_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D12
				    WHERE D12.FDOIP_OPE_TYPE = 12 AND
						  D12.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D12.FDOIP_END_APPLY_DATE >= @FromHour) DIST_COUPONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_COUPONS.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_COUPONS.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_COUPONS.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

	/* SERVICES */
	UPDATE DB_OPERATIONS_HOUR_DIST
	SET
		  OHD_SERVICES_AMOUNT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_AMOUNT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_SERVICES_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  OHD_SERVICES_PERC_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_PERC_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_SERVICES_PERC_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_PERC_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  OHD_SERVICES_FIXED_FEE = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_SERVICES_FIXED_FEE_VAT = dbo.ToInt((DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  OHD_SERVICES_TOTAL_AMOUNT = 0
	FROM DB_OPERATIONS_HOUR_DIST
		 INNER JOIN DB_OPERATIONS_HOUR ON  DB_OPERATIONS_HOUR.DBOH_ID = DB_OPERATIONS_HOUR_DIST.OHD_DBOH_ID
		 INNER JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D6
				    WHERE D6.FDOIP_OPE_TYPE = 6 AND
						  D6.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D6.FDOIP_END_APPLY_DATE >= @FromHour) DIST_SERVICES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_SERVICES.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_SERVICES.FDOIP_GRP_ID) AND
																					  DB_OPERATIONS_HOUR_DIST.OHD_FDO_ID = DIST_SERVICES.FDOIP_FDO_ID
	WHERE HOUR_UTC >= @FromHour

END





GO


ALTER PROCEDURE [dbo].[Update_DB_OPERATIONS_HOUR2]
	@FromHour AS Datetime,
	@ToHour AS Datetime
AS	
BEGIN

	IF (@FromHour IS NULL)
	BEGIN
		SET @FromHour = (SELECT MAX([HOUR_UTC])
		FROM DB_OPERATIONS_HOUR
		WHERE [HOUR_UTC] < GETUTCDATE())
	END
	
	IF (@FromHour IS NULL)
	BEGIN
		SET @FromHour = (SELECT MIN(OPE_UTC_DATE)
		FROM ALL_OPERATIONS_EXT
		WHERE OPE_TYPE IN (1,2,3,4, 5))
	END	

	DELETE FROM DB_OPERATIONS_HOUR_DIST
	WHERE OHD_DBOH_ID IN (SELECT DBOH_ID
						  FROM DB_OPERATIONS_HOUR
						  WHERE CASE WHEN [HOUR_UTC] IS NULL THEN [HOUR] ELSE [HOUR_UTC] END >= @FromHour AND
								CASE WHEN [HOUR_UTC] IS NULL THEN [HOUR] ELSE [HOUR_UTC] END < @ToHour)
						  
	DELETE FROM DB_OPERATIONS_HOUR
	WHERE CASE WHEN [HOUR_UTC] IS NULL THEN [HOUR] ELSE [HOUR_UTC] END >= @FromHour AND
		  CASE WHEN [HOUR_UTC] IS NULL THEN [HOUR] ELSE [HOUR_UTC] END < @ToHour
	

	INSERT INTO DB_OPERATIONS_HOUR([HOUR], OPE_INS_ID, GRP_ID, OPE_AMOUNT_CUR_ISO_CODE, PARKINGS_COUNT, EXTENSIONS_COUNT, REFUNDS_COUNT, TICKETPAYMENTS_COUNT, RECHARGES_COUNT, RECHARGEREFUNDS_COUNT, COUPONS_COUNT, COUPONREFUNDS_COUNT, SERVICES_COUNT, TICKETPAYMENTS_NON_USERS_COUNT,
								   PARKINGS_AMOUNT, PARKINGS_VAT, PARKINGS_PERC_FEE, PARKINGS_PERC_FEE_VAT, PARKINGS_FIXED_FEE, PARKINGS_FIXED_FEE_VAT, PARKINGS_TOTAL_AMOUNT, 
								   EXTENSIONS_AMOUNT, EXTENSIONS_VAT, EXTENSIONS_PERC_FEE, EXTENSIONS_PERC_FEE_VAT, EXTENSIONS_FIXED_FEE, EXTENSIONS_FIXED_FEE_VAT, EXTENSIONS_TOTAL_AMOUNT, 
								   REFUNDS_AMOUNT, REFUNDS_VAT, REFUNDS_PERC_FEE, REFUNDS_PERC_FEE_VAT, REFUNDS_FIXED_FEE, REFUNDS_FIXED_FEE_VAT, REFUNDS_TOTAL_AMOUNT, 
								   TICKETPAYMENTS_AMOUNT, TICKETPAYMENTS_VAT, TICKETPAYMENTS_PERC_FEE, TICKETPAYMENTS_PERC_FEE_VAT, TICKETPAYMENTS_FIXED_FEE, TICKETPAYMENTS_FIXED_FEE_VAT, TICKETPAYMENTS_TOTAL_AMOUNT, 
								   TICKETPAYMENTS_NON_USERS_AMOUNT, TICKETPAYMENTS_NON_USERS_VAT, TICKETPAYMENTS_NON_USERS_PERC_FEE, TICKETPAYMENTS_NON_USERS_PERC_FEE_VAT, TICKETPAYMENTS_NON_USERS_FIXED_FEE, TICKETPAYMENTS_NON_USERS_FIXED_FEE_VAT, TICKETPAYMENTS_NON_USERS_TOTAL_AMOUNT, 
								   RECHARGES_AMOUNT, RECHARGES_VAT, RECHARGES_PERC_FEE, RECHARGES_PERC_FEE_VAT, RECHARGES_FIXED_FEE, RECHARGES_FIXED_FEE_VAT, RECHARGES_TOTAL_AMOUNT, RECHARGEREFUNDS_TOTAL_AMOUNT,
								   COUPONS_AMOUNT, COUPONS_VAT, COUPONS_PERC_FEE, COUPONS_PERC_FEE_VAT, COUPONS_FIXED_FEE, COUPONS_FIXED_FEE_VAT, COUPONS_TOTAL_AMOUNT, COUPONREFUNDS_TOTAL_AMOUNT, 
								   SERVICES_AMOUNT, SERVICES_VAT, SERVICES_PERC_FEE, SERVICES_PERC_FEE_VAT, SERVICES_FIXED_FEE, SERVICES_FIXED_FEE_VAT, SERVICES_TOTAL_AMOUNT, 
								   PARKINGS_TIME, EXTENSIONS_TIME, REFUNDS_TIME, HOUR_UTC)
	SELECT dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN DATEADD(hour, -DATEDIFF(hour, OPE_DATE, OPE_UTC_DATE), STATUS_DATE) 
												  ELSE OPE_DATE END), 0) AS HOUR, 
		   ISNULL(OPE_INS_ID,0), ISNULL(GRP_ID,0), OPE_AMOUNT_CUR_ISO_CODE,
		   count(distinct(CASE OPE_TYPE WHEN 1 THEN ope_id ELSE NULL END)) PARKINGS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 2 THEN ope_id ELSE NULL END)) EXTENSIONS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 3 THEN ope_id ELSE NULL END)) REFUNDS_COUNT,		   
		   count(distinct(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN ope_id ELSE NULL END)) TICKETPAYMENTS_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN ope_id ELSE NULL END)) TICKETPAYMENTS_NON_USERS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 5 THEN ope_id ELSE NULL END)) RECHARGES_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS = 7 THEN ope_id ELSE NULL END)) RECHARGEREFUNDS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 12 THEN ope_id ELSE NULL END)) COUPONS_COUNT,
		   count(distinct(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS = 7 THEN ope_id ELSE NULL END)) COUPONREFUNDS_COUNT,
		   count(distinct(CASE OPE_TYPE WHEN 6 THEN ope_id ELSE NULL END)) SERVICES_COUNT,

		   sum(CASE OPE_TYPE WHEN 1 THEN -OPE_AMOUNT ELSE 0 END) PARKINGS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 1 THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) PARKINGS_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PARKINGS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PARKINGS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) PARKINGS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 1 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) PARKINGS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 1 THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) PARKINGS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 2 THEN -OPE_AMOUNT ELSE 0 END) EXTENSIONS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 2 THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) EXTENSIONS_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) EXTENSIONS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) EXTENSIONS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) EXTENSIONS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 2 THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) EXTENSIONS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 2 THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) EXTENSIONS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 3 THEN OPE_AMOUNT ELSE 0 END) REFUNDS_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 3 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) REFUNDS_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) REFUNDS_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) REFUNDS_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) REFUNDS_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 3 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) REFUNDS_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 3 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) REFUNDS_TOTAL_AMOUNT,
		   
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -OPE_AMOUNT ELSE 0 END) TICKETPAYMENTS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) TICKETPAYMENTS_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) TICKETPAYMENTS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -OPE_AMOUNT ELSE 0 END) TICKETPAYMENTS_NON_USERS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) TICKETPAYMENTS_NON_USERS_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -(ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN dbo.ToInt(  -((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) TICKETPAYMENTS_NON_USERS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN -ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) TICKETPAYMENTS_NON_USERS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) RECHARGES_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) RECHARGES_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) RECHARGES_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS != 7 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGES_TOTAL_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 5 AND TRANS_STATUS = 7 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) RECHARGEREFUNDS_TOTAL_AMOUNT,

		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN OPE_AMOUNT ELSE 0 END) COUPONS_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) COUPONS_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) COUPONS_PERC_FEE,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) COUPONS_PERC_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) COUPONS_FIXED_FEE,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) COUPONS_FIXED_FEE_VAT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS != 7 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) COUPONS_TOTAL_AMOUNT,
		   sum(CASE WHEN OPE_TYPE = 12 AND TRANS_STATUS = 7 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) COUPONREFUNDS_TOTAL_AMOUNT,

		   sum(CASE OPE_TYPE WHEN 6 THEN OPE_AMOUNT ELSE 0 END) SERVICES_AMOUNT,
		   sum(CASE OPE_TYPE WHEN 6 THEN ISNULL(OPE_PARTIAL_VAT1,0) ELSE 0 END) SERVICES_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_PERC_FEE,0) - ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) SERVICES_PERC_FEE,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_PERC_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) SERVICES_PERC_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  (ISNULL(OPE_PARTIAL_FIXED_FEE,0) - ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0))))  ) ELSE 0 END) SERVICES_FIXED_FEE,
		   sum(CASE OPE_TYPE WHEN 6 THEN dbo.ToInt(  ((ISNULL(OPE_PARTIAL_FIXED_FEE,0) * ISNULL(OPE_PERC_VAT2,0)) / (1 + ISNULL(OPE_PERC_VAT2,0)))  ) ELSE 0 END) SERVICES_FIXED_FEE_VAT,
		   sum(CASE OPE_TYPE WHEN 6 THEN ISNULL(OPE_TOTAL_AMOUNT,0) ELSE 0 END) SERVICES_TOTAL_AMOUNT,
		   		   
		   sum(CASE OPE_TYPE WHEN 1 THEN OPE_TIME ELSE 0 END) PARKINGS_TIME,
		   sum(CASE OPE_TYPE WHEN 2 THEN OPE_TIME ELSE 0 END) EXTENSIONS_TIME,
		   sum(CASE OPE_TYPE WHEN 3 THEN OPE_TIME ELSE 0 END) REFUNDS_TIME,
		   MAX(dateadd(hour, datediff(hour, 0, OPE_UTC_DATE), 0))
	   
	FROM ALL_OPERATIONS_EXT_DB
	WHERE OPE_TYPE IN (1,2,3,4,5,12,6) AND 
		  OPE_UTC_DATE >= @FromHour AND
		  OPE_UTC_DATE < @ToHour
	GROUP BY dateadd(hour, datediff(hour, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_INIDATE 
												  WHEN OPE_TYPE IN (5, 12) AND TRANS_STATUS = 7 THEN DATEADD(hour, -DATEDIFF(hour, OPE_DATE, OPE_UTC_DATE), STATUS_DATE) 
												  ELSE OPE_DATE END), 0), 
			 OPE_INS_ID, GRP_ID, OPE_AMOUNT_CUR_ISO_CODE
	
	INSERT INTO DB_OPERATIONS_HOUR_DIST(OHD_DBOH_ID, OHD_FDO_ID, 
									    OHD_PARKINGS_AMOUNT, OHD_PARKINGS_VAT, OHD_PARKINGS_PERC_FEE, OHD_PARKINGS_PERC_FEE_VAT, OHD_PARKINGS_FIXED_FEE, OHD_PARKINGS_FIXED_FEE_VAT, OHD_PARKINGS_TOTAL_AMOUNT, 
										OHD_EXTENSIONS_AMOUNT, OHD_EXTENSIONS_VAT, OHD_EXTENSIONS_PERC_FEE, OHD_EXTENSIONS_PERC_FEE_VAT, OHD_EXTENSIONS_FIXED_FEE, OHD_EXTENSIONS_FIXED_FEE_VAT, OHD_EXTENSIONS_TOTAL_AMOUNT, 
										OHD_REFUNDS_AMOUNT, OHD_REFUNDS_VAT, OHD_REFUNDS_PERC_FEE, OHD_REFUNDS_PERC_FEE_VAT, OHD_REFUNDS_FIXED_FEE, OHD_REFUNDS_FIXED_FEE_VAT, OHD_REFUNDS_TOTAL_AMOUNT, 
										OHD_TICKETPAYMENTS_AMOUNT, OHD_TICKETPAYMENTS_VAT, OHD_TICKETPAYMENTS_PERC_FEE, OHD_TICKETPAYMENTS_PERC_FEE_VAT, OHD_TICKETPAYMENTS_FIXED_FEE, OHD_TICKETPAYMENTS_FIXED_FEE_VAT, OHD_TICKETPAYMENTS_TOTAL_AMOUNT, 
										OHD_RECHARGES_AMOUNT, OHD_RECHARGES_VAT, OHD_RECHARGES_PERC_FEE, OHD_RECHARGES_PERC_FEE_VAT, OHD_RECHARGES_FIXED_FEE, OHD_RECHARGES_FIXED_FEE_VAT, OHD_RECHARGES_TOTAL_AMOUNT,
										OHD_COUPONS_AMOUNT, OHD_COUPONS_VAT, OHD_COUPONS_PERC_FEE, OHD_COUPONS_PERC_FEE_VAT, OHD_COUPONS_FIXED_FEE, OHD_COUPONS_FIXED_FEE_VAT, OHD_COUPONS_TOTAL_AMOUNT,
										OHD_SERVICES_AMOUNT, OHD_SERVICES_VAT, OHD_SERVICES_PERC_FEE, OHD_SERVICES_PERC_FEE_VAT, OHD_SERVICES_FIXED_FEE, OHD_SERVICES_FIXED_FEE_VAT, OHD_SERVICES_TOTAL_AMOUNT)
	SELECT DB_OPERATIONS_HOUR.DBOH_ID, FINAN_DIST_OPERATORS.FDO_ID,

		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_AMOUNT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_PERC_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.PARKINGS_FIXED_FEE_VAT * ISNULL(DIST_PARKINGS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_AMOUNT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_PERC_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.EXTENSIONS_FIXED_FEE_VAT * ISNULL(DIST_EXTENSIONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  -dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_AMOUNT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  -dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_PERC_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.REFUNDS_FIXED_FEE_VAT * ISNULL(DIST_REFUNDS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_AMOUNT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_PERC_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.TICKETPAYMENTS_FIXED_FEE_VAT * ISNULL(DIST_TICKETPAYMENTS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.RECHARGES_AMOUNT * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.RECHARGES_VAT * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.RECHARGES_PERC_FEE_VAT * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.RECHARGES_FIXED_FEE_VAT * ISNULL(DIST_RECHARGES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_AMOUNT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_PERC_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_PERC_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.COUPONS_FIXED_FEE_VAT * ISNULL(DIST_COUPONS.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0,

		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_AMOUNT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_VAT1,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_PERC_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_PERC_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_PERC_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  dbo.ToInt(SUM(DB_OPERATIONS_HOUR.SERVICES_FIXED_FEE_VAT * ISNULL(DIST_SERVICES.FDOIP_PERC_DIST_FIXED_FEE,0))),
		  0

	FROM DB_OPERATIONS_HOUR 
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D1
				    WHERE D1.FDOIP_OPE_TYPE = 1 AND
						  D1.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D1.FDOIP_END_APPLY_DATE >= @FromHour) DIST_PARKINGS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_PARKINGS.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_PARKINGS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D2
				    WHERE D2.FDOIP_OPE_TYPE = 2 AND
						  D2.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D2.FDOIP_END_APPLY_DATE >= @FromHour) DIST_EXTENSIONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_EXTENSIONS.FDOIP_INS_ID) AND
																					  DB_OPERATIONS_HOUR.GRP_ID = (DIST_EXTENSIONS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D3
				    WHERE D3.FDOIP_OPE_TYPE = 3 AND
						  D3.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D3.FDOIP_END_APPLY_DATE >= @FromHour) DIST_REFUNDS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_REFUNDS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_REFUNDS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D4
				    WHERE D4.FDOIP_OPE_TYPE = 4 AND
						  D4.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D4.FDOIP_END_APPLY_DATE >= @FromHour) DIST_TICKETPAYMENTS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_TICKETPAYMENTS.FDOIP_INS_ID) AND
																				   DB_OPERATIONS_HOUR.GRP_ID = (DIST_TICKETPAYMENTS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D5
				    WHERE D5.FDOIP_OPE_TYPE = 5 AND
						  D5.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D5.FDOIP_END_APPLY_DATE >= @FromHour) DIST_RECHARGES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_RECHARGES.FDOIP_INS_ID) AND
																					 DB_OPERATIONS_HOUR.GRP_ID = (DIST_RECHARGES.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D12
				    WHERE D12.FDOIP_OPE_TYPE = 12 AND
						  D12.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D12.FDOIP_END_APPLY_DATE >= @FromHour) DIST_COUPONS ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_COUPONS.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_COUPONS.FDOIP_GRP_ID)
		 LEFT JOIN (SELECT * FROM FINAN_DIST_OPERATORS_INSTALLATIONS_PARS_OPE_TYPE D6
				    WHERE D6.FDOIP_OPE_TYPE = 6 AND
						  D6.FDOIP_INI_APPLY_DATE <= @FromHour AND
						  D6.FDOIP_END_APPLY_DATE >= @FromHour) DIST_SERVICES ON DB_OPERATIONS_HOUR.OPE_INS_ID = (DIST_SERVICES.FDOIP_INS_ID) AND
																			     DB_OPERATIONS_HOUR.GRP_ID = (DIST_SERVICES.FDOIP_GRP_ID),

		 FINAN_DIST_OPERATORS

	WHERE HOUR_UTC >= @FromHour AND
		  HOUR_UTC < @ToHour AND
		  (DIST_PARKINGS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_PARKINGS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_EXTENSIONS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_EXTENSIONS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_REFUNDS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_REFUNDS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_TICKETPAYMENTS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_TICKETPAYMENTS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_RECHARGES.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_RECHARGES.FDOIP_FDO_ID IS NULL) AND
		  (DIST_COUPONS.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_COUPONS.FDOIP_FDO_ID IS NULL) AND
		  (DIST_SERVICES.FDOIP_FDO_ID = FINAN_DIST_OPERATORS.FDO_ID OR DIST_SERVICES.FDOIP_FDO_ID IS NULL) 
		  
	
	GROUP BY DB_OPERATIONS_HOUR.DBOH_ID, FINAN_DIST_OPERATORS.FDO_ID
	
END



GO


ALTER PROCEDURE [dbo].[Update_DB_OPERATIONS_MINUTE]
	@FromMinute AS Datetime
AS	
BEGIN

	IF (@FromMinute IS NULL)
	BEGIN
		SET @FromMinute = (SELECT MAX([MINUTE])
		FROM DB_OPERATIONS_MINUTE
		where [MINUTE] < GETDATE())

		IF (@FromMinute IS NOT NULL)
		BEGIN
			SET @FromMinute = DATEADD(HOUR, -1, @FromMinute)
		END		
	END

	IF (@FromMinute IS NULL)
	BEGIN
		SET @FromMinute = (SELECT MIN(CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_INIDATE ELSE OPE_DATE END)
		FROM ALL_OPERATIONS_EXT
		WHERE OPE_TYPE IN (1,2,3,4, 5))
	END
	
	DELETE FROM DB_OPERATIONS_MINUTE
	WHERE [MINUTE] >= @FromMinute
	

	INSERT INTO DB_OPERATIONS_MINUTE
	SELECT dateadd(minute, datediff(minute, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_INIDATE ELSE OPE_DATE END), 0) AS MINUTE, 
		ISNULL(OPE_INS_ID,0), ISNULL(GRP_ID,0), OPE_AMOUNT_CUR_ISO_CODE,
	   count(distinct(CASE OPE_TYPE WHEN 1 THEN ope_id ELSE NULL END)) PARKINGS_COUNT,
	   count(distinct(CASE OPE_TYPE WHEN 2 THEN ope_id ELSE NULL END)) EXTENSIONS_COUNT,
	   count(distinct(CASE OPE_TYPE WHEN 3 THEN ope_id ELSE NULL END)) REFUNDS_COUNT,
	   count(distinct(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NOT NULL THEN ope_id ELSE NULL END)) TICKETPAYMENTS_COUNT,	   
	   count(distinct(CASE OPE_TYPE WHEN 5 THEN ope_id ELSE NULL END)) RECHARGES_COUNT,
	   sum(CASE OPE_TYPE WHEN 1 THEN -OPE_AMOUNT ELSE 0 END) PARKINGS_AMOUNT,
	   sum(CASE OPE_TYPE WHEN 2 THEN -OPE_AMOUNT ELSE 0 END) EXTENSIONS_AMOUNT,
	   sum(CASE OPE_TYPE WHEN 3 THEN OPE_AMOUNT ELSE 0 END) REFUNDS_AMOUNT,
	   sum(CASE OPE_TYPE WHEN 5 THEN OPE_AMOUNT ELSE 0 END) RECHARGES_AMOUNT,
	   sum(CASE OPE_TYPE WHEN 1 THEN OPE_TIME ELSE 0 END) PARKINGS_TIME,
	   sum(CASE OPE_TYPE WHEN 2 THEN OPE_TIME ELSE 0 END) EXTENSIONS_TIME,
	   sum(CASE OPE_TYPE WHEN 3 THEN OPE_TIME ELSE 0 END) REFUNDS_TIME,	   
	   MAX(dateadd(minute, datediff(minute, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_UTC_INIDATE ELSE OPE_UTC_DATE END), 0)),
	   count(distinct(CASE WHEN OPE_TYPE = 4 AND OPE_USR_ID IS NULL THEN ope_id ELSE NULL END)) TICKETPAYMENTS_NON_USERS_COUNT
	   
	FROM ALL_OPERATIONS_EXT_DB
	WHERE OPE_TYPE IN (1,2,3,4, 5) AND 
		  CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_INIDATE ELSE OPE_DATE END >= @FromMinute AND
		  CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_INIDATE ELSE OPE_DATE END <= GETDATE()
	GROUP BY dateadd(minute, datediff(minute, 0, CASE WHEN OPE_TYPE = 1 OR OPE_TYPE = 2 OR OPE_TYPE = 3 THEN OPE_INIDATE ELSE OPE_DATE END), 0), 			 
			 OPE_INS_ID, GRP_ID, OPE_AMOUNT_CUR_ISO_CODE	

END






GO

